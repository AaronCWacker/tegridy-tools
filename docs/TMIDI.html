<!doctype html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />

  
  <title>TMIDI API documentation</title>
  <meta name="description" content="This module offers functions:  concatenate_scores(), grep(),
merge_scores(), mix_scores(), midi2opus..." />


  <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300' rel='stylesheet' type='text/css'>
  
  <style type="text/css">
* {
  box-sizing: border-box;
}
/*! normalize.css v1.1.1 | MIT License | git.io/normalize */

/* ==========================================================================
   HTML5 display definitions
   ========================================================================== */

/**
 * Correct `block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

article,
aside,
details,
figcaption,
figure,
footer,
header,
hgroup,
main,
nav,
section,
summary {
    display: block;
}

/**
 * Correct `inline-block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

audio,
canvas,
video {
    display: inline-block;
    *display: inline;
    *zoom: 1;
}

/**
 * Prevent modern browsers from displaying `audio` without controls.
 * Remove excess height in iOS 5 devices.
 */

audio:not([controls]) {
    display: none;
    height: 0;
}

/**
 * Address styling not present in IE 7/8/9, Firefox 3, and Safari 4.
 * Known issue: no IE 6 support.
 */

[hidden] {
    display: none;
}

/* ==========================================================================
   Base
   ========================================================================== */

/**
 * 1. Prevent system color scheme's background color being used in Firefox, IE,
 *    and Opera.
 * 2. Prevent system color scheme's text color being used in Firefox, IE, and
 *    Opera.
 * 3. Correct text resizing oddly in IE 6/7 when body `font-size` is set using
 *    `em` units.
 * 4. Prevent iOS text size adjust after orientation change, without disabling
 *    user zoom.
 */

html {
    background: #fff; /* 1 */
    color: #000; /* 2 */
    font-size: 100%; /* 3 */
    -webkit-text-size-adjust: 100%; /* 4 */
    -ms-text-size-adjust: 100%; /* 4 */
}

/**
 * Address `font-family` inconsistency between `textarea` and other form
 * elements.
 */

html,
button,
input,
select,
textarea {
    font-family: sans-serif;
}

/**
 * Address margins handled incorrectly in IE 6/7.
 */

body {
    margin: 0;
}

/* ==========================================================================
   Links
   ========================================================================== */

/**
 * Address `outline` inconsistency between Chrome and other browsers.
 */

a:focus {
    outline: thin dotted;
}

/**
 * Improve readability when focused and also mouse hovered in all browsers.
 */

a:active,
a:hover {
    outline: 0;
}

/* ==========================================================================
   Typography
   ========================================================================== */

/**
 * Address font sizes and margins set differently in IE 6/7.
 * Address font sizes within `section` and `article` in Firefox 4+, Safari 5,
 * and Chrome.
 */

h1 {
    font-size: 2em;
    margin: 0.67em 0;
}

h2 {
    font-size: 1.5em;
    margin: 0.83em 0;
}

h3 {
    font-size: 1.17em;
    margin: 1em 0;
}

h4 {
    font-size: 1em;
    margin: 1.33em 0;
}

h5 {
    font-size: 0.83em;
    margin: 1.67em 0;
}

h6 {
    font-size: 0.67em;
    margin: 2.33em 0;
}

/**
 * Address styling not present in IE 7/8/9, Safari 5, and Chrome.
 */

abbr[title] {
    border-bottom: 1px dotted;
}

/**
 * Address style set to `bolder` in Firefox 3+, Safari 4/5, and Chrome.
 */

b,
strong {
    font-weight: bold;
}

blockquote {
    margin: 1em 40px;
}

/**
 * Address styling not present in Safari 5 and Chrome.
 */

dfn {
    font-style: italic;
}

/**
 * Address differences between Firefox and other browsers.
 * Known issue: no IE 6/7 normalization.
 */

hr {
    -moz-box-sizing: content-box;
    box-sizing: content-box;
    height: 0;
}

/**
 * Address styling not present in IE 6/7/8/9.
 */

mark {
    background: #ff0;
    color: #000;
}

/**
 * Address margins set differently in IE 6/7.
 */

p,
pre {
    margin: 1em 0;
}

/**
 * Correct font family set oddly in IE 6, Safari 4/5, and Chrome.
 */

code,
kbd,
pre,
samp {
    font-family: monospace, serif;
    _font-family: 'courier new', monospace;
    font-size: 1em;
}

/**
 * Improve readability of pre-formatted text in all browsers.
 */

pre {
    white-space: pre;
    white-space: pre-wrap;
    word-wrap: break-word;
}

/**
 * Address CSS quotes not supported in IE 6/7.
 */

q {
    quotes: none;
}

/**
 * Address `quotes` property not supported in Safari 4.
 */

q:before,
q:after {
    content: '';
    content: none;
}

/**
 * Address inconsistent and variable font size in all browsers.
 */

small {
    font-size: 80%;
}

/**
 * Prevent `sub` and `sup` affecting `line-height` in all browsers.
 */

sub,
sup {
    font-size: 75%;
    line-height: 0;
    position: relative;
    vertical-align: baseline;
}

sup {
    top: -0.5em;
}

sub {
    bottom: -0.25em;
}

/* ==========================================================================
   Lists
   ========================================================================== */

/**
 * Address margins set differently in IE 6/7.
 */

dl,
menu,
ol,
ul {
    margin: 1em 0;
}

dd {
    margin: 0 0 0 40px;
}

/**
 * Address paddings set differently in IE 6/7.
 */

menu,
ol,
ul {
    padding: 0 0 0 40px;
}

/**
 * Correct list images handled incorrectly in IE 7.
 */

nav ul,
nav ol {
    list-style: none;
    list-style-image: none;
}

/* ==========================================================================
   Embedded content
   ========================================================================== */

/**
 * 1. Remove border when inside `a` element in IE 6/7/8/9 and Firefox 3.
 * 2. Improve image quality when scaled in IE 7.
 */

img {
    border: 0; /* 1 */
    -ms-interpolation-mode: bicubic; /* 2 */
}

/**
 * Correct overflow displayed oddly in IE 9.
 */

svg:not(:root) {
    overflow: hidden;
}

/* ==========================================================================
   Figures
   ========================================================================== */

/**
 * Address margin not present in IE 6/7/8/9, Safari 5, and Opera 11.
 */

figure {
    margin: 0;
}

/* ==========================================================================
   Forms
   ========================================================================== */

/**
 * Correct margin displayed oddly in IE 6/7.
 */

form {
    margin: 0;
}

/**
 * Define consistent border, margin, and padding.
 */

fieldset {
    border: 1px solid #c0c0c0;
    margin: 0 2px;
    padding: 0.35em 0.625em 0.75em;
}

/**
 * 1. Correct color not being inherited in IE 6/7/8/9.
 * 2. Correct text not wrapping in Firefox 3.
 * 3. Correct alignment displayed oddly in IE 6/7.
 */

legend {
    border: 0; /* 1 */
    padding: 0;
    white-space: normal; /* 2 */
    *margin-left: -7px; /* 3 */
}

/**
 * 1. Correct font size not being inherited in all browsers.
 * 2. Address margins set differently in IE 6/7, Firefox 3+, Safari 5,
 *    and Chrome.
 * 3. Improve appearance and consistency in all browsers.
 */

button,
input,
select,
textarea {
    font-size: 100%; /* 1 */
    margin: 0; /* 2 */
    vertical-align: baseline; /* 3 */
    *vertical-align: middle; /* 3 */
}

/**
 * Address Firefox 3+ setting `line-height` on `input` using `!important` in
 * the UA stylesheet.
 */

button,
input {
    line-height: normal;
}

/**
 * Address inconsistent `text-transform` inheritance for `button` and `select`.
 * All other form control elements do not inherit `text-transform` values.
 * Correct `button` style inheritance in Chrome, Safari 5+, and IE 6+.
 * Correct `select` style inheritance in Firefox 4+ and Opera.
 */

button,
select {
    text-transform: none;
}

/**
 * 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio`
 *    and `video` controls.
 * 2. Correct inability to style clickable `input` types in iOS.
 * 3. Improve usability and consistency of cursor style between image-type
 *    `input` and others.
 * 4. Remove inner spacing in IE 7 without affecting normal text inputs.
 *    Known issue: inner spacing remains in IE 6.
 */

button,
html input[type="button"], /* 1 */
input[type="reset"],
input[type="submit"] {
    -webkit-appearance: button; /* 2 */
    cursor: pointer; /* 3 */
    *overflow: visible;  /* 4 */
}

/**
 * Re-set default cursor for disabled elements.
 */

button[disabled],
html input[disabled] {
    cursor: default;
}

/**
 * 1. Address box sizing set to content-box in IE 8/9.
 * 2. Remove excess padding in IE 8/9.
 * 3. Remove excess padding in IE 7.
 *    Known issue: excess padding remains in IE 6.
 */

input[type="checkbox"],
input[type="radio"] {
    box-sizing: border-box; /* 1 */
    padding: 0; /* 2 */
    *height: 13px; /* 3 */
    *width: 13px; /* 3 */
}

/**
 * 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome.
 * 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome
 *    (include `-moz` to future-proof).
 */

input[type="search"] {
    -webkit-appearance: textfield; /* 1 */
    -moz-box-sizing: content-box;
    -webkit-box-sizing: content-box; /* 2 */
    box-sizing: content-box;
}

/**
 * Remove inner padding and search cancel button in Safari 5 and Chrome
 * on OS X.
 */

input[type="search"]::-webkit-search-cancel-button,
input[type="search"]::-webkit-search-decoration {
    -webkit-appearance: none;
}

/**
 * Remove inner padding and border in Firefox 3+.
 */

button::-moz-focus-inner,
input::-moz-focus-inner {
    border: 0;
    padding: 0;
}

/**
 * 1. Remove default vertical scrollbar in IE 6/7/8/9.
 * 2. Improve readability and alignment in all browsers.
 */

textarea {
    overflow: auto; /* 1 */
    vertical-align: top; /* 2 */
}

/* ==========================================================================
   Tables
   ========================================================================== */

/**
 * Remove most spacing between table cells.
 */

table {
    border-collapse: collapse;
    border-spacing: 0;
}
</style>
  <style type="text/css">
  html, body {
    margin: 0;
    padding: 0;
    min-height: 100%;
  }
  body {
    background: #fff;
    font-family: "Source Sans Pro", "Helvetica Neueue", Helvetica, sans;
    font-weight: 300;
    font-size: 16px;
    line-height: 1.6em;
  }
  #content {
    width: 70%;
    max-width: 850px;
    float: left;
    padding: 30px 60px;
    border-left: 1px solid #ddd;
  }
  #sidebar {
    width: 25%;
    float: left;
    padding: 30px;
    overflow: hidden;
  }
  #nav {
    font-size: 130%;
    margin: 0 0 15px 0;
  }

  #top {
    display: block;
    position: fixed;
    bottom: 5px;
    left: 5px;
    font-size: .85em;
    text-transform: uppercase;
  }

  #footer {
    font-size: .75em;
    padding: 5px 30px;
    border-top: 1px solid #ddd;
    text-align: right;
  }
    #footer p {
      margin: 0 0 0 30px;
      display: inline-block;
    }

  h1, h2, h3, h4, h5 {
    font-weight: 300;
  }
  h1 {
    font-size: 2.5em;
    line-height: 1.1em;
    margin: 0 0 .50em 0;
  }

  h2 {
    font-size: 1.75em;
    margin: 1em 0 .50em 0;
  }

  h3 {
    margin: 25px 0 10px 0;
  }

  h4 {
    margin: 0;
    font-size: 105%;
  }

  a {
    color: #058;
    text-decoration: none;
    transition: color .3s ease-in-out;
  }

  a:hover {
    color: #e08524;
    transition: color .3s ease-in-out;
  }

  pre, code, .mono, .name {
    font-family: "Ubuntu Mono", "Cousine", "DejaVu Sans Mono", monospace;
  }

  .title .name {
    font-weight: bold;
  }
  .section-title {
    margin-top: 2em;
  }
  .ident {
    color: #900;
  }

  code {
    background: #f9f9f9;
  } 

  pre {
    background: #fefefe;
    border: 1px solid #ddd;
    box-shadow: 2px 2px 0 #f3f3f3;
    margin: 0 30px;
    padding: 15px 30px;
  }

  .codehilite {
    margin: 0 30px 10px 30px;
  }

    .codehilite pre {
      margin: 0;
    }
    .codehilite .err { background: #ff3300; color: #fff !important; } 

  table#module-list {
    font-size: 110%;
  }

    table#module-list tr td:first-child {
      padding-right: 10px;
      white-space: nowrap;
    }

    table#module-list td {
      vertical-align: top;
      padding-bottom: 8px;
    }

      table#module-list td p {
        margin: 0 0 7px 0;
      }

  .def {
    display: table;
  }

    .def p {
      display: table-cell;
      vertical-align: top;
      text-align: left;
    }

    .def p:first-child {
      white-space: nowrap;
    }

    .def p:last-child {
      width: 100%;
    }


  #index {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }
    ul#index .class_name {
      /* font-size: 110%; */
      font-weight: bold;
    }
    #index ul {
      margin: 0;
    }

  .item {
    margin: 0 0 15px 0;
  }

    .item .class {
      margin: 0 0 25px 30px;
    }

      .item .class ul.class_list {
        margin: 0 0 20px 0;
      }

    .item .name {
      background: #fafafa;
      margin: 0;
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 3px;
      display: inline-block;
      min-width: 40%;
    }
      .item .name:hover {
        background: #f6f6f6;
      }

    .item .empty_desc {
      margin: 0 0 5px 0;
      padding: 0;
    }

    .item .inheritance {
      margin: 3px 0 0 30px;
    }

    .item .inherited {
      color: #666;
    }

    .item .desc {
      padding: 0 8px;
      margin: 0;
    }

      .item .desc p {
        margin: 0 0 10px 0;
      }

    .source_cont {
      margin: 0;
      padding: 0;
    }

    .source_link a {
      background: #ffc300;
      font-weight: 400;
      font-size: .75em;
      text-transform: uppercase;
      color: #fff;
      text-shadow: 1px 1px 0 #f4b700;
      
      padding: 3px 8px;
      border-radius: 2px;
      transition: background .3s ease-in-out;
    }
      .source_link a:hover {
        background: #FF7200;
        text-shadow: none;
        transition: background .3s ease-in-out;
      }

    .source {
      display: none;
      max-height: 600px;
      overflow-y: scroll;
      margin-bottom: 15px;
    }

      .source .codehilite {
        margin: 0;
      }

  .desc h1, .desc h2, .desc h3 {
    font-size: 100% !important;
  }
  .clear {
    clear: both;
  }

  @media all and (max-width: 950px) {
    #sidebar {
      width: 35%;
    }
    #content {
      width: 65%;
    }
  }
  @media all and (max-width: 650px) {
    #top {
      display: none;
    }
    #sidebar {
      float: none;
      width: auto;
    }
    #content {
      float: none;
      width: auto;
      padding: 30px;
    }

    #index ul {
      padding: 0;
      margin-bottom: 15px;
    }
    #index ul li {
      display: inline-block;
      margin-right: 30px;
    }
    #footer {
      text-align: left;
    }
    #footer p {
      display: block;
      margin: inherit;
    }
  }

  /*****************************/
</style>
  <style type="text/css">
  .codehilite .hll { background-color: #ffffcc }
.codehilite  { background: #f8f8f8; }
.codehilite .c { color: #408080; font-style: italic } /* Comment */
.codehilite .err { border: 1px solid #FF0000 } /* Error */
.codehilite .k { color: #008000; font-weight: bold } /* Keyword */
.codehilite .o { color: #666666 } /* Operator */
.codehilite .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
.codehilite .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.codehilite .cp { color: #BC7A00 } /* Comment.Preproc */
.codehilite .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
.codehilite .c1 { color: #408080; font-style: italic } /* Comment.Single */
.codehilite .cs { color: #408080; font-style: italic } /* Comment.Special */
.codehilite .gd { color: #A00000 } /* Generic.Deleted */
.codehilite .ge { font-style: italic } /* Generic.Emph */
.codehilite .gr { color: #FF0000 } /* Generic.Error */
.codehilite .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.codehilite .gi { color: #00A000 } /* Generic.Inserted */
.codehilite .go { color: #888888 } /* Generic.Output */
.codehilite .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.codehilite .gs { font-weight: bold } /* Generic.Strong */
.codehilite .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.codehilite .gt { color: #0044DD } /* Generic.Traceback */
.codehilite .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.codehilite .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.codehilite .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.codehilite .kp { color: #008000 } /* Keyword.Pseudo */
.codehilite .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.codehilite .kt { color: #B00040 } /* Keyword.Type */
.codehilite .m { color: #666666 } /* Literal.Number */
.codehilite .s { color: #BA2121 } /* Literal.String */
.codehilite .na { color: #7D9029 } /* Name.Attribute */
.codehilite .nb { color: #008000 } /* Name.Builtin */
.codehilite .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.codehilite .no { color: #880000 } /* Name.Constant */
.codehilite .nd { color: #AA22FF } /* Name.Decorator */
.codehilite .ni { color: #999999; font-weight: bold } /* Name.Entity */
.codehilite .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.codehilite .nf { color: #0000FF } /* Name.Function */
.codehilite .nl { color: #A0A000 } /* Name.Label */
.codehilite .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.codehilite .nt { color: #008000; font-weight: bold } /* Name.Tag */
.codehilite .nv { color: #19177C } /* Name.Variable */
.codehilite .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.codehilite .w { color: #bbbbbb } /* Text.Whitespace */
.codehilite .mb { color: #666666 } /* Literal.Number.Bin */
.codehilite .mf { color: #666666 } /* Literal.Number.Float */
.codehilite .mh { color: #666666 } /* Literal.Number.Hex */
.codehilite .mi { color: #666666 } /* Literal.Number.Integer */
.codehilite .mo { color: #666666 } /* Literal.Number.Oct */
.codehilite .sa { color: #BA2121 } /* Literal.String.Affix */
.codehilite .sb { color: #BA2121 } /* Literal.String.Backtick */
.codehilite .sc { color: #BA2121 } /* Literal.String.Char */
.codehilite .dl { color: #BA2121 } /* Literal.String.Delimiter */
.codehilite .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.codehilite .s2 { color: #BA2121 } /* Literal.String.Double */
.codehilite .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.codehilite .sh { color: #BA2121 } /* Literal.String.Heredoc */
.codehilite .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.codehilite .sx { color: #008000 } /* Literal.String.Other */
.codehilite .sr { color: #BB6688 } /* Literal.String.Regex */
.codehilite .s1 { color: #BA2121 } /* Literal.String.Single */
.codehilite .ss { color: #19177C } /* Literal.String.Symbol */
.codehilite .bp { color: #008000 } /* Name.Builtin.Pseudo */
.codehilite .fm { color: #0000FF } /* Name.Function.Magic */
.codehilite .vc { color: #19177C } /* Name.Variable.Class */
.codehilite .vg { color: #19177C } /* Name.Variable.Global */
.codehilite .vi { color: #19177C } /* Name.Variable.Instance */
.codehilite .vm { color: #19177C } /* Name.Variable.Magic */
.codehilite .il { color: #666666 } /* Literal.Number.Integer.Long */
  </style>
  <style type="text/css">
/* ==========================================================================
   EXAMPLE Media Queries for Responsive Design.
   These examples override the primary ('mobile first') styles.
   Modify as content requires.
   ========================================================================== */

@media only screen and (min-width: 35em) {
    /* Style adjustments for viewports that meet the condition */
}

@media print,
       (-o-min-device-pixel-ratio: 5/4),
       (-webkit-min-device-pixel-ratio: 1.25),
       (min-resolution: 120dpi) {
    /* Style adjustments for high resolution devices */
}

/* ==========================================================================
   Print styles.
   Inlined to avoid required HTTP connection: h5bp.com/r
   ========================================================================== */

@media print {
    * {
        background: transparent !important;
        color: #000 !important; /* Black prints faster: h5bp.com/s */
        box-shadow: none !important;
        text-shadow: none !important;
    }

    a,
    a:visited {
        text-decoration: underline;
    }

    a[href]:after {
        content: " (" attr(href) ")";
    }

    abbr[title]:after {
        content: " (" attr(title) ")";
    }

    /*
     * Don't show links for images, or javascript/internal links
     */

    .ir a:after,
    a[href^="javascript:"]:after,
    a[href^="#"]:after {
        content: "";
    }

    pre,
    blockquote {
        border: 1px solid #999;
        page-break-inside: avoid;
    }

    thead {
        display: table-header-group; /* h5bp.com/t */
    }

    tr,
    img {
        page-break-inside: avoid;
    }

    img {
        max-width: 100% !important;
    }

    @page {
        margin: 0.5cm;
    }

    p,
    h2,
    h3 {
        orphans: 3;
        widows: 3;
    }

    h2,
    h3 {
        page-break-after: avoid;
    }
}
</style>

  <script type="text/javascript">
  function toggle(id, $link) {
    $node = document.getElementById(id);
    if (!$node)
    return;
    if (!$node.style.display || $node.style.display == 'none') {
    $node.style.display = 'block';
    $link.innerHTML = 'Hide source &nequiv;';
    } else {
    $node.style.display = 'none';
    $link.innerHTML = 'Show source &equiv;';
    }
  }
  </script>
</head>
<body>
<a href="#" id="top">Top</a>
<div id="container">
  


















  
  <div id="sidebar">
    <h1>Index</h1>
    <ul id="index">
    <li class="set"><h3><a href="#header-variables">Module variables</a></h3>
      
  <ul>
    <li class="mono"><a href="#TMIDI.All_events">All_events</a></li>
    <li class="mono"><a href="#TMIDI.Event2channelindex">Event2channelindex</a></li>
    <li class="mono"><a href="#TMIDI.MIDI_events">MIDI_events</a></li>
    <li class="mono"><a href="#TMIDI.Meta_events">Meta_events</a></li>
    <li class="mono"><a href="#TMIDI.Nontext_meta_events">Nontext_meta_events</a></li>
    <li class="mono"><a href="#TMIDI.Notenum2percussion">Notenum2percussion</a></li>
    <li class="mono"><a href="#TMIDI.Number2patch">Number2patch</a></li>
    <li class="mono"><a href="#TMIDI.Text_events">Text_events</a></li>
    <li class="mono"><a href="#TMIDI.Version">Version</a></li>
    <li class="mono"><a href="#TMIDI.VersionDate">VersionDate</a></li>
  </ul>

    </li>

    <li class="set"><h3><a href="#header-functions">Functions</a></h3>
      
  <ul>
    <li class="mono"><a href="#TMIDI.Optimus_MIDI_TXT_Processor">Optimus_MIDI_TXT_Processor</a></li>
    <li class="mono"><a href="#TMIDI.Tegridy_Any_Pickle_File_Loader">Tegridy_Any_Pickle_File_Loader</a></li>
    <li class="mono"><a href="#TMIDI.Tegridy_Chords_Converter">Tegridy_Chords_Converter</a></li>
    <li class="mono"><a href="#TMIDI.Tegridy_File_Time_Stamp">Tegridy_File_Time_Stamp</a></li>
    <li class="mono"><a href="#TMIDI.Tegridy_INT_String_to_TXT_Converter">Tegridy_INT_String_to_TXT_Converter</a></li>
    <li class="mono"><a href="#TMIDI.Tegridy_INT_to_TXT_Converter">Tegridy_INT_to_TXT_Converter</a></li>
    <li class="mono"><a href="#TMIDI.Tegridy_INT_to_TXT_Processor">Tegridy_INT_to_TXT_Processor</a></li>
    <li class="mono"><a href="#TMIDI.Tegridy_Karaoke_MIDI_to_Reduced_TXT_Processor">Tegridy_Karaoke_MIDI_to_Reduced_TXT_Processor</a></li>
    <li class="mono"><a href="#TMIDI.Tegridy_Karaoke_Pitches_Words_List_to_CSV_Writer">Tegridy_Karaoke_Pitches_Words_List_to_CSV_Writer</a></li>
    <li class="mono"><a href="#TMIDI.Tegridy_Karaoke_TXT_to_MIDI_Processor">Tegridy_Karaoke_TXT_to_MIDI_Processor</a></li>
    <li class="mono"><a href="#TMIDI.Tegridy_List_Slicer">Tegridy_List_Slicer</a></li>
    <li class="mono"><a href="#TMIDI.Tegridy_MIDI_Processor">Tegridy_MIDI_Processor</a></li>
    <li class="mono"><a href="#TMIDI.Tegridy_MIDI_Signature">Tegridy_MIDI_Signature</a></li>
    <li class="mono"><a href="#TMIDI.Tegridy_MIDI_TXT_Processor">Tegridy_MIDI_TXT_Processor</a></li>
    <li class="mono"><a href="#TMIDI.Tegridy_Optimus_INT_to_TXT_Converter">Tegridy_Optimus_INT_to_TXT_Converter</a></li>
    <li class="mono"><a href="#TMIDI.Tegridy_Optimus_Sum_Intro_Rand_End_Sampler">Tegridy_Optimus_Sum_Intro_Rand_End_Sampler</a></li>
    <li class="mono"><a href="#TMIDI.Tegridy_Optimus_TXT_to_INT_Converter">Tegridy_Optimus_TXT_to_INT_Converter</a></li>
    <li class="mono"><a href="#TMIDI.Tegridy_Optimus_TXT_to_Notes_Converter">Tegridy_Optimus_TXT_to_Notes_Converter</a></li>
    <li class="mono"><a href="#TMIDI.Tegridy_Pickle_File_Loader">Tegridy_Pickle_File_Loader</a></li>
    <li class="mono"><a href="#TMIDI.Tegridy_Pickle_File_Writer">Tegridy_Pickle_File_Writer</a></li>
    <li class="mono"><a href="#TMIDI.Tegridy_Reduced_TXT_to_Notes_Converter">Tegridy_Reduced_TXT_to_Notes_Converter</a></li>
    <li class="mono"><a href="#TMIDI.Tegridy_SONG_to_MIDI_Converter">Tegridy_SONG_to_MIDI_Converter</a></li>
    <li class="mono"><a href="#TMIDI.Tegridy_TXT_Dataset_File_Writer">Tegridy_TXT_Dataset_File_Writer</a></li>
    <li class="mono"><a href="#TMIDI.Tegridy_TXT_DeTokenizer">Tegridy_TXT_DeTokenizer</a></li>
    <li class="mono"><a href="#TMIDI.Tegridy_TXT_MIDI_Processor">Tegridy_TXT_MIDI_Processor</a></li>
    <li class="mono"><a href="#TMIDI.Tegridy_TXT_Reducer">Tegridy_TXT_Reducer</a></li>
    <li class="mono"><a href="#TMIDI.Tegridy_TXT_Tokenizer">Tegridy_TXT_Tokenizer</a></li>
    <li class="mono"><a href="#TMIDI.Tegridy_TXT_to_INT_Converter">Tegridy_TXT_to_INT_Converter</a></li>
    <li class="mono"><a href="#TMIDI.Tegridy_TXT_to_INT_Processor">Tegridy_TXT_to_INT_Processor</a></li>
    <li class="mono"><a href="#TMIDI.concatenate_scores">concatenate_scores</a></li>
    <li class="mono"><a href="#TMIDI.event2alsaseq">event2alsaseq</a></li>
    <li class="mono"><a href="#TMIDI.grep">grep</a></li>
    <li class="mono"><a href="#TMIDI.merge_scores">merge_scores</a></li>
    <li class="mono"><a href="#TMIDI.midi2ms_score">midi2ms_score</a></li>
    <li class="mono"><a href="#TMIDI.midi2opus">midi2opus</a></li>
    <li class="mono"><a href="#TMIDI.midi2score">midi2score</a></li>
    <li class="mono"><a href="#TMIDI.mix_opus_tracks">mix_opus_tracks</a></li>
    <li class="mono"><a href="#TMIDI.mix_scores">mix_scores</a></li>
    <li class="mono"><a href="#TMIDI.opus2midi">opus2midi</a></li>
    <li class="mono"><a href="#TMIDI.opus2score">opus2score</a></li>
    <li class="mono"><a href="#TMIDI.play_score">play_score</a></li>
    <li class="mono"><a href="#TMIDI.score2midi">score2midi</a></li>
    <li class="mono"><a href="#TMIDI.score2opus">score2opus</a></li>
    <li class="mono"><a href="#TMIDI.score2stats">score2stats</a></li>
    <li class="mono"><a href="#TMIDI.score_type">score_type</a></li>
    <li class="mono"><a href="#TMIDI.segment">segment</a></li>
    <li class="mono"><a href="#TMIDI.timeshift">timeshift</a></li>
    <li class="mono"><a href="#TMIDI.to_millisecs">to_millisecs</a></li>
  </ul>

    </li>

    <li class="set"><h3><a href="#header-classes">Classes</a></h3>
      <ul>
        <li class="mono">
        <span class="class_name"><a href="#TMIDI.Note">Note</a></span>
        
          
  <ul>
    <li class="mono"><a href="#TMIDI.Note.get_duration">get_duration</a></li>
  </ul>

        </li>
        <li class="mono">
        <span class="class_name"><a href="#TMIDI.Tegridy_RPR_MidiEventProcessor">Tegridy_RPR_MidiEventProcessor</a></span>
        
          
  <ul>
    <li class="mono"><a href="#TMIDI.Tegridy_RPR_MidiEventProcessor.decode">decode</a></li>
    <li class="mono"><a href="#TMIDI.Tegridy_RPR_MidiEventProcessor.encode">encode</a></li>
  </ul>

        </li>
        <li class="mono">
        <span class="class_name"><a href="#TMIDI.Tegridy_ReprProcessor">Tegridy_ReprProcessor</a></span>
        
          
  <ul>
    <li class="mono"><a href="#TMIDI.Tegridy_ReprProcessor.decode">decode</a></li>
    <li class="mono"><a href="#TMIDI.Tegridy_ReprProcessor.encode">encode</a></li>
  </ul>

        </li>
      </ul>
    </li>

    </ul>
  </div>

<article id="content">
  

  


  <header id="section-intro">
  <h1 class="title"><span class="name">TMIDI</span> module</h1>
  <p>This module offers functions:  concatenate_scores(), grep(),
merge_scores(), mix_scores(), midi2opus(), midi2score(), opus2midi(),
opus2score(), play_score(), score2midi(), score2opus(), score2stats(),
score_type(), segment(), timeshift() and to_millisecs(),
where "midi" means the MIDI-file bytes (as can be put in a .mid file,
or piped into aplaymidi), and "opus" and "score" are list-structures
as inspired by Sean Burke's MIDI-Perl CPAN module.</p>
<p>Warning: Version 6.4 is not necessarily backward-compatible with
previous versions, in that text-data is now bytes, not strings.
This reflects the fact that many MIDI files have text data in
encodings other that ISO-8859-1, for example in Shift-JIS.</p>
<p>Download MIDI.py from   http://www.pjb.com.au/midi/free/MIDI.py
and put it in your PYTHONPATH.  MIDI.py depends on Python3.</p>
<p>There is also a call-compatible translation into Lua of this
module: see http://www.pjb.com.au/comp/lua/MIDI.html</p>
<p>The "opus" is a direct translation of the midi-file-events, where
the times are delta-times, in ticks, since the previous event.</p>
<p>The "score" is more human-centric; it uses absolute times, and
combines the separate note_on and note_off events into one "note"
event, with a duration:
 ['note', start_time, duration, channel, note, velocity] # in a "score"</p>
<p>EVENTS (in an "opus" structure)
     ['note_off', dtime, channel, note, velocity]       # in an "opus"
     ['note_on', dtime, channel, note, velocity]        # in an "opus"
     ['key_after_touch', dtime, channel, note, velocity]
     ['control_change', dtime, channel, controller(0-127), value(0-127)]
     ['patch_change', dtime, channel, patch]
     ['channel_after_touch', dtime, channel, velocity]
     ['pitch_wheel_change', dtime, channel, pitch_wheel]
     ['text_event', dtime, text]
     ['copyright_text_event', dtime, text]
     ['track_name', dtime, text]
     ['instrument_name', dtime, text]
     ['lyric', dtime, text]
     ['marker', dtime, text]
     ['cue_point', dtime, text]
     ['text_event_08', dtime, text]
     ['text_event_09', dtime, text]
     ['text_event_0a', dtime, text]
     ['text_event_0b', dtime, text]
     ['text_event_0c', dtime, text]
     ['text_event_0d', dtime, text]
     ['text_event_0e', dtime, text]
     ['text_event_0f', dtime, text]
     ['end_track', dtime]
     ['set_tempo', dtime, tempo]
     ['smpte_offset', dtime, hr, mn, se, fr, ff]
     ['time_signature', dtime, nn, dd, cc, bb]
     ['key_signature', dtime, sf, mi]
     ['sequencer_specific', dtime, raw]
     ['raw_meta_event', dtime, command(0-255), raw]
     ['sysex_f0', dtime, raw]
     ['sysex_f7', dtime, raw]
     ['song_position', dtime, song_pos]
     ['song_select', dtime, song_number]
     ['tune_request', dtime]</p>
<p>DATA TYPES
     channel = a value 0 to 15
     controller = 0 to 127 (see http://www.pjb.com.au/muscript/gm.html#cc )
     dtime = time measured in "ticks", 0 to 268435455
     velocity = a value 0 (soft) to 127 (loud)
     note = a value 0 to 127  (middle-C is 60)
     patch = 0 to 127 (see http://www.pjb.com.au/muscript/gm.html )
     pitch_wheel = a value -8192 to 8191 (0x1FFF)
     raw = bytes, of length 0 or more  (for sysex events see below)
     sequence_number = a value 0 to 65,535 (0xFFFF)
     song_pos = a value 0 to 16,383 (0x3FFF)
     song_number = a value 0 to 127
     tempo = microseconds per crochet (quarter-note), 0 to 16777215
     text = bytes, of length 0 or more
     ticks = the number of ticks per crochet (quarter-note)</p>
<p>In sysex_f0 events, the raw data must not start with a \xF0 byte,
   since this gets added automatically;
   but it must end with an explicit \xF7 byte!
   In the very unlikely case that you ever need to split sysex data
   into one sysex_f0 followed by one or more sysex_f7s, then only the
   last of those sysex_f7 events must end with the explicit \xF7 byte
   (again, the raw data of individual sysex_f7 events must not start
   with any \xF7 byte, since this gets added automatically).</p>
<p>Since version 6.4, text data is in bytes, not in a ISO-8859-1 string.</p>
<p>GOING THROUGH A SCORE WITHIN A PYTHON PROGRAM
    channels = {2,3,5,8,13}
    itrack = 1   # skip 1st element which is ticks
    while itrack &lt; len(score):
        for event in score[itrack]:
            if event[0] == 'note':   # for example,
                pass  # do something to all notes
            # or, to work on events in only particular channels&hellip;
            channel_index = MIDI.Event2channelindex.get(event[0], False)
            if channel_index and (event[channel_index] in channels):
                pass  # do something to channels 2,3,5,8 and 13
        itrack += 1</p>
  
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI" class="source">
    <div class="codehilite"><pre><span></span><span class="ch">#! /usr/bin/python3</span>

<span class="c1">###################################################################################</span>

<span class="c1">###################################################################################</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#	Tegridy MIDI Module (TMIDI / tee-midi)</span>
<span class="c1">#	Version 2.3</span>
<span class="c1">#</span>
<span class="c1">#       NOTE: TMIDI Module starts after MIDI.py module @ line 1780</span>
<span class="c1">#</span>
<span class="c1">#	Based upon and includes the amazing MIDI.py module v.6.7. by Peter Billam</span>
<span class="c1">#	pjb.com.au</span>
<span class="c1">#</span>
<span class="c1">#	Project Los Angeles</span>
<span class="c1">#</span>
<span class="c1">#	Tegridy Code 2021</span>
<span class="c1">#</span>
<span class="c1">#       https://github.com/Tegridy-Code/Project-Los-Angeles</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">###################################################################################</span>
<span class="c1">#       Copyright 2021 Project Los Angeles / Tegridy Code</span>
<span class="c1">#</span>
<span class="c1">#       Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1">#       you may not use this file except in compliance with the License.</span>
<span class="c1">#       You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#           http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1">#       Unless required by applicable law or agreed to in writing, software</span>
<span class="c1">#       distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1">#       WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1">#       See the License for the specific language governing permissions and</span>
<span class="c1">#       limitations under the License.</span>
<span class="c1">###################################################################################</span>
<span class="c1">#</span>
<span class="c1">#	MIDI.py Module v.6.7. by Peter Billam</span>
<span class="c1">#</span>
<span class="c1">#	https://pjb.com.au/</span>
<span class="c1">#	</span>
<span class="c1">#	Copyright 2020 Peter Billam</span>
<span class="c1">#</span>
<span class="c1">###################################################################################</span>

<span class="c1">###################################################################################</span>

<span class="c1"># unsupported 20091104 ...</span>
<span class="c1">#     [&#39;set_sequence_number&#39;, dtime, sequence]</span>
<span class="c1">#     [&#39;raw_data&#39;, dtime, raw]</span>

<span class="c1"># 20150914   jimbo1qaz   MIDI.py str/bytes bug report</span>
<span class="c1"># I found a MIDI file which had Shift-JIS titles. When midi.py decodes it as</span>
<span class="c1"># latin-1, it produces a string which cannot even be accessed without raising</span>
<span class="c1"># a UnicodeDecodeError.  Maybe, when converting raw byte strings from MIDI,</span>
<span class="c1"># you should keep them as bytes, not improperly decode them.  However, this</span>
<span class="c1"># would change the API.  (ie: text = a &quot;string&quot; ? of 0 or more bytes).  It</span>
<span class="c1"># could break compatiblity, but there&#39;s not much else you can do to fix the bug</span>
<span class="c1"># https://en.wikipedia.org/wiki/Shift_JIS</span>

<span class="sa">r</span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">This module offers functions:  concatenate_scores(), grep(),</span>
<span class="sd">merge_scores(), mix_scores(), midi2opus(), midi2score(), opus2midi(),</span>
<span class="sd">opus2score(), play_score(), score2midi(), score2opus(), score2stats(),</span>
<span class="sd">score_type(), segment(), timeshift() and to_millisecs(),</span>
<span class="sd">where &quot;midi&quot; means the MIDI-file bytes (as can be put in a .mid file,</span>
<span class="sd">or piped into aplaymidi), and &quot;opus&quot; and &quot;score&quot; are list-structures</span>
<span class="sd">as inspired by Sean Burke&#39;s MIDI-Perl CPAN module.</span>

<span class="sd">Warning: Version 6.4 is not necessarily backward-compatible with</span>
<span class="sd">previous versions, in that text-data is now bytes, not strings.</span>
<span class="sd">This reflects the fact that many MIDI files have text data in</span>
<span class="sd">encodings other that ISO-8859-1, for example in Shift-JIS.</span>

<span class="sd">Download MIDI.py from   http://www.pjb.com.au/midi/free/MIDI.py</span>
<span class="sd">and put it in your PYTHONPATH.  MIDI.py depends on Python3.</span>

<span class="sd">There is also a call-compatible translation into Lua of this</span>
<span class="sd">module: see http://www.pjb.com.au/comp/lua/MIDI.html</span>

<span class="sd">The &quot;opus&quot; is a direct translation of the midi-file-events, where</span>
<span class="sd">the times are delta-times, in ticks, since the previous event.</span>

<span class="sd">The &quot;score&quot; is more human-centric; it uses absolute times, and</span>
<span class="sd">combines the separate note_on and note_off events into one &quot;note&quot;</span>
<span class="sd">event, with a duration:</span>
<span class="sd"> [&#39;note&#39;, start_time, duration, channel, note, velocity] # in a &quot;score&quot;</span>

<span class="sd">  EVENTS (in an &quot;opus&quot; structure)</span>
<span class="sd">     [&#39;note_off&#39;, dtime, channel, note, velocity]       # in an &quot;opus&quot;</span>
<span class="sd">     [&#39;note_on&#39;, dtime, channel, note, velocity]        # in an &quot;opus&quot;</span>
<span class="sd">     [&#39;key_after_touch&#39;, dtime, channel, note, velocity]</span>
<span class="sd">     [&#39;control_change&#39;, dtime, channel, controller(0-127), value(0-127)]</span>
<span class="sd">     [&#39;patch_change&#39;, dtime, channel, patch]</span>
<span class="sd">     [&#39;channel_after_touch&#39;, dtime, channel, velocity]</span>
<span class="sd">     [&#39;pitch_wheel_change&#39;, dtime, channel, pitch_wheel]</span>
<span class="sd">     [&#39;text_event&#39;, dtime, text]</span>
<span class="sd">     [&#39;copyright_text_event&#39;, dtime, text]</span>
<span class="sd">     [&#39;track_name&#39;, dtime, text]</span>
<span class="sd">     [&#39;instrument_name&#39;, dtime, text]</span>
<span class="sd">     [&#39;lyric&#39;, dtime, text]</span>
<span class="sd">     [&#39;marker&#39;, dtime, text]</span>
<span class="sd">     [&#39;cue_point&#39;, dtime, text]</span>
<span class="sd">     [&#39;text_event_08&#39;, dtime, text]</span>
<span class="sd">     [&#39;text_event_09&#39;, dtime, text]</span>
<span class="sd">     [&#39;text_event_0a&#39;, dtime, text]</span>
<span class="sd">     [&#39;text_event_0b&#39;, dtime, text]</span>
<span class="sd">     [&#39;text_event_0c&#39;, dtime, text]</span>
<span class="sd">     [&#39;text_event_0d&#39;, dtime, text]</span>
<span class="sd">     [&#39;text_event_0e&#39;, dtime, text]</span>
<span class="sd">     [&#39;text_event_0f&#39;, dtime, text]</span>
<span class="sd">     [&#39;end_track&#39;, dtime]</span>
<span class="sd">     [&#39;set_tempo&#39;, dtime, tempo]</span>
<span class="sd">     [&#39;smpte_offset&#39;, dtime, hr, mn, se, fr, ff]</span>
<span class="sd">     [&#39;time_signature&#39;, dtime, nn, dd, cc, bb]</span>
<span class="sd">     [&#39;key_signature&#39;, dtime, sf, mi]</span>
<span class="sd">     [&#39;sequencer_specific&#39;, dtime, raw]</span>
<span class="sd">     [&#39;raw_meta_event&#39;, dtime, command(0-255), raw]</span>
<span class="sd">     [&#39;sysex_f0&#39;, dtime, raw]</span>
<span class="sd">     [&#39;sysex_f7&#39;, dtime, raw]</span>
<span class="sd">     [&#39;song_position&#39;, dtime, song_pos]</span>
<span class="sd">     [&#39;song_select&#39;, dtime, song_number]</span>
<span class="sd">     [&#39;tune_request&#39;, dtime]</span>

<span class="sd">  DATA TYPES</span>
<span class="sd">     channel = a value 0 to 15</span>
<span class="sd">     controller = 0 to 127 (see http://www.pjb.com.au/muscript/gm.html#cc )</span>
<span class="sd">     dtime = time measured in &quot;ticks&quot;, 0 to 268435455</span>
<span class="sd">     velocity = a value 0 (soft) to 127 (loud)</span>
<span class="sd">     note = a value 0 to 127  (middle-C is 60)</span>
<span class="sd">     patch = 0 to 127 (see http://www.pjb.com.au/muscript/gm.html )</span>
<span class="sd">     pitch_wheel = a value -8192 to 8191 (0x1FFF)</span>
<span class="sd">     raw = bytes, of length 0 or more  (for sysex events see below)</span>
<span class="sd">     sequence_number = a value 0 to 65,535 (0xFFFF)</span>
<span class="sd">     song_pos = a value 0 to 16,383 (0x3FFF)</span>
<span class="sd">     song_number = a value 0 to 127</span>
<span class="sd">     tempo = microseconds per crochet (quarter-note), 0 to 16777215</span>
<span class="sd">     text = bytes, of length 0 or more</span>
<span class="sd">     ticks = the number of ticks per crochet (quarter-note)</span>

<span class="sd">   In sysex_f0 events, the raw data must not start with a \xF0 byte,</span>
<span class="sd">   since this gets added automatically;</span>
<span class="sd">   but it must end with an explicit \xF7 byte!</span>
<span class="sd">   In the very unlikely case that you ever need to split sysex data</span>
<span class="sd">   into one sysex_f0 followed by one or more sysex_f7s, then only the</span>
<span class="sd">   last of those sysex_f7 events must end with the explicit \xF7 byte</span>
<span class="sd">   (again, the raw data of individual sysex_f7 events must not start</span>
<span class="sd">   with any \xF7 byte, since this gets added automatically).</span>

<span class="sd">   Since version 6.4, text data is in bytes, not in a ISO-8859-1 string.</span>


<span class="sd">  GOING THROUGH A SCORE WITHIN A PYTHON PROGRAM</span>
<span class="sd">    channels = {2,3,5,8,13}</span>
<span class="sd">    itrack = 1   # skip 1st element which is ticks</span>
<span class="sd">    while itrack &lt; len(score):</span>
<span class="sd">        for event in score[itrack]:</span>
<span class="sd">            if event[0] == &#39;note&#39;:   # for example,</span>
<span class="sd">                pass  # do something to all notes</span>
<span class="sd">            # or, to work on events in only particular channels...</span>
<span class="sd">            channel_index = MIDI.Event2channelindex.get(event[0], False)</span>
<span class="sd">            if channel_index and (event[channel_index] in channels):</span>
<span class="sd">                pass  # do something to channels 2,3,5,8 and 13</span>
<span class="sd">        itrack += 1</span>

<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">struct</span><span class="o">,</span> <span class="nn">copy</span>
<span class="c1"># sys.stdout = os.fdopen(sys.stdout.fileno(), &#39;wb&#39;)</span>
<span class="n">Version</span> <span class="o">=</span> <span class="s1">&#39;6.7&#39;</span>
<span class="n">VersionDate</span> <span class="o">=</span> <span class="s1">&#39;20201120&#39;</span>
<span class="c1"># 20201120 6.7 call to bytest() removed, and protect _unshift_ber_int</span>
<span class="c1"># 20160702 6.6 to_millisecs() now handles set_tempo across multiple Tracks</span>
<span class="c1"># 20150921 6.5 segment restores controllers as well as patch and tempo</span>
<span class="c1"># 20150914 6.4 text data is bytes or bytearray, not ISO-8859-1 strings</span>
<span class="c1"># 20150628 6.3 absent any set_tempo, default is 120bpm (see MIDI file spec 1.1)</span>
<span class="c1"># 20150101 6.2 all text events can be 8-bit; let user get the right encoding</span>
<span class="c1"># 20141231 6.1 fix _some_text_event; sequencer_specific data can be 8-bit</span>
<span class="c1"># 20141230 6.0 synth_specific data can be 8-bit</span>
<span class="c1"># 20120504 5.9 add the contents of mid_opus_tracks()</span>
<span class="c1"># 20120208 5.8 fix num_notes_by_channel() ; should be a dict</span>
<span class="c1"># 20120129 5.7 _encode handles empty tracks; score2stats num_notes_by_channel</span>
<span class="c1"># 20111111 5.6 fix patch 45 and 46 in Number2patch, should be Harp</span>
<span class="c1"># 20110129 5.5 add mix_opus_tracks() and event2alsaseq()</span>
<span class="c1"># 20110126 5.4 &quot;previous message repeated N times&quot; to save space on stderr</span>
<span class="c1"># 20110125 5.2 opus2score terminates unended notes at the end of the track</span>
<span class="c1"># 20110124 5.1 the warnings in midi2opus display track_num</span>
<span class="c1"># 21110122 5.0 if garbage, midi2opus returns the opus so far</span>
<span class="c1"># 21110119 4.9 non-ascii chars stripped out of the text_events</span>
<span class="c1"># 21110110 4.8 note_on with velocity=0 treated as a note-off</span>
<span class="c1"># 21110108 4.6 unknown F-series event correctly eats just one byte</span>
<span class="c1"># 21011010 4.2 segment() uses start_time, end_time named params</span>
<span class="c1"># 21011005 4.1 timeshift() must not pad the set_tempo command</span>
<span class="c1"># 21011003 4.0 pitch2note_event must be chapitch2note_event</span>
<span class="c1"># 21010918 3.9 set_sequence_number supported, FWIW</span>
<span class="c1"># 20100913 3.7 many small bugfixes; passes all tests</span>
<span class="c1"># 20100910 3.6 concatenate_scores enforce ticks=1000, just like merge_scores</span>
<span class="c1"># 20100908 3.5 minor bugs fixed in score2stats</span>
<span class="c1"># 20091104 3.4 tune_request now supported</span>
<span class="c1"># 20091104 3.3 fixed bug in decoding song_position and song_select</span>
<span class="c1"># 20091104 3.2 unsupported: set_sequence_number tune_request raw_data</span>
<span class="c1"># 20091101 3.1 document how to traverse a score within Python</span>
<span class="c1"># 20091021 3.0 fixed bug in score2stats detecting GM-mode = 0</span>
<span class="c1"># 20091020 2.9 score2stats reports GM-mode and bank msb,lsb events</span>
<span class="c1"># 20091019 2.8 in merge_scores, channel 9 must remain channel 9 (in GM)</span>
<span class="c1"># 20091018 2.7 handles empty tracks gracefully</span>
<span class="c1"># 20091015 2.6 grep() selects channels</span>
<span class="c1"># 20091010 2.5 merge_scores reassigns channels to avoid conflicts</span>
<span class="c1"># 20091010 2.4 fixed bug in to_millisecs which now only does opusses</span>
<span class="c1"># 20091010 2.3 score2stats returns channels &amp; patch_changes, by_track &amp; total</span>
<span class="c1"># 20091010 2.2 score2stats() returns also pitches and percussion dicts</span>
<span class="c1"># 20091010 2.1 bugs: &gt;= not &gt; in segment, to notice patch_change at time 0</span>
<span class="c1"># 20091010 2.0 bugs: spurious pop(0) ( in _decode sysex</span>
<span class="c1"># 20091008 1.9 bugs: ISO decoding in sysex; str( not int( in note-off warning</span>
<span class="c1"># 20091008 1.8 add concatenate_scores()</span>
<span class="c1"># 20091006 1.7 score2stats() measures nticks and ticks_per_quarter</span>
<span class="c1"># 20091004 1.6 first mix_scores() and merge_scores()</span>
<span class="c1"># 20090424 1.5 timeshift() bugfix: earliest only sees events after from_time</span>
<span class="c1"># 20090330 1.4 timeshift() has also a from_time argument</span>
<span class="c1"># 20090322 1.3 timeshift() has also a start_time argument</span>
<span class="c1"># 20090319 1.2 add segment() and timeshift()</span>
<span class="c1"># 20090301 1.1 add to_millisecs()</span>

<span class="n">_previous_warning</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># 5.4</span>
<span class="n">_previous_times</span> <span class="o">=</span> <span class="mi">0</span>     <span class="c1"># 5.4</span>
<span class="c1">#------------------------------- Encoding stuff --------------------------</span>

<span class="k">def</span> <span class="nf">opus2midi</span><span class="p">(</span><span class="n">opus</span><span class="o">=</span><span class="p">[],</span> <span class="n">text_encoding</span><span class="o">=</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;The argument is a list: the first item in the list is the &quot;ticks&quot;</span>
<span class="sd">parameter, the others are the tracks. Each track is a list</span>
<span class="sd">of midi-events, and each event is itself a list; see above.</span>
<span class="sd">opus2midi() returns a bytestring of the MIDI, which can then be</span>
<span class="sd">written either to a file opened in binary mode (mode=&#39;wb&#39;),</span>
<span class="sd">or to stdout by means of:   sys.stdout.buffer.write()</span>

<span class="sd">my_opus = [</span>
<span class="sd">    96, </span>
<span class="sd">    [   # track 0:</span>
<span class="sd">        [&#39;patch_change&#39;, 0, 1, 8],   # and these are the events...</span>
<span class="sd">        [&#39;note_on&#39;,   5, 1, 25, 96],</span>
<span class="sd">        [&#39;note_off&#39;, 96, 1, 25, 0],</span>
<span class="sd">        [&#39;note_on&#39;,   0, 1, 29, 96],</span>
<span class="sd">        [&#39;note_off&#39;, 96, 1, 29, 0],</span>
<span class="sd">    ],   # end of track 0</span>
<span class="sd">]</span>
<span class="sd">my_midi = opus2midi(my_opus)</span>
<span class="sd">sys.stdout.buffer.write(my_midi)</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">opus</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">opus</span><span class="o">=</span><span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="p">[],]</span>
    <span class="n">tracks</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">opus</span><span class="p">)</span>
    <span class="n">ticks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tracks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">ntracks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tracks</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ntracks</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">format</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">format</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">my_midi</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;MThd</span><span class="se">\x00\x00\x00\x06</span><span class="s2">&quot;</span><span class="o">+</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;HHH&#39;</span><span class="p">,</span><span class="nb">format</span><span class="p">,</span><span class="n">ntracks</span><span class="p">,</span><span class="n">ticks</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">tracks</span><span class="p">:</span>
        <span class="n">events</span> <span class="o">=</span> <span class="n">_encode</span><span class="p">(</span><span class="n">track</span><span class="p">,</span> <span class="n">text_encoding</span><span class="o">=</span><span class="n">text_encoding</span><span class="p">)</span>
        <span class="n">my_midi</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;MTrk&#39;</span> <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;I&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">))</span> <span class="o">+</span> <span class="n">events</span>
    <span class="n">_clean_up_warnings</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">my_midi</span>


<span class="k">def</span> <span class="nf">score2opus</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">text_encoding</span><span class="o">=</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">The argument is a list: the first item in the list is the &quot;ticks&quot;</span>
<span class="sd">parameter, the others are the tracks. Each track is a list</span>
<span class="sd">of score-events, and each event is itself a list.  A score-event</span>
<span class="sd">is similar to an opus-event (see above), except that in a score:</span>
<span class="sd"> 1) the times are expressed as an absolute number of ticks</span>
<span class="sd">    from the track&#39;s start time</span>
<span class="sd"> 2) the pairs of &#39;note_on&#39; and &#39;note_off&#39; events in an &quot;opus&quot;</span>
<span class="sd">    are abstracted into a single &#39;note&#39; event in a &quot;score&quot;:</span>
<span class="sd">    [&#39;note&#39;, start_time, duration, channel, pitch, velocity]</span>
<span class="sd">score2opus() returns a list specifying the equivalent &quot;opus&quot;.</span>

<span class="sd">my_score = [</span>
<span class="sd">    96,</span>
<span class="sd">    [   # track 0:</span>
<span class="sd">        [&#39;patch_change&#39;, 0, 1, 8],</span>
<span class="sd">        [&#39;note&#39;, 5, 96, 1, 25, 96],</span>
<span class="sd">        [&#39;note&#39;, 101, 96, 1, 29, 96]</span>
<span class="sd">    ],   # end of track 0</span>
<span class="sd">]</span>
<span class="sd">my_opus = score2opus(my_score)</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">score</span><span class="o">=</span><span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="p">[],]</span>
    <span class="n">tracks</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
    <span class="n">ticks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tracks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">opus_tracks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">scoretrack</span> <span class="ow">in</span> <span class="n">tracks</span><span class="p">:</span>
        <span class="n">time2events</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">scoreevent</span> <span class="ow">in</span> <span class="n">scoretrack</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scoreevent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note&#39;</span><span class="p">:</span>
                <span class="n">note_on_event</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;note_on&#39;</span><span class="p">,</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                 <span class="n">scoreevent</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span>
                <span class="n">note_off_event</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;note_off&#39;</span><span class="p">,</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                 <span class="n">scoreevent</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span>
                <span class="k">if</span> <span class="n">time2events</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">note_on_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                   <span class="n">time2events</span><span class="p">[</span><span class="n">note_on_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">note_on_event</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                   <span class="n">time2events</span><span class="p">[</span><span class="n">note_on_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">note_on_event</span><span class="p">,]</span>
                <span class="k">if</span> <span class="n">time2events</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">note_off_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                   <span class="n">time2events</span><span class="p">[</span><span class="n">note_off_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">note_off_event</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                   <span class="n">time2events</span><span class="p">[</span><span class="n">note_off_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">note_off_event</span><span class="p">,]</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">time2events</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
               <span class="n">time2events</span><span class="p">[</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scoreevent</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="n">time2events</span><span class="p">[</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">scoreevent</span><span class="p">,]</span>

        <span class="n">sorted_times</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of keys</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">time2events</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">sorted_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">sorted_times</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="n">sorted_events</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># once-flattened list of values sorted by key</span>
        <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">sorted_times</span><span class="p">:</span>
            <span class="n">sorted_events</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">time2events</span><span class="p">[</span><span class="n">time</span><span class="p">])</span>

        <span class="n">abs_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">sorted_events</span><span class="p">:</span>  <span class="c1"># convert abs times =&gt; delta times</span>
            <span class="n">delta_time</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">abs_time</span>
            <span class="n">abs_time</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">delta_time</span>
        <span class="n">opus_tracks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sorted_events</span><span class="p">)</span>
    <span class="n">opus_tracks</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ticks</span><span class="p">)</span>
    <span class="n">_clean_up_warnings</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">opus_tracks</span>

<span class="k">def</span> <span class="nf">score2midi</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">text_encoding</span><span class="o">=</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Translates a &quot;score&quot; into MIDI, using score2opus() then opus2midi()</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">opus2midi</span><span class="p">(</span><span class="n">score2opus</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">text_encoding</span><span class="p">),</span> <span class="n">text_encoding</span><span class="p">)</span>

<span class="c1">#--------------------------- Decoding stuff ------------------------</span>

<span class="k">def</span> <span class="nf">midi2opus</span><span class="p">(</span><span class="n">midi</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Translates MIDI into a &quot;opus&quot;.  For a description of the</span>
<span class="sd">&quot;opus&quot; format, see opus2midi()</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="n">my_midi</span><span class="o">=</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">midi</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">my_midi</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">_clean_up_warnings</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,[],]</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">my_midi</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">id</span> <span class="o">!=</span> <span class="sa">b</span><span class="s1">&#39;MThd&#39;</span><span class="p">:</span>
        <span class="n">_warn</span><span class="p">(</span><span class="s2">&quot;midi2opus: midi starts with &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; instead of &#39;MThd&#39;&quot;</span><span class="p">)</span>
        <span class="n">_clean_up_warnings</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,[],]</span>
    <span class="p">[</span><span class="n">length</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span> <span class="n">tracks_expected</span><span class="p">,</span> <span class="n">ticks</span><span class="p">]</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span>
     <span class="s1">&#39;&gt;IHHH&#39;</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">my_midi</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">14</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">length</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">:</span>
        <span class="n">_warn</span><span class="p">(</span><span class="s2">&quot;midi2opus: midi header length was &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">length</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; instead of 6&quot;</span><span class="p">)</span>
        <span class="n">_clean_up_warnings</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,[],]</span>
    <span class="n">my_opus</span> <span class="o">=</span> <span class="p">[</span><span class="n">ticks</span><span class="p">,]</span>
    <span class="n">my_midi</span> <span class="o">=</span> <span class="n">my_midi</span><span class="p">[</span><span class="mi">14</span><span class="p">:]</span>
    <span class="n">track_num</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># 5.1</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">my_midi</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">track_type</span>   <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">my_midi</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">track_type</span> <span class="o">!=</span> <span class="sa">b</span><span class="s1">&#39;MTrk&#39;</span><span class="p">:</span>
            <span class="c1">#_warn(&#39;midi2opus: Warning: track #&#39;+str(track_num)+&#39; type is &#39;+str(track_type)+&quot; instead of b&#39;MTrk&#39;&quot;)</span>
            <span class="k">pass</span>
        <span class="p">[</span><span class="n">track_length</span><span class="p">]</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&gt;I&#39;</span><span class="p">,</span> <span class="n">my_midi</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span>
        <span class="n">my_midi</span> <span class="o">=</span> <span class="n">my_midi</span><span class="p">[</span><span class="mi">8</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">track_length</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">my_midi</span><span class="p">):</span>
            <span class="n">_warn</span><span class="p">(</span><span class="s1">&#39;midi2opus: track #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">track_num</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; length &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">track_length</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; is too large&#39;</span><span class="p">)</span>
            <span class="n">_clean_up_warnings</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">my_opus</span>   <span class="c1"># 5.0</span>
        <span class="n">my_midi_track</span> <span class="o">=</span> <span class="n">my_midi</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">track_length</span><span class="p">]</span>
        <span class="n">my_track</span> <span class="o">=</span> <span class="n">_decode</span><span class="p">(</span><span class="n">my_midi_track</span><span class="p">)</span>
        <span class="n">my_opus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">my_track</span><span class="p">)</span>
        <span class="n">my_midi</span> <span class="o">=</span> <span class="n">my_midi</span><span class="p">[</span><span class="n">track_length</span><span class="p">:]</span>
        <span class="n">track_num</span> <span class="o">+=</span> <span class="mi">1</span>   <span class="c1"># 5.1</span>
    <span class="n">_clean_up_warnings</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">my_opus</span>

<span class="k">def</span> <span class="nf">opus2score</span><span class="p">(</span><span class="n">opus</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;For a description of the &quot;opus&quot; and &quot;score&quot; formats,</span>
<span class="sd">see opus2midi() and score2opus().</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">opus</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">_clean_up_warnings</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,[],]</span>
    <span class="n">tracks</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">opus</span><span class="p">)</span>  <span class="c1"># couple of slices probably quicker...</span>
    <span class="n">ticks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tracks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">score</span> <span class="o">=</span> <span class="p">[</span><span class="n">ticks</span><span class="p">,]</span>
    <span class="k">for</span> <span class="n">opus_track</span> <span class="ow">in</span> <span class="n">tracks</span><span class="p">:</span>
        <span class="n">ticks_so_far</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">score_track</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">chapitch2note_on_events</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([])</span>   <span class="c1"># 4.0</span>
        <span class="k">for</span> <span class="n">opus_event</span> <span class="ow">in</span> <span class="n">opus_track</span><span class="p">:</span>
            <span class="n">ticks_so_far</span> <span class="o">+=</span> <span class="n">opus_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">opus_event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note_off&#39;</span> <span class="ow">or</span> <span class="p">(</span><span class="n">opus_event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note_on&#39;</span> <span class="ow">and</span> <span class="n">opus_event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>  <span class="c1"># 4.8</span>
                <span class="n">cha</span> <span class="o">=</span> <span class="n">opus_event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">pitch</span> <span class="o">=</span> <span class="n">opus_event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">cha</span><span class="o">*</span><span class="mi">128</span> <span class="o">+</span> <span class="n">pitch</span>
                <span class="k">if</span> <span class="n">chapitch2note_on_events</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                    <span class="n">new_event</span> <span class="o">=</span> <span class="n">chapitch2note_on_events</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">new_event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ticks_so_far</span> <span class="o">-</span> <span class="n">new_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">score_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_event</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">pitch</span> <span class="o">&gt;</span> <span class="mi">127</span><span class="p">:</span>
                    <span class="k">pass</span> <span class="c1">#_warn(&#39;opus2score: note_off with no note_on, bad pitch=&#39;+str(pitch))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span> <span class="c1">#_warn(&#39;opus2score: note_off with no note_on cha=&#39;+str(cha)+&#39; pitch=&#39;+str(pitch))</span>
            <span class="k">elif</span> <span class="n">opus_event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note_on&#39;</span><span class="p">:</span>
                <span class="n">cha</span> <span class="o">=</span> <span class="n">opus_event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">pitch</span> <span class="o">=</span> <span class="n">opus_event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">cha</span><span class="o">*</span><span class="mi">128</span> <span class="o">+</span> <span class="n">pitch</span>
                <span class="n">new_event</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;note&#39;</span><span class="p">,</span><span class="n">ticks_so_far</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cha</span><span class="p">,</span><span class="n">pitch</span><span class="p">,</span> <span class="n">opus_event</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span>
                <span class="k">if</span> <span class="n">chapitch2note_on_events</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                    <span class="n">chapitch2note_on_events</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_event</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">chapitch2note_on_events</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_event</span><span class="p">,]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">opus_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ticks_so_far</span>
                <span class="n">score_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opus_event</span><span class="p">)</span>
        <span class="c1"># check for unterminated notes (Oisín) -- 5.2</span>
        <span class="k">for</span> <span class="n">chapitch</span> <span class="ow">in</span> <span class="n">chapitch2note_on_events</span><span class="p">:</span>
            <span class="n">note_on_events</span> <span class="o">=</span> <span class="n">chapitch2note_on_events</span><span class="p">[</span><span class="n">chapitch</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">new_e</span> <span class="ow">in</span> <span class="n">note_on_events</span><span class="p">:</span>
                <span class="n">new_e</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ticks_so_far</span> <span class="o">-</span> <span class="n">new_e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">score_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_e</span><span class="p">)</span>
                <span class="k">pass</span> <span class="c1">#_warn(&quot;opus2score: note_on with no note_off cha=&quot;+str(new_e[3])+&#39; pitch=&#39;+str(new_e[4])+&#39;; adding note_off at end&#39;)</span>
        <span class="n">score</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score_track</span><span class="p">)</span>
    <span class="n">_clean_up_warnings</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">score</span>

<span class="k">def</span> <span class="nf">midi2score</span><span class="p">(</span><span class="n">midi</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Translates MIDI into a &quot;score&quot;, using midi2opus() then opus2score()</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">opus2score</span><span class="p">(</span><span class="n">midi2opus</span><span class="p">(</span><span class="n">midi</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">midi2ms_score</span><span class="p">(</span><span class="n">midi</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Translates MIDI into a &quot;score&quot; with one beat per second and one</span>
<span class="sd">tick per millisecond, using midi2opus() then to_millisecs()</span>
<span class="sd">then opus2score()</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">opus2score</span><span class="p">(</span><span class="n">to_millisecs</span><span class="p">(</span><span class="n">midi2opus</span><span class="p">(</span><span class="n">midi</span><span class="p">)))</span>

<span class="c1">#------------------------ Other Transformations ---------------------</span>

<span class="k">def</span> <span class="nf">to_millisecs</span><span class="p">(</span><span class="n">old_opus</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">desired_time_in_ms</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Recallibrates all the times in an &quot;opus&quot; to use one beat</span>
<span class="sd">per second and one tick per millisecond.  This makes it</span>
<span class="sd">hard to retrieve any information about beats or barlines,</span>
<span class="sd">but it does make it easy to mix different scores together.</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">old_opus</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">1000</span> <span class="o">*</span> <span class="n">desired_time_in_ms</span><span class="p">,[],]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">old_tpq</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">old_opus</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>   <span class="c1"># 5.0</span>
        <span class="n">_warn</span><span class="p">(</span><span class="s1">&#39;to_millisecs: the opus &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">old_opus</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; has no elements&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">1000</span> <span class="o">*</span> <span class="n">desired_time_in_ms</span><span class="p">,[],]</span>
    <span class="n">new_opus</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1000</span> <span class="o">*</span> <span class="n">desired_time_in_ms</span><span class="p">,]</span>
    <span class="c1"># 6.7 first go through building a table of set_tempos by absolute-tick</span>
    <span class="n">ticks2tempo</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">itrack</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">itrack</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_opus</span><span class="p">):</span>
        <span class="n">ticks_so_far</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">old_event</span> <span class="ow">in</span> <span class="n">old_opus</span><span class="p">[</span><span class="n">itrack</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">old_event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;to_millisecs needs an opus, not a score&#39;</span><span class="p">)</span>
            <span class="n">ticks_so_far</span> <span class="o">+=</span> <span class="n">old_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">old_event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;set_tempo&#39;</span><span class="p">:</span>
                <span class="n">ticks2tempo</span><span class="p">[</span><span class="n">ticks_so_far</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">itrack</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1"># then get the sorted-array of their keys</span>
    <span class="n">tempo_ticks</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of keys</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ticks2tempo</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">tempo_ticks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="n">tempo_ticks</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="c1"># then go through converting to millisec, testing if the next</span>
    <span class="c1"># set_tempo lies before the next track-event, and using it if so.</span>
    <span class="n">itrack</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">itrack</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_opus</span><span class="p">):</span>
        <span class="n">ms_per_old_tick</span> <span class="o">=</span> <span class="mi">400</span> <span class="o">/</span> <span class="n">old_tpq</span>  <span class="c1"># float: will round later 6.3</span>
        <span class="n">i_tempo_ticks</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ticks_so_far</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ms_so_far</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">previous_ms_so_far</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">new_track</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;set_tempo&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1000000</span> <span class="o">*</span> <span class="n">desired_time_in_ms</span><span class="p">],]</span>  <span class="c1"># new &quot;crochet&quot; is 1 sec</span>
        <span class="k">for</span> <span class="n">old_event</span> <span class="ow">in</span> <span class="n">old_opus</span><span class="p">[</span><span class="n">itrack</span><span class="p">]:</span>
            <span class="c1"># detect if ticks2tempo has something before this event</span>
            <span class="c1"># 20160702 if ticks2tempo is at the same time, leave it</span>
            <span class="n">event_delta_ticks</span> <span class="o">=</span> <span class="n">old_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">desired_time_in_ms</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i_tempo_ticks</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tempo_ticks</span><span class="p">)</span> <span class="ow">and</span>
              <span class="n">tempo_ticks</span><span class="p">[</span><span class="n">i_tempo_ticks</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ticks_so_far</span> <span class="o">+</span> <span class="n">old_event</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">desired_time_in_ms</span><span class="p">):</span>
                <span class="n">delta_ticks</span> <span class="o">=</span> <span class="n">tempo_ticks</span><span class="p">[</span><span class="n">i_tempo_ticks</span><span class="p">]</span> <span class="o">-</span> <span class="n">ticks_so_far</span>
                <span class="n">ms_so_far</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ms_per_old_tick</span> <span class="o">*</span> <span class="n">delta_ticks</span> <span class="o">*</span> <span class="n">desired_time_in_ms</span><span class="p">)</span>
                <span class="n">ticks_so_far</span> <span class="o">=</span> <span class="n">tempo_ticks</span><span class="p">[</span><span class="n">i_tempo_ticks</span><span class="p">]</span>
                <span class="n">ms_per_old_tick</span> <span class="o">=</span> <span class="n">ticks2tempo</span><span class="p">[</span><span class="n">ticks_so_far</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1000.0</span><span class="o">*</span><span class="n">old_tpq</span> <span class="o">*</span> <span class="n">desired_time_in_ms</span><span class="p">)</span>
                <span class="n">i_tempo_ticks</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">event_delta_ticks</span> <span class="o">-=</span> <span class="n">delta_ticks</span>
            <span class="n">new_event</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">old_event</span><span class="p">)</span>  <span class="c1"># now handle the new event</span>
            <span class="n">ms_so_far</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ms_per_old_tick</span> <span class="o">*</span> <span class="n">old_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">desired_time_in_ms</span><span class="p">)</span>
            <span class="n">new_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">ms_so_far</span> <span class="o">-</span> <span class="n">previous_ms_so_far</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">old_event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;set_tempo&#39;</span><span class="p">:</span>
                <span class="n">previous_ms_so_far</span> <span class="o">=</span> <span class="n">ms_so_far</span>
                <span class="n">new_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_event</span><span class="p">)</span>
            <span class="n">ticks_so_far</span> <span class="o">+=</span> <span class="n">event_delta_ticks</span>
        <span class="n">new_opus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_track</span><span class="p">)</span>
        <span class="n">itrack</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">_clean_up_warnings</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">new_opus</span>

<span class="k">def</span> <span class="nf">event2alsaseq</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>   <span class="c1"># 5.5</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Converts an event into the format needed by the alsaseq module,</span>
<span class="sd">http://pp.com.mx/python/alsaseq</span>
<span class="sd">The type of track (opus or score) is autodetected.</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">grep</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Returns a &quot;score&quot; containing only the channels specified</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">score</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,[],]</span>
    <span class="n">ticks</span> <span class="o">=</span> <span class="n">score</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">new_score</span> <span class="o">=</span> <span class="p">[</span><span class="n">ticks</span><span class="p">,]</span>
    <span class="k">if</span> <span class="n">channels</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">new_score</span>
    <span class="n">channels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
    <span class="k">global</span> <span class="n">Event2channelindex</span>
    <span class="n">itrack</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">itrack</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">):</span>
        <span class="n">new_score</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">score</span><span class="p">[</span><span class="n">itrack</span><span class="p">]:</span>
            <span class="n">channel_index</span> <span class="o">=</span> <span class="n">Event2channelindex</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">channel_index</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="n">channel_index</span><span class="p">]</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
                    <span class="n">new_score</span><span class="p">[</span><span class="n">itrack</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_score</span><span class="p">[</span><span class="n">itrack</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="n">itrack</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">new_score</span>

<span class="k">def</span> <span class="nf">play_score</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Converts the &quot;score&quot; to midi, and feeds it into &#39;aplaymidi -&#39;</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">score</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="kn">import</span> <span class="nn">subprocess</span>
    <span class="n">pipe</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s1">&#39;aplaymidi&#39;</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">],</span> <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">score_type</span><span class="p">(</span><span class="n">score</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;opus&#39;</span><span class="p">:</span>
        <span class="n">pipe</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">opus2midi</span><span class="p">(</span><span class="n">score</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pipe</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">score2midi</span><span class="p">(</span><span class="n">score</span><span class="p">))</span>
    <span class="n">pipe</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">timeshift</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">from_time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tracks</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">}):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Returns a &quot;score&quot; shifted in time by &quot;shift&quot; ticks, or shifted</span>
<span class="sd">so that the first event starts at &quot;start_time&quot; ticks.</span>

<span class="sd">If &quot;from_time&quot; is specified, only those events in the score</span>
<span class="sd">that begin after it are shifted. If &quot;start_time&quot; is less than</span>
<span class="sd">&quot;from_time&quot; (or &quot;shift&quot; is negative), then the intermediate</span>
<span class="sd">notes are deleted, though patch-change events are preserved.</span>

<span class="sd">If &quot;tracks&quot; are specified, then only those tracks get shifted.</span>
<span class="sd">&quot;tracks&quot; can be a list, tuple or set; it gets converted to set</span>
<span class="sd">internally.</span>

<span class="sd">It is deprecated to specify both &quot;shift&quot; and &quot;start_time&quot;.</span>
<span class="sd">If this does happen, timeshift() will print a warning to</span>
<span class="sd">stderr and ignore the &quot;shift&quot; argument.</span>

<span class="sd">If &quot;shift&quot; is negative and sufficiently large that it would</span>
<span class="sd">leave some event with a negative tick-value, then the score</span>
<span class="sd">is shifted so that the first event occurs at time 0. This</span>
<span class="sd">also occurs if &quot;start_time&quot; is negative, and is also the</span>
<span class="sd">default if neither &quot;shift&quot; nor &quot;start_time&quot; are specified.</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="c1">#_warn(&#39;tracks=&#39;+str(tracks))</span>
    <span class="k">if</span> <span class="n">score</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="p">[],]</span>
    <span class="n">new_score</span> <span class="o">=</span> <span class="p">[</span><span class="n">score</span><span class="p">[</span><span class="mi">0</span><span class="p">],]</span>
    <span class="n">my_type</span> <span class="o">=</span> <span class="n">score_type</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">my_type</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">new_score</span>
    <span class="k">if</span> <span class="n">my_type</span> <span class="o">==</span> <span class="s1">&#39;opus&#39;</span><span class="p">:</span>
        <span class="n">_warn</span><span class="p">(</span><span class="s2">&quot;timeshift: opus format is not supported</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># _clean_up_scores()  6.2; doesn&#39;t exist! what was it supposed to do?</span>
        <span class="k">return</span> <span class="n">new_score</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">shift</span> <span class="o">==</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">start_time</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">_warn</span><span class="p">(</span><span class="s2">&quot;timeshift: shift and start_time specified: ignoring shift</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">shift</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">start_time</span> <span class="o">==</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">start_time</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># shift = start_time - from_time</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># ignore first element (ticks)</span>
    <span class="n">tracks</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">tracks</span><span class="p">)</span>  <span class="c1"># defend against tuples and lists</span>
    <span class="n">earliest</span> <span class="o">=</span> <span class="mi">1000000000</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">start_time</span> <span class="o">==</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">shift</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># first find the earliest event</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tracks</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tracks</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                 <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">from_time</span><span class="p">:</span>
                     <span class="k">continue</span>  <span class="c1"># just inspect the to_be_shifted events</span>
                 <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">earliest</span><span class="p">:</span>
                     <span class="n">earliest</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">earliest</span> <span class="o">&gt;</span> <span class="mi">999999999</span><span class="p">:</span>
        <span class="n">earliest</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">shift</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="n">start_time</span> <span class="o">-</span> <span class="n">earliest</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">earliest</span> <span class="o">+</span> <span class="n">shift</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">-</span> <span class="n">earliest</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># ignore first element (ticks)</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tracks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tracks</span><span class="p">):</span>  <span class="c1"># 3.8</span>
            <span class="n">new_score</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="n">new_track</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">new_event</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="c1">#if new_event[1] == 0 and shift &gt; 0 and new_event[0] != &#39;note&#39;:</span>
            <span class="c1">#    pass</span>
            <span class="c1">#elif new_event[1] &gt;= from_time:</span>
            <span class="k">if</span> <span class="n">new_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">from_time</span><span class="p">:</span>
                <span class="c1"># 4.1 must not rightshift set_tempo</span>
                <span class="k">if</span> <span class="n">new_event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;set_tempo&#39;</span> <span class="ow">or</span> <span class="n">shift</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">new_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">shift</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">shift</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">new_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">from_time</span><span class="o">+</span><span class="n">shift</span><span class="p">)):</span>
                <span class="k">continue</span>
            <span class="n">new_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_event</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_track</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">new_score</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_track</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">_clean_up_warnings</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">new_score</span>

<span class="k">def</span> <span class="nf">segment</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="mi">100000000</span><span class="p">,</span>
 <span class="n">tracks</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">}):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Returns a &quot;score&quot; which is a segment of the one supplied</span>
<span class="sd">as the argument, beginning at &quot;start_time&quot; ticks and ending</span>
<span class="sd">at &quot;end_time&quot; ticks (or at the end if &quot;end_time&quot; is not supplied).</span>
<span class="sd">If the set &quot;tracks&quot; is specified, only those tracks will</span>
<span class="sd">be returned.</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">score</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="p">[],]</span>
    <span class="k">if</span> <span class="n">start_time</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># as of 4.2 start_time is recommended</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">start</span>  <span class="c1"># start is legacy usage</span>
    <span class="k">if</span> <span class="n">end_time</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>    <span class="c1"># likewise</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">end</span>
    <span class="n">new_score</span> <span class="o">=</span> <span class="p">[</span><span class="n">score</span><span class="p">[</span><span class="mi">0</span><span class="p">],]</span>
    <span class="n">my_type</span> <span class="o">=</span> <span class="n">score_type</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">my_type</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">new_score</span>
    <span class="k">if</span> <span class="n">my_type</span> <span class="o">==</span> <span class="s1">&#39;opus&#39;</span><span class="p">:</span>
        <span class="c1"># more difficult (disconnecting note_on&#39;s from their note_off&#39;s)...</span>
        <span class="n">_warn</span><span class="p">(</span><span class="s2">&quot;segment: opus format is not supported</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">_clean_up_warnings</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">new_score</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># ignore first element (ticks); we count in ticks anyway</span>
    <span class="n">tracks</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">tracks</span><span class="p">)</span>  <span class="c1"># defend against tuples and lists</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tracks</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tracks</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="n">new_track</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">channel2cc_num</span>  <span class="o">=</span> <span class="p">{}</span>     <span class="c1"># most recent controller change before start</span>
        <span class="n">channel2cc_val</span>  <span class="o">=</span> <span class="p">{}</span>
        <span class="n">channel2cc_time</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">channel2patch_num</span>  <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># keep most recent patch change before start</span>
        <span class="n">channel2patch_time</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">set_tempo_num</span>  <span class="o">=</span> <span class="mi">500000</span> <span class="c1"># most recent tempo change before start 6.3</span>
        <span class="n">set_tempo_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">earliest_note_time</span> <span class="o">=</span> <span class="n">end_time</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control_change&#39;</span><span class="p">:</span>  <span class="c1"># 6.5</span>
                <span class="n">cc_time</span> <span class="o">=</span> <span class="n">channel2cc_time</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">start_time</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">cc_time</span><span class="p">):</span>
                    <span class="n">channel2cc_num</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>  <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">channel2cc_val</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>  <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                    <span class="n">channel2cc_time</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;patch_change&#39;</span><span class="p">:</span>
                <span class="n">patch_time</span> <span class="o">=</span> <span class="n">channel2patch_time</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">start_time</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">patch_time</span><span class="p">):</span>  <span class="c1"># 2.0</span>
                    <span class="n">channel2patch_num</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>  <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">channel2patch_time</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;set_tempo&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">start_time</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">set_tempo_time</span><span class="p">):</span> <span class="c1">#6.4</span>
                    <span class="n">set_tempo_num</span>  <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">set_tempo_time</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">start_time</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">end_time</span><span class="p">):</span>
                <span class="n">new_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">earliest_note_time</span><span class="p">):</span>
                    <span class="n">earliest_note_time</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_track</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">new_track</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;set_tempo&#39;</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">set_tempo_num</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">channel2patch_num</span><span class="p">:</span>
                <span class="n">new_track</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span><span class="n">start_time</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">channel2patch_num</span><span class="p">[</span><span class="n">c</span><span class="p">]],)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">channel2cc_num</span><span class="p">:</span>   <span class="c1"># 6.5</span>
                <span class="n">new_track</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;control_change&#39;</span><span class="p">,</span><span class="n">start_time</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">channel2cc_num</span><span class="p">[</span><span class="n">c</span><span class="p">],</span><span class="n">channel2cc_val</span><span class="p">[</span><span class="n">c</span><span class="p">]])</span>
            <span class="n">new_score</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_track</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">_clean_up_warnings</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">new_score</span>

<span class="k">def</span> <span class="nf">score_type</span><span class="p">(</span><span class="n">opus_or_score</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Returns a string, either &#39;opus&#39; or &#39;score&#39; or &#39;&#39;</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">opus_or_score</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">opus_or_score</span><span class="p">))</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">opus_or_score</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># ignore first element</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">opus_or_score</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">opus_or_score</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;score&#39;</span>
            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note_on&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;opus&#39;</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span>

<span class="k">def</span> <span class="nf">concatenate_scores</span><span class="p">(</span><span class="n">scores</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Concatenates a list of scores into one score.</span>
<span class="sd">If the scores differ in their &quot;ticks&quot; parameter,</span>
<span class="sd">they will all get converted to millisecond-tick format.</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="c1"># the deepcopys are needed if the input_score&#39;s are refs to the same obj</span>
    <span class="c1"># e.g. if invoked by midisox&#39;s repeat()</span>
    <span class="n">input_scores</span> <span class="o">=</span> <span class="n">_consistentise_ticks</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>  <span class="c1"># 3.7</span>
    <span class="n">output_score</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">input_scores</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">input_score</span> <span class="ow">in</span> <span class="n">input_scores</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">output_stats</span> <span class="o">=</span> <span class="n">score2stats</span><span class="p">(</span><span class="n">output_score</span><span class="p">)</span>
        <span class="n">delta_ticks</span> <span class="o">=</span> <span class="n">output_stats</span><span class="p">[</span><span class="s1">&#39;nticks&#39;</span><span class="p">]</span>
        <span class="n">itrack</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">itrack</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_score</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">itrack</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_score</span><span class="p">):</span> <span class="c1"># new output track if doesn&#39;t exist</span>
                <span class="n">output_score</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">input_score</span><span class="p">[</span><span class="n">itrack</span><span class="p">]:</span>
                <span class="n">output_score</span><span class="p">[</span><span class="n">itrack</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
                <span class="n">output_score</span><span class="p">[</span><span class="n">itrack</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">delta_ticks</span>
            <span class="n">itrack</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">output_score</span>

<span class="k">def</span> <span class="nf">merge_scores</span><span class="p">(</span><span class="n">scores</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Merges a list of scores into one score.  A merged score comprises</span>
<span class="sd">all of the tracks from all of the input scores; un-merging is possible</span>
<span class="sd">by selecting just some of the tracks.  If the scores differ in their</span>
<span class="sd">&quot;ticks&quot; parameter, they will all get converted to millisecond-tick</span>
<span class="sd">format.  merge_scores attempts to resolve channel-conflicts,</span>
<span class="sd">but there are of course only 15 available channels...</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="n">input_scores</span> <span class="o">=</span> <span class="n">_consistentise_ticks</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>  <span class="c1"># 3.6</span>
    <span class="n">output_score</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1000</span><span class="p">]</span>
    <span class="n">channels_so_far</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">all_channels</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">}</span>
    <span class="k">global</span> <span class="n">Event2channelindex</span>
    <span class="k">for</span> <span class="n">input_score</span> <span class="ow">in</span> <span class="n">input_scores</span><span class="p">:</span>
        <span class="n">new_channels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">score2stats</span><span class="p">(</span><span class="n">input_score</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;channels_total&#39;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">new_channels</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>  <span class="c1"># 2.8 cha9 must remain cha9 (in GM)</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channels_so_far</span> <span class="o">&amp;</span> <span class="n">new_channels</span><span class="p">:</span>
            <span class="c1"># consistently choose lowest avaiable, to ease testing</span>
            <span class="n">free_channels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">all_channels</span> <span class="o">-</span> <span class="p">(</span><span class="n">channels_so_far</span><span class="o">|</span><span class="n">new_channels</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">free_channels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">free_channels</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="n">free_channel</span> <span class="o">=</span> <span class="n">free_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">free_channel</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">break</span>
            <span class="n">itrack</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="n">itrack</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_score</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">input_event</span> <span class="ow">in</span> <span class="n">input_score</span><span class="p">[</span><span class="n">itrack</span><span class="p">]:</span>
                    <span class="n">channel_index</span><span class="o">=</span><span class="n">Event2channelindex</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">input_event</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">channel_index</span> <span class="ow">and</span> <span class="n">input_event</span><span class="p">[</span><span class="n">channel_index</span><span class="p">]</span><span class="o">==</span><span class="n">channel</span><span class="p">:</span>
                        <span class="n">input_event</span><span class="p">[</span><span class="n">channel_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">free_channel</span>
                <span class="n">itrack</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">channels_so_far</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">free_channel</span><span class="p">)</span>

        <span class="n">channels_so_far</span> <span class="o">|=</span> <span class="n">new_channels</span>
        <span class="n">output_score</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">input_score</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">return</span> <span class="n">output_score</span>

<span class="k">def</span> <span class="nf">_ticks</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">mix_opus_tracks</span><span class="p">(</span><span class="n">input_tracks</span><span class="p">):</span>   <span class="c1"># 5.5</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Mixes an array of tracks into one track.  A mixed track</span>
<span class="sd">cannot be un-mixed.  It is assumed that the tracks share the same</span>
<span class="sd">ticks parameter and the same tempo.</span>
<span class="sd">Mixing score-tracks is trivial (just insert all events into one array).</span>
<span class="sd">Mixing opus-tracks is only slightly harder, but it&#39;s common enough</span>
<span class="sd">that a dedicated function is useful.</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="n">output_score</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="p">[]]</span>
    <span class="k">for</span> <span class="n">input_track</span> <span class="ow">in</span> <span class="n">input_tracks</span><span class="p">:</span>   <span class="c1"># 5.8</span>
        <span class="n">input_score</span> <span class="o">=</span> <span class="n">opus2score</span><span class="p">([</span><span class="mi">1000</span><span class="p">,</span> <span class="n">input_track</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">input_score</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">output_score</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="n">output_score</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">_ticks</span><span class="p">)</span> 
    <span class="n">output_opus</span> <span class="o">=</span> <span class="n">score2opus</span><span class="p">(</span><span class="n">output_score</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_opus</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">mix_scores</span><span class="p">(</span><span class="n">scores</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Mixes a list of scores into one one-track score.</span>
<span class="sd">A mixed score cannot be un-mixed.  Hopefully the scores</span>
<span class="sd">have no undesirable channel-conflicts between them.</span>
<span class="sd">If the scores differ in their &quot;ticks&quot; parameter,</span>
<span class="sd">they will all get converted to millisecond-tick format.</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="n">input_scores</span> <span class="o">=</span> <span class="n">_consistentise_ticks</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>  <span class="c1"># 3.6</span>
    <span class="n">output_score</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="p">[]]</span>
    <span class="k">for</span> <span class="n">input_score</span> <span class="ow">in</span> <span class="n">input_scores</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">input_track</span> <span class="ow">in</span> <span class="n">input_score</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">output_score</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">input_track</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_score</span>

<span class="k">def</span> <span class="nf">score2stats</span><span class="p">(</span><span class="n">opus_or_score</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Returns a dict of some basic stats about the score, like</span>
<span class="sd">bank_select (list of tuples (msb,lsb)),</span>
<span class="sd">channels_by_track (list of lists), channels_total (set),</span>
<span class="sd">general_midi_mode (list),</span>
<span class="sd">ntracks, nticks, patch_changes_by_track (list of dicts),</span>
<span class="sd">num_notes_by_channel (list of numbers),</span>
<span class="sd">patch_changes_total (set),</span>
<span class="sd">percussion (dict histogram of channel 9 events),</span>
<span class="sd">pitches (dict histogram of pitches on channels other than 9),</span>
<span class="sd">pitch_range_by_track (list, by track, of two-member-tuples),</span>
<span class="sd">pitch_range_sum (sum over tracks of the pitch_ranges),</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="n">bank_select_msb</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">bank_select_lsb</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">bank_select</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">channels_by_track</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">channels_total</span>    <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
    <span class="n">general_midi_mode</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">num_notes_by_channel</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([])</span>
    <span class="n">patches_used_by_track</span>  <span class="o">=</span> <span class="p">[]</span>
    <span class="n">patches_used_total</span>     <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
    <span class="n">patch_changes_by_track</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">patch_changes_total</span>    <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
    <span class="n">percussion</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([])</span> <span class="c1"># histogram of channel 9 &quot;pitches&quot;</span>
    <span class="n">pitches</span>    <span class="o">=</span> <span class="nb">dict</span><span class="p">([])</span> <span class="c1"># histogram of pitch-occurrences channels 0-8,10-15</span>
    <span class="n">pitch_range_sum</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1"># u pitch-ranges of each track</span>
    <span class="n">pitch_range_by_track</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">is_a_score</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">opus_or_score</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;bank_select&#39;</span><span class="p">:[],</span> <span class="s1">&#39;channels_by_track&#39;</span><span class="p">:[],</span> <span class="s1">&#39;channels_total&#39;</span><span class="p">:[],</span>
         <span class="s1">&#39;general_midi_mode&#39;</span><span class="p">:[],</span> <span class="s1">&#39;ntracks&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;nticks&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
         <span class="s1">&#39;num_notes_by_channel&#39;</span><span class="p">:</span><span class="nb">dict</span><span class="p">([]),</span>
         <span class="s1">&#39;patch_changes_by_track&#39;</span><span class="p">:[],</span> <span class="s1">&#39;patch_changes_total&#39;</span><span class="p">:[],</span>
         <span class="s1">&#39;percussion&#39;</span><span class="p">:{},</span> <span class="s1">&#39;pitches&#39;</span><span class="p">:{},</span> <span class="s1">&#39;pitch_range_by_track&#39;</span><span class="p">:[],</span>
         <span class="s1">&#39;ticks_per_quarter&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;pitch_range_sum&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
    <span class="n">ticks_per_quarter</span> <span class="o">=</span> <span class="n">opus_or_score</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># ignore first element, which is ticks</span>
    <span class="n">nticks</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">opus_or_score</span><span class="p">):</span>
        <span class="n">highest_pitch</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">lowest_pitch</span> <span class="o">=</span> <span class="mi">128</span>
        <span class="n">channels_this_track</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="n">patch_changes_this_track</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({})</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">opus_or_score</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note&#39;</span><span class="p">:</span>
                <span class="n">num_notes_by_channel</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="o">=</span> <span class="n">num_notes_by_channel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
                    <span class="n">percussion</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> <span class="o">=</span> <span class="n">percussion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pitches</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span>    <span class="o">=</span> <span class="n">pitches</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">highest_pitch</span><span class="p">:</span>
                        <span class="n">highest_pitch</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lowest_pitch</span><span class="p">:</span>
                        <span class="n">lowest_pitch</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">channels_this_track</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">channels_total</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">finish_time</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">finish_time</span> <span class="o">&gt;</span> <span class="n">nticks</span><span class="p">:</span>
                    <span class="n">nticks</span> <span class="o">=</span> <span class="n">finish_time</span>
            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note_off&#39;</span> <span class="ow">or</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note_on&#39;</span> <span class="ow">and</span> <span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>  <span class="c1"># 4.8</span>
                <span class="n">finish_time</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">finish_time</span> <span class="o">&gt;</span> <span class="n">nticks</span><span class="p">:</span>
                    <span class="n">nticks</span> <span class="o">=</span> <span class="n">finish_time</span>
            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note_on&#39;</span><span class="p">:</span>
                <span class="n">is_a_score</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">num_notes_by_channel</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">num_notes_by_channel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
                    <span class="n">percussion</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="o">=</span> <span class="n">percussion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pitches</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>    <span class="o">=</span> <span class="n">pitches</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">highest_pitch</span><span class="p">:</span>
                        <span class="n">highest_pitch</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lowest_pitch</span><span class="p">:</span>
                        <span class="n">lowest_pitch</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">channels_this_track</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">channels_total</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;patch_change&#39;</span><span class="p">:</span>
                <span class="n">patch_changes_this_track</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">patch_changes_total</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control_change&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># bank select MSB</span>
                    <span class="n">bank_select_msb</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">32</span><span class="p">:</span>  <span class="c1"># bank select LSB</span>
                    <span class="n">bank_select_lsb</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">bank_select_msb</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">bank_select_lsb</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">bank_select</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">bank_select_msb</span><span class="p">,</span><span class="n">bank_select_lsb</span><span class="p">))</span>
                    <span class="n">bank_select_msb</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">bank_select_lsb</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;sysex_f0&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">_sysex2midimode</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">general_midi_mode</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_sysex2midimode</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">is_a_score</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">nticks</span><span class="p">:</span>
                    <span class="n">nticks</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nticks</span> <span class="o">+=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">lowest_pitch</span> <span class="o">==</span> <span class="mi">128</span><span class="p">:</span>
            <span class="n">lowest_pitch</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">channels_by_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">channels_this_track</span><span class="p">)</span>
        <span class="n">patch_changes_by_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">patch_changes_this_track</span><span class="p">)</span>
        <span class="n">pitch_range_by_track</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">lowest_pitch</span><span class="p">,</span><span class="n">highest_pitch</span><span class="p">))</span>
        <span class="n">pitch_range_sum</span> <span class="o">+=</span> <span class="p">(</span><span class="n">highest_pitch</span><span class="o">-</span><span class="n">lowest_pitch</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;bank_select&#39;</span><span class="p">:</span><span class="n">bank_select</span><span class="p">,</span>
            <span class="s1">&#39;channels_by_track&#39;</span><span class="p">:</span><span class="n">channels_by_track</span><span class="p">,</span>
            <span class="s1">&#39;channels_total&#39;</span><span class="p">:</span><span class="n">channels_total</span><span class="p">,</span>
            <span class="s1">&#39;general_midi_mode&#39;</span><span class="p">:</span><span class="n">general_midi_mode</span><span class="p">,</span>
            <span class="s1">&#39;ntracks&#39;</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">opus_or_score</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;nticks&#39;</span><span class="p">:</span><span class="n">nticks</span><span class="p">,</span>
            <span class="s1">&#39;num_notes_by_channel&#39;</span><span class="p">:</span><span class="n">num_notes_by_channel</span><span class="p">,</span>
            <span class="s1">&#39;patch_changes_by_track&#39;</span><span class="p">:</span><span class="n">patch_changes_by_track</span><span class="p">,</span>
            <span class="s1">&#39;patch_changes_total&#39;</span><span class="p">:</span><span class="n">patch_changes_total</span><span class="p">,</span>
            <span class="s1">&#39;percussion&#39;</span><span class="p">:</span><span class="n">percussion</span><span class="p">,</span>
            <span class="s1">&#39;pitches&#39;</span><span class="p">:</span><span class="n">pitches</span><span class="p">,</span>
            <span class="s1">&#39;pitch_range_by_track&#39;</span><span class="p">:</span><span class="n">pitch_range_by_track</span><span class="p">,</span>
            <span class="s1">&#39;pitch_range_sum&#39;</span><span class="p">:</span><span class="n">pitch_range_sum</span><span class="p">,</span>
            <span class="s1">&#39;ticks_per_quarter&#39;</span><span class="p">:</span><span class="n">ticks_per_quarter</span><span class="p">}</span>

<span class="c1">#----------------------------- Event stuff --------------------------</span>

<span class="n">_sysex2midimode</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;</span><span class="se">\x7E\x7F\x09\x01\xF7</span><span class="s2">&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;</span><span class="se">\x7E\x7F\x09\x02\xF7</span><span class="s2">&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;</span><span class="se">\x7E\x7F\x09\x03\xF7</span><span class="s2">&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># Some public-access tuples:</span>
<span class="n">MIDI_events</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;note_off note_on key_after_touch</span>
<span class="s1">control_change patch_change channel_after_touch</span>
<span class="s1">pitch_wheel_change&#39;&#39;&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>

<span class="n">Text_events</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;text_event copyright_text_event</span>
<span class="s1">track_name instrument_name lyric marker cue_point text_event_08</span>
<span class="s1">text_event_09 text_event_0a text_event_0b text_event_0c</span>
<span class="s1">text_event_0d text_event_0e text_event_0f&#39;&#39;&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>

<span class="n">Nontext_meta_events</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;end_track set_tempo</span>
<span class="s1">smpte_offset time_signature key_signature sequencer_specific</span>
<span class="s1">raw_meta_event sysex_f0 sysex_f7 song_position song_select</span>
<span class="s1">tune_request&#39;&#39;&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<span class="c1"># unsupported: raw_data</span>

<span class="c1"># Actually, &#39;tune_request&#39; is is F-series event, not strictly a meta-event...</span>
<span class="n">Meta_events</span> <span class="o">=</span> <span class="n">Text_events</span> <span class="o">+</span> <span class="n">Nontext_meta_events</span>
<span class="n">All_events</span>  <span class="o">=</span> <span class="n">MIDI_events</span> <span class="o">+</span> <span class="n">Meta_events</span>

<span class="c1"># And three dictionaries:</span>
<span class="n">Number2patch</span> <span class="o">=</span> <span class="p">{</span>   <span class="c1"># General MIDI patch numbers:</span>
<span class="mi">0</span><span class="p">:</span><span class="s1">&#39;Acoustic Grand&#39;</span><span class="p">,</span>
<span class="mi">1</span><span class="p">:</span><span class="s1">&#39;Bright Acoustic&#39;</span><span class="p">,</span>
<span class="mi">2</span><span class="p">:</span><span class="s1">&#39;Electric Grand&#39;</span><span class="p">,</span>
<span class="mi">3</span><span class="p">:</span><span class="s1">&#39;Honky-Tonk&#39;</span><span class="p">,</span>
<span class="mi">4</span><span class="p">:</span><span class="s1">&#39;Electric Piano 1&#39;</span><span class="p">,</span>
<span class="mi">5</span><span class="p">:</span><span class="s1">&#39;Electric Piano 2&#39;</span><span class="p">,</span>
<span class="mi">6</span><span class="p">:</span><span class="s1">&#39;Harpsichord&#39;</span><span class="p">,</span>
<span class="mi">7</span><span class="p">:</span><span class="s1">&#39;Clav&#39;</span><span class="p">,</span>
<span class="mi">8</span><span class="p">:</span><span class="s1">&#39;Celesta&#39;</span><span class="p">,</span>
<span class="mi">9</span><span class="p">:</span><span class="s1">&#39;Glockenspiel&#39;</span><span class="p">,</span>
<span class="mi">10</span><span class="p">:</span><span class="s1">&#39;Music Box&#39;</span><span class="p">,</span>
<span class="mi">11</span><span class="p">:</span><span class="s1">&#39;Vibraphone&#39;</span><span class="p">,</span>
<span class="mi">12</span><span class="p">:</span><span class="s1">&#39;Marimba&#39;</span><span class="p">,</span>
<span class="mi">13</span><span class="p">:</span><span class="s1">&#39;Xylophone&#39;</span><span class="p">,</span>
<span class="mi">14</span><span class="p">:</span><span class="s1">&#39;Tubular Bells&#39;</span><span class="p">,</span>
<span class="mi">15</span><span class="p">:</span><span class="s1">&#39;Dulcimer&#39;</span><span class="p">,</span>
<span class="mi">16</span><span class="p">:</span><span class="s1">&#39;Drawbar Organ&#39;</span><span class="p">,</span>
<span class="mi">17</span><span class="p">:</span><span class="s1">&#39;Percussive Organ&#39;</span><span class="p">,</span>
<span class="mi">18</span><span class="p">:</span><span class="s1">&#39;Rock Organ&#39;</span><span class="p">,</span>
<span class="mi">19</span><span class="p">:</span><span class="s1">&#39;Church Organ&#39;</span><span class="p">,</span>
<span class="mi">20</span><span class="p">:</span><span class="s1">&#39;Reed Organ&#39;</span><span class="p">,</span>
<span class="mi">21</span><span class="p">:</span><span class="s1">&#39;Accordion&#39;</span><span class="p">,</span>
<span class="mi">22</span><span class="p">:</span><span class="s1">&#39;Harmonica&#39;</span><span class="p">,</span>
<span class="mi">23</span><span class="p">:</span><span class="s1">&#39;Tango Accordion&#39;</span><span class="p">,</span>
<span class="mi">24</span><span class="p">:</span><span class="s1">&#39;Acoustic Guitar(nylon)&#39;</span><span class="p">,</span>
<span class="mi">25</span><span class="p">:</span><span class="s1">&#39;Acoustic Guitar(steel)&#39;</span><span class="p">,</span>
<span class="mi">26</span><span class="p">:</span><span class="s1">&#39;Electric Guitar(jazz)&#39;</span><span class="p">,</span>
<span class="mi">27</span><span class="p">:</span><span class="s1">&#39;Electric Guitar(clean)&#39;</span><span class="p">,</span>
<span class="mi">28</span><span class="p">:</span><span class="s1">&#39;Electric Guitar(muted)&#39;</span><span class="p">,</span>
<span class="mi">29</span><span class="p">:</span><span class="s1">&#39;Overdriven Guitar&#39;</span><span class="p">,</span>
<span class="mi">30</span><span class="p">:</span><span class="s1">&#39;Distortion Guitar&#39;</span><span class="p">,</span>
<span class="mi">31</span><span class="p">:</span><span class="s1">&#39;Guitar Harmonics&#39;</span><span class="p">,</span>
<span class="mi">32</span><span class="p">:</span><span class="s1">&#39;Acoustic Bass&#39;</span><span class="p">,</span>
<span class="mi">33</span><span class="p">:</span><span class="s1">&#39;Electric Bass(finger)&#39;</span><span class="p">,</span>
<span class="mi">34</span><span class="p">:</span><span class="s1">&#39;Electric Bass(pick)&#39;</span><span class="p">,</span>
<span class="mi">35</span><span class="p">:</span><span class="s1">&#39;Fretless Bass&#39;</span><span class="p">,</span>
<span class="mi">36</span><span class="p">:</span><span class="s1">&#39;Slap Bass 1&#39;</span><span class="p">,</span>
<span class="mi">37</span><span class="p">:</span><span class="s1">&#39;Slap Bass 2&#39;</span><span class="p">,</span>
<span class="mi">38</span><span class="p">:</span><span class="s1">&#39;Synth Bass 1&#39;</span><span class="p">,</span>
<span class="mi">39</span><span class="p">:</span><span class="s1">&#39;Synth Bass 2&#39;</span><span class="p">,</span>
<span class="mi">40</span><span class="p">:</span><span class="s1">&#39;Violin&#39;</span><span class="p">,</span>
<span class="mi">41</span><span class="p">:</span><span class="s1">&#39;Viola&#39;</span><span class="p">,</span>
<span class="mi">42</span><span class="p">:</span><span class="s1">&#39;Cello&#39;</span><span class="p">,</span>
<span class="mi">43</span><span class="p">:</span><span class="s1">&#39;Contrabass&#39;</span><span class="p">,</span>
<span class="mi">44</span><span class="p">:</span><span class="s1">&#39;Tremolo Strings&#39;</span><span class="p">,</span>
<span class="mi">45</span><span class="p">:</span><span class="s1">&#39;Pizzicato Strings&#39;</span><span class="p">,</span>
<span class="mi">46</span><span class="p">:</span><span class="s1">&#39;Orchestral Harp&#39;</span><span class="p">,</span>
<span class="mi">47</span><span class="p">:</span><span class="s1">&#39;Timpani&#39;</span><span class="p">,</span>
<span class="mi">48</span><span class="p">:</span><span class="s1">&#39;String Ensemble 1&#39;</span><span class="p">,</span>
<span class="mi">49</span><span class="p">:</span><span class="s1">&#39;String Ensemble 2&#39;</span><span class="p">,</span>
<span class="mi">50</span><span class="p">:</span><span class="s1">&#39;SynthStrings 1&#39;</span><span class="p">,</span>
<span class="mi">51</span><span class="p">:</span><span class="s1">&#39;SynthStrings 2&#39;</span><span class="p">,</span>
<span class="mi">52</span><span class="p">:</span><span class="s1">&#39;Choir Aahs&#39;</span><span class="p">,</span>
<span class="mi">53</span><span class="p">:</span><span class="s1">&#39;Voice Oohs&#39;</span><span class="p">,</span>
<span class="mi">54</span><span class="p">:</span><span class="s1">&#39;Synth Voice&#39;</span><span class="p">,</span>
<span class="mi">55</span><span class="p">:</span><span class="s1">&#39;Orchestra Hit&#39;</span><span class="p">,</span>
<span class="mi">56</span><span class="p">:</span><span class="s1">&#39;Trumpet&#39;</span><span class="p">,</span>
<span class="mi">57</span><span class="p">:</span><span class="s1">&#39;Trombone&#39;</span><span class="p">,</span>
<span class="mi">58</span><span class="p">:</span><span class="s1">&#39;Tuba&#39;</span><span class="p">,</span>
<span class="mi">59</span><span class="p">:</span><span class="s1">&#39;Muted Trumpet&#39;</span><span class="p">,</span>
<span class="mi">60</span><span class="p">:</span><span class="s1">&#39;French Horn&#39;</span><span class="p">,</span>
<span class="mi">61</span><span class="p">:</span><span class="s1">&#39;Brass Section&#39;</span><span class="p">,</span>
<span class="mi">62</span><span class="p">:</span><span class="s1">&#39;SynthBrass 1&#39;</span><span class="p">,</span>
<span class="mi">63</span><span class="p">:</span><span class="s1">&#39;SynthBrass 2&#39;</span><span class="p">,</span>
<span class="mi">64</span><span class="p">:</span><span class="s1">&#39;Soprano Sax&#39;</span><span class="p">,</span>
<span class="mi">65</span><span class="p">:</span><span class="s1">&#39;Alto Sax&#39;</span><span class="p">,</span>
<span class="mi">66</span><span class="p">:</span><span class="s1">&#39;Tenor Sax&#39;</span><span class="p">,</span>
<span class="mi">67</span><span class="p">:</span><span class="s1">&#39;Baritone Sax&#39;</span><span class="p">,</span>
<span class="mi">68</span><span class="p">:</span><span class="s1">&#39;Oboe&#39;</span><span class="p">,</span>
<span class="mi">69</span><span class="p">:</span><span class="s1">&#39;English Horn&#39;</span><span class="p">,</span>
<span class="mi">70</span><span class="p">:</span><span class="s1">&#39;Bassoon&#39;</span><span class="p">,</span>
<span class="mi">71</span><span class="p">:</span><span class="s1">&#39;Clarinet&#39;</span><span class="p">,</span>
<span class="mi">72</span><span class="p">:</span><span class="s1">&#39;Piccolo&#39;</span><span class="p">,</span>
<span class="mi">73</span><span class="p">:</span><span class="s1">&#39;Flute&#39;</span><span class="p">,</span>
<span class="mi">74</span><span class="p">:</span><span class="s1">&#39;Recorder&#39;</span><span class="p">,</span>
<span class="mi">75</span><span class="p">:</span><span class="s1">&#39;Pan Flute&#39;</span><span class="p">,</span>
<span class="mi">76</span><span class="p">:</span><span class="s1">&#39;Blown Bottle&#39;</span><span class="p">,</span>
<span class="mi">77</span><span class="p">:</span><span class="s1">&#39;Skakuhachi&#39;</span><span class="p">,</span>
<span class="mi">78</span><span class="p">:</span><span class="s1">&#39;Whistle&#39;</span><span class="p">,</span>
<span class="mi">79</span><span class="p">:</span><span class="s1">&#39;Ocarina&#39;</span><span class="p">,</span>
<span class="mi">80</span><span class="p">:</span><span class="s1">&#39;Lead 1 (square)&#39;</span><span class="p">,</span>
<span class="mi">81</span><span class="p">:</span><span class="s1">&#39;Lead 2 (sawtooth)&#39;</span><span class="p">,</span>
<span class="mi">82</span><span class="p">:</span><span class="s1">&#39;Lead 3 (calliope)&#39;</span><span class="p">,</span>
<span class="mi">83</span><span class="p">:</span><span class="s1">&#39;Lead 4 (chiff)&#39;</span><span class="p">,</span>
<span class="mi">84</span><span class="p">:</span><span class="s1">&#39;Lead 5 (charang)&#39;</span><span class="p">,</span>
<span class="mi">85</span><span class="p">:</span><span class="s1">&#39;Lead 6 (voice)&#39;</span><span class="p">,</span>
<span class="mi">86</span><span class="p">:</span><span class="s1">&#39;Lead 7 (fifths)&#39;</span><span class="p">,</span>
<span class="mi">87</span><span class="p">:</span><span class="s1">&#39;Lead 8 (bass+lead)&#39;</span><span class="p">,</span>
<span class="mi">88</span><span class="p">:</span><span class="s1">&#39;Pad 1 (new age)&#39;</span><span class="p">,</span>
<span class="mi">89</span><span class="p">:</span><span class="s1">&#39;Pad 2 (warm)&#39;</span><span class="p">,</span>
<span class="mi">90</span><span class="p">:</span><span class="s1">&#39;Pad 3 (polysynth)&#39;</span><span class="p">,</span>
<span class="mi">91</span><span class="p">:</span><span class="s1">&#39;Pad 4 (choir)&#39;</span><span class="p">,</span>
<span class="mi">92</span><span class="p">:</span><span class="s1">&#39;Pad 5 (bowed)&#39;</span><span class="p">,</span>
<span class="mi">93</span><span class="p">:</span><span class="s1">&#39;Pad 6 (metallic)&#39;</span><span class="p">,</span>
<span class="mi">94</span><span class="p">:</span><span class="s1">&#39;Pad 7 (halo)&#39;</span><span class="p">,</span>
<span class="mi">95</span><span class="p">:</span><span class="s1">&#39;Pad 8 (sweep)&#39;</span><span class="p">,</span>
<span class="mi">96</span><span class="p">:</span><span class="s1">&#39;FX 1 (rain)&#39;</span><span class="p">,</span>
<span class="mi">97</span><span class="p">:</span><span class="s1">&#39;FX 2 (soundtrack)&#39;</span><span class="p">,</span>
<span class="mi">98</span><span class="p">:</span><span class="s1">&#39;FX 3 (crystal)&#39;</span><span class="p">,</span>
<span class="mi">99</span><span class="p">:</span><span class="s1">&#39;FX 4 (atmosphere)&#39;</span><span class="p">,</span>
<span class="mi">100</span><span class="p">:</span><span class="s1">&#39;FX 5 (brightness)&#39;</span><span class="p">,</span>
<span class="mi">101</span><span class="p">:</span><span class="s1">&#39;FX 6 (goblins)&#39;</span><span class="p">,</span>
<span class="mi">102</span><span class="p">:</span><span class="s1">&#39;FX 7 (echoes)&#39;</span><span class="p">,</span>
<span class="mi">103</span><span class="p">:</span><span class="s1">&#39;FX 8 (sci-fi)&#39;</span><span class="p">,</span>
<span class="mi">104</span><span class="p">:</span><span class="s1">&#39;Sitar&#39;</span><span class="p">,</span>
<span class="mi">105</span><span class="p">:</span><span class="s1">&#39;Banjo&#39;</span><span class="p">,</span>
<span class="mi">106</span><span class="p">:</span><span class="s1">&#39;Shamisen&#39;</span><span class="p">,</span>
<span class="mi">107</span><span class="p">:</span><span class="s1">&#39;Koto&#39;</span><span class="p">,</span>
<span class="mi">108</span><span class="p">:</span><span class="s1">&#39;Kalimba&#39;</span><span class="p">,</span>
<span class="mi">109</span><span class="p">:</span><span class="s1">&#39;Bagpipe&#39;</span><span class="p">,</span>
<span class="mi">110</span><span class="p">:</span><span class="s1">&#39;Fiddle&#39;</span><span class="p">,</span>
<span class="mi">111</span><span class="p">:</span><span class="s1">&#39;Shanai&#39;</span><span class="p">,</span>
<span class="mi">112</span><span class="p">:</span><span class="s1">&#39;Tinkle Bell&#39;</span><span class="p">,</span>
<span class="mi">113</span><span class="p">:</span><span class="s1">&#39;Agogo&#39;</span><span class="p">,</span>
<span class="mi">114</span><span class="p">:</span><span class="s1">&#39;Steel Drums&#39;</span><span class="p">,</span>
<span class="mi">115</span><span class="p">:</span><span class="s1">&#39;Woodblock&#39;</span><span class="p">,</span>
<span class="mi">116</span><span class="p">:</span><span class="s1">&#39;Taiko Drum&#39;</span><span class="p">,</span>
<span class="mi">117</span><span class="p">:</span><span class="s1">&#39;Melodic Tom&#39;</span><span class="p">,</span>
<span class="mi">118</span><span class="p">:</span><span class="s1">&#39;Synth Drum&#39;</span><span class="p">,</span>
<span class="mi">119</span><span class="p">:</span><span class="s1">&#39;Reverse Cymbal&#39;</span><span class="p">,</span>
<span class="mi">120</span><span class="p">:</span><span class="s1">&#39;Guitar Fret Noise&#39;</span><span class="p">,</span>
<span class="mi">121</span><span class="p">:</span><span class="s1">&#39;Breath Noise&#39;</span><span class="p">,</span>
<span class="mi">122</span><span class="p">:</span><span class="s1">&#39;Seashore&#39;</span><span class="p">,</span>
<span class="mi">123</span><span class="p">:</span><span class="s1">&#39;Bird Tweet&#39;</span><span class="p">,</span>
<span class="mi">124</span><span class="p">:</span><span class="s1">&#39;Telephone Ring&#39;</span><span class="p">,</span>
<span class="mi">125</span><span class="p">:</span><span class="s1">&#39;Helicopter&#39;</span><span class="p">,</span>
<span class="mi">126</span><span class="p">:</span><span class="s1">&#39;Applause&#39;</span><span class="p">,</span>
<span class="mi">127</span><span class="p">:</span><span class="s1">&#39;Gunshot&#39;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">Notenum2percussion</span> <span class="o">=</span> <span class="p">{</span>   <span class="c1"># General MIDI Percussion (on Channel 9):</span>
<span class="mi">35</span><span class="p">:</span><span class="s1">&#39;Acoustic Bass Drum&#39;</span><span class="p">,</span>
<span class="mi">36</span><span class="p">:</span><span class="s1">&#39;Bass Drum 1&#39;</span><span class="p">,</span>
<span class="mi">37</span><span class="p">:</span><span class="s1">&#39;Side Stick&#39;</span><span class="p">,</span>
<span class="mi">38</span><span class="p">:</span><span class="s1">&#39;Acoustic Snare&#39;</span><span class="p">,</span>
<span class="mi">39</span><span class="p">:</span><span class="s1">&#39;Hand Clap&#39;</span><span class="p">,</span>
<span class="mi">40</span><span class="p">:</span><span class="s1">&#39;Electric Snare&#39;</span><span class="p">,</span>
<span class="mi">41</span><span class="p">:</span><span class="s1">&#39;Low Floor Tom&#39;</span><span class="p">,</span>
<span class="mi">42</span><span class="p">:</span><span class="s1">&#39;Closed Hi-Hat&#39;</span><span class="p">,</span>
<span class="mi">43</span><span class="p">:</span><span class="s1">&#39;High Floor Tom&#39;</span><span class="p">,</span>
<span class="mi">44</span><span class="p">:</span><span class="s1">&#39;Pedal Hi-Hat&#39;</span><span class="p">,</span>
<span class="mi">45</span><span class="p">:</span><span class="s1">&#39;Low Tom&#39;</span><span class="p">,</span>
<span class="mi">46</span><span class="p">:</span><span class="s1">&#39;Open Hi-Hat&#39;</span><span class="p">,</span>
<span class="mi">47</span><span class="p">:</span><span class="s1">&#39;Low-Mid Tom&#39;</span><span class="p">,</span>
<span class="mi">48</span><span class="p">:</span><span class="s1">&#39;Hi-Mid Tom&#39;</span><span class="p">,</span>
<span class="mi">49</span><span class="p">:</span><span class="s1">&#39;Crash Cymbal 1&#39;</span><span class="p">,</span>
<span class="mi">50</span><span class="p">:</span><span class="s1">&#39;High Tom&#39;</span><span class="p">,</span>
<span class="mi">51</span><span class="p">:</span><span class="s1">&#39;Ride Cymbal 1&#39;</span><span class="p">,</span>
<span class="mi">52</span><span class="p">:</span><span class="s1">&#39;Chinese Cymbal&#39;</span><span class="p">,</span>
<span class="mi">53</span><span class="p">:</span><span class="s1">&#39;Ride Bell&#39;</span><span class="p">,</span>
<span class="mi">54</span><span class="p">:</span><span class="s1">&#39;Tambourine&#39;</span><span class="p">,</span>
<span class="mi">55</span><span class="p">:</span><span class="s1">&#39;Splash Cymbal&#39;</span><span class="p">,</span>
<span class="mi">56</span><span class="p">:</span><span class="s1">&#39;Cowbell&#39;</span><span class="p">,</span>
<span class="mi">57</span><span class="p">:</span><span class="s1">&#39;Crash Cymbal 2&#39;</span><span class="p">,</span>
<span class="mi">58</span><span class="p">:</span><span class="s1">&#39;Vibraslap&#39;</span><span class="p">,</span>
<span class="mi">59</span><span class="p">:</span><span class="s1">&#39;Ride Cymbal 2&#39;</span><span class="p">,</span>
<span class="mi">60</span><span class="p">:</span><span class="s1">&#39;Hi Bongo&#39;</span><span class="p">,</span>
<span class="mi">61</span><span class="p">:</span><span class="s1">&#39;Low Bongo&#39;</span><span class="p">,</span>
<span class="mi">62</span><span class="p">:</span><span class="s1">&#39;Mute Hi Conga&#39;</span><span class="p">,</span>
<span class="mi">63</span><span class="p">:</span><span class="s1">&#39;Open Hi Conga&#39;</span><span class="p">,</span>
<span class="mi">64</span><span class="p">:</span><span class="s1">&#39;Low Conga&#39;</span><span class="p">,</span>
<span class="mi">65</span><span class="p">:</span><span class="s1">&#39;High Timbale&#39;</span><span class="p">,</span>
<span class="mi">66</span><span class="p">:</span><span class="s1">&#39;Low Timbale&#39;</span><span class="p">,</span>
<span class="mi">67</span><span class="p">:</span><span class="s1">&#39;High Agogo&#39;</span><span class="p">,</span>
<span class="mi">68</span><span class="p">:</span><span class="s1">&#39;Low Agogo&#39;</span><span class="p">,</span>
<span class="mi">69</span><span class="p">:</span><span class="s1">&#39;Cabasa&#39;</span><span class="p">,</span>
<span class="mi">70</span><span class="p">:</span><span class="s1">&#39;Maracas&#39;</span><span class="p">,</span>
<span class="mi">71</span><span class="p">:</span><span class="s1">&#39;Short Whistle&#39;</span><span class="p">,</span>
<span class="mi">72</span><span class="p">:</span><span class="s1">&#39;Long Whistle&#39;</span><span class="p">,</span>
<span class="mi">73</span><span class="p">:</span><span class="s1">&#39;Short Guiro&#39;</span><span class="p">,</span>
<span class="mi">74</span><span class="p">:</span><span class="s1">&#39;Long Guiro&#39;</span><span class="p">,</span>
<span class="mi">75</span><span class="p">:</span><span class="s1">&#39;Claves&#39;</span><span class="p">,</span>
<span class="mi">76</span><span class="p">:</span><span class="s1">&#39;Hi Wood Block&#39;</span><span class="p">,</span>
<span class="mi">77</span><span class="p">:</span><span class="s1">&#39;Low Wood Block&#39;</span><span class="p">,</span>
<span class="mi">78</span><span class="p">:</span><span class="s1">&#39;Mute Cuica&#39;</span><span class="p">,</span>
<span class="mi">79</span><span class="p">:</span><span class="s1">&#39;Open Cuica&#39;</span><span class="p">,</span>
<span class="mi">80</span><span class="p">:</span><span class="s1">&#39;Mute Triangle&#39;</span><span class="p">,</span>
<span class="mi">81</span><span class="p">:</span><span class="s1">&#39;Open Triangle&#39;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">Event2channelindex</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;note&#39;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;note_off&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;note_on&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
 <span class="s1">&#39;key_after_touch&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;control_change&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;patch_change&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
 <span class="s1">&#39;channel_after_touch&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;pitch_wheel_change&#39;</span><span class="p">:</span><span class="mi">2</span>
<span class="p">}</span>

<span class="c1">################################################################</span>
<span class="c1"># The code below this line is full of frightening things, all to</span>
<span class="c1"># do with the actual encoding and decoding of binary MIDI data.</span>

<span class="k">def</span> <span class="nf">_twobytes2int</span><span class="p">(</span><span class="n">byte_a</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;decode a 16 bit quantity from two bytes,&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">byte_a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">byte_a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_int2twobytes</span><span class="p">(</span><span class="n">int_16bit</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;encode a 16 bit quantity into two bytes,&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="nb">bytes</span><span class="p">([(</span><span class="n">int_16bit</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">int_16bit</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">_read_14_bit</span><span class="p">(</span><span class="n">byte_a</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;decode a 14 bit quantity from two bytes,&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">byte_a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">byte_a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_write_14_bit</span><span class="p">(</span><span class="n">int_14bit</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;encode a 14 bit quantity into two bytes,&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">int_14bit</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">,</span> <span class="p">(</span><span class="n">int_14bit</span><span class="o">&gt;&gt;</span><span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">_ber_compressed_int</span><span class="p">(</span><span class="n">integer</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;BER compressed integer (not an ASN.1 BER, see perlpacktut for</span>
<span class="sd">details).  Its bytes represent an unsigned integer in base 128,</span>
<span class="sd">most significant digit first, with as few digits as possible.</span>
<span class="sd">Bit eight (the high bit) is set on each byte except the last.</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="n">ber</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">seven_bits</span> <span class="o">=</span> <span class="mh">0x7F</span> <span class="o">&amp;</span> <span class="n">integer</span>
    <span class="n">ber</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">seven_bits</span><span class="p">)</span>  <span class="c1"># XXX surely should convert to a char ?</span>
    <span class="n">integer</span> <span class="o">&gt;&gt;=</span> <span class="mi">7</span>
    <span class="k">while</span> <span class="n">integer</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">seven_bits</span> <span class="o">=</span> <span class="mh">0x7F</span> <span class="o">&amp;</span> <span class="n">integer</span>
        <span class="n">ber</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x80</span><span class="o">|</span><span class="n">seven_bits</span><span class="p">)</span>  <span class="c1"># XXX surely should convert to a char ?</span>
        <span class="n">integer</span> <span class="o">&gt;&gt;=</span> <span class="mi">7</span>
    <span class="k">return</span> <span class="n">ber</span>

<span class="k">def</span> <span class="nf">_unshift_ber_int</span><span class="p">(</span><span class="n">ba</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Given a bytearray, returns a tuple of (the ber-integer at the</span>
<span class="sd">start, and the remainder of the bytearray).</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">ba</span><span class="p">):</span>   <span class="c1"># 6.7</span>
        <span class="n">_warn</span><span class="p">(</span><span class="s1">&#39;_unshift_ber_int: no integer found&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">))</span>
    <span class="n">byte</span> <span class="o">=</span> <span class="n">ba</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">integer</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">integer</span> <span class="o">+=</span> <span class="p">(</span><span class="n">byte</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">byte</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">((</span><span class="n">integer</span><span class="p">,</span> <span class="n">ba</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">ba</span><span class="p">):</span>
            <span class="n">_warn</span><span class="p">(</span><span class="s1">&#39;_unshift_ber_int: no end-of-integer found&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">ba</span><span class="p">))</span>
        <span class="n">byte</span> <span class="o">=</span> <span class="n">ba</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">integer</span> <span class="o">&lt;&lt;=</span> <span class="mi">7</span>

<span class="k">def</span> <span class="nf">_clean_up_warnings</span><span class="p">():</span>  <span class="c1"># 5.4</span>
    <span class="c1"># Call this before returning from any publicly callable function</span>
    <span class="c1"># whenever there&#39;s a possibility that a warning might have been printed</span>
    <span class="c1"># by the function, or by any private functions it might have called.</span>
    <span class="k">global</span> <span class="n">_previous_times</span>
    <span class="k">global</span> <span class="n">_previous_warning</span>
    <span class="k">if</span> <span class="n">_previous_times</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># E:1176, 0: invalid syntax (&lt;string&gt;, line 1176) (syntax-error) ???</span>
        <span class="c1"># print(&#39;  previous message repeated &#39;+str(_previous_times)+&#39; times&#39;, file=sys.stderr)</span>
        <span class="c1"># 6.7</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  previous message repeated </span><span class="si">{0}</span><span class="s1"> times</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_previous_times</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">_previous_times</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  previous message repeated</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">_previous_times</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">_previous_warning</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

<span class="k">def</span> <span class="nf">_warn</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">_previous_times</span>
    <span class="k">global</span> <span class="n">_previous_warning</span>
    <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="n">_previous_warning</span><span class="p">:</span>  <span class="c1"># 5.4</span>
        <span class="n">_previous_times</span> <span class="o">=</span> <span class="n">_previous_times</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_clean_up_warnings</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">_previous_warning</span> <span class="o">=</span> <span class="n">s</span>

<span class="k">def</span> <span class="nf">_some_text_event</span><span class="p">(</span><span class="n">which_kind</span><span class="o">=</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;some_text&#39;</span><span class="p">,</span> <span class="n">text_encoding</span><span class="o">=</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">text</span><span class="p">))</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;&#39;str&#39;&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>   <span class="c1"># 6.4 test for back-compatibility</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">text_encoding</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xFF</span><span class="s1">&#39;</span><span class="o">+</span><span class="nb">bytes</span><span class="p">((</span><span class="n">which_kind</span><span class="p">,))</span><span class="o">+</span><span class="n">_ber_compressed_int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span><span class="o">+</span><span class="n">data</span>

<span class="k">def</span> <span class="nf">_consistentise_ticks</span><span class="p">(</span><span class="n">scores</span><span class="p">):</span>  <span class="c1"># 3.6</span>
    <span class="c1"># used by mix_scores, merge_scores, concatenate_scores</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
         <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
    <span class="n">are_consistent</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">ticks</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">iscore</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">iscore</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">scores</span><span class="p">[</span><span class="n">iscore</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ticks</span><span class="p">:</span>
            <span class="n">are_consistent</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">break</span>
        <span class="n">iscore</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">are_consistent</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
    <span class="n">new_scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">iscore</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">iscore</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores</span><span class="p">):</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="n">iscore</span><span class="p">]</span>
        <span class="n">new_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opus2score</span><span class="p">(</span><span class="n">to_millisecs</span><span class="p">(</span><span class="n">score2opus</span><span class="p">(</span><span class="n">score</span><span class="p">))))</span>
        <span class="n">iscore</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">new_scores</span>


<span class="c1">###########################################################################</span>

<span class="k">def</span> <span class="nf">_decode</span><span class="p">(</span><span class="n">trackdata</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
 <span class="n">event_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclusive_event_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">no_eot_magic</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Decodes MIDI track data into an opus-style list of events.</span>
<span class="sd">The options:</span>
<span class="sd">  &#39;exclude&#39; is a list of event types which will be ignored SHOULD BE A SET</span>
<span class="sd">  &#39;include&#39; (and no exclude), makes exclude a list</span>
<span class="sd">       of all possible events, /minus/ what include specifies</span>
<span class="sd">  &#39;event_callback&#39; is a coderef</span>
<span class="sd">  &#39;exclusive_event_callback&#39; is a coderef</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="n">trackdata</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">trackdata</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">exclude</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">exclude</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">include</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">include</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">include</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">exclude</span><span class="p">:</span>
        <span class="n">exclude</span> <span class="o">=</span> <span class="n">All_events</span>
    <span class="n">include</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">include</span><span class="p">)</span>
    <span class="n">exclude</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">exclude</span><span class="p">)</span>

    <span class="c1"># Pointer = 0;  not used here; we eat through the bytearray instead.</span>
    <span class="n">event_code</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="c1"># used for running status</span>
    <span class="n">event_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">while</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trackdata</span><span class="p">)):</span>
        <span class="c1"># loop while there&#39;s anything to analyze ...</span>
        <span class="n">eot</span> <span class="o">=</span> <span class="kc">False</span>   <span class="c1"># When True, the event registrar aborts this loop</span>
        <span class="n">event_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">E</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># E for events - we&#39;ll feed it to the event registrar at the end.</span>

        <span class="c1"># Slice off the delta time code, and analyze it</span>
        <span class="p">[</span><span class="n">time</span><span class="p">,</span> <span class="n">remainder</span><span class="p">]</span> <span class="o">=</span> <span class="n">_unshift_ber_int</span><span class="p">(</span><span class="n">trackdata</span><span class="p">)</span>

        <span class="c1"># Now let&#39;s see what we can make of the command</span>
        <span class="n">first_byte</span> <span class="o">=</span> <span class="n">trackdata</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">first_byte</span> <span class="o">&lt;</span> <span class="mh">0xF0</span><span class="p">):</span>  <span class="c1"># It&#39;s a MIDI event</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">first_byte</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">):</span>
                <span class="n">event_code</span> <span class="o">=</span> <span class="n">first_byte</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># It wants running status; use last event_code value</span>
                <span class="n">trackdata</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">first_byte</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">event_code</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">_warn</span><span class="p">(</span><span class="s2">&quot;Running status not set; Aborting track.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="p">[]</span>

            <span class="n">command</span> <span class="o">=</span> <span class="n">event_code</span> <span class="o">&amp;</span> <span class="mh">0xF0</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="n">event_code</span> <span class="o">&amp;</span> <span class="mh">0x0F</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0xF6</span><span class="p">):</span>  <span class="c1">#  0-byte argument</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0xC0</span> <span class="ow">or</span> <span class="n">command</span> <span class="o">==</span> <span class="mh">0xD0</span><span class="p">):</span>  <span class="c1">#  1-byte argument</span>
                <span class="n">parameter</span> <span class="o">=</span> <span class="n">trackdata</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># could be B</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># 2-byte argument could be BB or 14-bit</span>
                <span class="n">parameter</span> <span class="o">=</span> <span class="p">(</span><span class="n">trackdata</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">trackdata</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

            <span class="c1">#################################################################</span>
            <span class="c1"># MIDI events</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">command</span>      <span class="o">==</span> <span class="mh">0x80</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;note_off&#39;</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;note_off&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">parameter</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parameter</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x90</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;note_on&#39;</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;note_on&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">parameter</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parameter</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0xA0</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;key_after_touch&#39;</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;key_after_touch&#39;</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">channel</span><span class="p">,</span><span class="n">parameter</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">parameter</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0xB0</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;control_change&#39;</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;control_change&#39;</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">channel</span><span class="p">,</span><span class="n">parameter</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">parameter</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0xC0</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;patch_change&#39;</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">parameter</span><span class="p">]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0xD0</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;channel_after_touch&#39;</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;channel_after_touch&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">parameter</span><span class="p">]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0xE0</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;pitch_wheel_change&#39;</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pitch_wheel_change&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span>
                 <span class="n">_read_14_bit</span><span class="p">(</span><span class="n">parameter</span><span class="p">)</span><span class="o">-</span><span class="mh">0x2000</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_warn</span><span class="p">(</span><span class="s2">&quot;Shouldn&#39;t get here; command=&quot;</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">command</span><span class="p">))</span>

        <span class="k">elif</span> <span class="p">(</span><span class="n">first_byte</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">):</span>  <span class="c1"># It&#39;s a Meta-Event! ##################</span>
            <span class="c1">#[command, length, remainder] =</span>
            <span class="c1">#    unpack(&quot;xCwa*&quot;, substr(trackdata, $Pointer, 6));</span>
            <span class="c1">#Pointer += 6 - len(remainder);</span>
            <span class="c1">#    # Move past JUST the length-encoded.</span>
            <span class="n">command</span> <span class="o">=</span> <span class="n">trackdata</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
            <span class="p">[</span><span class="n">length</span><span class="p">,</span> <span class="n">trackdata</span><span class="p">]</span> <span class="o">=</span> <span class="n">_unshift_ber_int</span><span class="p">(</span><span class="n">trackdata</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">command</span>      <span class="o">==</span> <span class="mh">0x00</span><span class="p">):</span>
                 <span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
                     <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;set_sequence_number&#39;</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">_twobytes2int</span><span class="p">(</span><span class="n">trackdata</span><span class="p">)]</span>
                 <span class="k">else</span><span class="p">:</span>
                     <span class="n">_warn</span><span class="p">(</span><span class="s1">&#39;set_sequence_number: length must be 2, not &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>
                     <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;set_sequence_number&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

            <span class="k">elif</span> <span class="n">command</span> <span class="o">&gt;=</span> <span class="mh">0x01</span> <span class="ow">and</span> <span class="n">command</span> <span class="o">&lt;=</span> <span class="mh">0x0f</span><span class="p">:</span>   <span class="c1"># Text events</span>
                <span class="c1"># 6.2 take it in bytes; let the user get the right encoding.</span>
                <span class="c1"># text_str = trackdata[0:length].decode(&#39;ascii&#39;,&#39;ignore&#39;)</span>
                <span class="c1"># text_str = trackdata[0:length].decode(&#39;ISO-8859-1&#39;)</span>
                <span class="c1"># 6.4 take it in bytes; let the user get the right encoding.</span>
                <span class="n">text_data</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">trackdata</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">length</span><span class="p">])</span>   <span class="c1"># 6.4</span>
                <span class="c1"># Defined text events</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">):</span>
                     <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;text_event&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">text_data</span><span class="p">]</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x02</span><span class="p">):</span>
                     <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;copyright_text_event&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">text_data</span><span class="p">]</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x03</span><span class="p">):</span>
                     <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;track_name&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">text_data</span><span class="p">]</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x04</span><span class="p">):</span>
                     <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;instrument_name&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">text_data</span><span class="p">]</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x05</span><span class="p">):</span>
                     <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;lyric&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">text_data</span><span class="p">]</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x06</span><span class="p">):</span>
                     <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;marker&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">text_data</span><span class="p">]</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x07</span><span class="p">):</span>
                     <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cue_point&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">text_data</span><span class="p">]</span>
                <span class="c1"># Reserved but apparently unassigned text events</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x08</span><span class="p">):</span>
                     <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;text_event_08&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">text_data</span><span class="p">]</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x09</span><span class="p">):</span>
                     <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;text_event_09&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">text_data</span><span class="p">]</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x0a</span><span class="p">):</span>
                     <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;text_event_0a&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">text_data</span><span class="p">]</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x0b</span><span class="p">):</span>
                     <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;text_event_0b&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">text_data</span><span class="p">]</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x0c</span><span class="p">):</span>
                     <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;text_event_0c&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">text_data</span><span class="p">]</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x0d</span><span class="p">):</span>
                     <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;text_event_0d&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">text_data</span><span class="p">]</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x0e</span><span class="p">):</span>
                     <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;text_event_0e&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">text_data</span><span class="p">]</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x0f</span><span class="p">):</span>
                     <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;text_event_0f&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">text_data</span><span class="p">]</span>

            <span class="c1"># Now the sticky events -------------------------------------</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x2F</span><span class="p">):</span>
                 <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;end_track&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">]</span>
                     <span class="c1"># The code for handling this, oddly, comes LATER,</span>
                     <span class="c1"># in the event registrar.</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x51</span><span class="p">):</span> <span class="c1"># DTime, Microseconds/Crochet</span>
                 <span class="k">if</span> <span class="n">length</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                     <span class="n">_warn</span><span class="p">(</span><span class="s1">&#39;set_tempo event, but length=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>
                 <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;set_tempo&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span>
                      <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;I&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">trackdata</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x54</span><span class="p">):</span>
                 <span class="k">if</span> <span class="n">length</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">:</span>   <span class="c1"># DTime, HR, MN, SE, FR, FF</span>
                     <span class="n">_warn</span><span class="p">(</span><span class="s1">&#39;smpte_offset event, but length=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>
                 <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;smpte_offset&#39;</span><span class="p">,</span><span class="n">time</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;BBBBB&quot;</span><span class="p">,</span><span class="n">trackdata</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x58</span><span class="p">):</span>
                 <span class="k">if</span> <span class="n">length</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>   <span class="c1"># DTime, NN, DD, CC, BB</span>
                     <span class="n">_warn</span><span class="p">(</span><span class="s1">&#39;time_signature event, but length=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>
                 <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;time_signature&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">]</span><span class="o">+</span><span class="nb">list</span><span class="p">(</span><span class="n">trackdata</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x59</span><span class="p">):</span>
                 <span class="k">if</span> <span class="n">length</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>   <span class="c1"># DTime, SF(signed), MI</span>
                     <span class="n">_warn</span><span class="p">(</span><span class="s1">&#39;key_signature event, but length=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>
                 <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;key_signature&#39;</span><span class="p">,</span><span class="n">time</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;bB&quot;</span><span class="p">,</span><span class="n">trackdata</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x7F</span><span class="p">):</span>   <span class="c1"># 6.4</span>
                 <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sequencer_specific&#39;</span><span class="p">,</span><span class="n">time</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">trackdata</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">length</span><span class="p">])]</span>
            <span class="k">else</span><span class="p">:</span>
                 <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;raw_meta_event&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span>
                   <span class="nb">bytes</span><span class="p">(</span><span class="n">trackdata</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">length</span><span class="p">])]</span>   <span class="c1"># 6.0</span>
                 <span class="c1">#&quot;[uninterpretable meta-event command of length length]&quot;</span>
                 <span class="c1"># DTime, Command, Binary Data</span>
                 <span class="c1"># It&#39;s uninterpretable; record it as raw_data.</span>

            <span class="c1"># Pointer += length; #  Now move Pointer</span>
            <span class="n">trackdata</span> <span class="o">=</span> <span class="n">trackdata</span><span class="p">[</span><span class="n">length</span><span class="p">:]</span>

        <span class="c1">######################################################################</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">first_byte</span> <span class="o">==</span> <span class="mh">0xF0</span> <span class="ow">or</span> <span class="n">first_byte</span> <span class="o">==</span> <span class="mh">0xF7</span><span class="p">):</span>
            <span class="c1"># Note that sysexes in MIDI /files/ are different than sysexes</span>
            <span class="c1"># in MIDI transmissions!! The vast majority of system exclusive</span>
            <span class="c1"># messages will just use the F0 format. For instance, the</span>
            <span class="c1"># transmitted message F0 43 12 00 07 F7 would be stored in a</span>
            <span class="c1"># MIDI file as F0 05 43 12 00 07 F7. As mentioned above, it is</span>
            <span class="c1"># required to include the F7 at the end so that the reader of the</span>
            <span class="c1"># MIDI file knows that it has read the entire message. (But the F7</span>
            <span class="c1"># is omitted if this is a non-final block in a multiblock sysex;</span>
            <span class="c1"># but the F7 (if there) is counted in the message&#39;s declared</span>
            <span class="c1"># length, so we don&#39;t have to think about it anyway.)</span>
            <span class="c1">#command = trackdata.pop(0)</span>
            <span class="p">[</span><span class="n">length</span><span class="p">,</span> <span class="n">trackdata</span><span class="p">]</span> <span class="o">=</span> <span class="n">_unshift_ber_int</span><span class="p">(</span><span class="n">trackdata</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">first_byte</span> <span class="o">==</span> <span class="mh">0xF0</span><span class="p">:</span>
                <span class="c1"># 20091008 added ISO-8859-1 to get an 8-bit str</span>
                <span class="c1"># 6.4 return bytes instead</span>
                <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sysex_f0&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">trackdata</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">length</span><span class="p">])]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sysex_f7&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">trackdata</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">length</span><span class="p">])]</span>
            <span class="n">trackdata</span> <span class="o">=</span> <span class="n">trackdata</span><span class="p">[</span><span class="n">length</span><span class="p">:]</span>

        <span class="c1">######################################################################</span>
        <span class="c1"># Now, the MIDI file spec says:</span>
        <span class="c1">#  &lt;track data&gt; = &lt;MTrk event&gt;+</span>
        <span class="c1">#  &lt;MTrk event&gt; = &lt;delta-time&gt; &lt;event&gt;</span>
        <span class="c1">#  &lt;event&gt; = &lt;MIDI event&gt; | &lt;sysex event&gt; | &lt;meta-event&gt;</span>
        <span class="c1"># I know that, on the wire, &lt;MIDI event&gt; can include note_on,</span>
        <span class="c1"># note_off, and all the other 8x to Ex events, AND Fx events</span>
        <span class="c1"># other than F0, F7, and FF -- namely, &lt;song position msg&gt;,</span>
        <span class="c1"># &lt;song select msg&gt;, and &lt;tune request&gt;.</span>
        <span class="c1">#</span>
        <span class="c1"># Whether these can occur in MIDI files is not clear specified</span>
        <span class="c1"># from the MIDI file spec.  So, I&#39;m going to assume that</span>
        <span class="c1"># they CAN, in practice, occur.  I don&#39;t know whether it&#39;s</span>
        <span class="c1"># proper for you to actually emit these into a MIDI file.</span>
        
        <span class="k">elif</span> <span class="p">(</span><span class="n">first_byte</span> <span class="o">==</span> <span class="mh">0xF2</span><span class="p">):</span>   <span class="c1"># DTime, Beats</span>
            <span class="c1">#  &lt;song position msg&gt; ::=     F2 &lt;data pair&gt;</span>
            <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;song_position&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">_read_14_bit</span><span class="p">(</span><span class="n">trackdata</span><span class="p">[:</span><span class="mi">2</span><span class="p">])]</span>
            <span class="n">trackdata</span> <span class="o">=</span> <span class="n">trackdata</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>

        <span class="k">elif</span> <span class="p">(</span><span class="n">first_byte</span> <span class="o">==</span> <span class="mh">0xF3</span><span class="p">):</span>   <span class="c1"># &lt;song select msg&gt; ::= F3 &lt;data singlet&gt;</span>
            <span class="c1"># E = [&#39;song_select&#39;, time, struct.unpack(&#39;&gt;B&#39;,trackdata.pop(0))[0]]</span>
            <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;song_select&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">trackdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">trackdata</span> <span class="o">=</span> <span class="n">trackdata</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="c1"># DTime, Thing (what?! song number?  whatever ...)</span>

        <span class="k">elif</span> <span class="p">(</span><span class="n">first_byte</span> <span class="o">==</span> <span class="mh">0xF6</span><span class="p">):</span>   <span class="c1"># DTime</span>
            <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tune_request&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">]</span>
            <span class="c1"># What would a tune request be doing in a MIDI /file/?</span>

        <span class="c1">#########################################################</span>
        <span class="c1"># ADD MORE META-EVENTS HERE.  TODO:</span>
        <span class="c1"># f1 -- MTC Quarter Frame Message. One data byte follows</span>
        <span class="c1">#     the Status; it&#39;s the time code value, from 0 to 127.</span>
        <span class="c1"># f8 -- MIDI clock.    no data.</span>
        <span class="c1"># fa -- MIDI start.    no data.</span>
        <span class="c1"># fb -- MIDI continue. no data.</span>
        <span class="c1"># fc -- MIDI stop.     no data.</span>
        <span class="c1"># fe -- Active sense.  no data.</span>
        <span class="c1"># f4 f5 f9 fd -- unallocated</span>

            <span class="sa">r</span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        elif (first_byte &gt; 0xF0) { # Some unknown kinda F-series event ####</span>
<span class="sd">            # Here we only produce a one-byte piece of raw data.</span>
<span class="sd">            # But the encoder for &#39;raw_data&#39; accepts any length of it.</span>
<span class="sd">            E = [ &#39;raw_data&#39;,</span>
<span class="sd">                         time, substr(trackdata,Pointer,1) ]</span>
<span class="sd">            # DTime and the Data (in this case, the one Event-byte)</span>
<span class="sd">            ++Pointer;  # itself</span>

<span class="sd">&#39;&#39;&#39;</span>
        <span class="k">elif</span> <span class="n">first_byte</span> <span class="o">&gt;</span> <span class="mh">0xF0</span><span class="p">:</span>  <span class="c1"># Some unknown F-series event</span>
            <span class="c1"># Here we only produce a one-byte piece of raw data.</span>
            <span class="c1"># E = [&#39;raw_data&#39;, time, bytest(trackdata[0])]   # 6.4</span>
            <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;raw_data&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">trackdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>   <span class="c1"># 6.4 6.7</span>
            <span class="n">trackdata</span> <span class="o">=</span> <span class="n">trackdata</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Fallthru.</span>
            <span class="n">_warn</span><span class="p">(</span><span class="s2">&quot;Aborting track.  Command-byte first_byte=&quot;</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">first_byte</span><span class="p">))</span>
            <span class="k">break</span>
        <span class="c1"># End of the big if-group</span>


        <span class="c1">######################################################################</span>
        <span class="c1">#  THE EVENT REGISTRAR...</span>
        <span class="k">if</span> <span class="n">E</span> <span class="ow">and</span>  <span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;end_track&#39;</span><span class="p">):</span>
            <span class="c1"># This is the code for exceptional handling of the EOT event.</span>
            <span class="n">eot</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">no_eot_magic</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">E</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># a null text-event to carry the delta-time</span>
                    <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;text_event&#39;</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">E</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1"># EOT with a delta-time of 0; ignore it.</span>
        
        <span class="k">if</span> <span class="n">E</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">):</span>
            <span class="c1">#if ( $exclusive_event_callback ):</span>
            <span class="c1">#    &amp;{ $exclusive_event_callback }( @E );</span>
            <span class="c1">#else:</span>
            <span class="c1">#    &amp;{ $event_callback }( @E ) if $event_callback;</span>
                <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">eot</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="c1"># End of the big &quot;Event&quot; while-block</span>

    <span class="k">return</span> <span class="n">events</span>


<span class="c1">###########################################################################</span>
<span class="k">def</span> <span class="nf">_encode</span><span class="p">(</span><span class="n">events_lol</span><span class="p">,</span> <span class="n">unknown_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">never_add_eot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
  <span class="n">no_eot_magic</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">no_running_status</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">text_encoding</span><span class="o">=</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">):</span>
    <span class="c1"># encode an event structure, presumably for writing to a file</span>
    <span class="c1"># Calling format:</span>
    <span class="c1">#   $data_r = MIDI::Event::encode( \@event_lol, { options } );</span>
    <span class="c1"># Takes a REFERENCE to an event structure (a LoL)</span>
    <span class="c1"># Returns an (unblessed) REFERENCE to track data.</span>

    <span class="c1"># If you want to use this to encode a /single/ event,</span>
    <span class="c1"># you still have to do it as a reference to an event structure (a LoL)</span>
    <span class="c1"># that just happens to have just one event.  I.e.,</span>
    <span class="c1">#   encode( [ $event ] ) or encode( [ [ &#39;note_on&#39;, 100, 5, 42, 64] ] )</span>
    <span class="c1"># If you&#39;re doing this, consider the never_add_eot track option, as in</span>
    <span class="c1">#   print MIDI ${ encode( [ $event], { &#39;never_add_eot&#39; =&gt; 1} ) };</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># what I&#39;ll store the chunks of byte-data in</span>

    <span class="c1"># This is so my end_track magic won&#39;t corrupt the original</span>
    <span class="n">events</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">events_lol</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">never_add_eot</span><span class="p">:</span>
        <span class="c1"># One way or another, tack on an &#39;end_track&#39;</span>
        <span class="k">if</span> <span class="n">events</span><span class="p">:</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">last</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;end_track&#39;</span><span class="p">):</span>  <span class="c1"># no end_track already</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">last</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;text_event&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">last</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="c1"># 0-length text event at track-end.</span>
                    <span class="k">if</span> <span class="n">no_eot_magic</span><span class="p">:</span>
                        <span class="c1"># Exceptional case: don&#39;t mess with track-final</span>
                        <span class="c1"># 0-length text_events; just peg on an end_track</span>
                        <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;end_track&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># NORMAL CASE: replace with an end_track, leaving DTime</span>
                        <span class="n">last</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;end_track&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># last event was neither 0-length text_event nor end_track</span>
                    <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;end_track&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># an eventless track!</span>
            <span class="n">events</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;end_track&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">],]</span>

    <span class="c1"># maybe_running_status = not no_running_status # unused? 4.7</span>
    <span class="n">last_status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">for</span> <span class="n">event_r</span> <span class="ow">in</span> <span class="p">(</span><span class="n">events</span><span class="p">):</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">event_r</span><span class="p">)</span>
        <span class="c1"># otherwise the shifting&#39;d corrupt the original</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">E</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">event</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="n">dtime</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="c1"># print(&#39;event=&#39;+str(event)+&#39; dtime=&#39;+str(dtime))</span>

        <span class="n">event_data</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="p">(</span>   <span class="c1"># MIDI events -- eligible for running status</span>
             <span class="n">event</span>    <span class="o">==</span> <span class="s1">&#39;note_on&#39;</span>
             <span class="ow">or</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;note_off&#39;</span>
             <span class="ow">or</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;control_change&#39;</span>
             <span class="ow">or</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;key_after_touch&#39;</span>
             <span class="ow">or</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;patch_change&#39;</span>
             <span class="ow">or</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;channel_after_touch&#39;</span>
             <span class="ow">or</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;pitch_wheel_change&#39;</span>  <span class="p">):</span>

            <span class="c1"># This block is where we spend most of the time.  Gotta be tight.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;note_off&#39;</span><span class="p">):</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span>
                <span class="n">parameters</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;BB&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">&amp;</span><span class="mh">0x7F</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">&amp;</span><span class="mh">0x7F</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;note_on&#39;</span><span class="p">):</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mh">0x90</span> <span class="o">|</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span>
                <span class="n">parameters</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;BB&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">&amp;</span><span class="mh">0x7F</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">&amp;</span><span class="mh">0x7F</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;key_after_touch&#39;</span><span class="p">):</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mh">0xA0</span> <span class="o">|</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span>
                <span class="n">parameters</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;BB&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">&amp;</span><span class="mh">0x7F</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">&amp;</span><span class="mh">0x7F</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;control_change&#39;</span><span class="p">):</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mh">0xB0</span> <span class="o">|</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span>
                <span class="n">parameters</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;BB&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">&amp;</span><span class="mh">0xFF</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">&amp;</span><span class="mh">0xFF</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;patch_change&#39;</span><span class="p">):</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mh">0xC0</span> <span class="o">|</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span>
                <span class="n">parameters</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;B&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;channel_after_touch&#39;</span><span class="p">):</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mh">0xD0</span> <span class="o">|</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span>
                <span class="n">parameters</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;B&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;pitch_wheel_change&#39;</span><span class="p">):</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mh">0xE0</span> <span class="o">|</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span>
                <span class="n">parameters</span> <span class="o">=</span>  <span class="n">_write_14_bit</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mh">0x2000</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_warn</span><span class="p">(</span><span class="s2">&quot;BADASS FREAKOUT ERROR 31415!&quot;</span><span class="p">)</span>

            <span class="c1"># And now the encoding</span>
            <span class="c1"># w = BER compressed integer (not ASN.1 BER, see perlpacktut for</span>
            <span class="c1"># details).  Its bytes represent an unsigned integer in base 128,</span>
            <span class="c1"># most significant digit first, with as few digits as possible.</span>
            <span class="c1"># Bit eight (the high bit) is set on each byte except the last.</span>

            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_ber_compressed_int</span><span class="p">(</span><span class="n">dtime</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">last_status</span><span class="p">)</span> <span class="ow">or</span> <span class="n">no_running_status</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;B&#39;</span><span class="p">,</span> <span class="n">status</span><span class="p">))</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
 
            <span class="n">last_status</span> <span class="o">=</span> <span class="n">status</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Not a MIDI event.</span>
            <span class="c1"># All the code in this block could be more efficient,</span>
            <span class="c1"># but this is not where the code needs to be tight.</span>
            <span class="c1"># print &quot;zaz $event\n&quot;;</span>
            <span class="n">last_status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

            <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;raw_meta_event&#39;</span><span class="p">:</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">_some_text_event</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">E</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">text_encoding</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;set_sequence_number&#39;</span><span class="p">):</span>  <span class="c1"># 3.9</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xFF\x00\x02</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">_int2twobytes</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="c1"># Text meta-events...</span>
            <span class="c1"># a case for a dict, I think (pjb) ...</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;text_event&#39;</span><span class="p">):</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">_some_text_event</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">text_encoding</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;copyright_text_event&#39;</span><span class="p">):</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">_some_text_event</span><span class="p">(</span><span class="mh">0x02</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">text_encoding</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;track_name&#39;</span><span class="p">):</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">_some_text_event</span><span class="p">(</span><span class="mh">0x03</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">text_encoding</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;instrument_name&#39;</span><span class="p">):</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">_some_text_event</span><span class="p">(</span><span class="mh">0x04</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">text_encoding</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;lyric&#39;</span><span class="p">):</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">_some_text_event</span><span class="p">(</span><span class="mh">0x05</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">text_encoding</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;marker&#39;</span><span class="p">):</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">_some_text_event</span><span class="p">(</span><span class="mh">0x06</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">text_encoding</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;cue_point&#39;</span><span class="p">):</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">_some_text_event</span><span class="p">(</span><span class="mh">0x07</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">text_encoding</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;text_event_08&#39;</span><span class="p">):</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">_some_text_event</span><span class="p">(</span><span class="mh">0x08</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">text_encoding</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;text_event_09&#39;</span><span class="p">):</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">_some_text_event</span><span class="p">(</span><span class="mh">0x09</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">text_encoding</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;text_event_0a&#39;</span><span class="p">):</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">_some_text_event</span><span class="p">(</span><span class="mh">0x0A</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">text_encoding</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;text_event_0b&#39;</span><span class="p">):</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">_some_text_event</span><span class="p">(</span><span class="mh">0x0B</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">text_encoding</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;text_event_0c&#39;</span><span class="p">):</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">_some_text_event</span><span class="p">(</span><span class="mh">0x0C</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">text_encoding</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;text_event_0d&#39;</span><span class="p">):</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">_some_text_event</span><span class="p">(</span><span class="mh">0x0D</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">text_encoding</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;text_event_0e&#39;</span><span class="p">):</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">_some_text_event</span><span class="p">(</span><span class="mh">0x0E</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">text_encoding</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;text_event_0f&#39;</span><span class="p">):</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">_some_text_event</span><span class="p">(</span><span class="mh">0x0F</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">text_encoding</span><span class="p">)</span>
            <span class="c1"># End of text meta-events</span>

            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;end_track&#39;</span><span class="p">):</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xFF\x2F\x00</span><span class="s2">&quot;</span>

            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;set_tempo&#39;</span><span class="p">):</span>
                <span class="c1">#event_data = struct.pack(&quot;&gt;BBwa*&quot;, 0xFF, 0x51, 3,</span>
                <span class="c1">#              substr( struct.pack(&#39;&gt;I&#39;, E[0]), 1, 3))</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xFF\x51\x03</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;I&#39;</span><span class="p">,</span><span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;smpte_offset&#39;</span><span class="p">):</span>
                <span class="c1"># event_data = struct.pack(&quot;&gt;BBwBBBBB&quot;, 0xFF, 0x54, 5, E[0:5] )</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;BBBbBBBB&quot;</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span><span class="mh">0x54</span><span class="p">,</span><span class="mh">0x05</span><span class="p">,</span><span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">E</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">E</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">E</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">E</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;time_signature&#39;</span><span class="p">):</span>
                <span class="c1"># event_data = struct.pack(&quot;&gt;BBwBBBB&quot;,  0xFF, 0x58, 4, E[0:4] )</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;BBBbBBB&quot;</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">E</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">E</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">E</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;key_signature&#39;</span><span class="p">):</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;BBBbB&quot;</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">E</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;sequencer_specific&#39;</span><span class="p">):</span>
                <span class="c1"># event_data = struct.pack(&quot;&gt;BBwa*&quot;, 0xFF,0x7F, len(E[0]), E[0])</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">_some_text_event</span><span class="p">(</span><span class="mh">0x7F</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">text_encoding</span><span class="p">)</span>
            <span class="c1"># End of Meta-events</span>

            <span class="c1"># Other Things...</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;sysex_f0&#39;</span><span class="p">):</span>
                 <span class="c1">#event_data = struct.pack(&quot;&gt;Bwa*&quot;, 0xF0, len(E[0]), E[0])</span>
                 <span class="c1">#B=bitstring w=BER-compressed-integer a=null-padded-ascii-str</span>
                 <span class="n">event_data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xF0</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">+</span><span class="n">_ber_compressed_int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">+</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;sysex_f7&#39;</span><span class="p">):</span>
                 <span class="c1">#event_data = struct.pack(&quot;&gt;Bwa*&quot;, 0xF7, len(E[0]), E[0])</span>
                 <span class="n">event_data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xF7</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">+</span><span class="n">_ber_compressed_int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">+</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;song_position&#39;</span><span class="p">):</span>
                 <span class="n">event_data</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xF2</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">_write_14_bit</span><span class="p">(</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;song_select&#39;</span><span class="p">):</span>
                 <span class="n">event_data</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;BB&#39;</span><span class="p">,</span> <span class="mh">0xF3</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;tune_request&#39;</span><span class="p">):</span>
                 <span class="n">event_data</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xF6</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;raw_data&#39;</span><span class="p">):</span>
                <span class="n">_warn</span><span class="p">(</span><span class="s2">&quot;_encode: raw_data event not supported&quot;</span><span class="p">)</span>
                <span class="c1"># event_data = E[0]</span>
                <span class="k">continue</span>
            <span class="c1"># End of Other Stuff</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># The Big Fallthru</span>
                <span class="k">if</span> <span class="n">unknown_callback</span><span class="p">:</span>
                    <span class="c1"># push(@data, &amp;{ $unknown_callback }( @$event_r ))</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_warn</span><span class="p">(</span><span class="s2">&quot;Unknown event: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
                    <span class="c1"># To surpress complaint here, just set</span>
                    <span class="c1">#  &#39;unknown_callback&#39; =&gt; sub { return () }</span>
                <span class="k">continue</span>

            <span class="c1">#print &quot;Event $event encoded part 2\n&quot;</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">event_data</span><span class="p">))</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;&#39;str&#39;&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">event_data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;Latin1&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">event_data</span><span class="p">):</span> <span class="c1"># how could $event_data be empty</span>
                <span class="c1"># data.append(struct.pack(&#39;&gt;wa*&#39;, dtime, event_data))</span>
                <span class="c1"># print(&#39; event_data=&#39;+str(event_data))</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_ber_compressed_int</span><span class="p">(</span><span class="n">dtime</span><span class="p">)</span><span class="o">+</span><span class="n">event_data</span><span class="p">)</span>

    <span class="k">return</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="c1">###################################################################################</span>
<span class="c1">###################################################################################</span>
<span class="c1">###################################################################################</span>
<span class="c1">#</span>
<span class="c1">#	Tegridy MIDI Module (TMIDI / tee-midi)</span>
<span class="c1">#	Version 1.4</span>
<span class="c1">#</span>
<span class="c1">#	Based upon and includes the amazing MIDI.py module v.6.7. by Peter Billam</span>
<span class="c1">#	pjb.com.au</span>
<span class="c1">#</span>
<span class="c1">#	Project Los Angeles</span>
<span class="c1">#	Tegridy Code 2021</span>
<span class="c1"># https://github.com/Tegridy-Code/Project-Los-Angeles</span>
<span class="c1">#</span>
<span class="c1">###################################################################################</span>
<span class="c1">###################################################################################</span>
<span class="c1">###################################################################################</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">import</span> <span class="nn">copy</span>

<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">import</span> <span class="nn">secrets</span>

<span class="kn">import</span> <span class="nn">pickle</span>

<span class="kn">import</span> <span class="nn">csv</span>

<span class="kn">import</span> <span class="nn">tqdm</span>

<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">zip_longest</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">groupby</span>

<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">itemgetter</span>

<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>

<span class="c1"># from collections import defaultdict</span>

<span class="c1">###################################################################################</span>

<span class="k">def</span> <span class="nf">Tegridy_MIDI_Processor</span><span class="p">(</span><span class="n">MIDI_file</span><span class="p">,</span> 
                          <span class="n">MIDI_channel</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                          <span class="n">time_denominator</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                          <span class="n">transpose_all_notes_by_this_many_pitches</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                          <span class="n">flip_notes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                          <span class="n">randomize_notes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                          <span class="n">randremove_notes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                          <span class="n">MIDI_patch</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">73</span><span class="p">],</span>
                          <span class="n">voble</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Tegridy MIDI Processor</span>

<span class="sd">    Input: A single MIDI file.</span>
<span class="sd">           Desired MIDI channel to process. Def. = 0. All but drums = -1 and all channels = 16</span>
<span class="sd">           Notes/Chords timings divider (denominator).</span>

<span class="sd">    Output: A list of MIDI chords and a list of melody notes.</span>
<span class="sd">    MIDI Chords: Sorted by pitch (chord[0] == highest pitch).</span>
<span class="sd">    Melody Notes: Sorted by start time.</span>

<span class="sd">    Format: MIDI.py Score Events format.</span>

<span class="sd">    Default precision: 1 ms per note/chord.</span>

<span class="sd">    Enjoy! :)</span>

<span class="sd">    Project Los Angeles</span>
<span class="sd">    Tegridy Code 2020&#39;&#39;&#39;</span>

<span class="c1">###########</span>

    <span class="n">minimum_number_of_notes_per_chord</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># Must be 2 or more...</span>

    <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1">###########</span>

    <span class="n">average_note_pitch</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">min_note</span> <span class="o">=</span> <span class="mi">127</span>
    <span class="n">max_note</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">files_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">ev</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">chords_list_final</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">chords_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">events_matrix</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">melody</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">melody1</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">itrack</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">min_note</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">max_note</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ev</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">patch</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">score</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">rec_event</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1">###########    </span>

    <span class="k">def</span> <span class="nf">list_average</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
      <span class="n">sum_num</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">num</span><span class="p">:</span>
          <span class="n">sum_num</span> <span class="o">=</span> <span class="n">sum_num</span> <span class="o">+</span> <span class="n">t</span>           

      <span class="n">avg</span> <span class="o">=</span> <span class="n">sum_num</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">avg</span>

<span class="c1">###########</span>

    <span class="c1">#print(&#39;Loading MIDI file...&#39;)</span>
    <span class="n">midi_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">MIDI_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Processing File:&#39;</span><span class="p">,</span> <span class="n">file_address</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
      <span class="n">opus</span> <span class="o">=</span> <span class="n">midi2opus</span><span class="p">(</span><span class="n">midi_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    
    <span class="k">except</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Bad file. Skipping...&#39;</span><span class="p">)</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;File name:&#39;</span><span class="p">,</span> <span class="n">MIDI_file</span><span class="p">)</span>
      <span class="n">midi_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">chords_list</span><span class="p">,</span> <span class="n">melody</span>
         
    <span class="n">midi_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">score1</span> <span class="o">=</span> <span class="n">to_millisecs</span><span class="p">(</span><span class="n">opus</span><span class="p">)</span>
    <span class="n">score2</span> <span class="o">=</span> <span class="n">opus2score</span><span class="p">(</span><span class="n">score1</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">MIDI_channel</span> <span class="o">==</span> <span class="mi">16</span><span class="p">:</span> <span class="c1"># Process all MIDI channels</span>
      <span class="n">score</span> <span class="o">=</span> <span class="n">score2</span>
    
    <span class="k">if</span> <span class="n">MIDI_channel</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">MIDI_channel</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">:</span> <span class="c1"># Process only a selected single MIDI channel</span>
      <span class="n">score</span> <span class="o">=</span> <span class="n">grep</span><span class="p">(</span><span class="n">score2</span><span class="p">,</span> <span class="p">[</span><span class="n">MIDI_channel</span><span class="p">])</span>
    
    <span class="k">if</span> <span class="n">MIDI_channel</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># Process all channels except drums (except channel 9)</span>
      <span class="n">score</span> <span class="o">=</span> <span class="n">grep</span><span class="p">(</span><span class="n">score2</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">])</span>   
    
    <span class="c1">#print(&#39;Reading all MIDI events from the MIDI file...&#39;)</span>
    <span class="k">while</span> <span class="n">itrack</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">):</span>
      <span class="n">chords_list_track</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">score</span><span class="p">[</span><span class="n">itrack</span><span class="p">]:</span>
        <span class="n">chords_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;patch_change&#39;</span><span class="p">:</span>
          <span class="n">patch</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> 
        <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note&#39;</span> <span class="ow">and</span> <span class="n">patch</span> <span class="ow">in</span> <span class="n">MIDI_patch</span><span class="p">:</span>
          <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span> <span class="c1"># Checking for bad notes...</span>
              <span class="n">rec_event</span> <span class="o">=</span> <span class="n">event</span>
              <span class="n">rec_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">voble</span><span class="p">)</span> <span class="o">/</span> <span class="n">time_denominator</span><span class="p">)</span>
              <span class="n">rec_event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">voble</span><span class="p">)</span> <span class="o">/</span> <span class="n">time_denominator</span><span class="p">)</span>
              <span class="n">rec_event</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="n">voble</span><span class="p">)</span>

              <span class="k">if</span> <span class="n">transpose_all_notes_by_this_many_pitches</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">rec_event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">transpose_all_notes_by_this_many_pitches</span><span class="p">))</span>

              <span class="k">if</span> <span class="n">flip_notes</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">flip_notes</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                  <span class="n">rec_event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">127</span> <span class="o">-</span> <span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
                
                <span class="k">if</span> <span class="n">flip_notes</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                  <span class="n">rec_event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">0</span> <span class="o">-</span> <span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>

              <span class="k">if</span> <span class="n">randomize_notes</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">rec_event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">randomize_notes</span><span class="p">))</span>

              <span class="k">if</span> <span class="n">randremove_notes</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">rec_event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="n">randremove_notes</span> <span class="o">*</span> <span class="n">secrets</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="n">randremove_notes</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">randremove_notes</span><span class="p">])))</span>

              <span class="n">events_matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rec_event</span><span class="p">)</span>

              <span class="n">min_note</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">min_note</span><span class="p">,</span> <span class="n">rec_event</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
              <span class="n">max_note</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">max_note</span><span class="p">,</span> <span class="n">rec_event</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>          
              
              <span class="n">ev</span> <span class="o">+=</span> <span class="mi">1</span>
      
      <span class="n">itrack</span> <span class="o">+=</span><span class="mi">1</span> <span class="c1"># Going to next track...</span>
  
    <span class="c1">#print(&#39;Doing some heavy pythonic sorting...Please stand by...&#39;)</span>

    <span class="c1">#print(&#39;Removing zero pitches and zero velocities events&#39;)</span>
    <span class="n">events_matrix1</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">events_matrix</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="c1"># removing zero pitches and zero velocities events</span>
    <span class="n">events_matrix</span> <span class="o">=</span> <span class="n">events_matrix1</span>
    <span class="n">events_matrix1</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events_matrix</span><span class="p">:</span>
      <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
      <span class="n">event1</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">event</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
      <span class="n">events_matrix1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event1</span><span class="p">)</span>

    <span class="n">events_matrix</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">events_matrix</span> <span class="o">=</span> <span class="n">events_matrix1</span> 

    <span class="c1">#print(&#39;Sorting input by start time...&#39;)</span>
    <span class="n">events_matrix</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Sorting input by start time</span>

    <span class="c1">#print(&#39;Grouping by start time. This will take a while...&#39;)</span>
    <span class="n">values</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">events_matrix</span><span class="p">))</span> <span class="c1"># Non-multithreaded function version just in case</span>

    <span class="n">groups</span> <span class="o">=</span> <span class="p">[[</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">events_matrix</span> <span class="k">if</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="n">x</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span> <span class="c1"># Grouping notes into chords while discarting bad notes...</span>
    
    <span class="n">chords_list1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1">#print(&#39;Removing single note/excessive events, sorting events by pitch, and creating a chords list...&#39;)</span>
    <span class="k">for</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span> 
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">minimum_number_of_notes_per_chord</span><span class="p">:</span> <span class="c1"># Removing single note events</span>
        <span class="n">items</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="c1"># Sorting events by pitch</span>
        <span class="n">chords_list1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="c1"># Creating final chords list</span>

    <span class="c1">#print(&#39;Removing duplicate pitches from chords and creating a final chords list...&#39;)</span>
    <span class="n">chords_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">chord</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">chord1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">chord2</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">chord</span> <span class="ow">in</span> <span class="n">chords_list1</span><span class="p">:</span>
      <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
      <span class="n">chord1</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">chord</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">])]</span>
      <span class="n">chord2</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">chord1</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">]</span> <span class="c1"># Removing bad note events from chords</span>
      <span class="n">chords_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chord2</span><span class="p">)</span>

    <span class="n">chords_list_track</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">chords_list</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="p">[]]</span>

    <span class="n">chords_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">chords_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">chords_list_track</span><span class="p">)</span>

    <span class="c1">#print(&#39;Extracting melody...&#39;)</span>
    <span class="n">melody_list</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1">#print(&#39;Sorting events...&#39;)</span>
    <span class="k">for</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
        <span class="n">items</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="c1"># Sorting events by pitch </span>
        <span class="n">melody_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="c1"># Creating final chords list</span>
    
    <span class="c1">#print(&#39;Removing duplicates if any...&#39;)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">melody_list</span><span class="p">:</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">mel</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">item</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
        <span class="n">melody1</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">mel</span><span class="p">)</span>
    
    <span class="c1">#print(&#39;Removing bad notes if any...&#39;)    </span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">melody1</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
          <span class="n">melody</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    
    <span class="c1">#print(&#39;Final sorting by start time...&#39;)      </span>
    <span class="n">melody</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Sorting events by start time</span>
      
    <span class="k">return</span> <span class="n">chords_list</span><span class="p">,</span> <span class="n">melody</span>

<span class="c1">###################################################################################</span>

<span class="k">def</span> <span class="nf">Tegridy_Chords_Converter</span><span class="p">(</span><span class="n">chords_list</span><span class="p">,</span> <span class="n">melody_list</span><span class="p">,</span> <span class="n">song_name</span><span class="p">,</span> <span class="n">melody_notes_in_chords</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
  <span class="sd">&#39;&#39;&#39;Tegridy Chords Coverter</span>

<span class="sd">  Inputs: Tegridy MIDI chords_list (as is)</span>

<span class="sd">          Tegridy MIDI melody_list (as is)</span>

<span class="sd">          Name of the song as plain string</span>

<span class="sd">          Include or exclude melody notes in each chord. Def. is to include.</span>


<span class="sd">  Outputs: Converted chords_list with melody_notes and song name</span>

<span class="sd">           Converted melody_list with song name</span>

<span class="sd">  Project Los Angeles</span>
<span class="sd">  Tegridy Code 2020&#39;&#39;&#39;</span>

  <span class="n">temp_chords_list</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">chords_list_final</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">melody_list_final</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="n">temp_chords_list</span> <span class="o">=</span> <span class="p">[[</span><span class="n">song_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
  <span class="n">melody_list_final</span> <span class="o">=</span> <span class="p">[</span><span class="n">song_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

  <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>

  <span class="k">for</span> <span class="n">notez</span> <span class="ow">in</span> <span class="n">melody_list</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">melody_notes_in_chords</span><span class="p">:</span>
      <span class="n">temp_chords_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">notez</span><span class="p">])</span>
    <span class="n">melody_list_final</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">notez</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">chord</span> <span class="ow">in</span> <span class="n">chords_list</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">notez</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">chord</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">temp_chords_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chord</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
  
  <span class="sd">&#39;&#39;&#39;# Gonna use a dic here to join chords by start-time :)</span>
<span class="sd">  record_dict = defaultdict(list)</span>

<span class="sd">  for chords in temp_chords_list:</span>
<span class="sd">    if len(chords) &gt; 0:</span>
<span class="sd">      record_dict[chords[0][1]].extend(chords)</span>

<span class="sd">  temp_chords_list = list(record_dict.values())&#39;&#39;&#39;</span>

  <span class="n">chords_list_final</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="c1">#print(&#39;Sorting chords notes by pitch/removing empty chords if any...&#39;)</span>
  <span class="n">chords_list_final</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_chords_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  <span class="k">for</span> <span class="n">chordz</span> <span class="ow">in</span> <span class="n">temp_chords_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chordz</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">chordz</span><span class="p">)</span>
      <span class="n">chordz</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="c1"># Sorting events by pitch </span>
      <span class="n">chords_list_final</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chordz</span><span class="p">)</span> <span class="c1"># Creating final chords list      </span>

  <span class="n">chords_list_final</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="n">song_name</span> <span class="o">+</span> <span class="s1">&#39;_with_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chords_list_final</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_Chords&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">chords_list_final</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
  <span class="n">melody_list_final</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">song_name</span> <span class="o">+</span> <span class="s1">&#39;_with_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">melody_list_final</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_Notes&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">melody_list_final</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
  <span class="n">chords_list_final</span><span class="o">.</span><span class="n">append</span><span class="p">([[</span><span class="s1">&#39;song_end&#39;</span><span class="p">,</span> <span class="n">chords_list_final</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">chords_list_final</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
  <span class="n">melody_list_final</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;song_end&#39;</span><span class="p">,</span> <span class="n">melody_list_final</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">melody_list_final</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>     
  <span class="n">first_song</span> <span class="o">=</span> <span class="kc">False</span>
    
  <span class="k">return</span> <span class="n">chords_list_final</span><span class="p">,</span> <span class="n">melody_list_final</span>

<span class="c1">###################################################################################</span>

<span class="k">def</span> <span class="nf">Tegridy_MIDI_TXT_Processor</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">,</span>
                              <span class="n">converted_chords_list</span><span class="p">,</span>
                              <span class="n">converted_melody_list</span><span class="p">,</span>
                              <span class="n">simulate_velocity</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">line_by_line_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">represent_every_number_of_chords</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                              <span class="n">chords_duration_multiplier</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                              <span class="n">pad_chords_with_stops</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">chords_beat_divider</span> <span class="o">=</span> <span class="mi">100</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Tegridy MIDI to TXT Processor</span>
<span class="sd">     </span>
<span class="sd">     Input: Dataset name</span>
<span class="sd">            Tegridy MIDI chords_list and melody_list (as is)</span>
<span class="sd">            Simulate velocity or not</span>
<span class="sd">            Line-by-line switch (useful for the AI models tokenizers and other specific purposes)</span>
<span class="sd">            Represent events every so many steps. Def. is 0. == do not represent.</span>
<span class="sd">            Chords durations multiplier. Def. = 1</span>
<span class="sd">            Pad chords with timed rests or not. Helps with some NLP implementations</span>
<span class="sd">            Chords beat divider/denominator. This essentially creates a beat for AI models to keep in mind. Default is 100 = 10 beats per second.</span>

<span class="sd">     Output: TXT encoded MIDI events as plain txt/plain str</span>
<span class="sd">             Number of processed chords</span>
<span class="sd">             Number of bad/skipped chords (for whatever reason)</span>

<span class="sd">     Project Los Angeles</span>
<span class="sd">     Tegridy Code 2020&#39;&#39;&#39;</span>

    <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">song_chords_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">number_of_chords_recorded</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">number_of_bad_chords_recorded</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">chord_start_time</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">first_song</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">rpz</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">previous_start_time</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">beat</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">dataset_name</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
      <span class="n">TXT_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">TXT_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    
    <span class="k">if</span> <span class="n">line_by_line_output</span><span class="p">:</span>
      <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>  

    <span class="k">for</span> <span class="n">chord</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">auto</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">converted_chords_list</span><span class="p">):</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">chord</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">:</span>
          <span class="n">song_dur</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chord</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chord</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
          <span class="n">durs_chord</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">chord</span><span class="p">))[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">chords_duration_multiplier</span><span class="p">)</span>
          <span class="n">chord_duration</span> <span class="o">=</span> <span class="n">durs_chord</span>
        
        <span class="k">else</span><span class="p">:</span>      
          <span class="n">chord_duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chord</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">chords_duration_multiplier</span><span class="p">)</span>
          
        <span class="k">if</span> <span class="n">simulate_velocity</span><span class="p">:</span>
          <span class="n">chord_velocity</span> <span class="o">=</span> <span class="n">chord</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>  
          <span class="n">chord_velocity</span> <span class="o">=</span> <span class="n">chord</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">chord_start_time</span> <span class="o">=</span> <span class="n">chord</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> 
        <span class="k">if</span> <span class="n">chord_duration</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">chord_velocity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
          <span class="k">if</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">(</span><span class="n">chord</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;song_end&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">first_song</span><span class="p">:</span>
              <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39;SONG=END_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">song_chords_count</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_Chords&#39;</span>
              <span class="k">if</span> <span class="n">line_by_line_output</span><span class="p">:</span>
                <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
              <span class="k">else</span><span class="p">:</span>  
                <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>

              <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39;SONG=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">chord</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
              <span class="k">if</span> <span class="n">line_by_line_output</span><span class="p">:</span>
                <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
              <span class="k">else</span><span class="p">:</span>  
                <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>
              <span class="n">song_chords_count</span> <span class="o">=</span> <span class="mi">1</span> 
                          
            <span class="k">else</span><span class="p">:</span>  

              <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39;SONG=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">chord</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
              <span class="k">if</span> <span class="n">line_by_line_output</span><span class="p">:</span>
                <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
              <span class="k">else</span><span class="p">:</span>  
                <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>
              <span class="n">song_chords_count</span> <span class="o">=</span> <span class="mi">1</span>  
            
          <span class="k">else</span><span class="p">:</span>
              <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39;SONG=END_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">song_chords_count</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_Chords&#39;</span>
              <span class="k">if</span> <span class="n">line_by_line_output</span><span class="p">:</span>
                <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
              <span class="k">else</span><span class="p">:</span>  
                <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>             

        <span class="k">else</span><span class="p">:</span>
          
          <span class="n">beat</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">chord_start_time</span> <span class="o">-</span> <span class="n">previous_start_time</span><span class="p">)))</span> <span class="o">/</span> <span class="n">chords_beat_divider</span><span class="p">)</span>

          <span class="k">if</span> <span class="n">pad_chords_with_stops</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">chord_start_time</span> <span class="o">-</span> <span class="n">previous_start_time</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
              <span class="n">TXT_string</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">chord_start_time</span> <span class="o">-</span> <span class="n">previous_start_time</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">beat</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
              <span class="k">if</span> <span class="n">line_by_line_output</span><span class="p">:</span>
                <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
              <span class="k">else</span><span class="p">:</span>  
                <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>

          <span class="n">TXT_string</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">chord_start_time</span> <span class="o">-</span> <span class="n">previous_start_time</span><span class="p">)))</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">chord_duration</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">chord</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">chord_velocity</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">beat</span><span class="p">)</span>
          
          
          <span class="n">previous_start_time</span> <span class="o">=</span> <span class="n">chord_start_time</span>
          
          <span class="k">for</span> <span class="n">note</span> <span class="ow">in</span> <span class="n">chord</span><span class="p">:</span>
            <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">note</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">chord_duration</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">note</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">chords_duration_multiplier</span><span class="p">))</span>
          
          <span class="c1"># Representation of events</span>
          <span class="k">if</span> <span class="n">represent_every_number_of_chords</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rpz</span> <span class="o">==</span> <span class="n">represent_every_number_of_chords</span><span class="p">:</span>
              <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">song_dur</span><span class="p">)</span>
              <span class="n">rpz</span> <span class="o">=</span> <span class="mi">0</span>    
          
          <span class="k">if</span> <span class="n">line_by_line_output</span><span class="p">:</span>
            <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
          <span class="k">else</span><span class="p">:</span>  
            <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>
          
          <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">chord</span><span class="p">)</span>

          <span class="n">song_chords_count</span> <span class="o">+=</span> <span class="mi">1</span>
          <span class="n">number_of_chords_recorded</span> <span class="o">+=</span> <span class="mi">1</span>
          <span class="n">rpz</span> <span class="o">+=</span> <span class="mi">1</span>
          
      <span class="k">except</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Bad chord. Skipping...&#39;</span><span class="p">)</span>
        <span class="n">number_of_bad_chords_recorded</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">continue</span>            

    <span class="k">return</span> <span class="n">TXT_string</span><span class="p">,</span> <span class="n">number_of_chords_recorded</span><span class="p">,</span> <span class="n">number_of_bad_chords_recorded</span>

<span class="c1">###################################################################################</span>

<span class="k">def</span> <span class="nf">Tegridy_TXT_MIDI_Processor</span><span class="p">(</span><span class="n">input_string</span><span class="p">,</span> 
                              <span class="n">line_by_line_dataset</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                              <span class="n">dataset_MIDI_events_time_denominator</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                              <span class="n">number_of_ticks_per_quarter</span> <span class="o">=</span> <span class="mi">425</span><span class="p">,</span>
                              <span class="n">start_from_this_generated_event</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                              <span class="n">remove_generated_silence_if_needed</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                              <span class="n">silence_offset_from_start</span> <span class="o">=</span> <span class="mi">75000</span><span class="p">,</span>
                              <span class="n">simulate_velocity</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                              <span class="n">output_signature</span> <span class="o">=</span> <span class="s1">&#39;TMIDI-TXT-MIDI&#39;</span><span class="p">,</span>
                              <span class="n">list_of_MIDI_patches</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]):</span>

    <span class="sd">&#39;&#39;&#39;Tegridy TXT to MIDI Processor</span>
<span class="sd">     </span>
<span class="sd">     Input: Input TXT string in the TMIDI-TXT format</span>
<span class="sd">            Input is line-by-line or one-line</span>
<span class="sd">            Used dataset time denominator</span>
<span class="sd">            Number of ticks per quater for output MIDI</span>
<span class="sd">            Start from this input event (skip this many from start)</span>
<span class="sd">            Is there a generated silence or not</span>
<span class="sd">            Silence offset in MIDI ticks from start</span>
<span class="sd">            Simulate velocity (V = max(Pitch))</span>
<span class="sd">            Output MIDI signature</span>
<span class="sd">            List of 16 desired MIDI patch numbers for the output MIDI. Def. is MuseNet compatible patch list.</span>

<span class="sd">     Output: NOTE: For now only 1st recorded TXT performance converted to MIDI.</span>
<span class="sd">             Raw/binary MIDI data that can be recorded to a file with standard python functions.</span>
<span class="sd">             Detected number of input notes</span>
<span class="sd">             Recorded number of output notes</span>
<span class="sd">             Detailed created MIDI stats in the MIDI.py module format (MIDI.score2stats)</span>

<span class="sd">     Project Los Angeles</span>
<span class="sd">     Tegridy Code 2020&#39;&#39;&#39;</span>

    <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">line_by_line_dataset</span><span class="p">:</span>
      <span class="n">input_string</span> <span class="o">=</span> <span class="n">input_string</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="c1"># for new datasets</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">input_string</span> <span class="o">=</span> <span class="n">input_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="c1"># for compatibility/legacy datasets</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">input_string</span><span class="p">)</span>


    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">z</span><span class="o">=</span><span class="mi">1</span>

    <span class="n">notes_specs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">song_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">previous_chord_start_time</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">number_of_notes_recorded</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">zero_marker</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">song_header</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">song_score</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">start_time</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Converting TXT to MIDI. Please wait...&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_string</span><span class="p">)):</span>
      <span class="k">if</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=END_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SONG&#39;</span><span class="p">:</span>
        <span class="k">break</span>
        <span class="c1">#TODO Record all perfomances (even incomplete ones) as separate tracks in output MIDI</span>

      <span class="k">if</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SONG&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="n">song_name</span> <span class="o">=</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
          <span class="n">song_header</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;track_name&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">song_name</span><span class="p">])</span>
          <span class="n">duration</span> <span class="o">=</span> <span class="mi">1</span>
          <span class="k">continue</span>
        <span class="k">except</span><span class="p">:</span>
          <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unknown Song name format&#39;</span><span class="p">,</span> <span class="n">song_name</span><span class="p">)</span>
          <span class="n">duration</span> <span class="o">=</span> <span class="mi">1</span>
          <span class="k">continue</span>
        
      <span class="k">if</span> <span class="n">duration</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#Skipping rests</span>

        <span class="k">try</span><span class="p">:</span>
          <span class="n">start_time</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">dataset_MIDI_events_time_denominator</span>
          <span class="n">duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">dataset_MIDI_events_time_denominator</span> 
          <span class="n">channel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
          <span class="n">velocity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
          <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unknown Chord:&#39;</span><span class="p">,</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        
        <span class="k">try</span><span class="p">:</span>
          <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">5</span><span class="p">:])):</span>
            <span class="n">notes_specs</span><span class="p">,</span> <span class="n">dur</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">5</span><span class="p">:][</span><span class="n">x</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="n">duration</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">dur</span><span class="p">)</span>
            <span class="n">simulated_velocity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">notes_specs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">simulate_velocity</span><span class="p">:</span>
              <span class="n">song_score</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;note&#39;</span><span class="p">,</span> 
                                  <span class="nb">int</span><span class="p">(</span><span class="n">start_time</span><span class="p">),</span> <span class="c1">#Start Time</span>
                                  <span class="nb">int</span><span class="p">(</span><span class="n">duration</span><span class="p">),</span> <span class="c1">#Duration</span>
                                  <span class="nb">int</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="c1">#Channel</span>
                                  <span class="nb">int</span><span class="p">(</span><span class="n">notes_specs</span><span class="p">),</span> <span class="c1">#Note</span>
                                  <span class="nb">int</span><span class="p">(</span><span class="n">simulated_velocity</span><span class="p">)])</span> <span class="c1">#Velocity              </span>
              <span class="n">number_of_notes_recorded</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>  
              <span class="n">song_score</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;note&#39;</span><span class="p">,</span> 
                                  <span class="nb">int</span><span class="p">(</span><span class="n">start_time</span><span class="p">),</span> <span class="c1">#Start Time</span>
                                  <span class="nb">int</span><span class="p">(</span><span class="n">duration</span><span class="p">),</span> <span class="c1">#Duration</span>
                                  <span class="nb">int</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="c1">#Channel</span>
                                  <span class="nb">int</span><span class="p">(</span><span class="n">notes_specs</span><span class="p">),</span> <span class="c1">#Note</span>
                                  <span class="nb">int</span><span class="p">(</span><span class="n">velocity</span><span class="p">)])</span> <span class="c1">#Velocity              </span>
              <span class="n">number_of_notes_recorded</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span><span class="p">:</span>
          <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unknown Notes: &quot;</span> <span class="o">+</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
          <span class="k">continue</span>

    <span class="k">if</span> <span class="n">remove_generated_silence_if_needed</span><span class="p">:</span>
      <span class="n">song_score1</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="n">note</span> <span class="ow">in</span> <span class="n">song_score</span><span class="p">[</span><span class="n">start_from_this_generated_event</span><span class="p">:]:</span>
        <span class="n">note1</span> <span class="o">=</span> <span class="n">note</span>
        <span class="n">note1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">note</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">silence_offset_from_start</span>
        <span class="n">song_score1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">note1</span><span class="p">)</span>
      <span class="n">song_score</span> <span class="o">=</span> <span class="n">song_score1</span>  

    <span class="n">output_header</span> <span class="o">=</span> <span class="p">[</span><span class="n">number_of_ticks_per_quarter</span><span class="p">,</span> <span class="p">[[</span><span class="s1">&#39;track_name&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">output_signature</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)]]]</span> 
                                                  
    <span class="n">patch_list</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> 
                <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
                <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span>
                <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">4</span><span class="p">]],</span>
                <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">5</span><span class="p">]],</span>
                <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">6</span><span class="p">]],</span>
                <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">7</span><span class="p">]],</span>
                <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">8</span><span class="p">]],</span>
                <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">9</span><span class="p">]],</span>
                <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">10</span><span class="p">]],</span>
                <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">11</span><span class="p">]],</span>
                <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">12</span><span class="p">]],</span>
                <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">13</span><span class="p">]],</span>
                <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">14</span><span class="p">]],</span>
                <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">15</span><span class="p">]]]</span>

    <span class="n">output_song</span> <span class="o">=</span> <span class="n">song_header</span> <span class="o">+</span> <span class="n">song_score</span><span class="p">[</span><span class="n">start_from_this_generated_event</span><span class="p">:]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">output_header</span> <span class="o">+</span> <span class="p">[</span><span class="n">patch_list</span> <span class="o">+</span> <span class="n">output_song</span><span class="p">]</span>

    <span class="n">midi_data</span> <span class="o">=</span> <span class="n">score2midi</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="n">detailed_MIDI_stats</span> <span class="o">=</span> <span class="n">score2stats</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">midi_data</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_string</span><span class="p">),</span> <span class="n">number_of_notes_recorded</span><span class="p">,</span> <span class="n">detailed_MIDI_stats</span>

<span class="c1">###################################################################################</span>

<span class="k">def</span> <span class="nf">Tegridy_TXT_to_INT_Processor</span><span class="p">(</span><span class="n">input_TXT_string</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Tegridy TXT to Intergers Processor</span>
<span class="sd">     </span>
<span class="sd">    Input: Input TXT string in the TMIDI-TXT format</span>

<span class="sd">    Output: List of intergers</span>
<span class="sd">            Decoding dictionary</span>


<span class="sd">    Project Los Angeles</span>
<span class="sd">    Tegridy Code 2020&#39;&#39;&#39;</span>

    <span class="c1"># get vocabulary set</span>
    <span class="n">words</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">input_TXT_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))))</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>

    <span class="c1"># create word-integer encoder/decoder</span>
    <span class="n">word2int</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">))))</span>
    <span class="n">decoding_dictionary</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)),</span> <span class="n">words</span><span class="p">))</span>

    <span class="c1"># encode all words in the string into integers</span>
    <span class="n">output_INT_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">word2int</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">input_TXT_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)]</span>
    
    <span class="k">return</span> <span class="n">output_INT_list</span><span class="p">,</span> <span class="n">decoding_dictionary</span>

<span class="c1">###################################################################################</span>

<span class="k">def</span> <span class="nf">Tegridy_INT_to_TXT_Processor</span><span class="p">(</span><span class="n">input_INT_list</span><span class="p">,</span> <span class="n">decoding_dictionary</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Tegridy Intergers to TXT Processor</span>
<span class="sd">     </span>
<span class="sd">    Input: List of intergers in TMIDI-TXT-INT format</span>
<span class="sd">          Decoding dictionary in TMIDI-TXT-INT format</span>

<span class="sd">    Output: Decoded TXT string in TMIDI-TXT format</span>

<span class="sd">    Project Los Angeles</span>
<span class="sd">    Tegridy Code 2020&#39;&#39;&#39;</span>

    <span class="n">output_TXT_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">decoding_dictionary</span><span class="p">[</span><span class="n">int_</span><span class="p">]</span> <span class="k">for</span> <span class="n">int_</span> <span class="ow">in</span> <span class="n">input_INT_list</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">output_TXT_string</span>

<span class="c1">###################################################################################</span>

<span class="k">def</span> <span class="nf">Tegridy_TXT_to_INT_Converter</span><span class="p">(</span><span class="n">input_TXT_string</span><span class="p">,</span> <span class="n">line_by_line_INT_string</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_INT</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Tegridy TXT to Intergers Converter</span>
<span class="sd">     </span>
<span class="sd">    Input: Input TXT string in the TMIDI-TXT format</span>

<span class="sd">           Type of output TXT INT string: line-by-line or one long string</span>

<span class="sd">           Maximum absolute integer to process. Maximum is inclusive </span>
<span class="sd">           Default = process all integers. This helps to remove outliers/unwanted ints</span>

<span class="sd">    Output: List of pure intergers</span>
<span class="sd">            String of intergers in the specified format: line-by-line or one long string</span>
<span class="sd">            Number of processed integers</span>
<span class="sd">            Number of skipped integers</span>
<span class="sd">    </span>
<span class="sd">    Project Los Angeles</span>
<span class="sd">    Tegridy Code 2021&#39;&#39;&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tegridy TXT to Intergers Converter&#39;</span><span class="p">)</span>

    <span class="n">output_INT_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">npi</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">nsi</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">TXT_List</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_TXT_string</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">TXT_List</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">max_INT</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">char</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="n">max_INT</span><span class="p">:</span>
          <span class="n">output_INT_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">char</span><span class="p">))</span>
          <span class="n">npi</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">nsi</span> <span class="o">+=</span> <span class="mi">1</span>  
      <span class="k">else</span><span class="p">:</span>
        <span class="n">output_INT_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">char</span><span class="p">))</span>
        <span class="n">npi</span> <span class="o">+=</span> <span class="mi">1</span>    
    
    <span class="k">if</span> <span class="n">line_by_line_INT_string</span><span class="p">:</span>
      <span class="n">output_INT_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">output_INT_list</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">output_INT_string</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">output_INT_list</span><span class="p">])</span>  

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Converted TXT to INTs:&#39;</span><span class="p">,</span> <span class="n">npi</span><span class="p">,</span> <span class="s1">&#39; / &#39;</span><span class="p">,</span> <span class="n">nsi</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output_INT_list</span><span class="p">,</span> <span class="n">output_INT_string</span><span class="p">,</span> <span class="n">npi</span><span class="p">,</span> <span class="n">nsi</span>

<span class="c1">###################################################################################</span>

<span class="k">def</span> <span class="nf">Tegridy_INT_to_TXT_Converter</span><span class="p">(</span><span class="n">input_INT_list</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Tegridy Intergers to TXT Converter</span>
<span class="sd">     </span>
<span class="sd">    Input: List of intergers in TMIDI-TXT-INT format</span>
<span class="sd">    Output: Decoded TXT string in TMIDI-TXT format</span>
<span class="sd">    Project Los Angeles</span>
<span class="sd">    Tegridy Code 2020&#39;&#39;&#39;</span>

    <span class="n">output_TXT_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">input_INT_list</span><span class="p">:</span>
      <span class="n">output_TXT_string</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">output_TXT_string</span>

<span class="c1">###################################################################################</span>

<span class="k">def</span> <span class="nf">Tegridy_INT_String_to_TXT_Converter</span><span class="p">(</span><span class="n">input_INT_String</span><span class="p">,</span> <span class="n">line_by_line_input</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Tegridy Intergers String to TXT Converter</span>
<span class="sd">     </span>
<span class="sd">    Input: List of intergers in TMIDI-TXT-INT-String format</span>
<span class="sd">    Output: Decoded TXT string in TMIDI-TXT format</span>
<span class="sd">    Project Los Angeles</span>
<span class="sd">    Tegridy Code 2020&#39;&#39;&#39;</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tegridy Intergers String to TXT Converter&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">line_by_line_input</span><span class="p">:</span>
      <span class="n">input_string</span> <span class="o">=</span> <span class="n">input_INT_String</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">input_string</span> <span class="o">=</span> <span class="n">input_INT_String</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>  

    <span class="n">output_TXT_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">input_string</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">output_TXT_string</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
      <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Bad note:&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="k">continue</span>  
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done!&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output_TXT_string</span>

<span class="c1">###################################################################################</span>

<span class="k">def</span> <span class="nf">Tegridy_TXT_Reducer</span><span class="p">(</span><span class="n">input_string</span><span class="p">,</span> 
                        <span class="n">line_by_line_input_dataset</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="n">line_by_line_output_dataset</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="n">include_MIDI_channels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">include_notes_velocities</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">char_encoding_offset</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
                        <span class="n">include_beat</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Tegridy TXT Reducer</span>
<span class="sd">     </span>
<span class="sd">    Input: Input TXT string in the TMIDI-TXT format</span>
<span class="sd">           Input dataset type</span>
<span class="sd">           Output dataset type</span>
<span class="sd">           Dataset MIDI events time divider/denominator</span>
<span class="sd">           Reduce MIDI channels or not (False = savings on AI token memory)</span>
<span class="sd">           Reduce Note&#39;s velocities or not (False = savings on AI token memory)</span>
<span class="sd">           Char encoding offset. This is to prevent ambiguity with sys chars like \n.</span>

<span class="sd">    Output: Reduced TXT string in UTF-8 format</span>
<span class="sd">            Number of recorded notes</span>

<span class="sd">    Project Los Angeles</span>
<span class="sd">    Tegridy Code 2020&#39;&#39;&#39;</span>

    <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">line_by_line_input_dataset</span><span class="p">:</span>
      <span class="n">input_string</span> <span class="o">=</span> <span class="n">input_string</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="c1"># for general use</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">input_string</span> <span class="o">=</span> <span class="n">input_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="c1"># for some specific purposes</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">input_string</span><span class="p">)</span>


    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">z</span><span class="o">=</span><span class="mi">1</span>

    <span class="n">notes_specs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">song_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">previous_chord_start_time</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">number_of_notes_recorded</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">zero_marker</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">song_header</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">song_score</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">start_time</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">Output_TXT_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reducing TXT. Please wait...&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">auto</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_string</span><span class="p">))):</span>
      
      <span class="k">if</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;DATASET&#39;</span><span class="p">:</span>
        <span class="n">Output_TXT_string</span> <span class="o">+=</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">continue</span>

      <span class="k">if</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SONG&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;END_&#39;</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">line_by_line_output_dataset</span><span class="p">:</span>
            <span class="n">Output_TXT_string</span> <span class="o">+=</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">continue</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">Output_TXT_string</span> <span class="o">+=</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>  
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">Output_TXT_string</span> <span class="o">+=</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
          <span class="k">continue</span>
        
      <span class="k">try</span><span class="p">:</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">velocity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">beat</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">4</span><span class="p">])</span>
      <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unknown Chord:&#39;</span><span class="p">,</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
      
      <span class="k">try</span><span class="p">:</span>
        <span class="n">chars</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">5</span><span class="p">:])):</span>
          <span class="n">notes_specs</span><span class="p">,</span> <span class="n">dur</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">5</span><span class="p">:][</span><span class="n">x</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
          <span class="n">dura</span> <span class="o">=</span> <span class="n">duration</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">dur</span><span class="p">)</span>
          
          <span class="n">chars</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">start_time</span><span class="p">)</span><span class="o">+</span><span class="n">char_encoding_offset</span><span class="p">)</span> <span class="c1">#Start Time</span>
          <span class="n">chars</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">dura</span><span class="p">)</span><span class="o">+</span><span class="n">char_encoding_offset</span><span class="p">)</span> <span class="c1">#Duration</span>
          
          <span class="k">if</span> <span class="n">include_beat</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">include_MIDI_channels</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">chars</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">beat</span><span class="p">)</span><span class="o">+</span><span class="n">char_encoding_offset</span><span class="p">)</span> <span class="c1">#Beat</span>

          <span class="k">if</span> <span class="n">include_MIDI_channels</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">include_beat</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">chars</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span><span class="o">+</span><span class="n">char_encoding_offset</span><span class="p">)</span> <span class="c1">#Channel</span>

          <span class="n">chars</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">notes_specs</span><span class="p">)</span><span class="o">+</span><span class="n">char_encoding_offset</span><span class="p">)</span> <span class="c1">#Note</span>

          <span class="k">if</span> <span class="n">include_notes_velocities</span><span class="p">:</span>
            <span class="n">chars</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">velocity</span><span class="p">)</span><span class="o">+</span><span class="n">char_encoding_offset</span><span class="p">)</span> <span class="c1">#Velocity</span>
 
          <span class="n">number_of_notes_recorded</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unknown Notes: &quot;</span> <span class="o">+</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">continue</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">Output_TXT_string</span> <span class="o">+=</span> <span class="n">chars</span>
        <span class="k">if</span> <span class="n">line_by_line_output_dataset</span><span class="p">:</span>
          <span class="n">Output_TXT_string</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">Output_TXT_string</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>  

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Task complete! Enjoy :)&#39;</span><span class="p">)</span>
       
    <span class="k">return</span> <span class="n">Output_TXT_string</span><span class="p">,</span> <span class="n">number_of_notes_recorded</span>

<span class="c1">###################################################################################</span>

<span class="k">def</span> <span class="nf">Tegridy_Reduced_TXT_to_Notes_Converter</span><span class="p">(</span><span class="n">Reduced_TXT_String</span><span class="p">,</span>
                                          <span class="n">line_by_line_dataset</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                          <span class="n">has_MIDI_channels</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                          <span class="n">has_velocities</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                          <span class="n">dataset_MIDI_events_time_denominator</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                                          <span class="n">char_encoding_offset</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
                                          <span class="n">save_only_first_composition</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                          <span class="n">dataset_includes_beat</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
                                                            
    <span class="sd">&#39;&#39;&#39;Tegridy Reduced TXT to Notes Converter</span>
<span class="sd">     </span>
<span class="sd">    Input: Input TXT string in the Reduced TMIDI-TXT format</span>
<span class="sd">           Input dataset type</span>
<span class="sd">           Dataset was encoded with MIDI channels info or not</span>
<span class="sd">           Dataset was encoded with note&#39;s velocities info or not</span>
<span class="sd">           Used dataset time denominator/divider. It must match or the timings will be off.</span>
<span class="sd">           Char encoding offset. This is to prevent ambiguity with sys chars like \n.</span>

<span class="sd">    Output: List of notes in MIDI.py Score format (TMIDI SONG format)</span>
<span class="sd">            First SONG= occurence (song name usually)</span>

<span class="sd">    Project Los Angeles</span>
<span class="sd">    Tegridy Code 2020&#39;&#39;&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tegridy Reduced TXT to Notes Converter&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Converting Reduced TXT to Notes list...Please wait...&#39;</span><span class="p">)</span>

    <span class="n">song_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">if</span> <span class="n">line_by_line_dataset</span><span class="p">:</span>
      <span class="n">input_string</span> <span class="o">=</span> <span class="n">Reduced_TXT_String</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">input_string</span> <span class="o">=</span> <span class="n">Reduced_TXT_String</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">line_by_line_dataset</span><span class="p">:</span>
      <span class="n">name_string</span> <span class="o">=</span> <span class="n">Reduced_TXT_String</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">name_string</span> <span class="o">=</span> <span class="n">Reduced_TXT_String</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">name_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SONG&#39;</span><span class="p">:</span>
      <span class="n">song_name</span> <span class="o">=</span> <span class="n">name_string</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">output_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">st</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_string</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
      
      <span class="k">if</span> <span class="n">save_only_first_composition</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SONG&#39;</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;END_&#39;</span> <span class="p">:</span>
            <span class="n">song_name</span> <span class="o">=</span> <span class="n">name_string</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">continue</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>

      <span class="k">try</span><span class="p">:</span>
        <span class="n">istring</span> <span class="o">=</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">has_MIDI_channels</span><span class="o">==</span><span class="kc">False</span> <span class="ow">and</span> <span class="n">has_velocities</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
          <span class="n">step</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="k">if</span> <span class="n">has_MIDI_channels</span><span class="o">==</span><span class="kc">True</span> <span class="ow">and</span> <span class="n">has_velocities</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
          <span class="n">step</span> <span class="o">=</span> <span class="mi">4</span>          
        
        <span class="k">if</span> <span class="n">has_MIDI_channels</span><span class="o">==</span><span class="kc">False</span> <span class="ow">and</span> <span class="n">has_velocities</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
          <span class="n">step</span> <span class="o">=</span> <span class="mi">4</span>  
        
        <span class="k">if</span> <span class="n">has_MIDI_channels</span><span class="o">==</span><span class="kc">True</span> <span class="ow">and</span> <span class="n">has_velocities</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
          <span class="n">step</span> <span class="o">=</span> <span class="mi">5</span>

        <span class="k">if</span> <span class="n">dataset_includes_beat</span><span class="p">:</span>
          <span class="n">step</span> <span class="o">=</span> <span class="n">step</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">dur</span> <span class="o">=</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="o">*</span> <span class="n">dataset_MIDI_events_time_denominator</span>


        <span class="k">if</span> <span class="n">dur</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#Check for rests/zero notes (we are skipping them)</span>

          <span class="n">st</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="o">*</span> <span class="n">dataset_MIDI_events_time_denominator</span>

          <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">istring</span><span class="p">),</span> <span class="n">step</span><span class="p">):</span>
              <span class="k">if</span> <span class="n">has_MIDI_channels</span><span class="o">==</span><span class="kc">True</span> <span class="ow">and</span> <span class="n">has_velocities</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">step</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">istring</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                      <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>       
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;note&#39;</span><span class="p">)</span>

                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="c1"># Start time</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="o">*</span> <span class="n">dataset_MIDI_events_time_denominator</span><span class="p">)</span> <span class="c1"># Duration</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="c1"># Channel</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="c1"># Pitch</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">4</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="c1"># Velocity</span>

                      <span class="n">output_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
              
              <span class="k">if</span> <span class="n">has_MIDI_channels</span><span class="o">==</span><span class="kc">True</span> <span class="ow">and</span> <span class="n">has_velocities</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">step</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">istring</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                      <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>       
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;note&#39;</span><span class="p">)</span>

                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="c1"># Start time</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="o">*</span> <span class="n">dataset_MIDI_events_time_denominator</span><span class="p">)</span> <span class="c1"># Duration</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="c1"># Channel</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="c1"># Pitch</span>
                      <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">sim_vel</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sim_vel</span><span class="p">)</span> <span class="c1"># Simulated Velocity (= highest note&#39;s pitch)</span>
                      <span class="n">output_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

              <span class="k">if</span> <span class="n">has_velocities</span><span class="o">==</span><span class="kc">True</span> <span class="ow">and</span> <span class="n">has_MIDI_channels</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">step</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">istring</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                      <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>       
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;note&#39;</span><span class="p">)</span>
                      
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="c1"># Start time</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="o">*</span> <span class="n">dataset_MIDI_events_time_denominator</span><span class="p">)</span> <span class="c1"># Duration</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="c1"># Simulated Channel (Defaulting to Channel 0)</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="c1"># Pitch</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">4</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="c1"># Velocity</span>

                      <span class="n">output_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

              <span class="k">if</span> <span class="n">has_MIDI_channels</span><span class="o">==</span><span class="kc">False</span> <span class="ow">and</span> <span class="n">has_velocities</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">step</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">istring</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                      <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>       
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;note&#39;</span><span class="p">)</span>

                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="c1"># Start time</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="o">*</span> <span class="n">dataset_MIDI_events_time_denominator</span><span class="p">)</span> <span class="c1"># Duration</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="c1"># Simulated Channel (Defaulting to Channel 0)</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="c1"># Pitch</span>
                      <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">sim_vel</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sim_vel</span><span class="p">)</span> <span class="c1"># Simulated Velocity (= highest note&#39;s pitch)</span>
                      <span class="n">output_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
      <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Bad note string:&#39;</span><span class="p">,</span> <span class="n">istring</span><span class="p">)</span>
        <span class="k">continue</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Task complete! Enjoy! :)&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output_list</span><span class="p">,</span> <span class="n">song_name</span>

<span class="c1">###################################################################################</span>

<span class="k">def</span> <span class="nf">Tegridy_SONG_to_MIDI_Converter</span><span class="p">(</span><span class="n">SONG</span><span class="p">,</span>
                                  <span class="n">output_signature</span> <span class="o">=</span> <span class="s1">&#39;Tegridy TMIDI Module&#39;</span><span class="p">,</span> 
                                  <span class="n">track_name</span> <span class="o">=</span> <span class="s1">&#39;Composition Track&#39;</span><span class="p">,</span>
                                  <span class="n">number_of_ticks_per_quarter</span> <span class="o">=</span> <span class="mi">425</span><span class="p">,</span>
                                  <span class="n">list_of_MIDI_patches</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                  <span class="n">output_file_name</span> <span class="o">=</span> <span class="s1">&#39;TMIDI-Composition&#39;</span><span class="p">,</span>
                                  <span class="n">text_encoding</span><span class="o">=</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Tegridy SONG to MIDI Converter</span>
<span class="sd">     </span>
<span class="sd">    Input: Input SONG in TMIDI SONG/MIDI.py Score format</span>
<span class="sd">           Output MIDI Track 0 name / MIDI Signature</span>
<span class="sd">           Output MIDI Track 1 name / Composition track name</span>
<span class="sd">           Number of ticks per quarter for the output MIDI</span>
<span class="sd">           List of 16 MIDI patch numbers for output MIDI. Def. is MuseNet compatible patches.</span>
<span class="sd">           Output file name w/o .mid extension.</span>
<span class="sd">           Optional text encoding if you are working with text_events/lyrics. This is especially useful for Karaoke. Please note that anything but ISO-8859-1 is a non-standard way of encoding text_events according to MIDI specs.</span>

<span class="sd">    Output: MIDI File</span>
<span class="sd">            Detailed MIDI stats</span>

<span class="sd">    Project Los Angeles</span>
<span class="sd">    Tegridy Code 2020&#39;&#39;&#39;</span>                                  

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Converting to MIDI. Please stand-by...&#39;</span><span class="p">)</span>
    
    <span class="n">output_header</span> <span class="o">=</span> <span class="p">[</span><span class="n">number_of_ticks_per_quarter</span><span class="p">,</span> 
                    <span class="p">[[</span><span class="s1">&#39;track_name&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">output_signature</span><span class="p">,</span> <span class="n">text_encoding</span><span class="p">)]]]</span>                                                    

    <span class="n">patch_list</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> 
                    <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                    <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
                    <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span>
                    <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">4</span><span class="p">]],</span>
                    <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">5</span><span class="p">]],</span>
                    <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">6</span><span class="p">]],</span>
                    <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">7</span><span class="p">]],</span>
                    <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">8</span><span class="p">]],</span>
                    <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">9</span><span class="p">]],</span>
                    <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">10</span><span class="p">]],</span>
                    <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">11</span><span class="p">]],</span>
                    <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">12</span><span class="p">]],</span>
                    <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">13</span><span class="p">]],</span>
                    <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">14</span><span class="p">]],</span>
                    <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">15</span><span class="p">]],</span>
                    <span class="p">[</span><span class="s1">&#39;track_name&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">track_name</span><span class="p">,</span> <span class="n">text_encoding</span><span class="p">)]]</span>

    <span class="n">output</span> <span class="o">=</span> <span class="n">output_header</span> <span class="o">+</span> <span class="p">[</span><span class="n">patch_list</span> <span class="o">+</span> <span class="n">SONG</span><span class="p">]</span>

    <span class="n">midi_data</span> <span class="o">=</span> <span class="n">score2midi</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">text_encoding</span><span class="p">)</span>
    <span class="n">detailed_MIDI_stats</span> <span class="o">=</span> <span class="n">score2stats</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file_name</span> <span class="o">+</span> <span class="s1">&#39;.mid&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">midi_file</span><span class="p">:</span>
        <span class="n">midi_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">midi_data</span><span class="p">)</span>
        <span class="n">midi_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done! Enjoy! :)&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">detailed_MIDI_stats</span>

<span class="c1">###################################################################################</span>

<span class="k">def</span> <span class="nf">Tegridy_Karaoke_MIDI_to_Reduced_TXT_Processor</span><span class="p">(</span><span class="n">Karaoke_MIDI_file</span><span class="p">,</span> 
                                                  <span class="n">karaoke_language_encoding</span> <span class="o">=</span> <span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">,</span>
                                                  <span class="n">char_encoding_offset</span> <span class="o">=</span> <span class="mi">30</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Tegridy Karaoke MIDI to Reduced TXT Processor</span>
<span class="sd">     </span>
<span class="sd">    Input: Karaoke MIDI file. Must be a Karaoke MIDI or the processor will not work properly.</span>
<span class="sd">           </span>
<span class="sd">           Karaoke language encoding. Please see official encoding list for your language. </span>
<span class="sd">           https://docs.python.org/3/library/codecs.html#standard-encodings</span>
<span class="sd">           Please note that anything but ISO-8859-1 is a non-standard way of encoding text_events according to MIDI specs.</span>
<span class="sd">           </span>
<span class="sd">           Char encoding offset to prevent ambiguity with sys chars like \n. </span>
<span class="sd">           This may need to be adjusted for languages other than English.</span>

<span class="sd">    Output: Line-by-line reduced TXT string</span>
<span class="sd">            Number of processed MIDI events from the Karaoke MIDI file</span>
<span class="sd">            Number of recorded Karaoke events in the TXT string</span>
<span class="sd">            All recorded Pitches/Words of the given KarMIDI file as a list</span>
<span class="sd">            All recorded words of the given KarMIDI file as a string</span>

<span class="sd">    Project Los Angeles</span>
<span class="sd">    Tegridy Code 2021&#39;&#39;&#39;</span>

    <span class="n">events_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">events_matrix</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">MIDI_ev</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">KAR_ev</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">itrack</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">tst</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">output_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="n">midi_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">Karaoke_MIDI_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
      <span class="n">opus</span> <span class="o">=</span> <span class="n">midi2opus</span><span class="p">(</span><span class="n">midi_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    
    <span class="k">except</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Problematic file. Skipping...&#39;</span><span class="p">)</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Skipped file name:&#39;</span><span class="p">,</span> <span class="n">Karaoke_MIDI_file</span><span class="p">)</span>
      <span class="n">midi_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">output_string</span><span class="p">,</span> <span class="n">MIDI_ev</span><span class="p">,</span> <span class="n">KAR_ev</span>
          
    <span class="n">midi_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">score1</span> <span class="o">=</span> <span class="n">to_millisecs</span><span class="p">(</span><span class="n">opus</span><span class="p">)</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">opus2score</span><span class="p">(</span><span class="n">score1</span><span class="p">)</span>

    <span class="c1">#print(&#39;Reading all MIDI events from the MIDI file...&#39;)</span>
    <span class="k">while</span> <span class="n">itrack</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">):</span>
      <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">score</span><span class="p">[</span><span class="n">itrack</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;text_event&#39;</span><span class="p">:</span>
          <span class="n">tst</span> <span class="o">=</span> <span class="mi">0</span>
          <span class="n">txt</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
          <span class="n">tst</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
          <span class="n">txt</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
          
        <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note&#39;</span> <span class="ow">and</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">tst</span><span class="p">:</span>
          <span class="n">evt</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
          <span class="n">evt</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="p">])</span>
          <span class="n">evt</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">txt</span>
          <span class="n">events_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">evt</span><span class="p">)</span>       
        
        <span class="n">MIDI_ev</span> <span class="o">+=</span> <span class="mi">1</span>
      
      <span class="n">itrack</span> <span class="o">+=</span><span class="mi">1</span> <span class="c1"># Going to next track...</span>

    <span class="n">evt</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">events_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># Sorting by start time</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">g</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">))]</span> <span class="c1"># Grouping by start time</span>

    <span class="n">events_matrix</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>

    <span class="n">f_matrix</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">final_matrix</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">events_matrix</span><span class="p">:</span> 
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Removing single note events</span>
        <span class="n">it</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="n">it</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
        <span class="n">it</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="c1"># Sorting events by pitch</span>
        <span class="n">f_matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">it</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> 

    <span class="n">ptime</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">time</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">output_song</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f_matrix</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
      <span class="n">no</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">f_matrix</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>

      <span class="n">no</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">delta</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span>
      <span class="n">no</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">no</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span>
      <span class="n">no</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">no</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>

      <span class="n">ptime</span> <span class="o">=</span> <span class="n">f_matrix</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
      <span class="n">time</span> <span class="o">=</span> <span class="n">f_matrix</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

      <span class="n">delta</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">time</span><span class="o">-</span><span class="n">ptime</span><span class="p">)</span>    

      <span class="n">output_song</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">no</span><span class="p">)</span>

    <span class="n">output_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">all_words</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">pitches_words_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">note</span> <span class="ow">in</span> <span class="n">output_song</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">note</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">250</span> <span class="ow">and</span> <span class="n">note</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">250</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">note</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">note</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> 
          <span class="n">output_string</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">note</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">char_encoding_offset</span><span class="p">)</span>
          <span class="n">output_string</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">note</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">char_encoding_offset</span><span class="p">)</span>
          <span class="n">output_string</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">note</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">char_encoding_offset</span><span class="p">)</span>
          <span class="n">output_string</span> <span class="o">+=</span> <span class="s1">&#39;=&#39;</span>
          <span class="n">word</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">note</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">karaoke_language_encoding</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
          <span class="n">output_string</span> <span class="o">+=</span> <span class="n">word</span>
          <span class="n">output_string</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
          <span class="n">all_words</span> <span class="o">+=</span> <span class="n">word</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
          <span class="n">pitches_words_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">note</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">word</span><span class="p">])</span>
          <span class="n">KAR_ev</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">output_string</span><span class="p">,</span> <span class="n">MIDI_ev</span><span class="p">,</span> <span class="n">KAR_ev</span><span class="p">,</span> <span class="n">pitches_words_list</span><span class="p">,</span> <span class="n">all_words</span>  

<span class="c1">###################################################################################</span>

<span class="k">def</span> <span class="nf">Tegridy_Karaoke_TXT_to_MIDI_Processor</span><span class="p">(</span><span class="n">Karaoke_TXT_String</span><span class="p">,</span>
                                          <span class="n">text_encoding</span><span class="o">=</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">,</span>
                                          <span class="n">char_encoding_offset</span> <span class="o">=</span> <span class="mi">30</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Tegridy Karaoke TXT to MIDI Processor</span>
<span class="sd">        </span>
<span class="sd">    Input: Karaoke Reduced TXT String in TMIDI Karaoke Reduced TXT format</span>
<span class="sd">            </span>
<span class="sd">           Karaoke language encoding. Please see official encoding list for your language. </span>
<span class="sd">           https://docs.python.org/3/library/codecs.html#standard-encodings</span>
<span class="sd">           Please note that anything but ISO-8859-1 is a non-standard way of encoding text_events according to MIDI specs.</span>
<span class="sd">            </span>
<span class="sd">           Char encoding offset to prevent ambiguity with sys chars like \n. </span>
<span class="sd">           This may need to be adjusted for languages other than English.</span>

<span class="sd">    Output: Inferred song name (from the first line of the input TXT string)</span>
<span class="sd">            Song (notes list in MIDI.py score format) that you can write to MIDI file with TMIDI Song to MIDI converter.</span>
<span class="sd">            All song&#39;s lyrics as one TXT string (this is for eval/display purposes mostly)</span>
<span class="sd">            Number of recorded Karaoke events in the output song</span>

<span class="sd">    Project Los Angeles</span>
<span class="sd">    Tegridy Code 2021&#39;&#39;&#39;</span>    
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tegridy Karaoke TXT to MIDI Processor&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Converting Karaoke TXT to MIDI. Please wait...&#39;</span><span class="p">)</span>

    <span class="n">o_str</span> <span class="o">=</span> <span class="n">Karaoke_TXT_String</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">song_name</span> <span class="o">=</span> <span class="n">o_str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">song</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">lyrics_text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="n">ptime</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">KAR_ev</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">o_str</span><span class="p">:</span>

      <span class="n">note</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;note&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
      <span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;text_event&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>

      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>

        <span class="n">note</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ptime</span> <span class="o">*</span> <span class="mi">10</span>
        <span class="n">note</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span>
        <span class="n">note</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span>
        <span class="n">note</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span>

        <span class="n">text</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ptime</span> <span class="o">*</span> <span class="mi">10</span>
        <span class="n">text</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">ptime</span> <span class="o">+=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span>

        <span class="n">song</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">note</span><span class="p">)</span>
        <span class="n">song</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

        <span class="n">lyrics_text</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>

        <span class="n">KAR_ev</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Task complete! Enjoy! :)&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">song_name</span><span class="p">,</span> <span class="n">song</span><span class="p">,</span> <span class="n">lyrics_text</span><span class="p">,</span> <span class="n">KAR_ev</span>

<span class="c1">###################################################################################</span>
<span class="c1">#</span>
<span class="c1"># Tegridy helper functions</span>
<span class="c1">#</span>
<span class="c1">###################################################################################</span>

<span class="k">def</span> <span class="nf">Tegridy_File_Time_Stamp</span><span class="p">(</span><span class="n">input_file_name</span><span class="o">=</span><span class="s1">&#39;File_Created_on_&#39;</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>

  <span class="sd">&#39;&#39;&#39;Tegridy File Time Stamp</span>
<span class="sd">     </span>
<span class="sd">  Input: Full path and file name without extention</span>
<span class="sd">         File extension</span>
<span class="sd">          </span>
<span class="sd">  Output: File name string with time-stamp and extension (time-stamped file name)</span>

<span class="sd">  Project Los Angeles</span>
<span class="sd">  Tegridy Code 2021&#39;&#39;&#39;</span>       

  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time-stamping output file...&#39;</span><span class="p">)</span>

  <span class="n">now</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
  <span class="n">now_n</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
  <span class="n">now_n</span> <span class="o">=</span> <span class="n">now_n</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
  <span class="n">now_n</span> <span class="o">=</span> <span class="n">now_n</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
  <span class="n">now</span> <span class="o">=</span> <span class="n">now_n</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
      
  <span class="n">fname</span> <span class="o">=</span> <span class="n">input_file_name</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">now</span><span class="p">)</span> <span class="o">+</span> <span class="n">ext</span>

  <span class="k">return</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

<span class="c1">###################################################################################</span>

<span class="k">def</span> <span class="nf">Tegridy_TXT_Dataset_File_Writer</span><span class="p">(</span><span class="n">input_file_name</span><span class="o">=</span><span class="s1">&#39;TMIDI_TXT_Dataset&#39;</span><span class="p">,</span> 
                                    <span class="n">ext</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> 
                                    <span class="n">TXT_String</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>

  <span class="sd">&#39;&#39;&#39;Tegridy TXT Dataset File Writer</span>
<span class="sd">     </span>
<span class="sd">  Input: Full path and file name without extention</span>
<span class="sd">         File extension</span>
<span class="sd">         Dataset as TXT string</span>
<span class="sd">          </span>
<span class="sd">  Output: Named TXT Dataset File</span>

<span class="sd">  Project Los Angeles</span>
<span class="sd">  Tegridy Code 2021&#39;&#39;&#39;</span>

  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tegridy TXT Dataset File Writer&#39;</span><span class="p">)</span>

  <span class="n">full_path_to_TXT_dataset</span> <span class="o">=</span> <span class="n">input_file_name</span> <span class="o">+</span> <span class="n">ext</span>
  
  <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">full_path_to_TXT_dataset</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">full_path_to_TXT_dataset</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Removing old Dataset...&#39;</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating new Dataset file...&quot;</span><span class="p">)</span>

  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Writing dataset to a file...Please wait...&#39;</span><span class="p">)</span>
  <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">full_path_to_TXT_dataset</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
  <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">TXT_String</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">))</span>
  <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Dataset was saved as:&#39;</span><span class="p">,</span> <span class="n">full_path_to_TXT_dataset</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Task complete! Enjoy :)&#39;</span><span class="p">)</span>

<span class="c1">###################################################################################</span>

<span class="k">def</span> <span class="nf">Tegridy_Pickle_File_Writer</span><span class="p">(</span><span class="n">Data</span><span class="p">,</span> <span class="n">input_file_name</span><span class="o">=</span><span class="s1">&#39;TMIDI_Pickle_File&#39;</span><span class="p">):</span>

  <span class="sd">&#39;&#39;&#39;Tegridy Pickle File Writer</span>
<span class="sd">     </span>
<span class="sd">  Input: Data to write (I.e. a list)</span>
<span class="sd">         Full path and file name without extention</span>
<span class="sd">         </span>
<span class="sd">  Output: Named Pickle file</span>

<span class="sd">  Project Los Angeles</span>
<span class="sd">  Tegridy Code 2021&#39;&#39;&#39;</span>

  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tegridy Pickle File Writer&#39;</span><span class="p">)</span>

  <span class="n">full_path_to_output_dataset_to</span> <span class="o">=</span> <span class="n">input_file_name</span> <span class="o">+</span> <span class="s1">&#39;.pickle&#39;</span>

  <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">full_path_to_output_dataset_to</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">full_path_to_output_dataset_to</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Removing old Dataset...&#39;</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating new Dataset file...&quot;</span><span class="p">)</span>

  <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">full_path_to_output_dataset_to</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">filehandle</span><span class="p">:</span>
    <span class="c1"># store the data as binary data stream</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">Data</span><span class="p">,</span> <span class="n">filehandle</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>

  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Dataset was saved as:&#39;</span><span class="p">,</span> <span class="n">full_path_to_output_dataset_to</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Task complete. Enjoy! :)&#39;</span><span class="p">)</span>

<span class="c1">###################################################################################</span>

<span class="k">def</span> <span class="nf">Tegridy_Pickle_File_Loader</span><span class="p">(</span><span class="n">input_file_name</span><span class="o">=</span><span class="s1">&#39;TMIDI_Pickle_File&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;.pickle&#39;</span><span class="p">):</span>

  <span class="sd">&#39;&#39;&#39;Tegridy Pickle File Loader</span>
<span class="sd">     </span>
<span class="sd">  Input: Full path and file name without extention</span>
<span class="sd">         File extension if different from default .pickle</span>
<span class="sd">       </span>
<span class="sd">  Output: Chords list in TMIDI MIDI Processor format</span>
<span class="sd">          Melody list in TMIDI MIDI Processor format</span>

<span class="sd">  Project Los Angeles</span>
<span class="sd">  Tegridy Code 2021&#39;&#39;&#39;</span>

  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tegridy Pickle File Loader&#39;</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading the pickle file. Please wait...&#39;</span><span class="p">)</span>

  <span class="n">dataset</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_file_name</span> <span class="o">+</span> <span class="n">ext</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>

  <span class="n">chords_list_f</span><span class="p">,</span> <span class="n">melody_list_f</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>

  <span class="n">dataset</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading complete.&#39;</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of MIDI chords recorded:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">chords_list_f</span><span class="p">))</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The longest chord:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">chords_list_f</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">)),</span> <span class="s1">&#39;notes&#39;</span><span class="p">)</span> 
  <span class="nb">print</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">chords_list_f</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">))</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of recorded melody events:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">melody_list_f</span><span class="p">))</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;First melody event:&#39;</span><span class="p">,</span> <span class="n">melody_list_f</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;Last Melody event:&#39;</span><span class="p">,</span> <span class="n">melody_list_f</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total number of MIDI events recorded:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">chords_list_f</span><span class="p">))</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Task complete. Enjoy! :)&#39;</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">chords_list_f</span><span class="p">,</span> <span class="n">melody_list_f</span>

<span class="k">def</span> <span class="nf">Tegridy_Any_Pickle_File_Loader</span><span class="p">(</span><span class="n">input_file_name</span><span class="o">=</span><span class="s1">&#39;TMIDI_Pickle_File&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;.pickle&#39;</span><span class="p">):</span>

  <span class="sd">&#39;&#39;&#39;Tegridy Pickle File Loader</span>
<span class="sd">     </span>
<span class="sd">  Input: Full path and file name without extention</span>
<span class="sd">         File extension if different from default .pickle</span>
<span class="sd">       </span>
<span class="sd">  Output: Standard Python 3 unpickled data object</span>

<span class="sd">  Project Los Angeles</span>
<span class="sd">  Tegridy Code 2021&#39;&#39;&#39;</span>

  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tegridy Pickle File Loader&#39;</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading the pickle file. Please wait...&#39;</span><span class="p">)</span>

  <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_file_name</span> <span class="o">+</span> <span class="n">ext</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pickle_file</span><span class="p">:</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">pickle_file</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">content</span>

<span class="c1">###################################################################################</span>

<span class="k">def</span> <span class="nf">Tegridy_Karaoke_Pitches_Words_List_to_CSV_Writer</span><span class="p">(</span><span class="n">pitches_words_list</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s1">&#39;pitches_words.csv&#39;</span><span class="p">):</span>
    
    <span class="sd">&#39;&#39;&#39;Tegridy Karaoke Pitches Words List to CSV Writer</span>
<span class="sd">      </span>
<span class="sd">    Input: Pitches/Words list in TMIDI Karaoke MIDI to TXT Converter format</span>
<span class="sd">           Desired full output CSV file name with extension</span>
<span class="sd">        </span>
<span class="sd">    Output: CSV file with all Pitches/Words that were in the input pitches/words list</span>

<span class="sd">    Project Los Angeles</span>
<span class="sd">    Tegridy Code 2021&#39;&#39;&#39;</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tegridy Karaoke Pitches/Words CSV Writer&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Starting up...&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Grouping input pitches/words list...Please stand by...&#39;</span><span class="p">)</span>
    <span class="n">values</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pitches_words_list</span><span class="p">))</span>

    <span class="n">groups</span> <span class="o">=</span> <span class="p">[[</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">pitches_words_list</span> <span class="k">if</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Preparing final CSV list...&#39;</span><span class="p">)</span>

    <span class="n">final_list</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
      <span class="n">pitch</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">f_list</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">g</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f_list</span><span class="p">:</span>
          <span class="n">f_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
      <span class="n">final_list</span><span class="p">[</span><span class="n">pitch</span><span class="p">]</span> <span class="o">=</span> <span class="n">f_list</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Writing CSV file to disk...&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
      <span class="n">w</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
      <span class="n">w</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s1">&#39;pitch&#39;</span><span class="p">,</span><span class="s1">&#39;words&#39;</span><span class="p">])</span>
      <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">items</span> <span class="ow">in</span> <span class="n">final_list</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">w</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">items</span><span class="p">))])</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Task complete! Enjoy :)&#39;</span><span class="p">)</span>

<span class="c1">###################################################################################</span>

<span class="c1"># TMIDI 2.0 Code is below</span>

<span class="c1">###################################################################################</span>


<span class="k">def</span> <span class="nf">Optimus_MIDI_TXT_Processor</span><span class="p">(</span><span class="n">MIDI_file</span><span class="p">,</span> 
                              <span class="n">line_by_line_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                              <span class="n">chordify_TXT</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">dataset_MIDI_events_time_denominator</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                              <span class="n">output_velocity</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">output_MIDI_channels</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                              <span class="n">MIDI_channel</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                              <span class="n">MIDI_patch</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> 
                              <span class="n">char_offset</span> <span class="o">=</span> <span class="mi">30000</span><span class="p">,</span>
                              <span class="n">transpose_by</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                              <span class="n">flip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                              <span class="n">melody_conditioned_encoding</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">melody_pitch_baseline</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                              <span class="n">number_of_notes_to_sample</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                              <span class="n">sampling_offset_from_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                              <span class="n">karaoke</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">karaoke_language_encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span>
                              <span class="n">song_name</span><span class="o">=</span><span class="s1">&#39;Song&#39;</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Project Los Angeles</span>
<span class="sd">       Tegridy Code 2021&#39;&#39;&#39;</span>
  
<span class="c1">###########</span>

    <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">ev</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">chords_list_final</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">chords_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">events_matrix</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">melody</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">melody1</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">itrack</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">min_note</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">max_note</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ev</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">patch</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">score</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">rec_event</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">txt</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">txtc</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">chords</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">melody_chords</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">karaoke_events_matrix</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">karaokez</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">sample</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">start_sample</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1">###########    </span>

    <span class="k">def</span> <span class="nf">list_average</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
      <span class="n">sum_num</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">num</span><span class="p">:</span>
          <span class="n">sum_num</span> <span class="o">=</span> <span class="n">sum_num</span> <span class="o">+</span> <span class="n">t</span>           

      <span class="n">avg</span> <span class="o">=</span> <span class="n">sum_num</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">avg</span>

<span class="c1">###########</span>

    <span class="c1">#print(&#39;Loading MIDI file...&#39;)</span>
    <span class="n">midi_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">MIDI_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Processing File:&#39;</span><span class="p">,</span> <span class="n">file_address</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
      <span class="n">opus</span> <span class="o">=</span> <span class="n">midi2opus</span><span class="p">(</span><span class="n">midi_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    
    <span class="k">except</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Bad file. Skipping...&#39;</span><span class="p">)</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;File name:&#39;</span><span class="p">,</span> <span class="n">MIDI_file</span><span class="p">)</span>
      <span class="n">midi_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">txt</span><span class="p">,</span> <span class="n">melody</span><span class="p">,</span> <span class="n">chords</span>
         
    <span class="n">midi_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">score1</span> <span class="o">=</span> <span class="n">to_millisecs</span><span class="p">(</span><span class="n">opus</span><span class="p">)</span>
    <span class="n">score2</span> <span class="o">=</span> <span class="n">opus2score</span><span class="p">(</span><span class="n">score1</span><span class="p">)</span>

    <span class="c1"># score2 = opus2score(opus) # TODO Improve score timings when it will be possible.</span>
    
    <span class="k">if</span> <span class="n">MIDI_channel</span> <span class="o">==</span> <span class="mi">16</span><span class="p">:</span> <span class="c1"># Process all MIDI channels</span>
      <span class="n">score</span> <span class="o">=</span> <span class="n">score2</span>
    
    <span class="k">if</span> <span class="n">MIDI_channel</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">MIDI_channel</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">:</span> <span class="c1"># Process only a selected single MIDI channel</span>
      <span class="n">score</span> <span class="o">=</span> <span class="n">grep</span><span class="p">(</span><span class="n">score2</span><span class="p">,</span> <span class="p">[</span><span class="n">MIDI_channel</span><span class="p">])</span>
    
    <span class="k">if</span> <span class="n">MIDI_channel</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># Process all channels except drums (except channel 9)</span>
      <span class="n">score</span> <span class="o">=</span> <span class="n">grep</span><span class="p">(</span><span class="n">score2</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">])</span>   
    
    <span class="c1">#print(&#39;Reading all MIDI events from the MIDI file...&#39;)</span>
    <span class="k">while</span> <span class="n">itrack</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">):</span>
      <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">score</span><span class="p">[</span><span class="n">itrack</span><span class="p">]:</span>

        <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;text_event&#39;</span> <span class="ow">or</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;lyric&#39;</span> <span class="ow">or</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note&#39;</span><span class="p">:</span>
          <span class="n">karaokez</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;text_event&#39;</span> <span class="ow">or</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;lyric&#39;</span><span class="p">:</span>
          <span class="k">try</span><span class="p">:</span>
            <span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">karaoke_language_encoding</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
          <span class="k">except</span><span class="p">:</span>
            <span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">continue</span>
          <span class="n">karaoke_events_matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;patch_change&#39;</span><span class="p">:</span>
          <span class="n">patch</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note&#39;</span> <span class="ow">and</span> <span class="n">patch</span> <span class="ow">in</span> <span class="n">MIDI_patch</span><span class="p">:</span>
          <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span> <span class="c1"># Checking for bad notes...</span>
              <span class="n">eve</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
              
              <span class="n">eve</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">dataset_MIDI_events_time_denominator</span><span class="p">)</span>
              <span class="n">eve</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">dataset_MIDI_events_time_denominator</span><span class="p">)</span>
              
              <span class="n">eve</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">transpose_by</span><span class="p">)</span>
              
              <span class="k">if</span> <span class="n">flip</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">eve</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">127</span> <span class="o">-</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">transpose_by</span><span class="p">))</span> 
              
              <span class="k">if</span> <span class="n">number_of_notes_to_sample</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sample</span> <span class="o">&lt;=</span> <span class="n">number_of_notes_to_sample</span><span class="p">:</span>
                  <span class="k">if</span> <span class="n">start_sample</span> <span class="o">&gt;=</span> <span class="n">sampling_offset_from_start</span><span class="p">:</span>
                    <span class="n">events_matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eve</span><span class="p">)</span>
                    <span class="n">sample</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">ev</span> <span class="o">+=</span> <span class="mi">1</span>
                  <span class="k">else</span><span class="p">:</span>
                    <span class="n">start_sample</span> <span class="o">+=</span> <span class="mi">1</span>

              <span class="k">else</span><span class="p">:</span>
                <span class="n">events_matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eve</span><span class="p">)</span>
                <span class="n">ev</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">start_sample</span> <span class="o">+=</span> <span class="mi">1</span>
                
      <span class="n">itrack</span> <span class="o">+=</span><span class="mi">1</span> <span class="c1"># Going to next track...</span>

    <span class="c1">#print(&#39;Doing some heavy pythonic sorting...Please stand by...&#39;)</span>

    <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">MIDI_file</span><span class="p">)</span>
    <span class="n">song_name</span> <span class="o">=</span> <span class="n">song_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">song_name</span> <span class="o">==</span> <span class="s1">&#39;Song&#39;</span><span class="p">:</span>
      <span class="n">sng_name</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
      <span class="n">song_name</span> <span class="o">=</span> <span class="n">sng_name</span>
    
    <span class="n">txt</span> <span class="o">+=</span> <span class="s1">&#39;SONG=&#39;</span> <span class="o">+</span> <span class="n">song_name</span> <span class="o">+</span> <span class="s1">&#39;_with_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">events_matrix</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_notes&#39;</span>
    <span class="n">txtc</span> <span class="o">+=</span> <span class="s1">&#39;SONG=&#39;</span> <span class="o">+</span> <span class="n">song_name</span> <span class="o">+</span> <span class="s1">&#39;_with_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">events_matrix</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_notes&#39;</span>

    <span class="k">if</span> <span class="n">line_by_line_output</span><span class="p">:</span>
      <span class="n">txt</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
      <span class="n">txtc</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">txt</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
      <span class="n">txtc</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

    <span class="c1">#print(&#39;Sorting input by start time...&#39;)</span>
    <span class="n">events_matrix</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Sorting input by start time</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">karaoke</span><span class="p">:</span>
      <span class="n">previous_event</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">events_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
      <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events_matrix</span><span class="p">:</span>

        <span class="sd">&#39;&#39;&#39;# Computing deltas</span>
<span class="sd">        start_time = int(event[1] - previous_event[1])</span>
<span class="sd">        duration = int(event[2] - previous_event[2])</span>
<span class="sd">        channel = int(event[3])</span>
<span class="sd">        pitch = int(event[4] - previous_event[4])</span>
<span class="sd">        velocity = int(event[5] - previous_event[5])&#39;&#39;&#39;</span>

        <span class="c1"># Computing events details</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">previous_event</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="n">duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">previous_event</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="n">channel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">previous_event</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

        <span class="n">pitch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">previous_event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">transpose_by</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">flip</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
          <span class="n">pitch</span> <span class="o">=</span> <span class="mi">127</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">previous_event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">transpose_by</span><span class="p">)</span>

        <span class="n">velocity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">previous_event</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>

        <span class="c1"># Converting to TXT</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">start_time</span> <span class="o">+</span> <span class="n">char_offset</span><span class="p">))</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">duration</span> <span class="o">+</span> <span class="n">char_offset</span><span class="p">))</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">pitch</span> <span class="o">+</span> <span class="n">char_offset</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">output_velocity</span><span class="p">:</span>
          <span class="n">txt</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">velocity</span> <span class="o">+</span> <span class="n">char_offset</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">output_MIDI_channels</span><span class="p">:</span>
          <span class="n">txt</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">channel</span> <span class="o">+</span> <span class="n">char_offset</span><span class="p">))</span>


        <span class="k">if</span> <span class="n">chordify_TXT</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">previous_event</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
          <span class="n">txt</span> <span class="o">+=</span> <span class="s1">&#39;&#39;</span>      
        <span class="k">else</span><span class="p">:</span>     
          <span class="k">if</span> <span class="n">line_by_line_output</span><span class="p">:</span>
            <span class="n">txt</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">txt</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> 
        
        <span class="n">previous_event</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
      
      <span class="k">if</span> <span class="ow">not</span> <span class="n">line_by_line_output</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>      
    
    <span class="n">chords</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">events_matrix</span><span class="p">)</span>
    <span class="c1">#print(chords)</span>

    <span class="c1">#print(&#39;Extracting melody...&#39;)</span>
    <span class="n">melody_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1">#print(&#39;Grouping by start time. This will take a while...&#39;)</span>
    <span class="n">values</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">events_matrix</span><span class="p">))</span> <span class="c1"># Non-multithreaded function version just in case</span>

    <span class="n">groups</span> <span class="o">=</span> <span class="p">[[</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">events_matrix</span> <span class="k">if</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="n">x</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span> <span class="c1"># Grouping notes into chords while discarting bad notes...</span>
  
    <span class="c1">#print(&#39;Sorting events...&#39;)</span>
    <span class="k">for</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
        <span class="n">items</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="c1"># Sorting events by pitch</span>
        <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Melody should always bear MIDI Channel 0 for code to work</span>
        <span class="n">melody_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># Creating final melody list</span>
        <span class="n">melody_chords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="c1"># Creating final chords list</span>
    <span class="c1">#print(&#39;Final sorting by start time...&#39;)      </span>
    <span class="n">melody_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Sorting events by start time</span>
    <span class="n">melody_chords</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Sorting events by start time</span>
    <span class="c1">#print(txt, melody, chords)</span>

    <span class="c1"># [WIP] Melody-conditioned chords list</span>
    <span class="k">if</span> <span class="n">melody_conditioned_encoding</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">karaoke</span><span class="p">:</span>
   
        <span class="n">previous_event</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">melody_chords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">melody_chords</span><span class="p">:</span>
          <span class="n">hp</span> <span class="o">=</span> <span class="kc">True</span>
          <span class="n">ev</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="c1"># Sorting chord events by pitch</span>
          <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">ev</span><span class="p">:</span>
          
            <span class="c1"># Computing events details</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">previous_event</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            
            <span class="n">duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">previous_event</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">hp</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
              <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">previous_event</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">melody_pitch_baseline</span><span class="p">:</span>
                <span class="n">channel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">hp</span> <span class="o">=</span> <span class="kc">False</span>
              <span class="k">else</span><span class="p">:</span>
                <span class="n">channel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">previous_event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">hp</span> <span class="o">=</span> <span class="kc">False</span>  
            <span class="k">else</span><span class="p">:</span>
              <span class="n">channel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">previous_event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
              <span class="n">hp</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">pitch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">previous_event</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>

            <span class="n">velocity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">previous_event</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>

            <span class="c1"># Converting to TXT</span>
            <span class="n">txtc</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">start_time</span> <span class="o">+</span> <span class="n">char_offset</span><span class="p">))</span>
            <span class="n">txtc</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">duration</span> <span class="o">+</span> <span class="n">char_offset</span><span class="p">))</span>
            <span class="n">txtc</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">pitch</span> <span class="o">+</span> <span class="n">char_offset</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">output_velocity</span><span class="p">:</span>
              <span class="n">txtc</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">velocity</span> <span class="o">+</span> <span class="n">char_offset</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">output_MIDI_channels</span><span class="p">:</span>
              <span class="n">txtc</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">channel</span> <span class="o">+</span> <span class="n">char_offset</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">line_by_line_output</span><span class="p">:</span>
            

              <span class="n">txtc</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>

              <span class="n">txtc</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

            <span class="n">previous_event</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line_by_line_output</span><span class="p">:</span>
          <span class="n">txtc</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

        <span class="n">txt</span> <span class="o">=</span> <span class="n">txtc</span>
        <span class="n">chords</span> <span class="o">=</span> <span class="n">melody_chords</span>

    <span class="k">if</span> <span class="n">karaoke</span><span class="p">:</span>
      <span class="n">previous_event</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">melody_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
      <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">melody_list</span><span class="p">:</span>

        <span class="c1"># Computing events details</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">previous_event</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="n">duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">previous_event</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="n">channel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">previous_event</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

        <span class="n">pitch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">previous_event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">transpose_by</span><span class="p">)</span>

        <span class="n">velocity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">previous_event</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>

        <span class="c1"># Converting to TXT</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">start_time</span> <span class="o">+</span> <span class="n">char_offset</span><span class="p">))</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">duration</span> <span class="o">+</span> <span class="n">char_offset</span><span class="p">))</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">pitch</span> <span class="o">+</span> <span class="n">char_offset</span><span class="p">))</span>

        <span class="n">txt</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">velocity</span> <span class="o">+</span> <span class="n">char_offset</span><span class="p">))</span>      

        <span class="n">txt</span> <span class="o">+=</span> <span class="s1">&#39;=&#39;</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">karaoke_events_matrix</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">txt</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>          
            <span class="k">break</span>

        <span class="k">if</span> <span class="n">line_by_line_output</span><span class="p">:</span>
          <span class="n">txt</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">txt</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> 
        
        <span class="n">previous_event</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
      
      <span class="k">if</span> <span class="ow">not</span> <span class="n">line_by_line_output</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

    <span class="c1"># Helper aux/backup function for Karaoke</span>
    <span class="n">karaokez</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">txt</span><span class="p">,</span> <span class="n">melody_list</span><span class="p">,</span> <span class="n">chords</span>

<span class="c1">###################################################################################</span>

<span class="k">def</span> <span class="nf">Tegridy_Optimus_TXT_to_Notes_Converter</span><span class="p">(</span><span class="n">Optimus_TXT_String</span><span class="p">,</span>
                                          <span class="n">line_by_line_dataset</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                          <span class="n">has_velocities</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                          <span class="n">has_MIDI_channels</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                          <span class="n">dataset_MIDI_events_time_denominator</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                                          <span class="n">char_encoding_offset</span> <span class="o">=</span> <span class="mi">30000</span><span class="p">,</span>
                                          <span class="n">save_only_first_composition</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                          <span class="n">simulate_velocity</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                          <span class="n">karaoke</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                                                            
    <span class="sd">&#39;&#39;&#39;Project Los Angeles</span>
<span class="sd">       Tegridy Code 2020&#39;&#39;&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tegridy Optimus TXT to Notes Converter&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Converting TXT to Notes list...Please wait...&#39;</span><span class="p">)</span>

    <span class="n">song_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">if</span> <span class="n">line_by_line_dataset</span><span class="p">:</span>
      <span class="n">input_string</span> <span class="o">=</span> <span class="n">Optimus_TXT_String</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">input_string</span> <span class="o">=</span> <span class="n">Optimus_TXT_String</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">line_by_line_dataset</span><span class="p">:</span>
      <span class="n">name_string</span> <span class="o">=</span> <span class="n">Optimus_TXT_String</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">name_string</span> <span class="o">=</span> <span class="n">Optimus_TXT_String</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">name_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SONG&#39;</span><span class="p">:</span>
      <span class="n">song_name</span> <span class="o">=</span> <span class="n">name_string</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">output_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">st</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_string</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
      
      <span class="k">if</span> <span class="n">save_only_first_composition</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SONG&#39;</span><span class="p">:</span>

          <span class="n">song_name</span> <span class="o">=</span> <span class="n">name_string</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
          <span class="k">break</span>

      <span class="k">try</span><span class="p">:</span>
        <span class="n">istring</span> <span class="o">=</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1">#print(istring)</span>

        <span class="k">if</span> <span class="n">has_MIDI_channels</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
          <span class="n">step</span> <span class="o">=</span> <span class="mi">4</span>          
        
        <span class="k">if</span> <span class="n">has_MIDI_channels</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
          <span class="n">step</span> <span class="o">=</span> <span class="mi">5</span>

        <span class="k">if</span> <span class="n">has_velocities</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
          <span class="n">step</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="n">st</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="o">*</span> <span class="n">dataset_MIDI_events_time_denominator</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">karaoke</span><span class="p">:</span>
          <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">istring</span><span class="p">),</span> <span class="n">step</span><span class="p">):</span>
              <span class="k">if</span> <span class="n">has_MIDI_channels</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">step</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">istring</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                      <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>       
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;note&#39;</span><span class="p">)</span>

                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="c1"># Start time</span>
                      
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="o">*</span> <span class="n">dataset_MIDI_events_time_denominator</span><span class="p">)</span> <span class="c1"># Duration</span>
                      
                      <span class="k">if</span> <span class="n">has_velocities</span><span class="p">:</span>
                        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">4</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">))</span> <span class="c1"># Channel</span>
                      <span class="k">else</span><span class="p">:</span>
                        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">))</span> <span class="c1"># Channel  </span>
                      
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">))</span> <span class="c1"># Pitch</span>
                      
                      <span class="k">if</span> <span class="n">simulate_velocity</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                          <span class="n">sim_vel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span>
                        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sim_vel</span><span class="p">)</span> <span class="c1"># Simulated Velocity (= highest note&#39;s pitch)</span>
                      <span class="k">else</span><span class="p">:</span>                      
                        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">))</span> <span class="c1"># Velocity</span>
            
              <span class="k">if</span> <span class="n">has_MIDI_channels</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">step</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">istring</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                      <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>       
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;note&#39;</span><span class="p">)</span>

                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="c1"># Start time</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="o">*</span> <span class="n">dataset_MIDI_events_time_denominator</span><span class="p">)</span> <span class="c1"># Duration</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># Channel</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">))</span> <span class="c1"># Pitch</span>
                      
                      <span class="k">if</span> <span class="n">simulate_velocity</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                          <span class="n">sim_vel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span>
                        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sim_vel</span><span class="p">)</span> <span class="c1"># Simulated Velocity (= highest note&#39;s pitch)</span>
                      <span class="k">else</span><span class="p">:</span>                      
                        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">))</span> <span class="c1"># Velocity</span>

              <span class="k">if</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">istring</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                      <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>       
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;note&#39;</span><span class="p">)</span>

                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="c1"># Start time</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="o">*</span> <span class="n">dataset_MIDI_events_time_denominator</span><span class="p">)</span> <span class="c1"># Duration</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># Channel</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">))</span> <span class="c1"># Pitch</span>
                      
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">))</span> <span class="c1"># Velocity = Pitch</span>

              <span class="n">output_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">karaoke</span><span class="p">:</span>
          <span class="k">try</span><span class="p">:</span>
              <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>       
              <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;note&#39;</span><span class="p">)</span>

              <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="c1"># Start time</span>
              <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="o">*</span> <span class="n">dataset_MIDI_events_time_denominator</span><span class="p">)</span> <span class="c1"># Duration</span>
              <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># Channel</span>
              <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">))</span> <span class="c1"># Pitch</span>
              
              <span class="k">if</span> <span class="n">simulate_velocity</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                  <span class="n">sim_vel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sim_vel</span><span class="p">)</span> <span class="c1"># Simulated Velocity (= highest note&#39;s pitch)</span>
              <span class="k">else</span><span class="p">:</span>                      
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">))</span> <span class="c1"># Velocity</span>
              <span class="n">output_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
              <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
              <span class="k">if</span> <span class="n">istring</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;lyric&#39;</span><span class="p">)</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="mi">5</span><span class="p">:])</span>
                <span class="n">output_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
          <span class="k">except</span><span class="p">:</span>
            <span class="k">continue</span>
            

      <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Bad note string:&#39;</span><span class="p">,</span> <span class="n">istring</span><span class="p">)</span>
        <span class="k">continue</span>

    <span class="c1"># Simple error control just in case</span>
    <span class="n">S</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">output_list</span><span class="p">:</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">S</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="n">output_list</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>    
    <span class="n">output_list</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>


    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Task complete! Enjoy! :)&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output_list</span><span class="p">,</span> <span class="n">song_name</span>

<span class="c1">###################################################################################</span>
<span class="c1">#</span>
<span class="c1"># TMIDI 2.0 Helper functions</span>
<span class="c1">#</span>
<span class="c1">###################################################################################</span>

<span class="k">def</span> <span class="nf">Tegridy_TXT_Tokenizer</span><span class="p">(</span><span class="n">input_TXT_string</span><span class="p">,</span> <span class="n">line_by_line_TXT_string</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Tegridy TXT Tokenizer</span>
<span class="sd">     </span>
<span class="sd">    Input: TXT String</span>

<span class="sd">    Output: Tokenized TXT string + forward and reverse dics</span>
<span class="sd">    </span>
<span class="sd">    Project Los Angeles</span>
<span class="sd">    Tegridy Code 2021&#39;&#39;&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tegridy TXT Tokenizer&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">line_by_line_TXT_string</span><span class="p">:</span>
      <span class="n">T</span> <span class="o">=</span> <span class="n">input_TXT_string</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">T</span> <span class="o">=</span> <span class="n">input_TXT_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

    <span class="n">DIC</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">T</span><span class="p">))))</span>
    <span class="n">RDIC</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">T</span><span class="p">)),</span> <span class="n">T</span><span class="p">))</span>

    <span class="n">TXTT</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">T</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">TXTT</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">DIC</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
      <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error. Could not finish.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">TXTT</span><span class="p">,</span> <span class="n">DIC</span><span class="p">,</span> <span class="n">RDIC</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done!&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">TXTT</span><span class="p">,</span> <span class="n">DIC</span><span class="p">,</span> <span class="n">RDIC</span>

<span class="c1">###################################################################################</span>

<span class="k">def</span> <span class="nf">Tegridy_TXT_DeTokenizer</span><span class="p">(</span><span class="n">input_Tokenized_TXT_string</span><span class="p">,</span> <span class="n">RDIC</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Tegridy TXT Tokenizer</span>
<span class="sd">     </span>
<span class="sd">    Input: Tokenized TXT String</span>
<span class="sd">           </span>

<span class="sd">    Output: DeTokenized TXT string</span>
<span class="sd">    </span>
<span class="sd">    Project Los Angeles</span>
<span class="sd">    Tegridy Code 2021&#39;&#39;&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tegridy TXT DeTokenizer&#39;</span><span class="p">)</span>

    <span class="n">Q</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_Tokenized_TXT_string</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">RTXT</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">Q</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">RTXT</span> <span class="o">+=</span> <span class="n">RDIC</span><span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="n">q</span><span class="p">)]</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
      <span class="k">except</span><span class="p">:</span>
        <span class="n">c</span><span class="o">+=</span><span class="mi">1</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of errors:&#39;</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done!&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">RTXT</span>

<span class="c1">###################################################################################</span>

<span class="k">def</span> <span class="nf">Tegridy_Optimus_TXT_to_INT_Converter</span><span class="p">(</span><span class="n">TXT_String</span><span class="p">,</span> <span class="n">time_denominator</span><span class="o">=</span><span class="mi">128</span><span class="p">):</span>

  <span class="sd">&#39;&#39;&#39;Project Los Angeles</span>
<span class="sd">     Tegridy Code 2021&#39;&#39;&#39;</span>

  <span class="n">INT8_List</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">TXT_String</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="nb">ord</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">//</span> <span class="n">time_denominator</span><span class="p">)</span> <span class="o">//</span> <span class="mi">128</span><span class="p">)</span>
      <span class="n">b</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">%</span> <span class="n">time_denominator</span><span class="p">)</span>

      <span class="n">INT8_List</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
      <span class="n">INT8_List</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Bad TXT bits:&#39;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
      <span class="k">continue</span>

  <span class="k">return</span> <span class="n">INT8_List</span>

<span class="c1">###################################################################################</span>

<span class="k">def</span> <span class="nf">Tegridy_Optimus_INT_to_TXT_Converter</span><span class="p">(</span><span class="n">INT8_List</span><span class="p">,</span> <span class="n">time_denominator</span><span class="o">=</span><span class="mi">128</span><span class="p">):</span>

  <span class="n">TXT_String</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">INT8_List</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">a</span> <span class="o">=</span> <span class="n">INT8_List</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">time_denominator</span> <span class="o">*</span> <span class="mi">128</span>
      <span class="n">b</span> <span class="o">=</span> <span class="n">INT8_List</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    
      <span class="n">TXT_String</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Bad INT bits:&#39;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
      <span class="k">continue</span>

  <span class="k">return</span> <span class="n">TXT_String</span>

<span class="c1">###################################################################################</span>

<span class="k">def</span> <span class="nf">Tegridy_Optimus_Sum_Intro_Rand_End_Sampler</span><span class="p">(</span><span class="n">MIDI_file</span><span class="p">,</span> <span class="n">number_of_notes_in_samples</span> <span class="o">=</span> <span class="mi">256</span><span class="p">):</span>

  <span class="sd">&#39;&#39;&#39;Project Los Angeles</span>
<span class="sd">     Tegridy Code 2021&#39;&#39;&#39;</span>

  <span class="n">INTRO</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">RAND</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">END</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="n">SUM</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="n">txt</span><span class="p">,</span> <span class="n">melody_list</span><span class="p">,</span> <span class="n">chords</span> <span class="o">=</span> <span class="n">Optimus_MIDI_TXT_Processor</span><span class="p">(</span><span class="n">MIDI_file</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">127</span><span class="p">))</span>

  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chords</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">number_of_notes_in_samples</span><span class="p">:</span>
    <span class="n">number_of_notes_in_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chords</span><span class="p">)</span>

  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">chords</span><span class="p">[:</span><span class="n">number_of_notes_in_samples</span><span class="p">]:</span>
    <span class="n">INTRO</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>

  <span class="n">r</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">randbelow</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chords</span><span class="p">)</span> <span class="o">-</span> <span class="n">number_of_notes_in_samples</span><span class="p">)</span>
  
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">chords</span><span class="p">[</span><span class="n">r</span><span class="p">:</span><span class="n">r</span><span class="o">+</span><span class="n">number_of_notes_in_samples</span><span class="p">]:</span> 
    <span class="n">RAND</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
  
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">chords</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">chords</span><span class="p">)</span><span class="o">-</span><span class="n">number_of_notes_in_samples</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">chords</span><span class="p">)]:</span> 
    <span class="n">END</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>

  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">chords</span><span class="p">:</span>
    <span class="n">SUM</span> <span class="o">+=</span> <span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>

  <span class="k">return</span> <span class="n">SUM</span><span class="p">,</span> <span class="n">INTRO</span><span class="p">,</span> <span class="n">RAND</span><span class="p">,</span> <span class="n">END</span>

<span class="c1">###################################################################################</span>

<span class="k">def</span> <span class="nf">Tegridy_MIDI_Signature</span><span class="p">(</span><span class="n">melody</span><span class="p">,</span> <span class="n">chords</span><span class="p">):</span>

  <span class="sd">&#39;&#39;&#39;Input: flat melody list and flat chords list</span>
<span class="sd">     </span>
<span class="sd">     Output: Melody signature and Chords signature</span>
<span class="sd">     </span>
<span class="sd">     Project Los Angeles</span>
<span class="sd">     Tegridy Code 2021&#39;&#39;&#39;</span>

  <span class="c1"># prepping data</span>
  <span class="n">melody_list_f</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">chords_list_f</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="c1"># melody</span>
  <span class="n">m_st_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">melody</span><span class="p">])</span>
  <span class="n">m_st_avg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m_st_sum</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">melody</span><span class="p">))</span>
  <span class="n">m_du_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">melody</span><span class="p">])</span>
  <span class="n">m_du_avg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m_du_sum</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">melody</span><span class="p">))</span>
  <span class="n">m_ch_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">y</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">melody</span><span class="p">])</span>
  <span class="n">m_ch_avg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m_ch_sum</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">melody</span><span class="p">))</span>
  <span class="n">m_pt_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">y</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">melody</span><span class="p">])</span>
  <span class="n">m_pt_avg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m_pt_sum</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">melody</span><span class="p">))</span>
  <span class="n">m_vl_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">y</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">melody</span><span class="p">])</span>
  <span class="n">m_vl_avg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m_vl_sum</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">melody</span><span class="p">))</span>
  
  <span class="n">melody_list_f</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">m_st_sum</span><span class="p">,</span> 
                        <span class="n">m_st_avg</span><span class="p">,</span>
                        <span class="n">m_du_sum</span><span class="p">,</span>
                        <span class="n">m_du_avg</span><span class="p">,</span>
                        <span class="n">m_ch_sum</span><span class="p">,</span>
                        <span class="n">m_ch_avg</span><span class="p">,</span>
                        <span class="n">m_pt_sum</span><span class="p">,</span>
                        <span class="n">m_pt_avg</span><span class="p">,</span>
                        <span class="n">m_vl_sum</span><span class="p">,</span>
                        <span class="n">m_vl_avg</span><span class="p">])</span>

  <span class="c1"># chords</span>
  <span class="n">c_st_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">chords</span><span class="p">])</span>
  <span class="n">c_st_avg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">c_st_sum</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">chords</span><span class="p">))</span>
  <span class="n">c_du_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">chords</span><span class="p">])</span>
  <span class="n">c_du_avg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">c_du_sum</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">chords</span><span class="p">))</span>
  <span class="n">c_ch_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">y</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">chords</span><span class="p">])</span>
  <span class="n">c_ch_avg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">c_ch_sum</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">chords</span><span class="p">))</span>
  <span class="n">c_pt_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">y</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">chords</span><span class="p">])</span>
  <span class="n">c_pt_avg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">c_pt_sum</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">chords</span><span class="p">))</span>
  <span class="n">c_vl_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">y</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">chords</span><span class="p">])</span>
  <span class="n">c_vl_avg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">c_vl_sum</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">chords</span><span class="p">))</span>

  <span class="n">chords_list_f</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">c_st_sum</span><span class="p">,</span> 
                        <span class="n">c_st_avg</span><span class="p">,</span>
                        <span class="n">c_du_sum</span><span class="p">,</span>
                        <span class="n">c_du_avg</span><span class="p">,</span>
                        <span class="n">c_ch_sum</span><span class="p">,</span>
                        <span class="n">c_ch_avg</span><span class="p">,</span>
                        <span class="n">c_pt_sum</span><span class="p">,</span>
                        <span class="n">c_pt_avg</span><span class="p">,</span>
                        <span class="n">c_vl_sum</span><span class="p">,</span>
                        <span class="n">c_vl_avg</span><span class="p">])</span>

  <span class="k">return</span> <span class="n">melody_list_f</span><span class="p">,</span> <span class="n">chords_list_f</span>

<span class="c1">###################################################################################</span>

<span class="k">def</span> <span class="nf">Tegridy_List_Slicer</span><span class="p">(</span><span class="n">input_list</span><span class="p">,</span> <span class="n">number_of_slices</span><span class="p">):</span>

  <span class="sd">&#39;&#39;&#39;Input: List to slice</span>
<span class="sd">            Number of desired slices</span>
<span class="sd">     </span>
<span class="sd">     Output: Sliced list of lists</span>
<span class="sd">     </span>
<span class="sd">     Project Los Angeles</span>
<span class="sd">     Tegridy Code 2021&#39;&#39;&#39;</span>

  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_list</span><span class="p">),</span> <span class="n">number_of_slices</span><span class="p">):</span>
     <span class="k">yield</span> <span class="n">input_list</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">number_of_slices</span><span class="p">]</span>

<span class="c1">###################################################################################</span>

<span class="c1"># Alternative MIDI Processor (Google Magenta note-seq representation)</span>
<span class="c1"># Useful in some cases and for some Music AI implementations/architectures. </span>

<span class="c1"># Based on the repo/code of Music X Lab at NYU Shanghai:</span>
<span class="c1"># https://github.com/music-x-lab/POP909-Dataset</span>
<span class="c1"># Please note that the license for the code below is MIT as requested by the dev.</span>

<span class="c1">###################################################################################</span>

<span class="c1"># Copyright (c) 2020 Music X Lab</span>

<span class="c1"># Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class="c1"># of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
<span class="c1"># in the Software without restriction, including without limitation the rights</span>
<span class="c1"># to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class="c1"># copies of the Software, and to permit persons to whom the Software is</span>
<span class="c1"># furnished to do so, subject to the following conditions:</span>

<span class="c1"># The above copyright notice and this permission notice shall be included in all</span>
<span class="c1"># copies or substantial portions of the Software.</span>

<span class="c1"># THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="c1"># IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="c1"># FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="c1"># AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="c1"># LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<span class="c1"># OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="c1"># SOFTWARE.</span>

<span class="c1">###################################################################################</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Notes Representation Processor</span>
<span class="sd">============</span>

<span class="sd">These are core classes of representation processor.</span>

<span class="sd">Repr Processor: the basic representation processor</span>
<span class="sd">    - Event Processor</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">class</span> <span class="nc">Tegridy_ReprProcessor</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Abstract base class severing as the representation processor.</span>

<span class="sd">    It provides the following abstract methods.</span>
<span class="sd">    - encode(self, note_seq): encode the note sequence into the representation sequence.</span>
<span class="sd">    - decode(self, repr_seq): decode the representation sequence into the note sequence.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The base representation processor class includes the convertion between the note sequence and the representation sequence.</span>
<span class="sd">    In general, we assume the input note sequence has already been quantized.</span>
<span class="sd">    In that, the smallest unit of the quantization is actually 1 tick no matter what resolution is.</span>
<span class="sd">    If you init &quot;min_step&quot; to be larger than 1, we assume you wish to compress all the base tick.</span>
<span class="sd">    e.g. min_step = 2, then the whole ticks will be convertd half.</span>
<span class="sd">    If you do this, the representation convertion may not be 100% correct.</span>
<span class="sd">    -----</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_step</span> <span class="o">=</span> <span class="n">min_step</span>

    <span class="k">def</span> <span class="nf">_compress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">note_seq</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the compressed note_seq based on the min_step &gt; 1.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        note_seq : Note Array.</span>
<span class="sd">        ----------</span>

<span class="sd">        WARNING: If you do this, the representation convertion may not be 100% correct.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_note_seq</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Note</span><span class="p">(</span>
                <span class="n">start</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">start</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_step</span><span class="p">),</span>
                <span class="n">end</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">end</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_step</span><span class="p">),</span>
                <span class="n">pitch</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">pitch</span><span class="p">,</span>
                <span class="n">velocity</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">velocity</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">note_seq</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">new_note_seq</span>

    <span class="k">def</span> <span class="nf">_expand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">note_seq</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the expanded note_seq based on the min_step &gt; 1.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        note_seq : Note Array.</span>
<span class="sd">        ----------</span>

<span class="sd">        WARNING: If you do this, the representation convertion may not be 100% correct.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_note_seq</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Note</span><span class="p">(</span>
                <span class="n">start</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">start</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_step</span><span class="p">),</span>
                <span class="n">end</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">end</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_step</span><span class="p">),</span>
                <span class="n">pitch</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">pitch</span><span class="p">,</span>
                <span class="n">velocity</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">velocity</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">note_seq</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">new_note_seq</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">note_seq</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;encode the note sequence into the representation sequence.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        note_seq= the input {Note} sequence</span>

<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">        repr_seq: the representation numpy sequence</span>

<span class="sd">        &quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repr_seq</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;decode the representation sequence into the note sequence.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        repr_seq: the representation numpy sequence</span>

<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">        note_seq= the input {Note} sequence</span>

<span class="sd">        &quot;&quot;&quot;</span>

<span class="c1">###################################################################################</span>
<span class="c1"># pretty_midi Note class</span>
<span class="c1"># Code is from original pretty_midi repo:</span>
<span class="c1"># https://github.com/craffel/pretty-midi/blob/master/pretty_midi/containers.py</span>
<span class="c1">###################################################################################</span>
<span class="k">class</span> <span class="nc">Note</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A note event.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    velocity : int</span>
<span class="sd">        Note velocity.</span>
<span class="sd">    pitch : int</span>
<span class="sd">        Note pitch, as a MIDI note number.</span>
<span class="sd">    start : float</span>
<span class="sd">        Note on time, absolute, in seconds.</span>
<span class="sd">    end : float</span>
<span class="sd">        Note off time, absolute, in seconds.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">velocity</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">velocity</span> <span class="o">=</span> <span class="n">velocity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pitch</span> <span class="o">=</span> <span class="n">pitch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">end</span>

    <span class="k">def</span> <span class="nf">get_duration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the duration of the note in seconds.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">duration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_duration</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;Note(start=</span><span class="si">{:f}</span><span class="s1">, end=</span><span class="si">{:f}</span><span class="s1">, pitch=</span><span class="si">{}</span><span class="s1">, velocity=</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pitch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">velocity</span><span class="p">)</span>

<span class="c1">###################################################################################</span>

<span class="k">class</span> <span class="nc">Tegridy_RPR_MidiEventProcessor</span><span class="p">(</span><span class="n">Tegridy_ReprProcessor</span><span class="p">):</span>
  
    <span class="sd">&quot;&quot;&quot;Midi Event Representation Processor.</span>

<span class="sd">    Representation Format:</span>
<span class="sd">    -----</span>
<span class="sd">    Size: L * D:</span>
<span class="sd">        - L for the sequence (event) length</span>
<span class="sd">        - D = 1 {</span>
<span class="sd">            0-127: note-on event,</span>
<span class="sd">            128-255: note-off event,</span>
<span class="sd">            256-355(default):</span>
<span class="sd">                tick-shift event</span>
<span class="sd">                256 for one tick, 355 for 100 ticks</span>
<span class="sd">                the maximum number of tick-shift can be specified</span>
<span class="sd">            356-388 (default):</span>
<span class="sd">                velocity event</span>
<span class="sd">                the maximum number of quantized velocity can be specified</span>
<span class="sd">            }</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----</span>
<span class="sd">    min_step(optional):</span>
<span class="sd">        minimum quantification step</span>
<span class="sd">        decide how many ticks to be the basic unit (default = 1)</span>
<span class="sd">    tick_dim(optional):</span>
<span class="sd">        tick-shift event dimensions</span>
<span class="sd">        the maximum number of tick-shift (default = 100)</span>
<span class="sd">    velocity_dim(optional):</span>
<span class="sd">        velocity event dimensions</span>
<span class="sd">        the maximum number of quantized velocity (default = 32, max = 128)</span>

<span class="sd">    e.g.</span>

<span class="sd">    [C5 - - - E5 - - / G5 - - / /]</span>
<span class="sd">    -&gt;</span>
<span class="sd">    [380, 60, 259, 188, 64, 258, 192, 256, 67, 258, 195, 257]</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;midievent&quot;</span>
        <span class="n">min_step</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="s2">&quot;min_step&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">min_step</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;min_step&quot;</span><span class="p">]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Tegridy_RPR_MidiEventProcessor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">min_step</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tick_dim</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">velocity_dim</span> <span class="o">=</span> <span class="mi">32</span>
        <span class="k">if</span> <span class="s2">&quot;tick_dim&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tick_dim</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;tick_dim&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;velocity_dim&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">velocity_dim</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;velocity_dim&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">velocity_dim</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;velocity_dim cannot be larger than 128&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">velocity_dim</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_vocab</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tick_dim</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">velocity_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_index</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;note_on&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;note_off&quot;</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>
            <span class="s2">&quot;time_shift&quot;</span><span class="p">:</span> <span class="mi">256</span><span class="p">,</span>
            <span class="s2">&quot;velocity&quot;</span><span class="p">:</span> <span class="mi">256</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tick_dim</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">note_seq</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the note token</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        note_seq : Note List.</span>

<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">        repr_seq: Representation List</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">note_seq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_step</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">note_seq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compress</span><span class="p">(</span><span class="n">note_seq</span><span class="p">)</span>
        <span class="n">notes</span> <span class="o">=</span> <span class="n">note_seq</span>
        <span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">meta_events</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">note</span> <span class="ow">in</span> <span class="n">notes</span><span class="p">:</span>
            <span class="n">token_on</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;note_on&quot;</span><span class="p">,</span>
                <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">note</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                <span class="s2">&quot;pitch&quot;</span><span class="p">:</span> <span class="n">note</span><span class="o">.</span><span class="n">pitch</span><span class="p">,</span>
                <span class="s2">&quot;vel&quot;</span><span class="p">:</span> <span class="n">note</span><span class="o">.</span><span class="n">velocity</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">token_off</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;note_off&quot;</span><span class="p">,</span>
                <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">note</span><span class="o">.</span><span class="n">end</span><span class="p">,</span>
                <span class="s2">&quot;pitch&quot;</span><span class="p">:</span> <span class="n">note</span><span class="o">.</span><span class="n">pitch</span><span class="p">,</span>
                <span class="s2">&quot;vel&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">meta_events</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">token_on</span><span class="p">,</span> <span class="n">token_off</span><span class="p">])</span>
        <span class="n">meta_events</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">])</span>    
        <span class="n">meta_events</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">])</span>
        <span class="n">time_shift</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cur_vel</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">me</span> <span class="ow">in</span> <span class="n">meta_events</span><span class="p">:</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">me</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">time_shift</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">duration</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tick_dim</span><span class="p">:</span>
                <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">start_index</span><span class="p">[</span><span class="s2">&quot;time_shift&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tick_dim</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="p">)</span>
                <span class="n">duration</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tick_dim</span>
            <span class="k">if</span> <span class="n">duration</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_index</span><span class="p">[</span><span class="s2">&quot;time_shift&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">duration</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">me</span><span class="p">[</span><span class="s2">&quot;vel&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cur_vel</span> <span class="o">!=</span> <span class="n">me</span><span class="p">[</span><span class="s2">&quot;vel&quot;</span><span class="p">]:</span>
                    <span class="n">cur_vel</span> <span class="o">=</span> <span class="n">me</span><span class="p">[</span><span class="s2">&quot;vel&quot;</span><span class="p">]</span>
                    <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">start_index</span><span class="p">[</span><span class="s2">&quot;velocity&quot;</span><span class="p">]</span>
                        <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">me</span><span class="p">[</span><span class="s2">&quot;vel&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">velocity_dim</span> <span class="o">/</span> <span class="mi">128</span><span class="p">))</span>
                    <span class="p">)</span>
            <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_index</span><span class="p">[</span><span class="n">me</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">+</span> <span class="n">me</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">])</span>
            <span class="n">time_shift</span> <span class="o">=</span> <span class="n">me</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">events</span>

    <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repr_seq</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the note seq</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        repr_seq: Representation Sequence List</span>

<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">        note_seq : Note List.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># print(repr_seq)</span>
        <span class="k">if</span> <span class="n">repr_seq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">time_shift</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">cur_vel</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">meta_events</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">note_on_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">notes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">repr_seq</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_index</span><span class="p">[</span><span class="s2">&quot;note_on&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">e</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_index</span><span class="p">[</span><span class="s2">&quot;note_off&quot;</span><span class="p">]:</span>
                <span class="n">token_on</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;note_on&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">time_shift</span><span class="p">,</span>
                    <span class="s2">&quot;pitch&quot;</span><span class="p">:</span> <span class="n">e</span><span class="p">,</span>
                    <span class="s2">&quot;vel&quot;</span><span class="p">:</span> <span class="n">cur_vel</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">meta_events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token_on</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">start_index</span><span class="p">[</span><span class="s2">&quot;note_off&quot;</span><span class="p">]</span>
                <span class="o">&lt;=</span> <span class="n">e</span>
                <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_index</span><span class="p">[</span><span class="s2">&quot;time_shift&quot;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="n">token_off</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;note_off&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">time_shift</span><span class="p">,</span>
                    <span class="s2">&quot;pitch&quot;</span><span class="p">:</span> <span class="n">e</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_index</span><span class="p">[</span><span class="s2">&quot;note_off&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;vel&quot;</span><span class="p">:</span> <span class="n">cur_vel</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">meta_events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token_off</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">start_index</span><span class="p">[</span><span class="s2">&quot;time_shift&quot;</span><span class="p">]</span>
                <span class="o">&lt;=</span> <span class="n">e</span>
                <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_index</span><span class="p">[</span><span class="s2">&quot;velocity&quot;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="n">time_shift</span> <span class="o">+=</span> <span class="p">(</span><span class="n">e</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_index</span><span class="p">[</span><span class="s2">&quot;time_shift&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.01</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_index</span><span class="p">[</span><span class="s2">&quot;velocity&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">e</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_vocab</span><span class="p">:</span>
                <span class="n">cur_vel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">e</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_index</span><span class="p">[</span><span class="s2">&quot;velocity&quot;</span><span class="p">])</span>
                    <span class="o">*</span> <span class="mi">128</span>
                    <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">velocity_dim</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="n">skip_notes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">me</span> <span class="ow">in</span> <span class="n">meta_events</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">me</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;note_on&quot;</span><span class="p">:</span>
                <span class="n">note_on_dict</span><span class="p">[</span><span class="n">me</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">me</span>
            <span class="k">elif</span> <span class="n">me</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;note_off&quot;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">token_on</span> <span class="o">=</span> <span class="n">note_on_dict</span><span class="p">[</span><span class="n">me</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">]]</span>
                    <span class="n">token_off</span> <span class="o">=</span> <span class="n">me</span>
                    <span class="k">if</span> <span class="n">token_on</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">token_off</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]:</span>
                        <span class="k">continue</span>
                    <span class="n">notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">Note</span><span class="p">(</span>
                            <span class="n">velocity</span><span class="o">=</span><span class="n">token_on</span><span class="p">[</span><span class="s2">&quot;vel&quot;</span><span class="p">],</span>
                            <span class="n">pitch</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">token_on</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">]),</span>
                            <span class="n">start</span><span class="o">=</span><span class="n">token_on</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span>
                            <span class="n">end</span><span class="o">=</span><span class="n">token_off</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">skip_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>
        <span class="n">notes</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_step</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">notes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand</span><span class="p">(</span><span class="n">notes</span><span class="p">)</span>
        <span class="c1"># print(notes)</span>
        <span class="k">return</span> <span class="n">notes</span>

<span class="c1">###################################################################################</span>

<span class="c1"># This is the end of the TMIDI Python module</span>

<span class="c1">###################################################################################</span>
</pre></div>

  </div>

  </header>

  <section id="section-items">
    <h2 class="section-title" id="header-variables">Module variables</h2>
      <div class="item">
      <p id="TMIDI.All_events" class="name">var <span class="ident">All_events</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="TMIDI.Event2channelindex" class="name">var <span class="ident">Event2channelindex</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="TMIDI.MIDI_events" class="name">var <span class="ident">MIDI_events</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="TMIDI.Meta_events" class="name">var <span class="ident">Meta_events</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="TMIDI.Nontext_meta_events" class="name">var <span class="ident">Nontext_meta_events</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="TMIDI.Notenum2percussion" class="name">var <span class="ident">Notenum2percussion</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="TMIDI.Number2patch" class="name">var <span class="ident">Number2patch</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="TMIDI.Text_events" class="name">var <span class="ident">Text_events</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="TMIDI.Version" class="name">var <span class="ident">Version</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="TMIDI.VersionDate" class="name">var <span class="ident">VersionDate</span></p>
      
  
  <div class="source_cont">
</div>

      </div>

    <h2 class="section-title" id="header-functions">Functions</h2>
      
  <div class="item">
    <div class="name def" id="TMIDI.Optimus_MIDI_TXT_Processor">
    <p>def <span class="ident">Optimus_MIDI_TXT_Processor</span>(</p><p>MIDI_file, line_by_line_output=True, chordify_TXT=False, dataset_MIDI_events_time_denominator=1, output_velocity=True, output_MIDI_channels=False, MIDI_channel=0, MIDI_patch=[0, 1], char_offset=30000, transpose_by=0, flip=False, melody_conditioned_encoding=False, melody_pitch_baseline=0, number_of_notes_to_sample=-1, sampling_offset_from_start=0, karaoke=False, karaoke_language_encoding=&#39;utf-8&#39;, song_name=&#39;Song&#39;)</p>
    </div>
    

    
  
    <div class="desc"><p>Project Los Angeles
Tegridy Code 2021</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.Optimus_MIDI_TXT_Processor', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.Optimus_MIDI_TXT_Processor" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">Optimus_MIDI_TXT_Processor</span><span class="p">(</span><span class="n">MIDI_file</span><span class="p">,</span> 
                              <span class="n">line_by_line_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                              <span class="n">chordify_TXT</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">dataset_MIDI_events_time_denominator</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                              <span class="n">output_velocity</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">output_MIDI_channels</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                              <span class="n">MIDI_channel</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                              <span class="n">MIDI_patch</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> 
                              <span class="n">char_offset</span> <span class="o">=</span> <span class="mi">30000</span><span class="p">,</span>
                              <span class="n">transpose_by</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                              <span class="n">flip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                              <span class="n">melody_conditioned_encoding</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">melody_pitch_baseline</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                              <span class="n">number_of_notes_to_sample</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                              <span class="n">sampling_offset_from_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                              <span class="n">karaoke</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">karaoke_language_encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span>
                              <span class="n">song_name</span><span class="o">=</span><span class="s1">&#39;Song&#39;</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Project Los Angeles</span>
<span class="sd">       Tegridy Code 2021&#39;&#39;&#39;</span>
  
<span class="c1">###########</span>

    <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">ev</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">chords_list_final</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">chords_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">events_matrix</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">melody</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">melody1</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">itrack</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">min_note</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">max_note</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ev</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">patch</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">score</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">rec_event</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">txt</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">txtc</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">chords</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">melody_chords</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">karaoke_events_matrix</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">karaokez</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">sample</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">start_sample</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1">###########    </span>

    <span class="k">def</span> <span class="nf">list_average</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
      <span class="n">sum_num</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">num</span><span class="p">:</span>
          <span class="n">sum_num</span> <span class="o">=</span> <span class="n">sum_num</span> <span class="o">+</span> <span class="n">t</span>           

      <span class="n">avg</span> <span class="o">=</span> <span class="n">sum_num</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">avg</span>

<span class="c1">###########</span>

    <span class="c1">#print(&#39;Loading MIDI file...&#39;)</span>
    <span class="n">midi_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">MIDI_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Processing File:&#39;</span><span class="p">,</span> <span class="n">file_address</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
      <span class="n">opus</span> <span class="o">=</span> <span class="n">midi2opus</span><span class="p">(</span><span class="n">midi_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    
    <span class="k">except</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Bad file. Skipping...&#39;</span><span class="p">)</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;File name:&#39;</span><span class="p">,</span> <span class="n">MIDI_file</span><span class="p">)</span>
      <span class="n">midi_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">txt</span><span class="p">,</span> <span class="n">melody</span><span class="p">,</span> <span class="n">chords</span>
         
    <span class="n">midi_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">score1</span> <span class="o">=</span> <span class="n">to_millisecs</span><span class="p">(</span><span class="n">opus</span><span class="p">)</span>
    <span class="n">score2</span> <span class="o">=</span> <span class="n">opus2score</span><span class="p">(</span><span class="n">score1</span><span class="p">)</span>

    <span class="c1"># score2 = opus2score(opus) # TODO Improve score timings when it will be possible.</span>
    
    <span class="k">if</span> <span class="n">MIDI_channel</span> <span class="o">==</span> <span class="mi">16</span><span class="p">:</span> <span class="c1"># Process all MIDI channels</span>
      <span class="n">score</span> <span class="o">=</span> <span class="n">score2</span>
    
    <span class="k">if</span> <span class="n">MIDI_channel</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">MIDI_channel</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">:</span> <span class="c1"># Process only a selected single MIDI channel</span>
      <span class="n">score</span> <span class="o">=</span> <span class="n">grep</span><span class="p">(</span><span class="n">score2</span><span class="p">,</span> <span class="p">[</span><span class="n">MIDI_channel</span><span class="p">])</span>
    
    <span class="k">if</span> <span class="n">MIDI_channel</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># Process all channels except drums (except channel 9)</span>
      <span class="n">score</span> <span class="o">=</span> <span class="n">grep</span><span class="p">(</span><span class="n">score2</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">])</span>   
    
    <span class="c1">#print(&#39;Reading all MIDI events from the MIDI file...&#39;)</span>
    <span class="k">while</span> <span class="n">itrack</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">):</span>
      <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">score</span><span class="p">[</span><span class="n">itrack</span><span class="p">]:</span>

        <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;text_event&#39;</span> <span class="ow">or</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;lyric&#39;</span> <span class="ow">or</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note&#39;</span><span class="p">:</span>
          <span class="n">karaokez</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;text_event&#39;</span> <span class="ow">or</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;lyric&#39;</span><span class="p">:</span>
          <span class="k">try</span><span class="p">:</span>
            <span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">karaoke_language_encoding</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
          <span class="k">except</span><span class="p">:</span>
            <span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">continue</span>
          <span class="n">karaoke_events_matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;patch_change&#39;</span><span class="p">:</span>
          <span class="n">patch</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note&#39;</span> <span class="ow">and</span> <span class="n">patch</span> <span class="ow">in</span> <span class="n">MIDI_patch</span><span class="p">:</span>
          <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span> <span class="c1"># Checking for bad notes...</span>
              <span class="n">eve</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
              
              <span class="n">eve</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">dataset_MIDI_events_time_denominator</span><span class="p">)</span>
              <span class="n">eve</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">dataset_MIDI_events_time_denominator</span><span class="p">)</span>
              
              <span class="n">eve</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">transpose_by</span><span class="p">)</span>
              
              <span class="k">if</span> <span class="n">flip</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">eve</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">127</span> <span class="o">-</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">transpose_by</span><span class="p">))</span> 
              
              <span class="k">if</span> <span class="n">number_of_notes_to_sample</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sample</span> <span class="o">&lt;=</span> <span class="n">number_of_notes_to_sample</span><span class="p">:</span>
                  <span class="k">if</span> <span class="n">start_sample</span> <span class="o">&gt;=</span> <span class="n">sampling_offset_from_start</span><span class="p">:</span>
                    <span class="n">events_matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eve</span><span class="p">)</span>
                    <span class="n">sample</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">ev</span> <span class="o">+=</span> <span class="mi">1</span>
                  <span class="k">else</span><span class="p">:</span>
                    <span class="n">start_sample</span> <span class="o">+=</span> <span class="mi">1</span>

              <span class="k">else</span><span class="p">:</span>
                <span class="n">events_matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eve</span><span class="p">)</span>
                <span class="n">ev</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">start_sample</span> <span class="o">+=</span> <span class="mi">1</span>
                
      <span class="n">itrack</span> <span class="o">+=</span><span class="mi">1</span> <span class="c1"># Going to next track...</span>

    <span class="c1">#print(&#39;Doing some heavy pythonic sorting...Please stand by...&#39;)</span>

    <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">MIDI_file</span><span class="p">)</span>
    <span class="n">song_name</span> <span class="o">=</span> <span class="n">song_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">song_name</span> <span class="o">==</span> <span class="s1">&#39;Song&#39;</span><span class="p">:</span>
      <span class="n">sng_name</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
      <span class="n">song_name</span> <span class="o">=</span> <span class="n">sng_name</span>
    
    <span class="n">txt</span> <span class="o">+=</span> <span class="s1">&#39;SONG=&#39;</span> <span class="o">+</span> <span class="n">song_name</span> <span class="o">+</span> <span class="s1">&#39;_with_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">events_matrix</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_notes&#39;</span>
    <span class="n">txtc</span> <span class="o">+=</span> <span class="s1">&#39;SONG=&#39;</span> <span class="o">+</span> <span class="n">song_name</span> <span class="o">+</span> <span class="s1">&#39;_with_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">events_matrix</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_notes&#39;</span>

    <span class="k">if</span> <span class="n">line_by_line_output</span><span class="p">:</span>
      <span class="n">txt</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
      <span class="n">txtc</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">txt</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
      <span class="n">txtc</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

    <span class="c1">#print(&#39;Sorting input by start time...&#39;)</span>
    <span class="n">events_matrix</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Sorting input by start time</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">karaoke</span><span class="p">:</span>
      <span class="n">previous_event</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">events_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
      <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events_matrix</span><span class="p">:</span>

        <span class="sd">&#39;&#39;&#39;# Computing deltas</span>
<span class="sd">        start_time = int(event[1] - previous_event[1])</span>
<span class="sd">        duration = int(event[2] - previous_event[2])</span>
<span class="sd">        channel = int(event[3])</span>
<span class="sd">        pitch = int(event[4] - previous_event[4])</span>
<span class="sd">        velocity = int(event[5] - previous_event[5])&#39;&#39;&#39;</span>

        <span class="c1"># Computing events details</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">previous_event</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="n">duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">previous_event</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="n">channel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">previous_event</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

        <span class="n">pitch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">previous_event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">transpose_by</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">flip</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
          <span class="n">pitch</span> <span class="o">=</span> <span class="mi">127</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">previous_event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">transpose_by</span><span class="p">)</span>

        <span class="n">velocity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">previous_event</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>

        <span class="c1"># Converting to TXT</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">start_time</span> <span class="o">+</span> <span class="n">char_offset</span><span class="p">))</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">duration</span> <span class="o">+</span> <span class="n">char_offset</span><span class="p">))</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">pitch</span> <span class="o">+</span> <span class="n">char_offset</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">output_velocity</span><span class="p">:</span>
          <span class="n">txt</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">velocity</span> <span class="o">+</span> <span class="n">char_offset</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">output_MIDI_channels</span><span class="p">:</span>
          <span class="n">txt</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">channel</span> <span class="o">+</span> <span class="n">char_offset</span><span class="p">))</span>


        <span class="k">if</span> <span class="n">chordify_TXT</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">previous_event</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
          <span class="n">txt</span> <span class="o">+=</span> <span class="s1">&#39;&#39;</span>      
        <span class="k">else</span><span class="p">:</span>     
          <span class="k">if</span> <span class="n">line_by_line_output</span><span class="p">:</span>
            <span class="n">txt</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">txt</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> 
        
        <span class="n">previous_event</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
      
      <span class="k">if</span> <span class="ow">not</span> <span class="n">line_by_line_output</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>      
    
    <span class="n">chords</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">events_matrix</span><span class="p">)</span>
    <span class="c1">#print(chords)</span>

    <span class="c1">#print(&#39;Extracting melody...&#39;)</span>
    <span class="n">melody_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1">#print(&#39;Grouping by start time. This will take a while...&#39;)</span>
    <span class="n">values</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">events_matrix</span><span class="p">))</span> <span class="c1"># Non-multithreaded function version just in case</span>

    <span class="n">groups</span> <span class="o">=</span> <span class="p">[[</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">events_matrix</span> <span class="k">if</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="n">x</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span> <span class="c1"># Grouping notes into chords while discarting bad notes...</span>
  
    <span class="c1">#print(&#39;Sorting events...&#39;)</span>
    <span class="k">for</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
        <span class="n">items</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="c1"># Sorting events by pitch</span>
        <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Melody should always bear MIDI Channel 0 for code to work</span>
        <span class="n">melody_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># Creating final melody list</span>
        <span class="n">melody_chords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="c1"># Creating final chords list</span>
    <span class="c1">#print(&#39;Final sorting by start time...&#39;)      </span>
    <span class="n">melody_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Sorting events by start time</span>
    <span class="n">melody_chords</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Sorting events by start time</span>
    <span class="c1">#print(txt, melody, chords)</span>

    <span class="c1"># [WIP] Melody-conditioned chords list</span>
    <span class="k">if</span> <span class="n">melody_conditioned_encoding</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">karaoke</span><span class="p">:</span>
   
        <span class="n">previous_event</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">melody_chords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">melody_chords</span><span class="p">:</span>
          <span class="n">hp</span> <span class="o">=</span> <span class="kc">True</span>
          <span class="n">ev</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="c1"># Sorting chord events by pitch</span>
          <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">ev</span><span class="p">:</span>
          
            <span class="c1"># Computing events details</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">previous_event</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            
            <span class="n">duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">previous_event</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">hp</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
              <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">previous_event</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">melody_pitch_baseline</span><span class="p">:</span>
                <span class="n">channel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">hp</span> <span class="o">=</span> <span class="kc">False</span>
              <span class="k">else</span><span class="p">:</span>
                <span class="n">channel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">previous_event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">hp</span> <span class="o">=</span> <span class="kc">False</span>  
            <span class="k">else</span><span class="p">:</span>
              <span class="n">channel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">previous_event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
              <span class="n">hp</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">pitch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">previous_event</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>

            <span class="n">velocity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">previous_event</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>

            <span class="c1"># Converting to TXT</span>
            <span class="n">txtc</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">start_time</span> <span class="o">+</span> <span class="n">char_offset</span><span class="p">))</span>
            <span class="n">txtc</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">duration</span> <span class="o">+</span> <span class="n">char_offset</span><span class="p">))</span>
            <span class="n">txtc</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">pitch</span> <span class="o">+</span> <span class="n">char_offset</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">output_velocity</span><span class="p">:</span>
              <span class="n">txtc</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">velocity</span> <span class="o">+</span> <span class="n">char_offset</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">output_MIDI_channels</span><span class="p">:</span>
              <span class="n">txtc</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">channel</span> <span class="o">+</span> <span class="n">char_offset</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">line_by_line_output</span><span class="p">:</span>
            

              <span class="n">txtc</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>

              <span class="n">txtc</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

            <span class="n">previous_event</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line_by_line_output</span><span class="p">:</span>
          <span class="n">txtc</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

        <span class="n">txt</span> <span class="o">=</span> <span class="n">txtc</span>
        <span class="n">chords</span> <span class="o">=</span> <span class="n">melody_chords</span>

    <span class="k">if</span> <span class="n">karaoke</span><span class="p">:</span>
      <span class="n">previous_event</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">melody_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
      <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">melody_list</span><span class="p">:</span>

        <span class="c1"># Computing events details</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">previous_event</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="n">duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">previous_event</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="n">channel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">previous_event</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

        <span class="n">pitch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">previous_event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">transpose_by</span><span class="p">)</span>

        <span class="n">velocity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">previous_event</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>

        <span class="c1"># Converting to TXT</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">start_time</span> <span class="o">+</span> <span class="n">char_offset</span><span class="p">))</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">duration</span> <span class="o">+</span> <span class="n">char_offset</span><span class="p">))</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">pitch</span> <span class="o">+</span> <span class="n">char_offset</span><span class="p">))</span>

        <span class="n">txt</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">velocity</span> <span class="o">+</span> <span class="n">char_offset</span><span class="p">))</span>      

        <span class="n">txt</span> <span class="o">+=</span> <span class="s1">&#39;=&#39;</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">karaoke_events_matrix</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">txt</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>          
            <span class="k">break</span>

        <span class="k">if</span> <span class="n">line_by_line_output</span><span class="p">:</span>
          <span class="n">txt</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">txt</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> 
        
        <span class="n">previous_event</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
      
      <span class="k">if</span> <span class="ow">not</span> <span class="n">line_by_line_output</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

    <span class="c1"># Helper aux/backup function for Karaoke</span>
    <span class="n">karaokez</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">txt</span><span class="p">,</span> <span class="n">melody_list</span><span class="p">,</span> <span class="n">chords</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.Tegridy_Any_Pickle_File_Loader">
    <p>def <span class="ident">Tegridy_Any_Pickle_File_Loader</span>(</p><p>input_file_name=&#39;TMIDI_Pickle_File&#39;, ext=&#39;.pickle&#39;)</p>
    </div>
    

    
  
    <div class="desc"><p>Tegridy Pickle File Loader</p>
<p>Input: Full path and file name without extention
       File extension if different from default .pickle</p>
<p>Output: Standard Python 3 unpickled data object</p>
<p>Project Los Angeles
Tegridy Code 2021</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.Tegridy_Any_Pickle_File_Loader', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.Tegridy_Any_Pickle_File_Loader" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">Tegridy_Any_Pickle_File_Loader</span><span class="p">(</span><span class="n">input_file_name</span><span class="o">=</span><span class="s1">&#39;TMIDI_Pickle_File&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;.pickle&#39;</span><span class="p">):</span>

  <span class="sd">&#39;&#39;&#39;Tegridy Pickle File Loader</span>
<span class="sd">     </span>
<span class="sd">  Input: Full path and file name without extention</span>
<span class="sd">         File extension if different from default .pickle</span>
<span class="sd">       </span>
<span class="sd">  Output: Standard Python 3 unpickled data object</span>

<span class="sd">  Project Los Angeles</span>
<span class="sd">  Tegridy Code 2021&#39;&#39;&#39;</span>

  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tegridy Pickle File Loader&#39;</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading the pickle file. Please wait...&#39;</span><span class="p">)</span>

  <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_file_name</span> <span class="o">+</span> <span class="n">ext</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pickle_file</span><span class="p">:</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">pickle_file</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">content</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.Tegridy_Chords_Converter">
    <p>def <span class="ident">Tegridy_Chords_Converter</span>(</p><p>chords_list, melody_list, song_name, melody_notes_in_chords=True)</p>
    </div>
    

    
  
    <div class="desc"><p>Tegridy Chords Coverter</p>
<p>Inputs: Tegridy MIDI chords_list (as is)</p>
<pre><code>    Tegridy MIDI melody_list (as is)

    Name of the song as plain string

    Include or exclude melody notes in each chord. Def. is to include.
</code></pre>
<p>Outputs: Converted chords_list with melody_notes and song name</p>
<pre><code>     Converted melody_list with song name
</code></pre>
<p>Project Los Angeles
Tegridy Code 2020</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.Tegridy_Chords_Converter', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.Tegridy_Chords_Converter" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">Tegridy_Chords_Converter</span><span class="p">(</span><span class="n">chords_list</span><span class="p">,</span> <span class="n">melody_list</span><span class="p">,</span> <span class="n">song_name</span><span class="p">,</span> <span class="n">melody_notes_in_chords</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
  <span class="sd">&#39;&#39;&#39;Tegridy Chords Coverter</span>

<span class="sd">  Inputs: Tegridy MIDI chords_list (as is)</span>

<span class="sd">          Tegridy MIDI melody_list (as is)</span>

<span class="sd">          Name of the song as plain string</span>

<span class="sd">          Include or exclude melody notes in each chord. Def. is to include.</span>


<span class="sd">  Outputs: Converted chords_list with melody_notes and song name</span>

<span class="sd">           Converted melody_list with song name</span>

<span class="sd">  Project Los Angeles</span>
<span class="sd">  Tegridy Code 2020&#39;&#39;&#39;</span>

  <span class="n">temp_chords_list</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">chords_list_final</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">melody_list_final</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="n">temp_chords_list</span> <span class="o">=</span> <span class="p">[[</span><span class="n">song_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
  <span class="n">melody_list_final</span> <span class="o">=</span> <span class="p">[</span><span class="n">song_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

  <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>

  <span class="k">for</span> <span class="n">notez</span> <span class="ow">in</span> <span class="n">melody_list</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">melody_notes_in_chords</span><span class="p">:</span>
      <span class="n">temp_chords_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">notez</span><span class="p">])</span>
    <span class="n">melody_list_final</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">notez</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">chord</span> <span class="ow">in</span> <span class="n">chords_list</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">notez</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">chord</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">temp_chords_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chord</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
  
  <span class="sd">&#39;&#39;&#39;# Gonna use a dic here to join chords by start-time :)</span>
<span class="sd">  record_dict = defaultdict(list)</span>

<span class="sd">  for chords in temp_chords_list:</span>
<span class="sd">    if len(chords) &gt; 0:</span>
<span class="sd">      record_dict[chords[0][1]].extend(chords)</span>

<span class="sd">  temp_chords_list = list(record_dict.values())&#39;&#39;&#39;</span>

  <span class="n">chords_list_final</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="c1">#print(&#39;Sorting chords notes by pitch/removing empty chords if any...&#39;)</span>
  <span class="n">chords_list_final</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_chords_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  <span class="k">for</span> <span class="n">chordz</span> <span class="ow">in</span> <span class="n">temp_chords_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chordz</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">chordz</span><span class="p">)</span>
      <span class="n">chordz</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="c1"># Sorting events by pitch </span>
      <span class="n">chords_list_final</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chordz</span><span class="p">)</span> <span class="c1"># Creating final chords list      </span>

  <span class="n">chords_list_final</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="n">song_name</span> <span class="o">+</span> <span class="s1">&#39;_with_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chords_list_final</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_Chords&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">chords_list_final</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
  <span class="n">melody_list_final</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">song_name</span> <span class="o">+</span> <span class="s1">&#39;_with_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">melody_list_final</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_Notes&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">melody_list_final</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
  <span class="n">chords_list_final</span><span class="o">.</span><span class="n">append</span><span class="p">([[</span><span class="s1">&#39;song_end&#39;</span><span class="p">,</span> <span class="n">chords_list_final</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">chords_list_final</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
  <span class="n">melody_list_final</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;song_end&#39;</span><span class="p">,</span> <span class="n">melody_list_final</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">melody_list_final</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>     
  <span class="n">first_song</span> <span class="o">=</span> <span class="kc">False</span>
    
  <span class="k">return</span> <span class="n">chords_list_final</span><span class="p">,</span> <span class="n">melody_list_final</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.Tegridy_File_Time_Stamp">
    <p>def <span class="ident">Tegridy_File_Time_Stamp</span>(</p><p>input_file_name=&#39;File_Created_on_&#39;, ext=&#39;&#39;)</p>
    </div>
    

    
  
    <div class="desc"><p>Tegridy File Time Stamp</p>
<p>Input: Full path and file name without extention
       File extension</p>
<p>Output: File name string with time-stamp and extension (time-stamped file name)</p>
<p>Project Los Angeles
Tegridy Code 2021</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.Tegridy_File_Time_Stamp', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.Tegridy_File_Time_Stamp" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">Tegridy_File_Time_Stamp</span><span class="p">(</span><span class="n">input_file_name</span><span class="o">=</span><span class="s1">&#39;File_Created_on_&#39;</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>

  <span class="sd">&#39;&#39;&#39;Tegridy File Time Stamp</span>
<span class="sd">     </span>
<span class="sd">  Input: Full path and file name without extention</span>
<span class="sd">         File extension</span>
<span class="sd">          </span>
<span class="sd">  Output: File name string with time-stamp and extension (time-stamped file name)</span>

<span class="sd">  Project Los Angeles</span>
<span class="sd">  Tegridy Code 2021&#39;&#39;&#39;</span>       

  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time-stamping output file...&#39;</span><span class="p">)</span>

  <span class="n">now</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
  <span class="n">now_n</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
  <span class="n">now_n</span> <span class="o">=</span> <span class="n">now_n</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
  <span class="n">now_n</span> <span class="o">=</span> <span class="n">now_n</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
  <span class="n">now</span> <span class="o">=</span> <span class="n">now_n</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
      
  <span class="n">fname</span> <span class="o">=</span> <span class="n">input_file_name</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">now</span><span class="p">)</span> <span class="o">+</span> <span class="n">ext</span>

  <span class="k">return</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.Tegridy_INT_String_to_TXT_Converter">
    <p>def <span class="ident">Tegridy_INT_String_to_TXT_Converter</span>(</p><p>input_INT_String, line_by_line_input=True)</p>
    </div>
    

    
  
    <div class="desc"><p>Tegridy Intergers String to TXT Converter</p>
<p>Input: List of intergers in TMIDI-TXT-INT-String format
Output: Decoded TXT string in TMIDI-TXT format
Project Los Angeles
Tegridy Code 2020</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.Tegridy_INT_String_to_TXT_Converter', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.Tegridy_INT_String_to_TXT_Converter" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">Tegridy_INT_String_to_TXT_Converter</span><span class="p">(</span><span class="n">input_INT_String</span><span class="p">,</span> <span class="n">line_by_line_input</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Tegridy Intergers String to TXT Converter</span>
<span class="sd">     </span>
<span class="sd">    Input: List of intergers in TMIDI-TXT-INT-String format</span>
<span class="sd">    Output: Decoded TXT string in TMIDI-TXT format</span>
<span class="sd">    Project Los Angeles</span>
<span class="sd">    Tegridy Code 2020&#39;&#39;&#39;</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tegridy Intergers String to TXT Converter&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">line_by_line_input</span><span class="p">:</span>
      <span class="n">input_string</span> <span class="o">=</span> <span class="n">input_INT_String</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">input_string</span> <span class="o">=</span> <span class="n">input_INT_String</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>  

    <span class="n">output_TXT_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">input_string</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">output_TXT_string</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
      <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Bad note:&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="k">continue</span>  
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done!&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output_TXT_string</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.Tegridy_INT_to_TXT_Converter">
    <p>def <span class="ident">Tegridy_INT_to_TXT_Converter</span>(</p><p>input_INT_list)</p>
    </div>
    

    
  
    <div class="desc"><p>Tegridy Intergers to TXT Converter</p>
<p>Input: List of intergers in TMIDI-TXT-INT format
Output: Decoded TXT string in TMIDI-TXT format
Project Los Angeles
Tegridy Code 2020</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.Tegridy_INT_to_TXT_Converter', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.Tegridy_INT_to_TXT_Converter" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">Tegridy_INT_to_TXT_Converter</span><span class="p">(</span><span class="n">input_INT_list</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Tegridy Intergers to TXT Converter</span>
<span class="sd">     </span>
<span class="sd">    Input: List of intergers in TMIDI-TXT-INT format</span>
<span class="sd">    Output: Decoded TXT string in TMIDI-TXT format</span>
<span class="sd">    Project Los Angeles</span>
<span class="sd">    Tegridy Code 2020&#39;&#39;&#39;</span>

    <span class="n">output_TXT_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">input_INT_list</span><span class="p">:</span>
      <span class="n">output_TXT_string</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">output_TXT_string</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.Tegridy_INT_to_TXT_Processor">
    <p>def <span class="ident">Tegridy_INT_to_TXT_Processor</span>(</p><p>input_INT_list, decoding_dictionary)</p>
    </div>
    

    
  
    <div class="desc"><p>Tegridy Intergers to TXT Processor</p>
<p>Input: List of intergers in TMIDI-TXT-INT format
      Decoding dictionary in TMIDI-TXT-INT format</p>
<p>Output: Decoded TXT string in TMIDI-TXT format</p>
<p>Project Los Angeles
Tegridy Code 2020</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.Tegridy_INT_to_TXT_Processor', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.Tegridy_INT_to_TXT_Processor" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">Tegridy_INT_to_TXT_Processor</span><span class="p">(</span><span class="n">input_INT_list</span><span class="p">,</span> <span class="n">decoding_dictionary</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Tegridy Intergers to TXT Processor</span>
<span class="sd">     </span>
<span class="sd">    Input: List of intergers in TMIDI-TXT-INT format</span>
<span class="sd">          Decoding dictionary in TMIDI-TXT-INT format</span>

<span class="sd">    Output: Decoded TXT string in TMIDI-TXT format</span>

<span class="sd">    Project Los Angeles</span>
<span class="sd">    Tegridy Code 2020&#39;&#39;&#39;</span>

    <span class="n">output_TXT_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">decoding_dictionary</span><span class="p">[</span><span class="n">int_</span><span class="p">]</span> <span class="k">for</span> <span class="n">int_</span> <span class="ow">in</span> <span class="n">input_INT_list</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">output_TXT_string</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.Tegridy_Karaoke_MIDI_to_Reduced_TXT_Processor">
    <p>def <span class="ident">Tegridy_Karaoke_MIDI_to_Reduced_TXT_Processor</span>(</p><p>Karaoke_MIDI_file, karaoke_language_encoding=&#39;ISO-8859-1&#39;, char_encoding_offset=30)</p>
    </div>
    

    
  
    <div class="desc"><p>Tegridy Karaoke MIDI to Reduced TXT Processor</p>
<pre><code>Input: Karaoke MIDI file. Must be a Karaoke MIDI or the processor will not work properly.

       Karaoke language encoding. Please see official encoding list for your language. 
       https://docs.python.org/3/library/codecs.html#standard-encodings
       Please note that anything but ISO-8859-1 is a non-standard way of encoding text_events according to MIDI specs.

       Char encoding offset to prevent ambiguity with sys chars like
</code></pre>
<p>. 
           This may need to be adjusted for languages other than English.</p>
<pre><code>Output: Line-by-line reduced TXT string
        Number of processed MIDI events from the Karaoke MIDI file
        Number of recorded Karaoke events in the TXT string
        All recorded Pitches/Words of the given KarMIDI file as a list
        All recorded words of the given KarMIDI file as a string

Project Los Angeles
Tegridy Code 2021
</code></pre></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.Tegridy_Karaoke_MIDI_to_Reduced_TXT_Processor', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.Tegridy_Karaoke_MIDI_to_Reduced_TXT_Processor" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">Tegridy_Karaoke_MIDI_to_Reduced_TXT_Processor</span><span class="p">(</span><span class="n">Karaoke_MIDI_file</span><span class="p">,</span> 
                                                  <span class="n">karaoke_language_encoding</span> <span class="o">=</span> <span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">,</span>
                                                  <span class="n">char_encoding_offset</span> <span class="o">=</span> <span class="mi">30</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Tegridy Karaoke MIDI to Reduced TXT Processor</span>
<span class="sd">     </span>
<span class="sd">    Input: Karaoke MIDI file. Must be a Karaoke MIDI or the processor will not work properly.</span>
<span class="sd">           </span>
<span class="sd">           Karaoke language encoding. Please see official encoding list for your language. </span>
<span class="sd">           https://docs.python.org/3/library/codecs.html#standard-encodings</span>
<span class="sd">           Please note that anything but ISO-8859-1 is a non-standard way of encoding text_events according to MIDI specs.</span>
<span class="sd">           </span>
<span class="sd">           Char encoding offset to prevent ambiguity with sys chars like \n. </span>
<span class="sd">           This may need to be adjusted for languages other than English.</span>

<span class="sd">    Output: Line-by-line reduced TXT string</span>
<span class="sd">            Number of processed MIDI events from the Karaoke MIDI file</span>
<span class="sd">            Number of recorded Karaoke events in the TXT string</span>
<span class="sd">            All recorded Pitches/Words of the given KarMIDI file as a list</span>
<span class="sd">            All recorded words of the given KarMIDI file as a string</span>

<span class="sd">    Project Los Angeles</span>
<span class="sd">    Tegridy Code 2021&#39;&#39;&#39;</span>

    <span class="n">events_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">events_matrix</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">MIDI_ev</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">KAR_ev</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">itrack</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">tst</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">output_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="n">midi_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">Karaoke_MIDI_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
      <span class="n">opus</span> <span class="o">=</span> <span class="n">midi2opus</span><span class="p">(</span><span class="n">midi_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    
    <span class="k">except</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Problematic file. Skipping...&#39;</span><span class="p">)</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Skipped file name:&#39;</span><span class="p">,</span> <span class="n">Karaoke_MIDI_file</span><span class="p">)</span>
      <span class="n">midi_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">output_string</span><span class="p">,</span> <span class="n">MIDI_ev</span><span class="p">,</span> <span class="n">KAR_ev</span>
          
    <span class="n">midi_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">score1</span> <span class="o">=</span> <span class="n">to_millisecs</span><span class="p">(</span><span class="n">opus</span><span class="p">)</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">opus2score</span><span class="p">(</span><span class="n">score1</span><span class="p">)</span>

    <span class="c1">#print(&#39;Reading all MIDI events from the MIDI file...&#39;)</span>
    <span class="k">while</span> <span class="n">itrack</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">):</span>
      <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">score</span><span class="p">[</span><span class="n">itrack</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;text_event&#39;</span><span class="p">:</span>
          <span class="n">tst</span> <span class="o">=</span> <span class="mi">0</span>
          <span class="n">txt</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
          <span class="n">tst</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
          <span class="n">txt</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
          
        <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note&#39;</span> <span class="ow">and</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">tst</span><span class="p">:</span>
          <span class="n">evt</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
          <span class="n">evt</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="p">])</span>
          <span class="n">evt</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">txt</span>
          <span class="n">events_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">evt</span><span class="p">)</span>       
        
        <span class="n">MIDI_ev</span> <span class="o">+=</span> <span class="mi">1</span>
      
      <span class="n">itrack</span> <span class="o">+=</span><span class="mi">1</span> <span class="c1"># Going to next track...</span>

    <span class="n">evt</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">events_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># Sorting by start time</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">g</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">))]</span> <span class="c1"># Grouping by start time</span>

    <span class="n">events_matrix</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>

    <span class="n">f_matrix</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">final_matrix</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">events_matrix</span><span class="p">:</span> 
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Removing single note events</span>
        <span class="n">it</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="n">it</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
        <span class="n">it</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="c1"># Sorting events by pitch</span>
        <span class="n">f_matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">it</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> 

    <span class="n">ptime</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">time</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">output_song</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f_matrix</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
      <span class="n">no</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">f_matrix</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>

      <span class="n">no</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">delta</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span>
      <span class="n">no</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">no</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span>
      <span class="n">no</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">no</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>

      <span class="n">ptime</span> <span class="o">=</span> <span class="n">f_matrix</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
      <span class="n">time</span> <span class="o">=</span> <span class="n">f_matrix</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

      <span class="n">delta</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">time</span><span class="o">-</span><span class="n">ptime</span><span class="p">)</span>    

      <span class="n">output_song</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">no</span><span class="p">)</span>

    <span class="n">output_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">all_words</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">pitches_words_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">note</span> <span class="ow">in</span> <span class="n">output_song</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">note</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">250</span> <span class="ow">and</span> <span class="n">note</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">250</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">note</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">note</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> 
          <span class="n">output_string</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">note</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">char_encoding_offset</span><span class="p">)</span>
          <span class="n">output_string</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">note</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">char_encoding_offset</span><span class="p">)</span>
          <span class="n">output_string</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">note</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">char_encoding_offset</span><span class="p">)</span>
          <span class="n">output_string</span> <span class="o">+=</span> <span class="s1">&#39;=&#39;</span>
          <span class="n">word</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">note</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">karaoke_language_encoding</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
          <span class="n">output_string</span> <span class="o">+=</span> <span class="n">word</span>
          <span class="n">output_string</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
          <span class="n">all_words</span> <span class="o">+=</span> <span class="n">word</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
          <span class="n">pitches_words_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">note</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">word</span><span class="p">])</span>
          <span class="n">KAR_ev</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">output_string</span><span class="p">,</span> <span class="n">MIDI_ev</span><span class="p">,</span> <span class="n">KAR_ev</span><span class="p">,</span> <span class="n">pitches_words_list</span><span class="p">,</span> <span class="n">all_words</span>  
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.Tegridy_Karaoke_Pitches_Words_List_to_CSV_Writer">
    <p>def <span class="ident">Tegridy_Karaoke_Pitches_Words_List_to_CSV_Writer</span>(</p><p>pitches_words_list, file_name=&#39;pitches_words.csv&#39;)</p>
    </div>
    

    
  
    <div class="desc"><p>Tegridy Karaoke Pitches Words List to CSV Writer</p>
<p>Input: Pitches/Words list in TMIDI Karaoke MIDI to TXT Converter format
       Desired full output CSV file name with extension</p>
<p>Output: CSV file with all Pitches/Words that were in the input pitches/words list</p>
<p>Project Los Angeles
Tegridy Code 2021</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.Tegridy_Karaoke_Pitches_Words_List_to_CSV_Writer', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.Tegridy_Karaoke_Pitches_Words_List_to_CSV_Writer" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">Tegridy_Karaoke_Pitches_Words_List_to_CSV_Writer</span><span class="p">(</span><span class="n">pitches_words_list</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s1">&#39;pitches_words.csv&#39;</span><span class="p">):</span>
    
    <span class="sd">&#39;&#39;&#39;Tegridy Karaoke Pitches Words List to CSV Writer</span>
<span class="sd">      </span>
<span class="sd">    Input: Pitches/Words list in TMIDI Karaoke MIDI to TXT Converter format</span>
<span class="sd">           Desired full output CSV file name with extension</span>
<span class="sd">        </span>
<span class="sd">    Output: CSV file with all Pitches/Words that were in the input pitches/words list</span>

<span class="sd">    Project Los Angeles</span>
<span class="sd">    Tegridy Code 2021&#39;&#39;&#39;</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tegridy Karaoke Pitches/Words CSV Writer&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Starting up...&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Grouping input pitches/words list...Please stand by...&#39;</span><span class="p">)</span>
    <span class="n">values</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pitches_words_list</span><span class="p">))</span>

    <span class="n">groups</span> <span class="o">=</span> <span class="p">[[</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">pitches_words_list</span> <span class="k">if</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Preparing final CSV list...&#39;</span><span class="p">)</span>

    <span class="n">final_list</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
      <span class="n">pitch</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">f_list</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">g</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f_list</span><span class="p">:</span>
          <span class="n">f_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
      <span class="n">final_list</span><span class="p">[</span><span class="n">pitch</span><span class="p">]</span> <span class="o">=</span> <span class="n">f_list</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Writing CSV file to disk...&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
      <span class="n">w</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
      <span class="n">w</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s1">&#39;pitch&#39;</span><span class="p">,</span><span class="s1">&#39;words&#39;</span><span class="p">])</span>
      <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">items</span> <span class="ow">in</span> <span class="n">final_list</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">w</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">items</span><span class="p">))])</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Task complete! Enjoy :)&#39;</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.Tegridy_Karaoke_TXT_to_MIDI_Processor">
    <p>def <span class="ident">Tegridy_Karaoke_TXT_to_MIDI_Processor</span>(</p><p>Karaoke_TXT_String, text_encoding=&#39;ISO-8859-1&#39;, char_encoding_offset=30)</p>
    </div>
    

    
  
    <div class="desc"><p>Tegridy Karaoke TXT to MIDI Processor</p>
<pre><code>Input: Karaoke Reduced TXT String in TMIDI Karaoke Reduced TXT format

       Karaoke language encoding. Please see official encoding list for your language. 
       https://docs.python.org/3/library/codecs.html#standard-encodings
       Please note that anything but ISO-8859-1 is a non-standard way of encoding text_events according to MIDI specs.

       Char encoding offset to prevent ambiguity with sys chars like
</code></pre>
<p>. 
           This may need to be adjusted for languages other than English.</p>
<pre><code>Output: Inferred song name (from the first line of the input TXT string)
        Song (notes list in MIDI.py score format) that you can write to MIDI file with TMIDI Song to MIDI converter.
        All song's lyrics as one TXT string (this is for eval/display purposes mostly)
        Number of recorded Karaoke events in the output song

Project Los Angeles
Tegridy Code 2021
</code></pre></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.Tegridy_Karaoke_TXT_to_MIDI_Processor', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.Tegridy_Karaoke_TXT_to_MIDI_Processor" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">Tegridy_Karaoke_TXT_to_MIDI_Processor</span><span class="p">(</span><span class="n">Karaoke_TXT_String</span><span class="p">,</span>
                                          <span class="n">text_encoding</span><span class="o">=</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">,</span>
                                          <span class="n">char_encoding_offset</span> <span class="o">=</span> <span class="mi">30</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Tegridy Karaoke TXT to MIDI Processor</span>
<span class="sd">        </span>
<span class="sd">    Input: Karaoke Reduced TXT String in TMIDI Karaoke Reduced TXT format</span>
<span class="sd">            </span>
<span class="sd">           Karaoke language encoding. Please see official encoding list for your language. </span>
<span class="sd">           https://docs.python.org/3/library/codecs.html#standard-encodings</span>
<span class="sd">           Please note that anything but ISO-8859-1 is a non-standard way of encoding text_events according to MIDI specs.</span>
<span class="sd">            </span>
<span class="sd">           Char encoding offset to prevent ambiguity with sys chars like \n. </span>
<span class="sd">           This may need to be adjusted for languages other than English.</span>

<span class="sd">    Output: Inferred song name (from the first line of the input TXT string)</span>
<span class="sd">            Song (notes list in MIDI.py score format) that you can write to MIDI file with TMIDI Song to MIDI converter.</span>
<span class="sd">            All song&#39;s lyrics as one TXT string (this is for eval/display purposes mostly)</span>
<span class="sd">            Number of recorded Karaoke events in the output song</span>

<span class="sd">    Project Los Angeles</span>
<span class="sd">    Tegridy Code 2021&#39;&#39;&#39;</span>    
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tegridy Karaoke TXT to MIDI Processor&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Converting Karaoke TXT to MIDI. Please wait...&#39;</span><span class="p">)</span>

    <span class="n">o_str</span> <span class="o">=</span> <span class="n">Karaoke_TXT_String</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">song_name</span> <span class="o">=</span> <span class="n">o_str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">song</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">lyrics_text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="n">ptime</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">KAR_ev</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">o_str</span><span class="p">:</span>

      <span class="n">note</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;note&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
      <span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;text_event&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>

      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>

        <span class="n">note</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ptime</span> <span class="o">*</span> <span class="mi">10</span>
        <span class="n">note</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span>
        <span class="n">note</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span>
        <span class="n">note</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span>

        <span class="n">text</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ptime</span> <span class="o">*</span> <span class="mi">10</span>
        <span class="n">text</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">ptime</span> <span class="o">+=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span>

        <span class="n">song</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">note</span><span class="p">)</span>
        <span class="n">song</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

        <span class="n">lyrics_text</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>

        <span class="n">KAR_ev</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Task complete! Enjoy! :)&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">song_name</span><span class="p">,</span> <span class="n">song</span><span class="p">,</span> <span class="n">lyrics_text</span><span class="p">,</span> <span class="n">KAR_ev</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.Tegridy_List_Slicer">
    <p>def <span class="ident">Tegridy_List_Slicer</span>(</p><p>input_list, number_of_slices)</p>
    </div>
    

    
  
    <div class="desc"><p>Input: List to slice
       Number of desired slices</p>
<p>Output: Sliced list of lists</p>
<p>Project Los Angeles
Tegridy Code 2021</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.Tegridy_List_Slicer', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.Tegridy_List_Slicer" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">Tegridy_List_Slicer</span><span class="p">(</span><span class="n">input_list</span><span class="p">,</span> <span class="n">number_of_slices</span><span class="p">):</span>

  <span class="sd">&#39;&#39;&#39;Input: List to slice</span>
<span class="sd">            Number of desired slices</span>
<span class="sd">     </span>
<span class="sd">     Output: Sliced list of lists</span>
<span class="sd">     </span>
<span class="sd">     Project Los Angeles</span>
<span class="sd">     Tegridy Code 2021&#39;&#39;&#39;</span>

  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_list</span><span class="p">),</span> <span class="n">number_of_slices</span><span class="p">):</span>
     <span class="k">yield</span> <span class="n">input_list</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">number_of_slices</span><span class="p">]</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.Tegridy_MIDI_Processor">
    <p>def <span class="ident">Tegridy_MIDI_Processor</span>(</p><p>MIDI_file, MIDI_channel=0, time_denominator=1, transpose_all_notes_by_this_many_pitches=0, flip_notes=0, randomize_notes=0, randremove_notes=0, MIDI_patch=[0, 24, 32, 40, 42, 46, 56, 71, 73], voble=0)</p>
    </div>
    

    
  
    <div class="desc"><p>Tegridy MIDI Processor</p>
<p>Input: A single MIDI file.
       Desired MIDI channel to process. Def. = 0. All but drums = -1 and all channels = 16
       Notes/Chords timings divider (denominator).</p>
<p>Output: A list of MIDI chords and a list of melody notes.
MIDI Chords: Sorted by pitch (chord[0] == highest pitch).
Melody Notes: Sorted by start time.</p>
<p>Format: MIDI.py Score Events format.</p>
<p>Default precision: 1 ms per note/chord.</p>
<p>Enjoy! :)</p>
<p>Project Los Angeles
Tegridy Code 2020</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.Tegridy_MIDI_Processor', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.Tegridy_MIDI_Processor" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">Tegridy_MIDI_Processor</span><span class="p">(</span><span class="n">MIDI_file</span><span class="p">,</span> 
                          <span class="n">MIDI_channel</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                          <span class="n">time_denominator</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                          <span class="n">transpose_all_notes_by_this_many_pitches</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                          <span class="n">flip_notes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                          <span class="n">randomize_notes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                          <span class="n">randremove_notes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                          <span class="n">MIDI_patch</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">73</span><span class="p">],</span>
                          <span class="n">voble</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Tegridy MIDI Processor</span>

<span class="sd">    Input: A single MIDI file.</span>
<span class="sd">           Desired MIDI channel to process. Def. = 0. All but drums = -1 and all channels = 16</span>
<span class="sd">           Notes/Chords timings divider (denominator).</span>

<span class="sd">    Output: A list of MIDI chords and a list of melody notes.</span>
<span class="sd">    MIDI Chords: Sorted by pitch (chord[0] == highest pitch).</span>
<span class="sd">    Melody Notes: Sorted by start time.</span>

<span class="sd">    Format: MIDI.py Score Events format.</span>

<span class="sd">    Default precision: 1 ms per note/chord.</span>

<span class="sd">    Enjoy! :)</span>

<span class="sd">    Project Los Angeles</span>
<span class="sd">    Tegridy Code 2020&#39;&#39;&#39;</span>

<span class="c1">###########</span>

    <span class="n">minimum_number_of_notes_per_chord</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># Must be 2 or more...</span>

    <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1">###########</span>

    <span class="n">average_note_pitch</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">min_note</span> <span class="o">=</span> <span class="mi">127</span>
    <span class="n">max_note</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">files_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">ev</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">chords_list_final</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">chords_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">events_matrix</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">melody</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">melody1</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">itrack</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">min_note</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">max_note</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ev</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">patch</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">score</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">rec_event</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1">###########    </span>

    <span class="k">def</span> <span class="nf">list_average</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
      <span class="n">sum_num</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">num</span><span class="p">:</span>
          <span class="n">sum_num</span> <span class="o">=</span> <span class="n">sum_num</span> <span class="o">+</span> <span class="n">t</span>           

      <span class="n">avg</span> <span class="o">=</span> <span class="n">sum_num</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">avg</span>

<span class="c1">###########</span>

    <span class="c1">#print(&#39;Loading MIDI file...&#39;)</span>
    <span class="n">midi_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">MIDI_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Processing File:&#39;</span><span class="p">,</span> <span class="n">file_address</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
      <span class="n">opus</span> <span class="o">=</span> <span class="n">midi2opus</span><span class="p">(</span><span class="n">midi_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    
    <span class="k">except</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Bad file. Skipping...&#39;</span><span class="p">)</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;File name:&#39;</span><span class="p">,</span> <span class="n">MIDI_file</span><span class="p">)</span>
      <span class="n">midi_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">chords_list</span><span class="p">,</span> <span class="n">melody</span>
         
    <span class="n">midi_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">score1</span> <span class="o">=</span> <span class="n">to_millisecs</span><span class="p">(</span><span class="n">opus</span><span class="p">)</span>
    <span class="n">score2</span> <span class="o">=</span> <span class="n">opus2score</span><span class="p">(</span><span class="n">score1</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">MIDI_channel</span> <span class="o">==</span> <span class="mi">16</span><span class="p">:</span> <span class="c1"># Process all MIDI channels</span>
      <span class="n">score</span> <span class="o">=</span> <span class="n">score2</span>
    
    <span class="k">if</span> <span class="n">MIDI_channel</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">MIDI_channel</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">:</span> <span class="c1"># Process only a selected single MIDI channel</span>
      <span class="n">score</span> <span class="o">=</span> <span class="n">grep</span><span class="p">(</span><span class="n">score2</span><span class="p">,</span> <span class="p">[</span><span class="n">MIDI_channel</span><span class="p">])</span>
    
    <span class="k">if</span> <span class="n">MIDI_channel</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># Process all channels except drums (except channel 9)</span>
      <span class="n">score</span> <span class="o">=</span> <span class="n">grep</span><span class="p">(</span><span class="n">score2</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">])</span>   
    
    <span class="c1">#print(&#39;Reading all MIDI events from the MIDI file...&#39;)</span>
    <span class="k">while</span> <span class="n">itrack</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">):</span>
      <span class="n">chords_list_track</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">score</span><span class="p">[</span><span class="n">itrack</span><span class="p">]:</span>
        <span class="n">chords_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;patch_change&#39;</span><span class="p">:</span>
          <span class="n">patch</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> 
        <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note&#39;</span> <span class="ow">and</span> <span class="n">patch</span> <span class="ow">in</span> <span class="n">MIDI_patch</span><span class="p">:</span>
          <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span> <span class="c1"># Checking for bad notes...</span>
              <span class="n">rec_event</span> <span class="o">=</span> <span class="n">event</span>
              <span class="n">rec_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">voble</span><span class="p">)</span> <span class="o">/</span> <span class="n">time_denominator</span><span class="p">)</span>
              <span class="n">rec_event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">voble</span><span class="p">)</span> <span class="o">/</span> <span class="n">time_denominator</span><span class="p">)</span>
              <span class="n">rec_event</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="n">voble</span><span class="p">)</span>

              <span class="k">if</span> <span class="n">transpose_all_notes_by_this_many_pitches</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">rec_event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">transpose_all_notes_by_this_many_pitches</span><span class="p">))</span>

              <span class="k">if</span> <span class="n">flip_notes</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">flip_notes</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                  <span class="n">rec_event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">127</span> <span class="o">-</span> <span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
                
                <span class="k">if</span> <span class="n">flip_notes</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                  <span class="n">rec_event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">0</span> <span class="o">-</span> <span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>

              <span class="k">if</span> <span class="n">randomize_notes</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">rec_event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">randomize_notes</span><span class="p">))</span>

              <span class="k">if</span> <span class="n">randremove_notes</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">rec_event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="n">randremove_notes</span> <span class="o">*</span> <span class="n">secrets</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="n">randremove_notes</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">randremove_notes</span><span class="p">])))</span>

              <span class="n">events_matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rec_event</span><span class="p">)</span>

              <span class="n">min_note</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">min_note</span><span class="p">,</span> <span class="n">rec_event</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
              <span class="n">max_note</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">max_note</span><span class="p">,</span> <span class="n">rec_event</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>          
              
              <span class="n">ev</span> <span class="o">+=</span> <span class="mi">1</span>
      
      <span class="n">itrack</span> <span class="o">+=</span><span class="mi">1</span> <span class="c1"># Going to next track...</span>
  
    <span class="c1">#print(&#39;Doing some heavy pythonic sorting...Please stand by...&#39;)</span>

    <span class="c1">#print(&#39;Removing zero pitches and zero velocities events&#39;)</span>
    <span class="n">events_matrix1</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">events_matrix</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="c1"># removing zero pitches and zero velocities events</span>
    <span class="n">events_matrix</span> <span class="o">=</span> <span class="n">events_matrix1</span>
    <span class="n">events_matrix1</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events_matrix</span><span class="p">:</span>
      <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
      <span class="n">event1</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">event</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
      <span class="n">events_matrix1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event1</span><span class="p">)</span>

    <span class="n">events_matrix</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">events_matrix</span> <span class="o">=</span> <span class="n">events_matrix1</span> 

    <span class="c1">#print(&#39;Sorting input by start time...&#39;)</span>
    <span class="n">events_matrix</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Sorting input by start time</span>

    <span class="c1">#print(&#39;Grouping by start time. This will take a while...&#39;)</span>
    <span class="n">values</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">events_matrix</span><span class="p">))</span> <span class="c1"># Non-multithreaded function version just in case</span>

    <span class="n">groups</span> <span class="o">=</span> <span class="p">[[</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">events_matrix</span> <span class="k">if</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="n">x</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span> <span class="c1"># Grouping notes into chords while discarting bad notes...</span>
    
    <span class="n">chords_list1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1">#print(&#39;Removing single note/excessive events, sorting events by pitch, and creating a chords list...&#39;)</span>
    <span class="k">for</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span> 
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">minimum_number_of_notes_per_chord</span><span class="p">:</span> <span class="c1"># Removing single note events</span>
        <span class="n">items</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="c1"># Sorting events by pitch</span>
        <span class="n">chords_list1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="c1"># Creating final chords list</span>

    <span class="c1">#print(&#39;Removing duplicate pitches from chords and creating a final chords list...&#39;)</span>
    <span class="n">chords_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">chord</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">chord1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">chord2</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">chord</span> <span class="ow">in</span> <span class="n">chords_list1</span><span class="p">:</span>
      <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
      <span class="n">chord1</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">chord</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">])]</span>
      <span class="n">chord2</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">chord1</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">]</span> <span class="c1"># Removing bad note events from chords</span>
      <span class="n">chords_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chord2</span><span class="p">)</span>

    <span class="n">chords_list_track</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">chords_list</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="p">[]]</span>

    <span class="n">chords_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">chords_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">chords_list_track</span><span class="p">)</span>

    <span class="c1">#print(&#39;Extracting melody...&#39;)</span>
    <span class="n">melody_list</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1">#print(&#39;Sorting events...&#39;)</span>
    <span class="k">for</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
        <span class="n">items</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="c1"># Sorting events by pitch </span>
        <span class="n">melody_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="c1"># Creating final chords list</span>
    
    <span class="c1">#print(&#39;Removing duplicates if any...&#39;)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">melody_list</span><span class="p">:</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">mel</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">item</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
        <span class="n">melody1</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">mel</span><span class="p">)</span>
    
    <span class="c1">#print(&#39;Removing bad notes if any...&#39;)    </span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">melody1</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
          <span class="n">melody</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    
    <span class="c1">#print(&#39;Final sorting by start time...&#39;)      </span>
    <span class="n">melody</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Sorting events by start time</span>
      
    <span class="k">return</span> <span class="n">chords_list</span><span class="p">,</span> <span class="n">melody</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.Tegridy_MIDI_Signature">
    <p>def <span class="ident">Tegridy_MIDI_Signature</span>(</p><p>melody, chords)</p>
    </div>
    

    
  
    <div class="desc"><p>Input: flat melody list and flat chords list</p>
<p>Output: Melody signature and Chords signature</p>
<p>Project Los Angeles
Tegridy Code 2021</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.Tegridy_MIDI_Signature', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.Tegridy_MIDI_Signature" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">Tegridy_MIDI_Signature</span><span class="p">(</span><span class="n">melody</span><span class="p">,</span> <span class="n">chords</span><span class="p">):</span>

  <span class="sd">&#39;&#39;&#39;Input: flat melody list and flat chords list</span>
<span class="sd">     </span>
<span class="sd">     Output: Melody signature and Chords signature</span>
<span class="sd">     </span>
<span class="sd">     Project Los Angeles</span>
<span class="sd">     Tegridy Code 2021&#39;&#39;&#39;</span>

  <span class="c1"># prepping data</span>
  <span class="n">melody_list_f</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">chords_list_f</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="c1"># melody</span>
  <span class="n">m_st_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">melody</span><span class="p">])</span>
  <span class="n">m_st_avg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m_st_sum</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">melody</span><span class="p">))</span>
  <span class="n">m_du_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">melody</span><span class="p">])</span>
  <span class="n">m_du_avg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m_du_sum</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">melody</span><span class="p">))</span>
  <span class="n">m_ch_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">y</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">melody</span><span class="p">])</span>
  <span class="n">m_ch_avg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m_ch_sum</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">melody</span><span class="p">))</span>
  <span class="n">m_pt_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">y</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">melody</span><span class="p">])</span>
  <span class="n">m_pt_avg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m_pt_sum</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">melody</span><span class="p">))</span>
  <span class="n">m_vl_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">y</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">melody</span><span class="p">])</span>
  <span class="n">m_vl_avg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m_vl_sum</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">melody</span><span class="p">))</span>
  
  <span class="n">melody_list_f</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">m_st_sum</span><span class="p">,</span> 
                        <span class="n">m_st_avg</span><span class="p">,</span>
                        <span class="n">m_du_sum</span><span class="p">,</span>
                        <span class="n">m_du_avg</span><span class="p">,</span>
                        <span class="n">m_ch_sum</span><span class="p">,</span>
                        <span class="n">m_ch_avg</span><span class="p">,</span>
                        <span class="n">m_pt_sum</span><span class="p">,</span>
                        <span class="n">m_pt_avg</span><span class="p">,</span>
                        <span class="n">m_vl_sum</span><span class="p">,</span>
                        <span class="n">m_vl_avg</span><span class="p">])</span>

  <span class="c1"># chords</span>
  <span class="n">c_st_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">chords</span><span class="p">])</span>
  <span class="n">c_st_avg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">c_st_sum</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">chords</span><span class="p">))</span>
  <span class="n">c_du_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">chords</span><span class="p">])</span>
  <span class="n">c_du_avg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">c_du_sum</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">chords</span><span class="p">))</span>
  <span class="n">c_ch_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">y</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">chords</span><span class="p">])</span>
  <span class="n">c_ch_avg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">c_ch_sum</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">chords</span><span class="p">))</span>
  <span class="n">c_pt_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">y</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">chords</span><span class="p">])</span>
  <span class="n">c_pt_avg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">c_pt_sum</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">chords</span><span class="p">))</span>
  <span class="n">c_vl_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">y</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">chords</span><span class="p">])</span>
  <span class="n">c_vl_avg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">c_vl_sum</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">chords</span><span class="p">))</span>

  <span class="n">chords_list_f</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">c_st_sum</span><span class="p">,</span> 
                        <span class="n">c_st_avg</span><span class="p">,</span>
                        <span class="n">c_du_sum</span><span class="p">,</span>
                        <span class="n">c_du_avg</span><span class="p">,</span>
                        <span class="n">c_ch_sum</span><span class="p">,</span>
                        <span class="n">c_ch_avg</span><span class="p">,</span>
                        <span class="n">c_pt_sum</span><span class="p">,</span>
                        <span class="n">c_pt_avg</span><span class="p">,</span>
                        <span class="n">c_vl_sum</span><span class="p">,</span>
                        <span class="n">c_vl_avg</span><span class="p">])</span>

  <span class="k">return</span> <span class="n">melody_list_f</span><span class="p">,</span> <span class="n">chords_list_f</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.Tegridy_MIDI_TXT_Processor">
    <p>def <span class="ident">Tegridy_MIDI_TXT_Processor</span>(</p><p>dataset_name, converted_chords_list, converted_melody_list, simulate_velocity=False, line_by_line_output=False, represent_every_number_of_chords=0, chords_duration_multiplier=1, pad_chords_with_stops=False, chords_beat_divider=100)</p>
    </div>
    

    
  
    <div class="desc"><p>Tegridy MIDI to TXT Processor</p>
<p>Input: Dataset name
       Tegridy MIDI chords_list and melody_list (as is)
       Simulate velocity or not
       Line-by-line switch (useful for the AI models tokenizers and other specific purposes)
       Represent events every so many steps. Def. is 0. == do not represent.
       Chords durations multiplier. Def. = 1
       Pad chords with timed rests or not. Helps with some NLP implementations
       Chords beat divider/denominator. This essentially creates a beat for AI models to keep in mind. Default is 100 = 10 beats per second.</p>
<p>Output: TXT encoded MIDI events as plain txt/plain str
        Number of processed chords
        Number of bad/skipped chords (for whatever reason)</p>
<p>Project Los Angeles
Tegridy Code 2020</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.Tegridy_MIDI_TXT_Processor', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.Tegridy_MIDI_TXT_Processor" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">Tegridy_MIDI_TXT_Processor</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">,</span>
                              <span class="n">converted_chords_list</span><span class="p">,</span>
                              <span class="n">converted_melody_list</span><span class="p">,</span>
                              <span class="n">simulate_velocity</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">line_by_line_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">represent_every_number_of_chords</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                              <span class="n">chords_duration_multiplier</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                              <span class="n">pad_chords_with_stops</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">chords_beat_divider</span> <span class="o">=</span> <span class="mi">100</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Tegridy MIDI to TXT Processor</span>
<span class="sd">     </span>
<span class="sd">     Input: Dataset name</span>
<span class="sd">            Tegridy MIDI chords_list and melody_list (as is)</span>
<span class="sd">            Simulate velocity or not</span>
<span class="sd">            Line-by-line switch (useful for the AI models tokenizers and other specific purposes)</span>
<span class="sd">            Represent events every so many steps. Def. is 0. == do not represent.</span>
<span class="sd">            Chords durations multiplier. Def. = 1</span>
<span class="sd">            Pad chords with timed rests or not. Helps with some NLP implementations</span>
<span class="sd">            Chords beat divider/denominator. This essentially creates a beat for AI models to keep in mind. Default is 100 = 10 beats per second.</span>

<span class="sd">     Output: TXT encoded MIDI events as plain txt/plain str</span>
<span class="sd">             Number of processed chords</span>
<span class="sd">             Number of bad/skipped chords (for whatever reason)</span>

<span class="sd">     Project Los Angeles</span>
<span class="sd">     Tegridy Code 2020&#39;&#39;&#39;</span>

    <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">song_chords_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">number_of_chords_recorded</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">number_of_bad_chords_recorded</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">chord_start_time</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">first_song</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">rpz</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">previous_start_time</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">beat</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">dataset_name</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
      <span class="n">TXT_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">TXT_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    
    <span class="k">if</span> <span class="n">line_by_line_output</span><span class="p">:</span>
      <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>  

    <span class="k">for</span> <span class="n">chord</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">auto</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">converted_chords_list</span><span class="p">):</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">chord</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">:</span>
          <span class="n">song_dur</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chord</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chord</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
          <span class="n">durs_chord</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">chord</span><span class="p">))[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">chords_duration_multiplier</span><span class="p">)</span>
          <span class="n">chord_duration</span> <span class="o">=</span> <span class="n">durs_chord</span>
        
        <span class="k">else</span><span class="p">:</span>      
          <span class="n">chord_duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chord</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">chords_duration_multiplier</span><span class="p">)</span>
          
        <span class="k">if</span> <span class="n">simulate_velocity</span><span class="p">:</span>
          <span class="n">chord_velocity</span> <span class="o">=</span> <span class="n">chord</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>  
          <span class="n">chord_velocity</span> <span class="o">=</span> <span class="n">chord</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">chord_start_time</span> <span class="o">=</span> <span class="n">chord</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> 
        <span class="k">if</span> <span class="n">chord_duration</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">chord_velocity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
          <span class="k">if</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">(</span><span class="n">chord</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;song_end&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">first_song</span><span class="p">:</span>
              <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39;SONG=END_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">song_chords_count</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_Chords&#39;</span>
              <span class="k">if</span> <span class="n">line_by_line_output</span><span class="p">:</span>
                <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
              <span class="k">else</span><span class="p">:</span>  
                <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>

              <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39;SONG=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">chord</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
              <span class="k">if</span> <span class="n">line_by_line_output</span><span class="p">:</span>
                <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
              <span class="k">else</span><span class="p">:</span>  
                <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>
              <span class="n">song_chords_count</span> <span class="o">=</span> <span class="mi">1</span> 
                          
            <span class="k">else</span><span class="p">:</span>  

              <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39;SONG=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">chord</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
              <span class="k">if</span> <span class="n">line_by_line_output</span><span class="p">:</span>
                <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
              <span class="k">else</span><span class="p">:</span>  
                <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>
              <span class="n">song_chords_count</span> <span class="o">=</span> <span class="mi">1</span>  
            
          <span class="k">else</span><span class="p">:</span>
              <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39;SONG=END_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">song_chords_count</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_Chords&#39;</span>
              <span class="k">if</span> <span class="n">line_by_line_output</span><span class="p">:</span>
                <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
              <span class="k">else</span><span class="p">:</span>  
                <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>             

        <span class="k">else</span><span class="p">:</span>
          
          <span class="n">beat</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">chord_start_time</span> <span class="o">-</span> <span class="n">previous_start_time</span><span class="p">)))</span> <span class="o">/</span> <span class="n">chords_beat_divider</span><span class="p">)</span>

          <span class="k">if</span> <span class="n">pad_chords_with_stops</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">chord_start_time</span> <span class="o">-</span> <span class="n">previous_start_time</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
              <span class="n">TXT_string</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">chord_start_time</span> <span class="o">-</span> <span class="n">previous_start_time</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">beat</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
              <span class="k">if</span> <span class="n">line_by_line_output</span><span class="p">:</span>
                <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
              <span class="k">else</span><span class="p">:</span>  
                <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>

          <span class="n">TXT_string</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">chord_start_time</span> <span class="o">-</span> <span class="n">previous_start_time</span><span class="p">)))</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">chord_duration</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">chord</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">chord_velocity</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">beat</span><span class="p">)</span>
          
          
          <span class="n">previous_start_time</span> <span class="o">=</span> <span class="n">chord_start_time</span>
          
          <span class="k">for</span> <span class="n">note</span> <span class="ow">in</span> <span class="n">chord</span><span class="p">:</span>
            <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">note</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">chord_duration</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">note</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">chords_duration_multiplier</span><span class="p">))</span>
          
          <span class="c1"># Representation of events</span>
          <span class="k">if</span> <span class="n">represent_every_number_of_chords</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rpz</span> <span class="o">==</span> <span class="n">represent_every_number_of_chords</span><span class="p">:</span>
              <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">song_dur</span><span class="p">)</span>
              <span class="n">rpz</span> <span class="o">=</span> <span class="mi">0</span>    
          
          <span class="k">if</span> <span class="n">line_by_line_output</span><span class="p">:</span>
            <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
          <span class="k">else</span><span class="p">:</span>  
            <span class="n">TXT_string</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>
          
          <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">chord</span><span class="p">)</span>

          <span class="n">song_chords_count</span> <span class="o">+=</span> <span class="mi">1</span>
          <span class="n">number_of_chords_recorded</span> <span class="o">+=</span> <span class="mi">1</span>
          <span class="n">rpz</span> <span class="o">+=</span> <span class="mi">1</span>
          
      <span class="k">except</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Bad chord. Skipping...&#39;</span><span class="p">)</span>
        <span class="n">number_of_bad_chords_recorded</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">continue</span>            

    <span class="k">return</span> <span class="n">TXT_string</span><span class="p">,</span> <span class="n">number_of_chords_recorded</span><span class="p">,</span> <span class="n">number_of_bad_chords_recorded</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.Tegridy_Optimus_INT_to_TXT_Converter">
    <p>def <span class="ident">Tegridy_Optimus_INT_to_TXT_Converter</span>(</p><p>INT8_List, time_denominator=128)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.Tegridy_Optimus_INT_to_TXT_Converter', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.Tegridy_Optimus_INT_to_TXT_Converter" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">Tegridy_Optimus_INT_to_TXT_Converter</span><span class="p">(</span><span class="n">INT8_List</span><span class="p">,</span> <span class="n">time_denominator</span><span class="o">=</span><span class="mi">128</span><span class="p">):</span>

  <span class="n">TXT_String</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">INT8_List</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">a</span> <span class="o">=</span> <span class="n">INT8_List</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">time_denominator</span> <span class="o">*</span> <span class="mi">128</span>
      <span class="n">b</span> <span class="o">=</span> <span class="n">INT8_List</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    
      <span class="n">TXT_String</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Bad INT bits:&#39;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
      <span class="k">continue</span>

  <span class="k">return</span> <span class="n">TXT_String</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.Tegridy_Optimus_Sum_Intro_Rand_End_Sampler">
    <p>def <span class="ident">Tegridy_Optimus_Sum_Intro_Rand_End_Sampler</span>(</p><p>MIDI_file, number_of_notes_in_samples=256)</p>
    </div>
    

    
  
    <div class="desc"><p>Project Los Angeles
Tegridy Code 2021</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.Tegridy_Optimus_Sum_Intro_Rand_End_Sampler', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.Tegridy_Optimus_Sum_Intro_Rand_End_Sampler" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">Tegridy_Optimus_Sum_Intro_Rand_End_Sampler</span><span class="p">(</span><span class="n">MIDI_file</span><span class="p">,</span> <span class="n">number_of_notes_in_samples</span> <span class="o">=</span> <span class="mi">256</span><span class="p">):</span>

  <span class="sd">&#39;&#39;&#39;Project Los Angeles</span>
<span class="sd">     Tegridy Code 2021&#39;&#39;&#39;</span>

  <span class="n">INTRO</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">RAND</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">END</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="n">SUM</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="n">txt</span><span class="p">,</span> <span class="n">melody_list</span><span class="p">,</span> <span class="n">chords</span> <span class="o">=</span> <span class="n">Optimus_MIDI_TXT_Processor</span><span class="p">(</span><span class="n">MIDI_file</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">127</span><span class="p">))</span>

  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chords</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">number_of_notes_in_samples</span><span class="p">:</span>
    <span class="n">number_of_notes_in_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chords</span><span class="p">)</span>

  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">chords</span><span class="p">[:</span><span class="n">number_of_notes_in_samples</span><span class="p">]:</span>
    <span class="n">INTRO</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>

  <span class="n">r</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">randbelow</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chords</span><span class="p">)</span> <span class="o">-</span> <span class="n">number_of_notes_in_samples</span><span class="p">)</span>
  
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">chords</span><span class="p">[</span><span class="n">r</span><span class="p">:</span><span class="n">r</span><span class="o">+</span><span class="n">number_of_notes_in_samples</span><span class="p">]:</span> 
    <span class="n">RAND</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
  
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">chords</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">chords</span><span class="p">)</span><span class="o">-</span><span class="n">number_of_notes_in_samples</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">chords</span><span class="p">)]:</span> 
    <span class="n">END</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>

  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">chords</span><span class="p">:</span>
    <span class="n">SUM</span> <span class="o">+=</span> <span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>

  <span class="k">return</span> <span class="n">SUM</span><span class="p">,</span> <span class="n">INTRO</span><span class="p">,</span> <span class="n">RAND</span><span class="p">,</span> <span class="n">END</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.Tegridy_Optimus_TXT_to_INT_Converter">
    <p>def <span class="ident">Tegridy_Optimus_TXT_to_INT_Converter</span>(</p><p>TXT_String, time_denominator=128)</p>
    </div>
    

    
  
    <div class="desc"><p>Project Los Angeles
Tegridy Code 2021</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.Tegridy_Optimus_TXT_to_INT_Converter', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.Tegridy_Optimus_TXT_to_INT_Converter" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">Tegridy_Optimus_TXT_to_INT_Converter</span><span class="p">(</span><span class="n">TXT_String</span><span class="p">,</span> <span class="n">time_denominator</span><span class="o">=</span><span class="mi">128</span><span class="p">):</span>

  <span class="sd">&#39;&#39;&#39;Project Los Angeles</span>
<span class="sd">     Tegridy Code 2021&#39;&#39;&#39;</span>

  <span class="n">INT8_List</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">TXT_String</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="nb">ord</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">//</span> <span class="n">time_denominator</span><span class="p">)</span> <span class="o">//</span> <span class="mi">128</span><span class="p">)</span>
      <span class="n">b</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">%</span> <span class="n">time_denominator</span><span class="p">)</span>

      <span class="n">INT8_List</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
      <span class="n">INT8_List</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Bad TXT bits:&#39;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
      <span class="k">continue</span>

  <span class="k">return</span> <span class="n">INT8_List</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.Tegridy_Optimus_TXT_to_Notes_Converter">
    <p>def <span class="ident">Tegridy_Optimus_TXT_to_Notes_Converter</span>(</p><p>Optimus_TXT_String, line_by_line_dataset=True, has_velocities=True, has_MIDI_channels=True, dataset_MIDI_events_time_denominator=1, char_encoding_offset=30000, save_only_first_composition=True, simulate_velocity=True, karaoke=False)</p>
    </div>
    

    
  
    <div class="desc"><p>Project Los Angeles
Tegridy Code 2020</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.Tegridy_Optimus_TXT_to_Notes_Converter', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.Tegridy_Optimus_TXT_to_Notes_Converter" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">Tegridy_Optimus_TXT_to_Notes_Converter</span><span class="p">(</span><span class="n">Optimus_TXT_String</span><span class="p">,</span>
                                          <span class="n">line_by_line_dataset</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                          <span class="n">has_velocities</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                          <span class="n">has_MIDI_channels</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                          <span class="n">dataset_MIDI_events_time_denominator</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                                          <span class="n">char_encoding_offset</span> <span class="o">=</span> <span class="mi">30000</span><span class="p">,</span>
                                          <span class="n">save_only_first_composition</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                          <span class="n">simulate_velocity</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                          <span class="n">karaoke</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                                                            
    <span class="sd">&#39;&#39;&#39;Project Los Angeles</span>
<span class="sd">       Tegridy Code 2020&#39;&#39;&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tegridy Optimus TXT to Notes Converter&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Converting TXT to Notes list...Please wait...&#39;</span><span class="p">)</span>

    <span class="n">song_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">if</span> <span class="n">line_by_line_dataset</span><span class="p">:</span>
      <span class="n">input_string</span> <span class="o">=</span> <span class="n">Optimus_TXT_String</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">input_string</span> <span class="o">=</span> <span class="n">Optimus_TXT_String</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">line_by_line_dataset</span><span class="p">:</span>
      <span class="n">name_string</span> <span class="o">=</span> <span class="n">Optimus_TXT_String</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">name_string</span> <span class="o">=</span> <span class="n">Optimus_TXT_String</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">name_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SONG&#39;</span><span class="p">:</span>
      <span class="n">song_name</span> <span class="o">=</span> <span class="n">name_string</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">output_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">st</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_string</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
      
      <span class="k">if</span> <span class="n">save_only_first_composition</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SONG&#39;</span><span class="p">:</span>

          <span class="n">song_name</span> <span class="o">=</span> <span class="n">name_string</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
          <span class="k">break</span>

      <span class="k">try</span><span class="p">:</span>
        <span class="n">istring</span> <span class="o">=</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1">#print(istring)</span>

        <span class="k">if</span> <span class="n">has_MIDI_channels</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
          <span class="n">step</span> <span class="o">=</span> <span class="mi">4</span>          
        
        <span class="k">if</span> <span class="n">has_MIDI_channels</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
          <span class="n">step</span> <span class="o">=</span> <span class="mi">5</span>

        <span class="k">if</span> <span class="n">has_velocities</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
          <span class="n">step</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="n">st</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="o">*</span> <span class="n">dataset_MIDI_events_time_denominator</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">karaoke</span><span class="p">:</span>
          <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">istring</span><span class="p">),</span> <span class="n">step</span><span class="p">):</span>
              <span class="k">if</span> <span class="n">has_MIDI_channels</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">step</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">istring</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                      <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>       
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;note&#39;</span><span class="p">)</span>

                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="c1"># Start time</span>
                      
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="o">*</span> <span class="n">dataset_MIDI_events_time_denominator</span><span class="p">)</span> <span class="c1"># Duration</span>
                      
                      <span class="k">if</span> <span class="n">has_velocities</span><span class="p">:</span>
                        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">4</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">))</span> <span class="c1"># Channel</span>
                      <span class="k">else</span><span class="p">:</span>
                        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">))</span> <span class="c1"># Channel  </span>
                      
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">))</span> <span class="c1"># Pitch</span>
                      
                      <span class="k">if</span> <span class="n">simulate_velocity</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                          <span class="n">sim_vel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span>
                        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sim_vel</span><span class="p">)</span> <span class="c1"># Simulated Velocity (= highest note&#39;s pitch)</span>
                      <span class="k">else</span><span class="p">:</span>                      
                        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">))</span> <span class="c1"># Velocity</span>
            
              <span class="k">if</span> <span class="n">has_MIDI_channels</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">step</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">istring</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                      <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>       
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;note&#39;</span><span class="p">)</span>

                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="c1"># Start time</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="o">*</span> <span class="n">dataset_MIDI_events_time_denominator</span><span class="p">)</span> <span class="c1"># Duration</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># Channel</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">))</span> <span class="c1"># Pitch</span>
                      
                      <span class="k">if</span> <span class="n">simulate_velocity</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                          <span class="n">sim_vel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span>
                        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sim_vel</span><span class="p">)</span> <span class="c1"># Simulated Velocity (= highest note&#39;s pitch)</span>
                      <span class="k">else</span><span class="p">:</span>                      
                        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">))</span> <span class="c1"># Velocity</span>

              <span class="k">if</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">istring</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                      <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>       
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;note&#39;</span><span class="p">)</span>

                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="c1"># Start time</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="o">*</span> <span class="n">dataset_MIDI_events_time_denominator</span><span class="p">)</span> <span class="c1"># Duration</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># Channel</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">))</span> <span class="c1"># Pitch</span>
                      
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">))</span> <span class="c1"># Velocity = Pitch</span>

              <span class="n">output_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">karaoke</span><span class="p">:</span>
          <span class="k">try</span><span class="p">:</span>
              <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>       
              <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;note&#39;</span><span class="p">)</span>

              <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="c1"># Start time</span>
              <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="o">*</span> <span class="n">dataset_MIDI_events_time_denominator</span><span class="p">)</span> <span class="c1"># Duration</span>
              <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># Channel</span>
              <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">))</span> <span class="c1"># Pitch</span>
              
              <span class="k">if</span> <span class="n">simulate_velocity</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                  <span class="n">sim_vel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sim_vel</span><span class="p">)</span> <span class="c1"># Simulated Velocity (= highest note&#39;s pitch)</span>
              <span class="k">else</span><span class="p">:</span>                      
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">))</span> <span class="c1"># Velocity</span>
              <span class="n">output_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
              <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
              <span class="k">if</span> <span class="n">istring</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;lyric&#39;</span><span class="p">)</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="mi">5</span><span class="p">:])</span>
                <span class="n">output_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
          <span class="k">except</span><span class="p">:</span>
            <span class="k">continue</span>
            

      <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Bad note string:&#39;</span><span class="p">,</span> <span class="n">istring</span><span class="p">)</span>
        <span class="k">continue</span>

    <span class="c1"># Simple error control just in case</span>
    <span class="n">S</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">output_list</span><span class="p">:</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">S</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="n">output_list</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>    
    <span class="n">output_list</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>


    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Task complete! Enjoy! :)&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output_list</span><span class="p">,</span> <span class="n">song_name</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.Tegridy_Pickle_File_Loader">
    <p>def <span class="ident">Tegridy_Pickle_File_Loader</span>(</p><p>input_file_name=&#39;TMIDI_Pickle_File&#39;, ext=&#39;.pickle&#39;)</p>
    </div>
    

    
  
    <div class="desc"><p>Tegridy Pickle File Loader</p>
<p>Input: Full path and file name without extention
       File extension if different from default .pickle</p>
<p>Output: Chords list in TMIDI MIDI Processor format
        Melody list in TMIDI MIDI Processor format</p>
<p>Project Los Angeles
Tegridy Code 2021</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.Tegridy_Pickle_File_Loader', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.Tegridy_Pickle_File_Loader" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">Tegridy_Pickle_File_Loader</span><span class="p">(</span><span class="n">input_file_name</span><span class="o">=</span><span class="s1">&#39;TMIDI_Pickle_File&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;.pickle&#39;</span><span class="p">):</span>

  <span class="sd">&#39;&#39;&#39;Tegridy Pickle File Loader</span>
<span class="sd">     </span>
<span class="sd">  Input: Full path and file name without extention</span>
<span class="sd">         File extension if different from default .pickle</span>
<span class="sd">       </span>
<span class="sd">  Output: Chords list in TMIDI MIDI Processor format</span>
<span class="sd">          Melody list in TMIDI MIDI Processor format</span>

<span class="sd">  Project Los Angeles</span>
<span class="sd">  Tegridy Code 2021&#39;&#39;&#39;</span>

  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tegridy Pickle File Loader&#39;</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading the pickle file. Please wait...&#39;</span><span class="p">)</span>

  <span class="n">dataset</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_file_name</span> <span class="o">+</span> <span class="n">ext</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>

  <span class="n">chords_list_f</span><span class="p">,</span> <span class="n">melody_list_f</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>

  <span class="n">dataset</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading complete.&#39;</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of MIDI chords recorded:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">chords_list_f</span><span class="p">))</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The longest chord:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">chords_list_f</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">)),</span> <span class="s1">&#39;notes&#39;</span><span class="p">)</span> 
  <span class="nb">print</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">chords_list_f</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">))</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of recorded melody events:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">melody_list_f</span><span class="p">))</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;First melody event:&#39;</span><span class="p">,</span> <span class="n">melody_list_f</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;Last Melody event:&#39;</span><span class="p">,</span> <span class="n">melody_list_f</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total number of MIDI events recorded:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">chords_list_f</span><span class="p">))</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Task complete. Enjoy! :)&#39;</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">chords_list_f</span><span class="p">,</span> <span class="n">melody_list_f</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.Tegridy_Pickle_File_Writer">
    <p>def <span class="ident">Tegridy_Pickle_File_Writer</span>(</p><p>Data, input_file_name=&#39;TMIDI_Pickle_File&#39;)</p>
    </div>
    

    
  
    <div class="desc"><p>Tegridy Pickle File Writer</p>
<p>Input: Data to write (I.e. a list)
       Full path and file name without extention</p>
<p>Output: Named Pickle file</p>
<p>Project Los Angeles
Tegridy Code 2021</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.Tegridy_Pickle_File_Writer', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.Tegridy_Pickle_File_Writer" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">Tegridy_Pickle_File_Writer</span><span class="p">(</span><span class="n">Data</span><span class="p">,</span> <span class="n">input_file_name</span><span class="o">=</span><span class="s1">&#39;TMIDI_Pickle_File&#39;</span><span class="p">):</span>

  <span class="sd">&#39;&#39;&#39;Tegridy Pickle File Writer</span>
<span class="sd">     </span>
<span class="sd">  Input: Data to write (I.e. a list)</span>
<span class="sd">         Full path and file name without extention</span>
<span class="sd">         </span>
<span class="sd">  Output: Named Pickle file</span>

<span class="sd">  Project Los Angeles</span>
<span class="sd">  Tegridy Code 2021&#39;&#39;&#39;</span>

  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tegridy Pickle File Writer&#39;</span><span class="p">)</span>

  <span class="n">full_path_to_output_dataset_to</span> <span class="o">=</span> <span class="n">input_file_name</span> <span class="o">+</span> <span class="s1">&#39;.pickle&#39;</span>

  <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">full_path_to_output_dataset_to</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">full_path_to_output_dataset_to</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Removing old Dataset...&#39;</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating new Dataset file...&quot;</span><span class="p">)</span>

  <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">full_path_to_output_dataset_to</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">filehandle</span><span class="p">:</span>
    <span class="c1"># store the data as binary data stream</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">Data</span><span class="p">,</span> <span class="n">filehandle</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>

  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Dataset was saved as:&#39;</span><span class="p">,</span> <span class="n">full_path_to_output_dataset_to</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Task complete. Enjoy! :)&#39;</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.Tegridy_Reduced_TXT_to_Notes_Converter">
    <p>def <span class="ident">Tegridy_Reduced_TXT_to_Notes_Converter</span>(</p><p>Reduced_TXT_String, line_by_line_dataset=True, has_MIDI_channels=True, has_velocities=True, dataset_MIDI_events_time_denominator=10, char_encoding_offset=30, save_only_first_composition=True, dataset_includes_beat=False)</p>
    </div>
    

    
  
    <div class="desc"><p>Tegridy Reduced TXT to Notes Converter</p>
<pre><code>Input: Input TXT string in the Reduced TMIDI-TXT format
       Input dataset type
       Dataset was encoded with MIDI channels info or not
       Dataset was encoded with note's velocities info or not
       Used dataset time denominator/divider. It must match or the timings will be off.
       Char encoding offset. This is to prevent ambiguity with sys chars like
</code></pre>
<p>.</p>
<pre><code>Output: List of notes in MIDI.py Score format (TMIDI SONG format)
        First SONG= occurence (song name usually)

Project Los Angeles
Tegridy Code 2020
</code></pre></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.Tegridy_Reduced_TXT_to_Notes_Converter', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.Tegridy_Reduced_TXT_to_Notes_Converter" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">Tegridy_Reduced_TXT_to_Notes_Converter</span><span class="p">(</span><span class="n">Reduced_TXT_String</span><span class="p">,</span>
                                          <span class="n">line_by_line_dataset</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                          <span class="n">has_MIDI_channels</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                          <span class="n">has_velocities</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                          <span class="n">dataset_MIDI_events_time_denominator</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                                          <span class="n">char_encoding_offset</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
                                          <span class="n">save_only_first_composition</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                          <span class="n">dataset_includes_beat</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
                                                            
    <span class="sd">&#39;&#39;&#39;Tegridy Reduced TXT to Notes Converter</span>
<span class="sd">     </span>
<span class="sd">    Input: Input TXT string in the Reduced TMIDI-TXT format</span>
<span class="sd">           Input dataset type</span>
<span class="sd">           Dataset was encoded with MIDI channels info or not</span>
<span class="sd">           Dataset was encoded with note&#39;s velocities info or not</span>
<span class="sd">           Used dataset time denominator/divider. It must match or the timings will be off.</span>
<span class="sd">           Char encoding offset. This is to prevent ambiguity with sys chars like \n.</span>

<span class="sd">    Output: List of notes in MIDI.py Score format (TMIDI SONG format)</span>
<span class="sd">            First SONG= occurence (song name usually)</span>

<span class="sd">    Project Los Angeles</span>
<span class="sd">    Tegridy Code 2020&#39;&#39;&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tegridy Reduced TXT to Notes Converter&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Converting Reduced TXT to Notes list...Please wait...&#39;</span><span class="p">)</span>

    <span class="n">song_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">if</span> <span class="n">line_by_line_dataset</span><span class="p">:</span>
      <span class="n">input_string</span> <span class="o">=</span> <span class="n">Reduced_TXT_String</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">input_string</span> <span class="o">=</span> <span class="n">Reduced_TXT_String</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">line_by_line_dataset</span><span class="p">:</span>
      <span class="n">name_string</span> <span class="o">=</span> <span class="n">Reduced_TXT_String</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">name_string</span> <span class="o">=</span> <span class="n">Reduced_TXT_String</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">name_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SONG&#39;</span><span class="p">:</span>
      <span class="n">song_name</span> <span class="o">=</span> <span class="n">name_string</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">output_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">st</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_string</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
      
      <span class="k">if</span> <span class="n">save_only_first_composition</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SONG&#39;</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;END_&#39;</span> <span class="p">:</span>
            <span class="n">song_name</span> <span class="o">=</span> <span class="n">name_string</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">continue</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>

      <span class="k">try</span><span class="p">:</span>
        <span class="n">istring</span> <span class="o">=</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">has_MIDI_channels</span><span class="o">==</span><span class="kc">False</span> <span class="ow">and</span> <span class="n">has_velocities</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
          <span class="n">step</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="k">if</span> <span class="n">has_MIDI_channels</span><span class="o">==</span><span class="kc">True</span> <span class="ow">and</span> <span class="n">has_velocities</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
          <span class="n">step</span> <span class="o">=</span> <span class="mi">4</span>          
        
        <span class="k">if</span> <span class="n">has_MIDI_channels</span><span class="o">==</span><span class="kc">False</span> <span class="ow">and</span> <span class="n">has_velocities</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
          <span class="n">step</span> <span class="o">=</span> <span class="mi">4</span>  
        
        <span class="k">if</span> <span class="n">has_MIDI_channels</span><span class="o">==</span><span class="kc">True</span> <span class="ow">and</span> <span class="n">has_velocities</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
          <span class="n">step</span> <span class="o">=</span> <span class="mi">5</span>

        <span class="k">if</span> <span class="n">dataset_includes_beat</span><span class="p">:</span>
          <span class="n">step</span> <span class="o">=</span> <span class="n">step</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">dur</span> <span class="o">=</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="o">*</span> <span class="n">dataset_MIDI_events_time_denominator</span>


        <span class="k">if</span> <span class="n">dur</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#Check for rests/zero notes (we are skipping them)</span>

          <span class="n">st</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="o">*</span> <span class="n">dataset_MIDI_events_time_denominator</span>

          <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">istring</span><span class="p">),</span> <span class="n">step</span><span class="p">):</span>
              <span class="k">if</span> <span class="n">has_MIDI_channels</span><span class="o">==</span><span class="kc">True</span> <span class="ow">and</span> <span class="n">has_velocities</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">step</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">istring</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                      <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>       
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;note&#39;</span><span class="p">)</span>

                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="c1"># Start time</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="o">*</span> <span class="n">dataset_MIDI_events_time_denominator</span><span class="p">)</span> <span class="c1"># Duration</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="c1"># Channel</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="c1"># Pitch</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">4</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="c1"># Velocity</span>

                      <span class="n">output_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
              
              <span class="k">if</span> <span class="n">has_MIDI_channels</span><span class="o">==</span><span class="kc">True</span> <span class="ow">and</span> <span class="n">has_velocities</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">step</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">istring</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                      <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>       
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;note&#39;</span><span class="p">)</span>

                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="c1"># Start time</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="o">*</span> <span class="n">dataset_MIDI_events_time_denominator</span><span class="p">)</span> <span class="c1"># Duration</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="c1"># Channel</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="c1"># Pitch</span>
                      <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">sim_vel</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sim_vel</span><span class="p">)</span> <span class="c1"># Simulated Velocity (= highest note&#39;s pitch)</span>
                      <span class="n">output_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

              <span class="k">if</span> <span class="n">has_velocities</span><span class="o">==</span><span class="kc">True</span> <span class="ow">and</span> <span class="n">has_MIDI_channels</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">step</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">istring</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                      <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>       
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;note&#39;</span><span class="p">)</span>
                      
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="c1"># Start time</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="o">*</span> <span class="n">dataset_MIDI_events_time_denominator</span><span class="p">)</span> <span class="c1"># Duration</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="c1"># Simulated Channel (Defaulting to Channel 0)</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="c1"># Pitch</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">4</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="c1"># Velocity</span>

                      <span class="n">output_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

              <span class="k">if</span> <span class="n">has_MIDI_channels</span><span class="o">==</span><span class="kc">False</span> <span class="ow">and</span> <span class="n">has_velocities</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">step</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">istring</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                      <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>       
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;note&#39;</span><span class="p">)</span>

                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="c1"># Start time</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="o">*</span> <span class="n">dataset_MIDI_events_time_denominator</span><span class="p">)</span> <span class="c1"># Duration</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="c1"># Simulated Channel (Defaulting to Channel 0)</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span><span class="p">)</span> <span class="c1"># Pitch</span>
                      <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">sim_vel</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">istring</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="n">char_encoding_offset</span>
                      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sim_vel</span><span class="p">)</span> <span class="c1"># Simulated Velocity (= highest note&#39;s pitch)</span>
                      <span class="n">output_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
      <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Bad note string:&#39;</span><span class="p">,</span> <span class="n">istring</span><span class="p">)</span>
        <span class="k">continue</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Task complete! Enjoy! :)&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output_list</span><span class="p">,</span> <span class="n">song_name</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.Tegridy_SONG_to_MIDI_Converter">
    <p>def <span class="ident">Tegridy_SONG_to_MIDI_Converter</span>(</p><p>SONG, output_signature=&#39;Tegridy TMIDI Module&#39;, track_name=&#39;Composition Track&#39;, number_of_ticks_per_quarter=425, list_of_MIDI_patches=[0, 24, 32, 40, 42, 46, 56, 71, 73, 0, 0, 0, 0, 0, 0, 0], output_file_name=&#39;TMIDI-Composition&#39;, text_encoding=&#39;ISO-8859-1&#39;)</p>
    </div>
    

    
  
    <div class="desc"><p>Tegridy SONG to MIDI Converter</p>
<p>Input: Input SONG in TMIDI SONG/MIDI.py Score format
       Output MIDI Track 0 name / MIDI Signature
       Output MIDI Track 1 name / Composition track name
       Number of ticks per quarter for the output MIDI
       List of 16 MIDI patch numbers for output MIDI. Def. is MuseNet compatible patches.
       Output file name w/o .mid extension.
       Optional text encoding if you are working with text_events/lyrics. This is especially useful for Karaoke. Please note that anything but ISO-8859-1 is a non-standard way of encoding text_events according to MIDI specs.</p>
<p>Output: MIDI File
        Detailed MIDI stats</p>
<p>Project Los Angeles
Tegridy Code 2020</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.Tegridy_SONG_to_MIDI_Converter', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.Tegridy_SONG_to_MIDI_Converter" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">Tegridy_SONG_to_MIDI_Converter</span><span class="p">(</span><span class="n">SONG</span><span class="p">,</span>
                                  <span class="n">output_signature</span> <span class="o">=</span> <span class="s1">&#39;Tegridy TMIDI Module&#39;</span><span class="p">,</span> 
                                  <span class="n">track_name</span> <span class="o">=</span> <span class="s1">&#39;Composition Track&#39;</span><span class="p">,</span>
                                  <span class="n">number_of_ticks_per_quarter</span> <span class="o">=</span> <span class="mi">425</span><span class="p">,</span>
                                  <span class="n">list_of_MIDI_patches</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                  <span class="n">output_file_name</span> <span class="o">=</span> <span class="s1">&#39;TMIDI-Composition&#39;</span><span class="p">,</span>
                                  <span class="n">text_encoding</span><span class="o">=</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Tegridy SONG to MIDI Converter</span>
<span class="sd">     </span>
<span class="sd">    Input: Input SONG in TMIDI SONG/MIDI.py Score format</span>
<span class="sd">           Output MIDI Track 0 name / MIDI Signature</span>
<span class="sd">           Output MIDI Track 1 name / Composition track name</span>
<span class="sd">           Number of ticks per quarter for the output MIDI</span>
<span class="sd">           List of 16 MIDI patch numbers for output MIDI. Def. is MuseNet compatible patches.</span>
<span class="sd">           Output file name w/o .mid extension.</span>
<span class="sd">           Optional text encoding if you are working with text_events/lyrics. This is especially useful for Karaoke. Please note that anything but ISO-8859-1 is a non-standard way of encoding text_events according to MIDI specs.</span>

<span class="sd">    Output: MIDI File</span>
<span class="sd">            Detailed MIDI stats</span>

<span class="sd">    Project Los Angeles</span>
<span class="sd">    Tegridy Code 2020&#39;&#39;&#39;</span>                                  

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Converting to MIDI. Please stand-by...&#39;</span><span class="p">)</span>
    
    <span class="n">output_header</span> <span class="o">=</span> <span class="p">[</span><span class="n">number_of_ticks_per_quarter</span><span class="p">,</span> 
                    <span class="p">[[</span><span class="s1">&#39;track_name&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">output_signature</span><span class="p">,</span> <span class="n">text_encoding</span><span class="p">)]]]</span>                                                    

    <span class="n">patch_list</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> 
                    <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                    <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
                    <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span>
                    <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">4</span><span class="p">]],</span>
                    <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">5</span><span class="p">]],</span>
                    <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">6</span><span class="p">]],</span>
                    <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">7</span><span class="p">]],</span>
                    <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">8</span><span class="p">]],</span>
                    <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">9</span><span class="p">]],</span>
                    <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">10</span><span class="p">]],</span>
                    <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">11</span><span class="p">]],</span>
                    <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">12</span><span class="p">]],</span>
                    <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">13</span><span class="p">]],</span>
                    <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">14</span><span class="p">]],</span>
                    <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">15</span><span class="p">]],</span>
                    <span class="p">[</span><span class="s1">&#39;track_name&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">track_name</span><span class="p">,</span> <span class="n">text_encoding</span><span class="p">)]]</span>

    <span class="n">output</span> <span class="o">=</span> <span class="n">output_header</span> <span class="o">+</span> <span class="p">[</span><span class="n">patch_list</span> <span class="o">+</span> <span class="n">SONG</span><span class="p">]</span>

    <span class="n">midi_data</span> <span class="o">=</span> <span class="n">score2midi</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">text_encoding</span><span class="p">)</span>
    <span class="n">detailed_MIDI_stats</span> <span class="o">=</span> <span class="n">score2stats</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file_name</span> <span class="o">+</span> <span class="s1">&#39;.mid&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">midi_file</span><span class="p">:</span>
        <span class="n">midi_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">midi_data</span><span class="p">)</span>
        <span class="n">midi_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done! Enjoy! :)&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">detailed_MIDI_stats</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.Tegridy_TXT_Dataset_File_Writer">
    <p>def <span class="ident">Tegridy_TXT_Dataset_File_Writer</span>(</p><p>input_file_name=&#39;TMIDI_TXT_Dataset&#39;, ext=&#39;&#39;, TXT_String=&#39;&#39;)</p>
    </div>
    

    
  
    <div class="desc"><p>Tegridy TXT Dataset File Writer</p>
<p>Input: Full path and file name without extention
       File extension
       Dataset as TXT string</p>
<p>Output: Named TXT Dataset File</p>
<p>Project Los Angeles
Tegridy Code 2021</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.Tegridy_TXT_Dataset_File_Writer', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.Tegridy_TXT_Dataset_File_Writer" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">Tegridy_TXT_Dataset_File_Writer</span><span class="p">(</span><span class="n">input_file_name</span><span class="o">=</span><span class="s1">&#39;TMIDI_TXT_Dataset&#39;</span><span class="p">,</span> 
                                    <span class="n">ext</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> 
                                    <span class="n">TXT_String</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>

  <span class="sd">&#39;&#39;&#39;Tegridy TXT Dataset File Writer</span>
<span class="sd">     </span>
<span class="sd">  Input: Full path and file name without extention</span>
<span class="sd">         File extension</span>
<span class="sd">         Dataset as TXT string</span>
<span class="sd">          </span>
<span class="sd">  Output: Named TXT Dataset File</span>

<span class="sd">  Project Los Angeles</span>
<span class="sd">  Tegridy Code 2021&#39;&#39;&#39;</span>

  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tegridy TXT Dataset File Writer&#39;</span><span class="p">)</span>

  <span class="n">full_path_to_TXT_dataset</span> <span class="o">=</span> <span class="n">input_file_name</span> <span class="o">+</span> <span class="n">ext</span>
  
  <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">full_path_to_TXT_dataset</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">full_path_to_TXT_dataset</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Removing old Dataset...&#39;</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating new Dataset file...&quot;</span><span class="p">)</span>

  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Writing dataset to a file...Please wait...&#39;</span><span class="p">)</span>
  <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">full_path_to_TXT_dataset</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
  <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">TXT_String</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">))</span>
  <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Dataset was saved as:&#39;</span><span class="p">,</span> <span class="n">full_path_to_TXT_dataset</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Task complete! Enjoy :)&#39;</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.Tegridy_TXT_DeTokenizer">
    <p>def <span class="ident">Tegridy_TXT_DeTokenizer</span>(</p><p>input_Tokenized_TXT_string, RDIC)</p>
    </div>
    

    
  
    <div class="desc"><p>Tegridy TXT Tokenizer</p>
<p>Input: Tokenized TXT String</p>
<p>Output: DeTokenized TXT string</p>
<p>Project Los Angeles
Tegridy Code 2021</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.Tegridy_TXT_DeTokenizer', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.Tegridy_TXT_DeTokenizer" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">Tegridy_TXT_DeTokenizer</span><span class="p">(</span><span class="n">input_Tokenized_TXT_string</span><span class="p">,</span> <span class="n">RDIC</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Tegridy TXT Tokenizer</span>
<span class="sd">     </span>
<span class="sd">    Input: Tokenized TXT String</span>
<span class="sd">           </span>

<span class="sd">    Output: DeTokenized TXT string</span>
<span class="sd">    </span>
<span class="sd">    Project Los Angeles</span>
<span class="sd">    Tegridy Code 2021&#39;&#39;&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tegridy TXT DeTokenizer&#39;</span><span class="p">)</span>

    <span class="n">Q</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_Tokenized_TXT_string</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">RTXT</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">Q</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">RTXT</span> <span class="o">+=</span> <span class="n">RDIC</span><span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="n">q</span><span class="p">)]</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
      <span class="k">except</span><span class="p">:</span>
        <span class="n">c</span><span class="o">+=</span><span class="mi">1</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of errors:&#39;</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done!&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">RTXT</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.Tegridy_TXT_MIDI_Processor">
    <p>def <span class="ident">Tegridy_TXT_MIDI_Processor</span>(</p><p>input_string, line_by_line_dataset=False, dataset_MIDI_events_time_denominator=10, number_of_ticks_per_quarter=425, start_from_this_generated_event=0, remove_generated_silence_if_needed=False, silence_offset_from_start=75000, simulate_velocity=False, output_signature=&#39;TMIDI-TXT-MIDI&#39;, list_of_MIDI_patches=[0, 24, 32, 40, 42, 46, 56, 71, 73, 0, 0, 0, 0, 0, 0, 0])</p>
    </div>
    

    
  
    <div class="desc"><p>Tegridy TXT to MIDI Processor</p>
<p>Input: Input TXT string in the TMIDI-TXT format
       Input is line-by-line or one-line
       Used dataset time denominator
       Number of ticks per quater for output MIDI
       Start from this input event (skip this many from start)
       Is there a generated silence or not
       Silence offset in MIDI ticks from start
       Simulate velocity (V = max(Pitch))
       Output MIDI signature
       List of 16 desired MIDI patch numbers for the output MIDI. Def. is MuseNet compatible patch list.</p>
<p>Output: NOTE: For now only 1st recorded TXT performance converted to MIDI.
        Raw/binary MIDI data that can be recorded to a file with standard python functions.
        Detected number of input notes
        Recorded number of output notes
        Detailed created MIDI stats in the MIDI.py module format (MIDI.score2stats)</p>
<p>Project Los Angeles
Tegridy Code 2020</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.Tegridy_TXT_MIDI_Processor', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.Tegridy_TXT_MIDI_Processor" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">Tegridy_TXT_MIDI_Processor</span><span class="p">(</span><span class="n">input_string</span><span class="p">,</span> 
                              <span class="n">line_by_line_dataset</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                              <span class="n">dataset_MIDI_events_time_denominator</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                              <span class="n">number_of_ticks_per_quarter</span> <span class="o">=</span> <span class="mi">425</span><span class="p">,</span>
                              <span class="n">start_from_this_generated_event</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                              <span class="n">remove_generated_silence_if_needed</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                              <span class="n">silence_offset_from_start</span> <span class="o">=</span> <span class="mi">75000</span><span class="p">,</span>
                              <span class="n">simulate_velocity</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                              <span class="n">output_signature</span> <span class="o">=</span> <span class="s1">&#39;TMIDI-TXT-MIDI&#39;</span><span class="p">,</span>
                              <span class="n">list_of_MIDI_patches</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]):</span>

    <span class="sd">&#39;&#39;&#39;Tegridy TXT to MIDI Processor</span>
<span class="sd">     </span>
<span class="sd">     Input: Input TXT string in the TMIDI-TXT format</span>
<span class="sd">            Input is line-by-line or one-line</span>
<span class="sd">            Used dataset time denominator</span>
<span class="sd">            Number of ticks per quater for output MIDI</span>
<span class="sd">            Start from this input event (skip this many from start)</span>
<span class="sd">            Is there a generated silence or not</span>
<span class="sd">            Silence offset in MIDI ticks from start</span>
<span class="sd">            Simulate velocity (V = max(Pitch))</span>
<span class="sd">            Output MIDI signature</span>
<span class="sd">            List of 16 desired MIDI patch numbers for the output MIDI. Def. is MuseNet compatible patch list.</span>

<span class="sd">     Output: NOTE: For now only 1st recorded TXT performance converted to MIDI.</span>
<span class="sd">             Raw/binary MIDI data that can be recorded to a file with standard python functions.</span>
<span class="sd">             Detected number of input notes</span>
<span class="sd">             Recorded number of output notes</span>
<span class="sd">             Detailed created MIDI stats in the MIDI.py module format (MIDI.score2stats)</span>

<span class="sd">     Project Los Angeles</span>
<span class="sd">     Tegridy Code 2020&#39;&#39;&#39;</span>

    <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">line_by_line_dataset</span><span class="p">:</span>
      <span class="n">input_string</span> <span class="o">=</span> <span class="n">input_string</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="c1"># for new datasets</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">input_string</span> <span class="o">=</span> <span class="n">input_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="c1"># for compatibility/legacy datasets</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">input_string</span><span class="p">)</span>


    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">z</span><span class="o">=</span><span class="mi">1</span>

    <span class="n">notes_specs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">song_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">previous_chord_start_time</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">number_of_notes_recorded</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">zero_marker</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">song_header</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">song_score</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">start_time</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Converting TXT to MIDI. Please wait...&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_string</span><span class="p">)):</span>
      <span class="k">if</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=END_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SONG&#39;</span><span class="p">:</span>
        <span class="k">break</span>
        <span class="c1">#TODO Record all perfomances (even incomplete ones) as separate tracks in output MIDI</span>

      <span class="k">if</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SONG&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="n">song_name</span> <span class="o">=</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
          <span class="n">song_header</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;track_name&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">song_name</span><span class="p">])</span>
          <span class="n">duration</span> <span class="o">=</span> <span class="mi">1</span>
          <span class="k">continue</span>
        <span class="k">except</span><span class="p">:</span>
          <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unknown Song name format&#39;</span><span class="p">,</span> <span class="n">song_name</span><span class="p">)</span>
          <span class="n">duration</span> <span class="o">=</span> <span class="mi">1</span>
          <span class="k">continue</span>
        
      <span class="k">if</span> <span class="n">duration</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#Skipping rests</span>

        <span class="k">try</span><span class="p">:</span>
          <span class="n">start_time</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">dataset_MIDI_events_time_denominator</span>
          <span class="n">duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">dataset_MIDI_events_time_denominator</span> 
          <span class="n">channel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
          <span class="n">velocity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
          <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unknown Chord:&#39;</span><span class="p">,</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        
        <span class="k">try</span><span class="p">:</span>
          <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">5</span><span class="p">:])):</span>
            <span class="n">notes_specs</span><span class="p">,</span> <span class="n">dur</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">5</span><span class="p">:][</span><span class="n">x</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="n">duration</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">dur</span><span class="p">)</span>
            <span class="n">simulated_velocity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">notes_specs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">simulate_velocity</span><span class="p">:</span>
              <span class="n">song_score</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;note&#39;</span><span class="p">,</span> 
                                  <span class="nb">int</span><span class="p">(</span><span class="n">start_time</span><span class="p">),</span> <span class="c1">#Start Time</span>
                                  <span class="nb">int</span><span class="p">(</span><span class="n">duration</span><span class="p">),</span> <span class="c1">#Duration</span>
                                  <span class="nb">int</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="c1">#Channel</span>
                                  <span class="nb">int</span><span class="p">(</span><span class="n">notes_specs</span><span class="p">),</span> <span class="c1">#Note</span>
                                  <span class="nb">int</span><span class="p">(</span><span class="n">simulated_velocity</span><span class="p">)])</span> <span class="c1">#Velocity              </span>
              <span class="n">number_of_notes_recorded</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>  
              <span class="n">song_score</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;note&#39;</span><span class="p">,</span> 
                                  <span class="nb">int</span><span class="p">(</span><span class="n">start_time</span><span class="p">),</span> <span class="c1">#Start Time</span>
                                  <span class="nb">int</span><span class="p">(</span><span class="n">duration</span><span class="p">),</span> <span class="c1">#Duration</span>
                                  <span class="nb">int</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span> <span class="c1">#Channel</span>
                                  <span class="nb">int</span><span class="p">(</span><span class="n">notes_specs</span><span class="p">),</span> <span class="c1">#Note</span>
                                  <span class="nb">int</span><span class="p">(</span><span class="n">velocity</span><span class="p">)])</span> <span class="c1">#Velocity              </span>
              <span class="n">number_of_notes_recorded</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span><span class="p">:</span>
          <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unknown Notes: &quot;</span> <span class="o">+</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
          <span class="k">continue</span>

    <span class="k">if</span> <span class="n">remove_generated_silence_if_needed</span><span class="p">:</span>
      <span class="n">song_score1</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="n">note</span> <span class="ow">in</span> <span class="n">song_score</span><span class="p">[</span><span class="n">start_from_this_generated_event</span><span class="p">:]:</span>
        <span class="n">note1</span> <span class="o">=</span> <span class="n">note</span>
        <span class="n">note1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">note</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">silence_offset_from_start</span>
        <span class="n">song_score1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">note1</span><span class="p">)</span>
      <span class="n">song_score</span> <span class="o">=</span> <span class="n">song_score1</span>  

    <span class="n">output_header</span> <span class="o">=</span> <span class="p">[</span><span class="n">number_of_ticks_per_quarter</span><span class="p">,</span> <span class="p">[[</span><span class="s1">&#39;track_name&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">output_signature</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)]]]</span> 
                                                  
    <span class="n">patch_list</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> 
                <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
                <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span>
                <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">4</span><span class="p">]],</span>
                <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">5</span><span class="p">]],</span>
                <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">6</span><span class="p">]],</span>
                <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">7</span><span class="p">]],</span>
                <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">8</span><span class="p">]],</span>
                <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">9</span><span class="p">]],</span>
                <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">10</span><span class="p">]],</span>
                <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">11</span><span class="p">]],</span>
                <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">12</span><span class="p">]],</span>
                <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">13</span><span class="p">]],</span>
                <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">14</span><span class="p">]],</span>
                <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">list_of_MIDI_patches</span><span class="p">[</span><span class="mi">15</span><span class="p">]]]</span>

    <span class="n">output_song</span> <span class="o">=</span> <span class="n">song_header</span> <span class="o">+</span> <span class="n">song_score</span><span class="p">[</span><span class="n">start_from_this_generated_event</span><span class="p">:]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">output_header</span> <span class="o">+</span> <span class="p">[</span><span class="n">patch_list</span> <span class="o">+</span> <span class="n">output_song</span><span class="p">]</span>

    <span class="n">midi_data</span> <span class="o">=</span> <span class="n">score2midi</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="n">detailed_MIDI_stats</span> <span class="o">=</span> <span class="n">score2stats</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">midi_data</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_string</span><span class="p">),</span> <span class="n">number_of_notes_recorded</span><span class="p">,</span> <span class="n">detailed_MIDI_stats</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.Tegridy_TXT_Reducer">
    <p>def <span class="ident">Tegridy_TXT_Reducer</span>(</p><p>input_string, line_by_line_input_dataset=True, line_by_line_output_dataset=True, include_MIDI_channels=True, include_notes_velocities=True, char_encoding_offset=30, include_beat=False)</p>
    </div>
    

    
  
    <div class="desc"><p>Tegridy TXT Reducer</p>
<pre><code>Input: Input TXT string in the TMIDI-TXT format
       Input dataset type
       Output dataset type
       Dataset MIDI events time divider/denominator
       Reduce MIDI channels or not (False = savings on AI token memory)
       Reduce Note's velocities or not (False = savings on AI token memory)
       Char encoding offset. This is to prevent ambiguity with sys chars like
</code></pre>
<p>.</p>
<pre><code>Output: Reduced TXT string in UTF-8 format
        Number of recorded notes

Project Los Angeles
Tegridy Code 2020
</code></pre></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.Tegridy_TXT_Reducer', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.Tegridy_TXT_Reducer" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">Tegridy_TXT_Reducer</span><span class="p">(</span><span class="n">input_string</span><span class="p">,</span> 
                        <span class="n">line_by_line_input_dataset</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="n">line_by_line_output_dataset</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="n">include_MIDI_channels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">include_notes_velocities</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">char_encoding_offset</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
                        <span class="n">include_beat</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Tegridy TXT Reducer</span>
<span class="sd">     </span>
<span class="sd">    Input: Input TXT string in the TMIDI-TXT format</span>
<span class="sd">           Input dataset type</span>
<span class="sd">           Output dataset type</span>
<span class="sd">           Dataset MIDI events time divider/denominator</span>
<span class="sd">           Reduce MIDI channels or not (False = savings on AI token memory)</span>
<span class="sd">           Reduce Note&#39;s velocities or not (False = savings on AI token memory)</span>
<span class="sd">           Char encoding offset. This is to prevent ambiguity with sys chars like \n.</span>

<span class="sd">    Output: Reduced TXT string in UTF-8 format</span>
<span class="sd">            Number of recorded notes</span>

<span class="sd">    Project Los Angeles</span>
<span class="sd">    Tegridy Code 2020&#39;&#39;&#39;</span>

    <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">line_by_line_input_dataset</span><span class="p">:</span>
      <span class="n">input_string</span> <span class="o">=</span> <span class="n">input_string</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="c1"># for general use</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">input_string</span> <span class="o">=</span> <span class="n">input_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="c1"># for some specific purposes</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">input_string</span><span class="p">)</span>


    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">z</span><span class="o">=</span><span class="mi">1</span>

    <span class="n">notes_specs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">song_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">previous_chord_start_time</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">number_of_notes_recorded</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">zero_marker</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">song_header</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">song_score</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">start_time</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">Output_TXT_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reducing TXT. Please wait...&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">auto</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_string</span><span class="p">))):</span>
      
      <span class="k">if</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;DATASET&#39;</span><span class="p">:</span>
        <span class="n">Output_TXT_string</span> <span class="o">+=</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">continue</span>

      <span class="k">if</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SONG&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;END_&#39;</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">line_by_line_output_dataset</span><span class="p">:</span>
            <span class="n">Output_TXT_string</span> <span class="o">+=</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">continue</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">Output_TXT_string</span> <span class="o">+=</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>  
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">Output_TXT_string</span> <span class="o">+=</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
          <span class="k">continue</span>
        
      <span class="k">try</span><span class="p">:</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">velocity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">beat</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">4</span><span class="p">])</span>
      <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unknown Chord:&#39;</span><span class="p">,</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
      
      <span class="k">try</span><span class="p">:</span>
        <span class="n">chars</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">5</span><span class="p">:])):</span>
          <span class="n">notes_specs</span><span class="p">,</span> <span class="n">dur</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">5</span><span class="p">:][</span><span class="n">x</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
          <span class="n">dura</span> <span class="o">=</span> <span class="n">duration</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">dur</span><span class="p">)</span>
          
          <span class="n">chars</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">start_time</span><span class="p">)</span><span class="o">+</span><span class="n">char_encoding_offset</span><span class="p">)</span> <span class="c1">#Start Time</span>
          <span class="n">chars</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">dura</span><span class="p">)</span><span class="o">+</span><span class="n">char_encoding_offset</span><span class="p">)</span> <span class="c1">#Duration</span>
          
          <span class="k">if</span> <span class="n">include_beat</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">include_MIDI_channels</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">chars</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">beat</span><span class="p">)</span><span class="o">+</span><span class="n">char_encoding_offset</span><span class="p">)</span> <span class="c1">#Beat</span>

          <span class="k">if</span> <span class="n">include_MIDI_channels</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">include_beat</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">chars</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span><span class="o">+</span><span class="n">char_encoding_offset</span><span class="p">)</span> <span class="c1">#Channel</span>

          <span class="n">chars</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">notes_specs</span><span class="p">)</span><span class="o">+</span><span class="n">char_encoding_offset</span><span class="p">)</span> <span class="c1">#Note</span>

          <span class="k">if</span> <span class="n">include_notes_velocities</span><span class="p">:</span>
            <span class="n">chars</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">velocity</span><span class="p">)</span><span class="o">+</span><span class="n">char_encoding_offset</span><span class="p">)</span> <span class="c1">#Velocity</span>
 
          <span class="n">number_of_notes_recorded</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unknown Notes: &quot;</span> <span class="o">+</span> <span class="n">input_string</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">continue</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">Output_TXT_string</span> <span class="o">+=</span> <span class="n">chars</span>
        <span class="k">if</span> <span class="n">line_by_line_output_dataset</span><span class="p">:</span>
          <span class="n">Output_TXT_string</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">Output_TXT_string</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>  

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Task complete! Enjoy :)&#39;</span><span class="p">)</span>
       
    <span class="k">return</span> <span class="n">Output_TXT_string</span><span class="p">,</span> <span class="n">number_of_notes_recorded</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.Tegridy_TXT_Tokenizer">
    <p>def <span class="ident">Tegridy_TXT_Tokenizer</span>(</p><p>input_TXT_string, line_by_line_TXT_string=True)</p>
    </div>
    

    
  
    <div class="desc"><p>Tegridy TXT Tokenizer</p>
<p>Input: TXT String</p>
<p>Output: Tokenized TXT string + forward and reverse dics</p>
<p>Project Los Angeles
Tegridy Code 2021</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.Tegridy_TXT_Tokenizer', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.Tegridy_TXT_Tokenizer" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">Tegridy_TXT_Tokenizer</span><span class="p">(</span><span class="n">input_TXT_string</span><span class="p">,</span> <span class="n">line_by_line_TXT_string</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Tegridy TXT Tokenizer</span>
<span class="sd">     </span>
<span class="sd">    Input: TXT String</span>

<span class="sd">    Output: Tokenized TXT string + forward and reverse dics</span>
<span class="sd">    </span>
<span class="sd">    Project Los Angeles</span>
<span class="sd">    Tegridy Code 2021&#39;&#39;&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tegridy TXT Tokenizer&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">line_by_line_TXT_string</span><span class="p">:</span>
      <span class="n">T</span> <span class="o">=</span> <span class="n">input_TXT_string</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">T</span> <span class="o">=</span> <span class="n">input_TXT_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

    <span class="n">DIC</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">T</span><span class="p">))))</span>
    <span class="n">RDIC</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">T</span><span class="p">)),</span> <span class="n">T</span><span class="p">))</span>

    <span class="n">TXTT</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">T</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">TXTT</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">DIC</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
      <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error. Could not finish.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">TXTT</span><span class="p">,</span> <span class="n">DIC</span><span class="p">,</span> <span class="n">RDIC</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done!&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">TXTT</span><span class="p">,</span> <span class="n">DIC</span><span class="p">,</span> <span class="n">RDIC</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.Tegridy_TXT_to_INT_Converter">
    <p>def <span class="ident">Tegridy_TXT_to_INT_Converter</span>(</p><p>input_TXT_string, line_by_line_INT_string=True, max_INT=0)</p>
    </div>
    

    
  
    <div class="desc"><p>Tegridy TXT to Intergers Converter</p>
<p>Input: Input TXT string in the TMIDI-TXT format</p>
<pre><code>   Type of output TXT INT string: line-by-line or one long string

   Maximum absolute integer to process. Maximum is inclusive 
   Default = process all integers. This helps to remove outliers/unwanted ints
</code></pre>
<p>Output: List of pure intergers
        String of intergers in the specified format: line-by-line or one long string
        Number of processed integers
        Number of skipped integers</p>
<p>Project Los Angeles
Tegridy Code 2021</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.Tegridy_TXT_to_INT_Converter', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.Tegridy_TXT_to_INT_Converter" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">Tegridy_TXT_to_INT_Converter</span><span class="p">(</span><span class="n">input_TXT_string</span><span class="p">,</span> <span class="n">line_by_line_INT_string</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_INT</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Tegridy TXT to Intergers Converter</span>
<span class="sd">     </span>
<span class="sd">    Input: Input TXT string in the TMIDI-TXT format</span>

<span class="sd">           Type of output TXT INT string: line-by-line or one long string</span>

<span class="sd">           Maximum absolute integer to process. Maximum is inclusive </span>
<span class="sd">           Default = process all integers. This helps to remove outliers/unwanted ints</span>

<span class="sd">    Output: List of pure intergers</span>
<span class="sd">            String of intergers in the specified format: line-by-line or one long string</span>
<span class="sd">            Number of processed integers</span>
<span class="sd">            Number of skipped integers</span>
<span class="sd">    </span>
<span class="sd">    Project Los Angeles</span>
<span class="sd">    Tegridy Code 2021&#39;&#39;&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tegridy TXT to Intergers Converter&#39;</span><span class="p">)</span>

    <span class="n">output_INT_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">npi</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">nsi</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">TXT_List</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_TXT_string</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">TXT_List</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">max_INT</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">char</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="n">max_INT</span><span class="p">:</span>
          <span class="n">output_INT_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">char</span><span class="p">))</span>
          <span class="n">npi</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">nsi</span> <span class="o">+=</span> <span class="mi">1</span>  
      <span class="k">else</span><span class="p">:</span>
        <span class="n">output_INT_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">char</span><span class="p">))</span>
        <span class="n">npi</span> <span class="o">+=</span> <span class="mi">1</span>    
    
    <span class="k">if</span> <span class="n">line_by_line_INT_string</span><span class="p">:</span>
      <span class="n">output_INT_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">output_INT_list</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">output_INT_string</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">output_INT_list</span><span class="p">])</span>  

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Converted TXT to INTs:&#39;</span><span class="p">,</span> <span class="n">npi</span><span class="p">,</span> <span class="s1">&#39; / &#39;</span><span class="p">,</span> <span class="n">nsi</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output_INT_list</span><span class="p">,</span> <span class="n">output_INT_string</span><span class="p">,</span> <span class="n">npi</span><span class="p">,</span> <span class="n">nsi</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.Tegridy_TXT_to_INT_Processor">
    <p>def <span class="ident">Tegridy_TXT_to_INT_Processor</span>(</p><p>input_TXT_string)</p>
    </div>
    

    
  
    <div class="desc"><p>Tegridy TXT to Intergers Processor</p>
<p>Input: Input TXT string in the TMIDI-TXT format</p>
<p>Output: List of intergers
        Decoding dictionary</p>
<p>Project Los Angeles
Tegridy Code 2020</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.Tegridy_TXT_to_INT_Processor', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.Tegridy_TXT_to_INT_Processor" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">Tegridy_TXT_to_INT_Processor</span><span class="p">(</span><span class="n">input_TXT_string</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Tegridy TXT to Intergers Processor</span>
<span class="sd">     </span>
<span class="sd">    Input: Input TXT string in the TMIDI-TXT format</span>

<span class="sd">    Output: List of intergers</span>
<span class="sd">            Decoding dictionary</span>


<span class="sd">    Project Los Angeles</span>
<span class="sd">    Tegridy Code 2020&#39;&#39;&#39;</span>

    <span class="c1"># get vocabulary set</span>
    <span class="n">words</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">input_TXT_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))))</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>

    <span class="c1"># create word-integer encoder/decoder</span>
    <span class="n">word2int</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">))))</span>
    <span class="n">decoding_dictionary</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)),</span> <span class="n">words</span><span class="p">))</span>

    <span class="c1"># encode all words in the string into integers</span>
    <span class="n">output_INT_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">word2int</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">input_TXT_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)]</span>
    
    <span class="k">return</span> <span class="n">output_INT_list</span><span class="p">,</span> <span class="n">decoding_dictionary</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.concatenate_scores">
    <p>def <span class="ident">concatenate_scores</span>(</p><p>scores)</p>
    </div>
    

    
  
    <div class="desc"><p>Concatenates a list of scores into one score.
If the scores differ in their "ticks" parameter,
they will all get converted to millisecond-tick format.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.concatenate_scores', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.concatenate_scores" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">concatenate_scores</span><span class="p">(</span><span class="n">scores</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Concatenates a list of scores into one score.</span>
<span class="sd">If the scores differ in their &quot;ticks&quot; parameter,</span>
<span class="sd">they will all get converted to millisecond-tick format.</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="c1"># the deepcopys are needed if the input_score&#39;s are refs to the same obj</span>
    <span class="c1"># e.g. if invoked by midisox&#39;s repeat()</span>
    <span class="n">input_scores</span> <span class="o">=</span> <span class="n">_consistentise_ticks</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>  <span class="c1"># 3.7</span>
    <span class="n">output_score</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">input_scores</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">input_score</span> <span class="ow">in</span> <span class="n">input_scores</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">output_stats</span> <span class="o">=</span> <span class="n">score2stats</span><span class="p">(</span><span class="n">output_score</span><span class="p">)</span>
        <span class="n">delta_ticks</span> <span class="o">=</span> <span class="n">output_stats</span><span class="p">[</span><span class="s1">&#39;nticks&#39;</span><span class="p">]</span>
        <span class="n">itrack</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">itrack</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_score</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">itrack</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_score</span><span class="p">):</span> <span class="c1"># new output track if doesn&#39;t exist</span>
                <span class="n">output_score</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">input_score</span><span class="p">[</span><span class="n">itrack</span><span class="p">]:</span>
                <span class="n">output_score</span><span class="p">[</span><span class="n">itrack</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
                <span class="n">output_score</span><span class="p">[</span><span class="n">itrack</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">delta_ticks</span>
            <span class="n">itrack</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">output_score</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.event2alsaseq">
    <p>def <span class="ident">event2alsaseq</span>(</p><p>event=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Converts an event into the format needed by the alsaseq module,
http://pp.com.mx/python/alsaseq
The type of track (opus or score) is autodetected.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.event2alsaseq', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.event2alsaseq" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">event2alsaseq</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>   <span class="c1"># 5.5</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Converts an event into the format needed by the alsaseq module,</span>
<span class="sd">http://pp.com.mx/python/alsaseq</span>
<span class="sd">The type of track (opus or score) is autodetected.</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">pass</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.grep">
    <p>def <span class="ident">grep</span>(</p><p>score=None, channels=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Returns a "score" containing only the channels specified</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.grep', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.grep" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">grep</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Returns a &quot;score&quot; containing only the channels specified</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">score</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,[],]</span>
    <span class="n">ticks</span> <span class="o">=</span> <span class="n">score</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">new_score</span> <span class="o">=</span> <span class="p">[</span><span class="n">ticks</span><span class="p">,]</span>
    <span class="k">if</span> <span class="n">channels</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">new_score</span>
    <span class="n">channels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
    <span class="k">global</span> <span class="n">Event2channelindex</span>
    <span class="n">itrack</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">itrack</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">):</span>
        <span class="n">new_score</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">score</span><span class="p">[</span><span class="n">itrack</span><span class="p">]:</span>
            <span class="n">channel_index</span> <span class="o">=</span> <span class="n">Event2channelindex</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">channel_index</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="n">channel_index</span><span class="p">]</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
                    <span class="n">new_score</span><span class="p">[</span><span class="n">itrack</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_score</span><span class="p">[</span><span class="n">itrack</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="n">itrack</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">new_score</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.merge_scores">
    <p>def <span class="ident">merge_scores</span>(</p><p>scores)</p>
    </div>
    

    
  
    <div class="desc"><p>Merges a list of scores into one score.  A merged score comprises
all of the tracks from all of the input scores; un-merging is possible
by selecting just some of the tracks.  If the scores differ in their
"ticks" parameter, they will all get converted to millisecond-tick
format.  merge_scores attempts to resolve channel-conflicts,
but there are of course only 15 available channels&hellip;</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.merge_scores', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.merge_scores" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">merge_scores</span><span class="p">(</span><span class="n">scores</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Merges a list of scores into one score.  A merged score comprises</span>
<span class="sd">all of the tracks from all of the input scores; un-merging is possible</span>
<span class="sd">by selecting just some of the tracks.  If the scores differ in their</span>
<span class="sd">&quot;ticks&quot; parameter, they will all get converted to millisecond-tick</span>
<span class="sd">format.  merge_scores attempts to resolve channel-conflicts,</span>
<span class="sd">but there are of course only 15 available channels...</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="n">input_scores</span> <span class="o">=</span> <span class="n">_consistentise_ticks</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>  <span class="c1"># 3.6</span>
    <span class="n">output_score</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1000</span><span class="p">]</span>
    <span class="n">channels_so_far</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">all_channels</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">}</span>
    <span class="k">global</span> <span class="n">Event2channelindex</span>
    <span class="k">for</span> <span class="n">input_score</span> <span class="ow">in</span> <span class="n">input_scores</span><span class="p">:</span>
        <span class="n">new_channels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">score2stats</span><span class="p">(</span><span class="n">input_score</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;channels_total&#39;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">new_channels</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>  <span class="c1"># 2.8 cha9 must remain cha9 (in GM)</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channels_so_far</span> <span class="o">&amp;</span> <span class="n">new_channels</span><span class="p">:</span>
            <span class="c1"># consistently choose lowest avaiable, to ease testing</span>
            <span class="n">free_channels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">all_channels</span> <span class="o">-</span> <span class="p">(</span><span class="n">channels_so_far</span><span class="o">|</span><span class="n">new_channels</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">free_channels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">free_channels</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="n">free_channel</span> <span class="o">=</span> <span class="n">free_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">free_channel</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">break</span>
            <span class="n">itrack</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="n">itrack</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_score</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">input_event</span> <span class="ow">in</span> <span class="n">input_score</span><span class="p">[</span><span class="n">itrack</span><span class="p">]:</span>
                    <span class="n">channel_index</span><span class="o">=</span><span class="n">Event2channelindex</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">input_event</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">channel_index</span> <span class="ow">and</span> <span class="n">input_event</span><span class="p">[</span><span class="n">channel_index</span><span class="p">]</span><span class="o">==</span><span class="n">channel</span><span class="p">:</span>
                        <span class="n">input_event</span><span class="p">[</span><span class="n">channel_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">free_channel</span>
                <span class="n">itrack</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">channels_so_far</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">free_channel</span><span class="p">)</span>

        <span class="n">channels_so_far</span> <span class="o">|=</span> <span class="n">new_channels</span>
        <span class="n">output_score</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">input_score</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">return</span> <span class="n">output_score</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.midi2ms_score">
    <p>def <span class="ident">midi2ms_score</span>(</p><p>midi=b&#39;&#39;)</p>
    </div>
    

    
  
    <div class="desc"><p>Translates MIDI into a "score" with one beat per second and one
tick per millisecond, using midi2opus() then to_millisecs()
then opus2score()</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.midi2ms_score', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.midi2ms_score" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">midi2ms_score</span><span class="p">(</span><span class="n">midi</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Translates MIDI into a &quot;score&quot; with one beat per second and one</span>
<span class="sd">tick per millisecond, using midi2opus() then to_millisecs()</span>
<span class="sd">then opus2score()</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">opus2score</span><span class="p">(</span><span class="n">to_millisecs</span><span class="p">(</span><span class="n">midi2opus</span><span class="p">(</span><span class="n">midi</span><span class="p">)))</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.midi2opus">
    <p>def <span class="ident">midi2opus</span>(</p><p>midi=b&#39;&#39;)</p>
    </div>
    

    
  
    <div class="desc"><p>Translates MIDI into a "opus".  For a description of the
"opus" format, see opus2midi()</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.midi2opus', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.midi2opus" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">midi2opus</span><span class="p">(</span><span class="n">midi</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Translates MIDI into a &quot;opus&quot;.  For a description of the</span>
<span class="sd">&quot;opus&quot; format, see opus2midi()</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="n">my_midi</span><span class="o">=</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">midi</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">my_midi</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">_clean_up_warnings</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,[],]</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">my_midi</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">id</span> <span class="o">!=</span> <span class="sa">b</span><span class="s1">&#39;MThd&#39;</span><span class="p">:</span>
        <span class="n">_warn</span><span class="p">(</span><span class="s2">&quot;midi2opus: midi starts with &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; instead of &#39;MThd&#39;&quot;</span><span class="p">)</span>
        <span class="n">_clean_up_warnings</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,[],]</span>
    <span class="p">[</span><span class="n">length</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span> <span class="n">tracks_expected</span><span class="p">,</span> <span class="n">ticks</span><span class="p">]</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span>
     <span class="s1">&#39;&gt;IHHH&#39;</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">my_midi</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">14</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">length</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">:</span>
        <span class="n">_warn</span><span class="p">(</span><span class="s2">&quot;midi2opus: midi header length was &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">length</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; instead of 6&quot;</span><span class="p">)</span>
        <span class="n">_clean_up_warnings</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,[],]</span>
    <span class="n">my_opus</span> <span class="o">=</span> <span class="p">[</span><span class="n">ticks</span><span class="p">,]</span>
    <span class="n">my_midi</span> <span class="o">=</span> <span class="n">my_midi</span><span class="p">[</span><span class="mi">14</span><span class="p">:]</span>
    <span class="n">track_num</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># 5.1</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">my_midi</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">track_type</span>   <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">my_midi</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">track_type</span> <span class="o">!=</span> <span class="sa">b</span><span class="s1">&#39;MTrk&#39;</span><span class="p">:</span>
            <span class="c1">#_warn(&#39;midi2opus: Warning: track #&#39;+str(track_num)+&#39; type is &#39;+str(track_type)+&quot; instead of b&#39;MTrk&#39;&quot;)</span>
            <span class="k">pass</span>
        <span class="p">[</span><span class="n">track_length</span><span class="p">]</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&gt;I&#39;</span><span class="p">,</span> <span class="n">my_midi</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span>
        <span class="n">my_midi</span> <span class="o">=</span> <span class="n">my_midi</span><span class="p">[</span><span class="mi">8</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">track_length</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">my_midi</span><span class="p">):</span>
            <span class="n">_warn</span><span class="p">(</span><span class="s1">&#39;midi2opus: track #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">track_num</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; length &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">track_length</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; is too large&#39;</span><span class="p">)</span>
            <span class="n">_clean_up_warnings</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">my_opus</span>   <span class="c1"># 5.0</span>
        <span class="n">my_midi_track</span> <span class="o">=</span> <span class="n">my_midi</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">track_length</span><span class="p">]</span>
        <span class="n">my_track</span> <span class="o">=</span> <span class="n">_decode</span><span class="p">(</span><span class="n">my_midi_track</span><span class="p">)</span>
        <span class="n">my_opus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">my_track</span><span class="p">)</span>
        <span class="n">my_midi</span> <span class="o">=</span> <span class="n">my_midi</span><span class="p">[</span><span class="n">track_length</span><span class="p">:]</span>
        <span class="n">track_num</span> <span class="o">+=</span> <span class="mi">1</span>   <span class="c1"># 5.1</span>
    <span class="n">_clean_up_warnings</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">my_opus</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.midi2score">
    <p>def <span class="ident">midi2score</span>(</p><p>midi=b&#39;&#39;)</p>
    </div>
    

    
  
    <div class="desc"><p>Translates MIDI into a "score", using midi2opus() then opus2score()</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.midi2score', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.midi2score" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">midi2score</span><span class="p">(</span><span class="n">midi</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Translates MIDI into a &quot;score&quot;, using midi2opus() then opus2score()</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">opus2score</span><span class="p">(</span><span class="n">midi2opus</span><span class="p">(</span><span class="n">midi</span><span class="p">))</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.mix_opus_tracks">
    <p>def <span class="ident">mix_opus_tracks</span>(</p><p>input_tracks)</p>
    </div>
    

    
  
    <div class="desc"><p>Mixes an array of tracks into one track.  A mixed track
cannot be un-mixed.  It is assumed that the tracks share the same
ticks parameter and the same tempo.
Mixing score-tracks is trivial (just insert all events into one array).
Mixing opus-tracks is only slightly harder, but it's common enough
that a dedicated function is useful.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.mix_opus_tracks', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.mix_opus_tracks" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">mix_opus_tracks</span><span class="p">(</span><span class="n">input_tracks</span><span class="p">):</span>   <span class="c1"># 5.5</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Mixes an array of tracks into one track.  A mixed track</span>
<span class="sd">cannot be un-mixed.  It is assumed that the tracks share the same</span>
<span class="sd">ticks parameter and the same tempo.</span>
<span class="sd">Mixing score-tracks is trivial (just insert all events into one array).</span>
<span class="sd">Mixing opus-tracks is only slightly harder, but it&#39;s common enough</span>
<span class="sd">that a dedicated function is useful.</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="n">output_score</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="p">[]]</span>
    <span class="k">for</span> <span class="n">input_track</span> <span class="ow">in</span> <span class="n">input_tracks</span><span class="p">:</span>   <span class="c1"># 5.8</span>
        <span class="n">input_score</span> <span class="o">=</span> <span class="n">opus2score</span><span class="p">([</span><span class="mi">1000</span><span class="p">,</span> <span class="n">input_track</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">input_score</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">output_score</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="n">output_score</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">_ticks</span><span class="p">)</span> 
    <span class="n">output_opus</span> <span class="o">=</span> <span class="n">score2opus</span><span class="p">(</span><span class="n">output_score</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_opus</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.mix_scores">
    <p>def <span class="ident">mix_scores</span>(</p><p>scores)</p>
    </div>
    

    
  
    <div class="desc"><p>Mixes a list of scores into one one-track score.
A mixed score cannot be un-mixed.  Hopefully the scores
have no undesirable channel-conflicts between them.
If the scores differ in their "ticks" parameter,
they will all get converted to millisecond-tick format.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.mix_scores', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.mix_scores" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">mix_scores</span><span class="p">(</span><span class="n">scores</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Mixes a list of scores into one one-track score.</span>
<span class="sd">A mixed score cannot be un-mixed.  Hopefully the scores</span>
<span class="sd">have no undesirable channel-conflicts between them.</span>
<span class="sd">If the scores differ in their &quot;ticks&quot; parameter,</span>
<span class="sd">they will all get converted to millisecond-tick format.</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="n">input_scores</span> <span class="o">=</span> <span class="n">_consistentise_ticks</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>  <span class="c1"># 3.6</span>
    <span class="n">output_score</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="p">[]]</span>
    <span class="k">for</span> <span class="n">input_score</span> <span class="ow">in</span> <span class="n">input_scores</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">input_track</span> <span class="ow">in</span> <span class="n">input_score</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">output_score</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">input_track</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_score</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.opus2midi">
    <p>def <span class="ident">opus2midi</span>(</p><p>opus=[], text_encoding=&#39;ISO-8859-1&#39;)</p>
    </div>
    

    
  
    <div class="desc"><p>The argument is a list: the first item in the list is the "ticks"
parameter, the others are the tracks. Each track is a list
of midi-events, and each event is itself a list; see above.
opus2midi() returns a bytestring of the MIDI, which can then be
written either to a file opened in binary mode (mode='wb'),
or to stdout by means of:   sys.stdout.buffer.write()</p>
<p>my_opus = [
    96, 
    [   # track 0:
        ['patch_change', 0, 1, 8],   # and these are the events&hellip;
        ['note_on',   5, 1, 25, 96],
        ['note_off', 96, 1, 25, 0],
        ['note_on',   0, 1, 29, 96],
        ['note_off', 96, 1, 29, 0],
    ],   # end of track 0
]
my_midi = opus2midi(my_opus)
sys.stdout.buffer.write(my_midi)</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.opus2midi', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.opus2midi" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">opus2midi</span><span class="p">(</span><span class="n">opus</span><span class="o">=</span><span class="p">[],</span> <span class="n">text_encoding</span><span class="o">=</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;The argument is a list: the first item in the list is the &quot;ticks&quot;</span>
<span class="sd">parameter, the others are the tracks. Each track is a list</span>
<span class="sd">of midi-events, and each event is itself a list; see above.</span>
<span class="sd">opus2midi() returns a bytestring of the MIDI, which can then be</span>
<span class="sd">written either to a file opened in binary mode (mode=&#39;wb&#39;),</span>
<span class="sd">or to stdout by means of:   sys.stdout.buffer.write()</span>

<span class="sd">my_opus = [</span>
<span class="sd">    96, </span>
<span class="sd">    [   # track 0:</span>
<span class="sd">        [&#39;patch_change&#39;, 0, 1, 8],   # and these are the events...</span>
<span class="sd">        [&#39;note_on&#39;,   5, 1, 25, 96],</span>
<span class="sd">        [&#39;note_off&#39;, 96, 1, 25, 0],</span>
<span class="sd">        [&#39;note_on&#39;,   0, 1, 29, 96],</span>
<span class="sd">        [&#39;note_off&#39;, 96, 1, 29, 0],</span>
<span class="sd">    ],   # end of track 0</span>
<span class="sd">]</span>
<span class="sd">my_midi = opus2midi(my_opus)</span>
<span class="sd">sys.stdout.buffer.write(my_midi)</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">opus</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">opus</span><span class="o">=</span><span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="p">[],]</span>
    <span class="n">tracks</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">opus</span><span class="p">)</span>
    <span class="n">ticks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tracks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">ntracks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tracks</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ntracks</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">format</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">format</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">my_midi</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;MThd</span><span class="se">\x00\x00\x00\x06</span><span class="s2">&quot;</span><span class="o">+</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;HHH&#39;</span><span class="p">,</span><span class="nb">format</span><span class="p">,</span><span class="n">ntracks</span><span class="p">,</span><span class="n">ticks</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">tracks</span><span class="p">:</span>
        <span class="n">events</span> <span class="o">=</span> <span class="n">_encode</span><span class="p">(</span><span class="n">track</span><span class="p">,</span> <span class="n">text_encoding</span><span class="o">=</span><span class="n">text_encoding</span><span class="p">)</span>
        <span class="n">my_midi</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;MTrk&#39;</span> <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;I&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">))</span> <span class="o">+</span> <span class="n">events</span>
    <span class="n">_clean_up_warnings</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">my_midi</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.opus2score">
    <p>def <span class="ident">opus2score</span>(</p><p>opus=[])</p>
    </div>
    

    
  
    <div class="desc"><p>For a description of the "opus" and "score" formats,
see opus2midi() and score2opus().</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.opus2score', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.opus2score" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">opus2score</span><span class="p">(</span><span class="n">opus</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;For a description of the &quot;opus&quot; and &quot;score&quot; formats,</span>
<span class="sd">see opus2midi() and score2opus().</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">opus</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">_clean_up_warnings</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,[],]</span>
    <span class="n">tracks</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">opus</span><span class="p">)</span>  <span class="c1"># couple of slices probably quicker...</span>
    <span class="n">ticks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tracks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">score</span> <span class="o">=</span> <span class="p">[</span><span class="n">ticks</span><span class="p">,]</span>
    <span class="k">for</span> <span class="n">opus_track</span> <span class="ow">in</span> <span class="n">tracks</span><span class="p">:</span>
        <span class="n">ticks_so_far</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">score_track</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">chapitch2note_on_events</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([])</span>   <span class="c1"># 4.0</span>
        <span class="k">for</span> <span class="n">opus_event</span> <span class="ow">in</span> <span class="n">opus_track</span><span class="p">:</span>
            <span class="n">ticks_so_far</span> <span class="o">+=</span> <span class="n">opus_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">opus_event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note_off&#39;</span> <span class="ow">or</span> <span class="p">(</span><span class="n">opus_event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note_on&#39;</span> <span class="ow">and</span> <span class="n">opus_event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>  <span class="c1"># 4.8</span>
                <span class="n">cha</span> <span class="o">=</span> <span class="n">opus_event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">pitch</span> <span class="o">=</span> <span class="n">opus_event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">cha</span><span class="o">*</span><span class="mi">128</span> <span class="o">+</span> <span class="n">pitch</span>
                <span class="k">if</span> <span class="n">chapitch2note_on_events</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                    <span class="n">new_event</span> <span class="o">=</span> <span class="n">chapitch2note_on_events</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">new_event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ticks_so_far</span> <span class="o">-</span> <span class="n">new_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">score_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_event</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">pitch</span> <span class="o">&gt;</span> <span class="mi">127</span><span class="p">:</span>
                    <span class="k">pass</span> <span class="c1">#_warn(&#39;opus2score: note_off with no note_on, bad pitch=&#39;+str(pitch))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span> <span class="c1">#_warn(&#39;opus2score: note_off with no note_on cha=&#39;+str(cha)+&#39; pitch=&#39;+str(pitch))</span>
            <span class="k">elif</span> <span class="n">opus_event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note_on&#39;</span><span class="p">:</span>
                <span class="n">cha</span> <span class="o">=</span> <span class="n">opus_event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">pitch</span> <span class="o">=</span> <span class="n">opus_event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">cha</span><span class="o">*</span><span class="mi">128</span> <span class="o">+</span> <span class="n">pitch</span>
                <span class="n">new_event</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;note&#39;</span><span class="p">,</span><span class="n">ticks_so_far</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cha</span><span class="p">,</span><span class="n">pitch</span><span class="p">,</span> <span class="n">opus_event</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span>
                <span class="k">if</span> <span class="n">chapitch2note_on_events</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                    <span class="n">chapitch2note_on_events</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_event</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">chapitch2note_on_events</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_event</span><span class="p">,]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">opus_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ticks_so_far</span>
                <span class="n">score_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opus_event</span><span class="p">)</span>
        <span class="c1"># check for unterminated notes (Oisín) -- 5.2</span>
        <span class="k">for</span> <span class="n">chapitch</span> <span class="ow">in</span> <span class="n">chapitch2note_on_events</span><span class="p">:</span>
            <span class="n">note_on_events</span> <span class="o">=</span> <span class="n">chapitch2note_on_events</span><span class="p">[</span><span class="n">chapitch</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">new_e</span> <span class="ow">in</span> <span class="n">note_on_events</span><span class="p">:</span>
                <span class="n">new_e</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ticks_so_far</span> <span class="o">-</span> <span class="n">new_e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">score_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_e</span><span class="p">)</span>
                <span class="k">pass</span> <span class="c1">#_warn(&quot;opus2score: note_on with no note_off cha=&quot;+str(new_e[3])+&#39; pitch=&#39;+str(new_e[4])+&#39;; adding note_off at end&#39;)</span>
        <span class="n">score</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score_track</span><span class="p">)</span>
    <span class="n">_clean_up_warnings</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">score</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.play_score">
    <p>def <span class="ident">play_score</span>(</p><p>score=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Converts the "score" to midi, and feeds it into 'aplaymidi -'</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.play_score', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.play_score" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">play_score</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Converts the &quot;score&quot; to midi, and feeds it into &#39;aplaymidi -&#39;</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">score</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="kn">import</span> <span class="nn">subprocess</span>
    <span class="n">pipe</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s1">&#39;aplaymidi&#39;</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">],</span> <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">score_type</span><span class="p">(</span><span class="n">score</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;opus&#39;</span><span class="p">:</span>
        <span class="n">pipe</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">opus2midi</span><span class="p">(</span><span class="n">score</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pipe</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">score2midi</span><span class="p">(</span><span class="n">score</span><span class="p">))</span>
    <span class="n">pipe</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.score2midi">
    <p>def <span class="ident">score2midi</span>(</p><p>score=None, text_encoding=&#39;ISO-8859-1&#39;)</p>
    </div>
    

    
  
    <div class="desc"><p>Translates a "score" into MIDI, using score2opus() then opus2midi()</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.score2midi', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.score2midi" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">score2midi</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">text_encoding</span><span class="o">=</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Translates a &quot;score&quot; into MIDI, using score2opus() then opus2midi()</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">opus2midi</span><span class="p">(</span><span class="n">score2opus</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">text_encoding</span><span class="p">),</span> <span class="n">text_encoding</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.score2opus">
    <p>def <span class="ident">score2opus</span>(</p><p>score=None, text_encoding=&#39;ISO-8859-1&#39;)</p>
    </div>
    

    
  
    <div class="desc"><p>The argument is a list: the first item in the list is the "ticks"
parameter, the others are the tracks. Each track is a list
of score-events, and each event is itself a list.  A score-event
is similar to an opus-event (see above), except that in a score:
 1) the times are expressed as an absolute number of ticks
    from the track's start time
 2) the pairs of 'note_on' and 'note_off' events in an "opus"
    are abstracted into a single 'note' event in a "score":
    ['note', start_time, duration, channel, pitch, velocity]
score2opus() returns a list specifying the equivalent "opus".</p>
<p>my_score = [
    96,
    [   # track 0:
        ['patch_change', 0, 1, 8],
        ['note', 5, 96, 1, 25, 96],
        ['note', 101, 96, 1, 29, 96]
    ],   # end of track 0
]
my_opus = score2opus(my_score)</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.score2opus', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.score2opus" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">score2opus</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">text_encoding</span><span class="o">=</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">The argument is a list: the first item in the list is the &quot;ticks&quot;</span>
<span class="sd">parameter, the others are the tracks. Each track is a list</span>
<span class="sd">of score-events, and each event is itself a list.  A score-event</span>
<span class="sd">is similar to an opus-event (see above), except that in a score:</span>
<span class="sd"> 1) the times are expressed as an absolute number of ticks</span>
<span class="sd">    from the track&#39;s start time</span>
<span class="sd"> 2) the pairs of &#39;note_on&#39; and &#39;note_off&#39; events in an &quot;opus&quot;</span>
<span class="sd">    are abstracted into a single &#39;note&#39; event in a &quot;score&quot;:</span>
<span class="sd">    [&#39;note&#39;, start_time, duration, channel, pitch, velocity]</span>
<span class="sd">score2opus() returns a list specifying the equivalent &quot;opus&quot;.</span>

<span class="sd">my_score = [</span>
<span class="sd">    96,</span>
<span class="sd">    [   # track 0:</span>
<span class="sd">        [&#39;patch_change&#39;, 0, 1, 8],</span>
<span class="sd">        [&#39;note&#39;, 5, 96, 1, 25, 96],</span>
<span class="sd">        [&#39;note&#39;, 101, 96, 1, 29, 96]</span>
<span class="sd">    ],   # end of track 0</span>
<span class="sd">]</span>
<span class="sd">my_opus = score2opus(my_score)</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">score</span><span class="o">=</span><span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="p">[],]</span>
    <span class="n">tracks</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
    <span class="n">ticks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tracks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">opus_tracks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">scoretrack</span> <span class="ow">in</span> <span class="n">tracks</span><span class="p">:</span>
        <span class="n">time2events</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">scoreevent</span> <span class="ow">in</span> <span class="n">scoretrack</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scoreevent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note&#39;</span><span class="p">:</span>
                <span class="n">note_on_event</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;note_on&#39;</span><span class="p">,</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                 <span class="n">scoreevent</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span>
                <span class="n">note_off_event</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;note_off&#39;</span><span class="p">,</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                 <span class="n">scoreevent</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span>
                <span class="k">if</span> <span class="n">time2events</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">note_on_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                   <span class="n">time2events</span><span class="p">[</span><span class="n">note_on_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">note_on_event</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                   <span class="n">time2events</span><span class="p">[</span><span class="n">note_on_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">note_on_event</span><span class="p">,]</span>
                <span class="k">if</span> <span class="n">time2events</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">note_off_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                   <span class="n">time2events</span><span class="p">[</span><span class="n">note_off_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">note_off_event</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                   <span class="n">time2events</span><span class="p">[</span><span class="n">note_off_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">note_off_event</span><span class="p">,]</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">time2events</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
               <span class="n">time2events</span><span class="p">[</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scoreevent</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="n">time2events</span><span class="p">[</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">scoreevent</span><span class="p">,]</span>

        <span class="n">sorted_times</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of keys</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">time2events</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">sorted_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">sorted_times</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="n">sorted_events</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># once-flattened list of values sorted by key</span>
        <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">sorted_times</span><span class="p">:</span>
            <span class="n">sorted_events</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">time2events</span><span class="p">[</span><span class="n">time</span><span class="p">])</span>

        <span class="n">abs_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">sorted_events</span><span class="p">:</span>  <span class="c1"># convert abs times =&gt; delta times</span>
            <span class="n">delta_time</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">abs_time</span>
            <span class="n">abs_time</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">delta_time</span>
        <span class="n">opus_tracks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sorted_events</span><span class="p">)</span>
    <span class="n">opus_tracks</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ticks</span><span class="p">)</span>
    <span class="n">_clean_up_warnings</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">opus_tracks</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.score2stats">
    <p>def <span class="ident">score2stats</span>(</p><p>opus_or_score=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Returns a dict of some basic stats about the score, like
bank_select (list of tuples (msb,lsb)),
channels_by_track (list of lists), channels_total (set),
general_midi_mode (list),
ntracks, nticks, patch_changes_by_track (list of dicts),
num_notes_by_channel (list of numbers),
patch_changes_total (set),
percussion (dict histogram of channel 9 events),
pitches (dict histogram of pitches on channels other than 9),
pitch_range_by_track (list, by track, of two-member-tuples),
pitch_range_sum (sum over tracks of the pitch_ranges),</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.score2stats', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.score2stats" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">score2stats</span><span class="p">(</span><span class="n">opus_or_score</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Returns a dict of some basic stats about the score, like</span>
<span class="sd">bank_select (list of tuples (msb,lsb)),</span>
<span class="sd">channels_by_track (list of lists), channels_total (set),</span>
<span class="sd">general_midi_mode (list),</span>
<span class="sd">ntracks, nticks, patch_changes_by_track (list of dicts),</span>
<span class="sd">num_notes_by_channel (list of numbers),</span>
<span class="sd">patch_changes_total (set),</span>
<span class="sd">percussion (dict histogram of channel 9 events),</span>
<span class="sd">pitches (dict histogram of pitches on channels other than 9),</span>
<span class="sd">pitch_range_by_track (list, by track, of two-member-tuples),</span>
<span class="sd">pitch_range_sum (sum over tracks of the pitch_ranges),</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="n">bank_select_msb</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">bank_select_lsb</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">bank_select</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">channels_by_track</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">channels_total</span>    <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
    <span class="n">general_midi_mode</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">num_notes_by_channel</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([])</span>
    <span class="n">patches_used_by_track</span>  <span class="o">=</span> <span class="p">[]</span>
    <span class="n">patches_used_total</span>     <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
    <span class="n">patch_changes_by_track</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">patch_changes_total</span>    <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
    <span class="n">percussion</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([])</span> <span class="c1"># histogram of channel 9 &quot;pitches&quot;</span>
    <span class="n">pitches</span>    <span class="o">=</span> <span class="nb">dict</span><span class="p">([])</span> <span class="c1"># histogram of pitch-occurrences channels 0-8,10-15</span>
    <span class="n">pitch_range_sum</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1"># u pitch-ranges of each track</span>
    <span class="n">pitch_range_by_track</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">is_a_score</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">opus_or_score</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;bank_select&#39;</span><span class="p">:[],</span> <span class="s1">&#39;channels_by_track&#39;</span><span class="p">:[],</span> <span class="s1">&#39;channels_total&#39;</span><span class="p">:[],</span>
         <span class="s1">&#39;general_midi_mode&#39;</span><span class="p">:[],</span> <span class="s1">&#39;ntracks&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;nticks&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
         <span class="s1">&#39;num_notes_by_channel&#39;</span><span class="p">:</span><span class="nb">dict</span><span class="p">([]),</span>
         <span class="s1">&#39;patch_changes_by_track&#39;</span><span class="p">:[],</span> <span class="s1">&#39;patch_changes_total&#39;</span><span class="p">:[],</span>
         <span class="s1">&#39;percussion&#39;</span><span class="p">:{},</span> <span class="s1">&#39;pitches&#39;</span><span class="p">:{},</span> <span class="s1">&#39;pitch_range_by_track&#39;</span><span class="p">:[],</span>
         <span class="s1">&#39;ticks_per_quarter&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;pitch_range_sum&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
    <span class="n">ticks_per_quarter</span> <span class="o">=</span> <span class="n">opus_or_score</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># ignore first element, which is ticks</span>
    <span class="n">nticks</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">opus_or_score</span><span class="p">):</span>
        <span class="n">highest_pitch</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">lowest_pitch</span> <span class="o">=</span> <span class="mi">128</span>
        <span class="n">channels_this_track</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="n">patch_changes_this_track</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({})</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">opus_or_score</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note&#39;</span><span class="p">:</span>
                <span class="n">num_notes_by_channel</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="o">=</span> <span class="n">num_notes_by_channel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
                    <span class="n">percussion</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> <span class="o">=</span> <span class="n">percussion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pitches</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span>    <span class="o">=</span> <span class="n">pitches</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">highest_pitch</span><span class="p">:</span>
                        <span class="n">highest_pitch</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lowest_pitch</span><span class="p">:</span>
                        <span class="n">lowest_pitch</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">channels_this_track</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">channels_total</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">finish_time</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">finish_time</span> <span class="o">&gt;</span> <span class="n">nticks</span><span class="p">:</span>
                    <span class="n">nticks</span> <span class="o">=</span> <span class="n">finish_time</span>
            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note_off&#39;</span> <span class="ow">or</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note_on&#39;</span> <span class="ow">and</span> <span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>  <span class="c1"># 4.8</span>
                <span class="n">finish_time</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">finish_time</span> <span class="o">&gt;</span> <span class="n">nticks</span><span class="p">:</span>
                    <span class="n">nticks</span> <span class="o">=</span> <span class="n">finish_time</span>
            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note_on&#39;</span><span class="p">:</span>
                <span class="n">is_a_score</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">num_notes_by_channel</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">num_notes_by_channel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
                    <span class="n">percussion</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="o">=</span> <span class="n">percussion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pitches</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>    <span class="o">=</span> <span class="n">pitches</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">highest_pitch</span><span class="p">:</span>
                        <span class="n">highest_pitch</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lowest_pitch</span><span class="p">:</span>
                        <span class="n">lowest_pitch</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">channels_this_track</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">channels_total</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;patch_change&#39;</span><span class="p">:</span>
                <span class="n">patch_changes_this_track</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">patch_changes_total</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control_change&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># bank select MSB</span>
                    <span class="n">bank_select_msb</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">32</span><span class="p">:</span>  <span class="c1"># bank select LSB</span>
                    <span class="n">bank_select_lsb</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">bank_select_msb</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">bank_select_lsb</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">bank_select</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">bank_select_msb</span><span class="p">,</span><span class="n">bank_select_lsb</span><span class="p">))</span>
                    <span class="n">bank_select_msb</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">bank_select_lsb</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;sysex_f0&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">_sysex2midimode</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">general_midi_mode</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_sysex2midimode</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">is_a_score</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">nticks</span><span class="p">:</span>
                    <span class="n">nticks</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nticks</span> <span class="o">+=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">lowest_pitch</span> <span class="o">==</span> <span class="mi">128</span><span class="p">:</span>
            <span class="n">lowest_pitch</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">channels_by_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">channels_this_track</span><span class="p">)</span>
        <span class="n">patch_changes_by_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">patch_changes_this_track</span><span class="p">)</span>
        <span class="n">pitch_range_by_track</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">lowest_pitch</span><span class="p">,</span><span class="n">highest_pitch</span><span class="p">))</span>
        <span class="n">pitch_range_sum</span> <span class="o">+=</span> <span class="p">(</span><span class="n">highest_pitch</span><span class="o">-</span><span class="n">lowest_pitch</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;bank_select&#39;</span><span class="p">:</span><span class="n">bank_select</span><span class="p">,</span>
            <span class="s1">&#39;channels_by_track&#39;</span><span class="p">:</span><span class="n">channels_by_track</span><span class="p">,</span>
            <span class="s1">&#39;channels_total&#39;</span><span class="p">:</span><span class="n">channels_total</span><span class="p">,</span>
            <span class="s1">&#39;general_midi_mode&#39;</span><span class="p">:</span><span class="n">general_midi_mode</span><span class="p">,</span>
            <span class="s1">&#39;ntracks&#39;</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">opus_or_score</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;nticks&#39;</span><span class="p">:</span><span class="n">nticks</span><span class="p">,</span>
            <span class="s1">&#39;num_notes_by_channel&#39;</span><span class="p">:</span><span class="n">num_notes_by_channel</span><span class="p">,</span>
            <span class="s1">&#39;patch_changes_by_track&#39;</span><span class="p">:</span><span class="n">patch_changes_by_track</span><span class="p">,</span>
            <span class="s1">&#39;patch_changes_total&#39;</span><span class="p">:</span><span class="n">patch_changes_total</span><span class="p">,</span>
            <span class="s1">&#39;percussion&#39;</span><span class="p">:</span><span class="n">percussion</span><span class="p">,</span>
            <span class="s1">&#39;pitches&#39;</span><span class="p">:</span><span class="n">pitches</span><span class="p">,</span>
            <span class="s1">&#39;pitch_range_by_track&#39;</span><span class="p">:</span><span class="n">pitch_range_by_track</span><span class="p">,</span>
            <span class="s1">&#39;pitch_range_sum&#39;</span><span class="p">:</span><span class="n">pitch_range_sum</span><span class="p">,</span>
            <span class="s1">&#39;ticks_per_quarter&#39;</span><span class="p">:</span><span class="n">ticks_per_quarter</span><span class="p">}</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.score_type">
    <p>def <span class="ident">score_type</span>(</p><p>opus_or_score=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Returns a string, either 'opus' or 'score' or ''</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.score_type', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.score_type" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">score_type</span><span class="p">(</span><span class="n">opus_or_score</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Returns a string, either &#39;opus&#39; or &#39;score&#39; or &#39;&#39;</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">opus_or_score</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">opus_or_score</span><span class="p">))</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">opus_or_score</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># ignore first element</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">opus_or_score</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">opus_or_score</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;score&#39;</span>
            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note_on&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;opus&#39;</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.segment">
    <p>def <span class="ident">segment</span>(</p><p>score=None, start_time=None, end_time=None, start=0, end=100000000, tracks={0, 1, 2, 3, 4, 5, 6, 7, 8, 10, 11, 12, 13, 14, 15})</p>
    </div>
    

    
  
    <div class="desc"><p>Returns a "score" which is a segment of the one supplied
as the argument, beginning at "start_time" ticks and ending
at "end_time" ticks (or at the end if "end_time" is not supplied).
If the set "tracks" is specified, only those tracks will
be returned.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.segment', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.segment" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">segment</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="mi">100000000</span><span class="p">,</span>
 <span class="n">tracks</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">}):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Returns a &quot;score&quot; which is a segment of the one supplied</span>
<span class="sd">as the argument, beginning at &quot;start_time&quot; ticks and ending</span>
<span class="sd">at &quot;end_time&quot; ticks (or at the end if &quot;end_time&quot; is not supplied).</span>
<span class="sd">If the set &quot;tracks&quot; is specified, only those tracks will</span>
<span class="sd">be returned.</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">score</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="p">[],]</span>
    <span class="k">if</span> <span class="n">start_time</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># as of 4.2 start_time is recommended</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">start</span>  <span class="c1"># start is legacy usage</span>
    <span class="k">if</span> <span class="n">end_time</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>    <span class="c1"># likewise</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">end</span>
    <span class="n">new_score</span> <span class="o">=</span> <span class="p">[</span><span class="n">score</span><span class="p">[</span><span class="mi">0</span><span class="p">],]</span>
    <span class="n">my_type</span> <span class="o">=</span> <span class="n">score_type</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">my_type</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">new_score</span>
    <span class="k">if</span> <span class="n">my_type</span> <span class="o">==</span> <span class="s1">&#39;opus&#39;</span><span class="p">:</span>
        <span class="c1"># more difficult (disconnecting note_on&#39;s from their note_off&#39;s)...</span>
        <span class="n">_warn</span><span class="p">(</span><span class="s2">&quot;segment: opus format is not supported</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">_clean_up_warnings</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">new_score</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># ignore first element (ticks); we count in ticks anyway</span>
    <span class="n">tracks</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">tracks</span><span class="p">)</span>  <span class="c1"># defend against tuples and lists</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tracks</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tracks</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="n">new_track</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">channel2cc_num</span>  <span class="o">=</span> <span class="p">{}</span>     <span class="c1"># most recent controller change before start</span>
        <span class="n">channel2cc_val</span>  <span class="o">=</span> <span class="p">{}</span>
        <span class="n">channel2cc_time</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">channel2patch_num</span>  <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># keep most recent patch change before start</span>
        <span class="n">channel2patch_time</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">set_tempo_num</span>  <span class="o">=</span> <span class="mi">500000</span> <span class="c1"># most recent tempo change before start 6.3</span>
        <span class="n">set_tempo_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">earliest_note_time</span> <span class="o">=</span> <span class="n">end_time</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control_change&#39;</span><span class="p">:</span>  <span class="c1"># 6.5</span>
                <span class="n">cc_time</span> <span class="o">=</span> <span class="n">channel2cc_time</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">start_time</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">cc_time</span><span class="p">):</span>
                    <span class="n">channel2cc_num</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>  <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">channel2cc_val</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>  <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                    <span class="n">channel2cc_time</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;patch_change&#39;</span><span class="p">:</span>
                <span class="n">patch_time</span> <span class="o">=</span> <span class="n">channel2patch_time</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">start_time</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">patch_time</span><span class="p">):</span>  <span class="c1"># 2.0</span>
                    <span class="n">channel2patch_num</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>  <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">channel2patch_time</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;set_tempo&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">start_time</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">set_tempo_time</span><span class="p">):</span> <span class="c1">#6.4</span>
                    <span class="n">set_tempo_num</span>  <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">set_tempo_time</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">start_time</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">end_time</span><span class="p">):</span>
                <span class="n">new_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">earliest_note_time</span><span class="p">):</span>
                    <span class="n">earliest_note_time</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_track</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">new_track</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;set_tempo&#39;</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">set_tempo_num</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">channel2patch_num</span><span class="p">:</span>
                <span class="n">new_track</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span><span class="n">start_time</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">channel2patch_num</span><span class="p">[</span><span class="n">c</span><span class="p">]],)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">channel2cc_num</span><span class="p">:</span>   <span class="c1"># 6.5</span>
                <span class="n">new_track</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;control_change&#39;</span><span class="p">,</span><span class="n">start_time</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">channel2cc_num</span><span class="p">[</span><span class="n">c</span><span class="p">],</span><span class="n">channel2cc_val</span><span class="p">[</span><span class="n">c</span><span class="p">]])</span>
            <span class="n">new_score</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_track</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">_clean_up_warnings</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">new_score</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.timeshift">
    <p>def <span class="ident">timeshift</span>(</p><p>score=None, shift=None, start_time=None, from_time=0, tracks={0, 1, 2, 3, 4, 5, 6, 7, 8, 10, 12, 13, 14, 15})</p>
    </div>
    

    
  
    <div class="desc"><p>Returns a "score" shifted in time by "shift" ticks, or shifted
so that the first event starts at "start_time" ticks.</p>
<p>If "from_time" is specified, only those events in the score
that begin after it are shifted. If "start_time" is less than
"from_time" (or "shift" is negative), then the intermediate
notes are deleted, though patch-change events are preserved.</p>
<p>If "tracks" are specified, then only those tracks get shifted.
"tracks" can be a list, tuple or set; it gets converted to set
internally.</p>
<p>It is deprecated to specify both "shift" and "start_time".
If this does happen, timeshift() will print a warning to
stderr and ignore the "shift" argument.</p>
<p>If "shift" is negative and sufficiently large that it would
leave some event with a negative tick-value, then the score
is shifted so that the first event occurs at time 0. This
also occurs if "start_time" is negative, and is also the
default if neither "shift" nor "start_time" are specified.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.timeshift', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.timeshift" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">timeshift</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">from_time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tracks</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">}):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Returns a &quot;score&quot; shifted in time by &quot;shift&quot; ticks, or shifted</span>
<span class="sd">so that the first event starts at &quot;start_time&quot; ticks.</span>

<span class="sd">If &quot;from_time&quot; is specified, only those events in the score</span>
<span class="sd">that begin after it are shifted. If &quot;start_time&quot; is less than</span>
<span class="sd">&quot;from_time&quot; (or &quot;shift&quot; is negative), then the intermediate</span>
<span class="sd">notes are deleted, though patch-change events are preserved.</span>

<span class="sd">If &quot;tracks&quot; are specified, then only those tracks get shifted.</span>
<span class="sd">&quot;tracks&quot; can be a list, tuple or set; it gets converted to set</span>
<span class="sd">internally.</span>

<span class="sd">It is deprecated to specify both &quot;shift&quot; and &quot;start_time&quot;.</span>
<span class="sd">If this does happen, timeshift() will print a warning to</span>
<span class="sd">stderr and ignore the &quot;shift&quot; argument.</span>

<span class="sd">If &quot;shift&quot; is negative and sufficiently large that it would</span>
<span class="sd">leave some event with a negative tick-value, then the score</span>
<span class="sd">is shifted so that the first event occurs at time 0. This</span>
<span class="sd">also occurs if &quot;start_time&quot; is negative, and is also the</span>
<span class="sd">default if neither &quot;shift&quot; nor &quot;start_time&quot; are specified.</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="c1">#_warn(&#39;tracks=&#39;+str(tracks))</span>
    <span class="k">if</span> <span class="n">score</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="p">[],]</span>
    <span class="n">new_score</span> <span class="o">=</span> <span class="p">[</span><span class="n">score</span><span class="p">[</span><span class="mi">0</span><span class="p">],]</span>
    <span class="n">my_type</span> <span class="o">=</span> <span class="n">score_type</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">my_type</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">new_score</span>
    <span class="k">if</span> <span class="n">my_type</span> <span class="o">==</span> <span class="s1">&#39;opus&#39;</span><span class="p">:</span>
        <span class="n">_warn</span><span class="p">(</span><span class="s2">&quot;timeshift: opus format is not supported</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># _clean_up_scores()  6.2; doesn&#39;t exist! what was it supposed to do?</span>
        <span class="k">return</span> <span class="n">new_score</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">shift</span> <span class="o">==</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">start_time</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">_warn</span><span class="p">(</span><span class="s2">&quot;timeshift: shift and start_time specified: ignoring shift</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">shift</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">start_time</span> <span class="o">==</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">start_time</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># shift = start_time - from_time</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># ignore first element (ticks)</span>
    <span class="n">tracks</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">tracks</span><span class="p">)</span>  <span class="c1"># defend against tuples and lists</span>
    <span class="n">earliest</span> <span class="o">=</span> <span class="mi">1000000000</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">start_time</span> <span class="o">==</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">shift</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># first find the earliest event</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tracks</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tracks</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                 <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">from_time</span><span class="p">:</span>
                     <span class="k">continue</span>  <span class="c1"># just inspect the to_be_shifted events</span>
                 <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">earliest</span><span class="p">:</span>
                     <span class="n">earliest</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">earliest</span> <span class="o">&gt;</span> <span class="mi">999999999</span><span class="p">:</span>
        <span class="n">earliest</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">shift</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="n">start_time</span> <span class="o">-</span> <span class="n">earliest</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">earliest</span> <span class="o">+</span> <span class="n">shift</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">-</span> <span class="n">earliest</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># ignore first element (ticks)</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tracks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tracks</span><span class="p">):</span>  <span class="c1"># 3.8</span>
            <span class="n">new_score</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="n">new_track</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">new_event</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="c1">#if new_event[1] == 0 and shift &gt; 0 and new_event[0] != &#39;note&#39;:</span>
            <span class="c1">#    pass</span>
            <span class="c1">#elif new_event[1] &gt;= from_time:</span>
            <span class="k">if</span> <span class="n">new_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">from_time</span><span class="p">:</span>
                <span class="c1"># 4.1 must not rightshift set_tempo</span>
                <span class="k">if</span> <span class="n">new_event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;set_tempo&#39;</span> <span class="ow">or</span> <span class="n">shift</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">new_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">shift</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">shift</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">new_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">from_time</span><span class="o">+</span><span class="n">shift</span><span class="p">)):</span>
                <span class="k">continue</span>
            <span class="n">new_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_event</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_track</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">new_score</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_track</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">_clean_up_warnings</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">new_score</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="TMIDI.to_millisecs">
    <p>def <span class="ident">to_millisecs</span>(</p><p>old_opus=None, desired_time_in_ms=1)</p>
    </div>
    

    
  
    <div class="desc"><p>Recallibrates all the times in an "opus" to use one beat
per second and one tick per millisecond.  This makes it
hard to retrieve any information about beats or barlines,
but it does make it easy to mix different scores together.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.to_millisecs', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.to_millisecs" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">to_millisecs</span><span class="p">(</span><span class="n">old_opus</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">desired_time_in_ms</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;Recallibrates all the times in an &quot;opus&quot; to use one beat</span>
<span class="sd">per second and one tick per millisecond.  This makes it</span>
<span class="sd">hard to retrieve any information about beats or barlines,</span>
<span class="sd">but it does make it easy to mix different scores together.</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">old_opus</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">1000</span> <span class="o">*</span> <span class="n">desired_time_in_ms</span><span class="p">,[],]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">old_tpq</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">old_opus</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>   <span class="c1"># 5.0</span>
        <span class="n">_warn</span><span class="p">(</span><span class="s1">&#39;to_millisecs: the opus &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">old_opus</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; has no elements&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">1000</span> <span class="o">*</span> <span class="n">desired_time_in_ms</span><span class="p">,[],]</span>
    <span class="n">new_opus</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1000</span> <span class="o">*</span> <span class="n">desired_time_in_ms</span><span class="p">,]</span>
    <span class="c1"># 6.7 first go through building a table of set_tempos by absolute-tick</span>
    <span class="n">ticks2tempo</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">itrack</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">itrack</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_opus</span><span class="p">):</span>
        <span class="n">ticks_so_far</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">old_event</span> <span class="ow">in</span> <span class="n">old_opus</span><span class="p">[</span><span class="n">itrack</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">old_event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;to_millisecs needs an opus, not a score&#39;</span><span class="p">)</span>
            <span class="n">ticks_so_far</span> <span class="o">+=</span> <span class="n">old_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">old_event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;set_tempo&#39;</span><span class="p">:</span>
                <span class="n">ticks2tempo</span><span class="p">[</span><span class="n">ticks_so_far</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">itrack</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1"># then get the sorted-array of their keys</span>
    <span class="n">tempo_ticks</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of keys</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ticks2tempo</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">tempo_ticks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="n">tempo_ticks</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="c1"># then go through converting to millisec, testing if the next</span>
    <span class="c1"># set_tempo lies before the next track-event, and using it if so.</span>
    <span class="n">itrack</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">itrack</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_opus</span><span class="p">):</span>
        <span class="n">ms_per_old_tick</span> <span class="o">=</span> <span class="mi">400</span> <span class="o">/</span> <span class="n">old_tpq</span>  <span class="c1"># float: will round later 6.3</span>
        <span class="n">i_tempo_ticks</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ticks_so_far</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ms_so_far</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">previous_ms_so_far</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">new_track</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;set_tempo&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1000000</span> <span class="o">*</span> <span class="n">desired_time_in_ms</span><span class="p">],]</span>  <span class="c1"># new &quot;crochet&quot; is 1 sec</span>
        <span class="k">for</span> <span class="n">old_event</span> <span class="ow">in</span> <span class="n">old_opus</span><span class="p">[</span><span class="n">itrack</span><span class="p">]:</span>
            <span class="c1"># detect if ticks2tempo has something before this event</span>
            <span class="c1"># 20160702 if ticks2tempo is at the same time, leave it</span>
            <span class="n">event_delta_ticks</span> <span class="o">=</span> <span class="n">old_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">desired_time_in_ms</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i_tempo_ticks</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tempo_ticks</span><span class="p">)</span> <span class="ow">and</span>
              <span class="n">tempo_ticks</span><span class="p">[</span><span class="n">i_tempo_ticks</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ticks_so_far</span> <span class="o">+</span> <span class="n">old_event</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">desired_time_in_ms</span><span class="p">):</span>
                <span class="n">delta_ticks</span> <span class="o">=</span> <span class="n">tempo_ticks</span><span class="p">[</span><span class="n">i_tempo_ticks</span><span class="p">]</span> <span class="o">-</span> <span class="n">ticks_so_far</span>
                <span class="n">ms_so_far</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ms_per_old_tick</span> <span class="o">*</span> <span class="n">delta_ticks</span> <span class="o">*</span> <span class="n">desired_time_in_ms</span><span class="p">)</span>
                <span class="n">ticks_so_far</span> <span class="o">=</span> <span class="n">tempo_ticks</span><span class="p">[</span><span class="n">i_tempo_ticks</span><span class="p">]</span>
                <span class="n">ms_per_old_tick</span> <span class="o">=</span> <span class="n">ticks2tempo</span><span class="p">[</span><span class="n">ticks_so_far</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1000.0</span><span class="o">*</span><span class="n">old_tpq</span> <span class="o">*</span> <span class="n">desired_time_in_ms</span><span class="p">)</span>
                <span class="n">i_tempo_ticks</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">event_delta_ticks</span> <span class="o">-=</span> <span class="n">delta_ticks</span>
            <span class="n">new_event</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">old_event</span><span class="p">)</span>  <span class="c1"># now handle the new event</span>
            <span class="n">ms_so_far</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ms_per_old_tick</span> <span class="o">*</span> <span class="n">old_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">desired_time_in_ms</span><span class="p">)</span>
            <span class="n">new_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">ms_so_far</span> <span class="o">-</span> <span class="n">previous_ms_so_far</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">old_event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;set_tempo&#39;</span><span class="p">:</span>
                <span class="n">previous_ms_so_far</span> <span class="o">=</span> <span class="n">ms_so_far</span>
                <span class="n">new_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_event</span><span class="p">)</span>
            <span class="n">ticks_so_far</span> <span class="o">+=</span> <span class="n">event_delta_ticks</span>
        <span class="n">new_opus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_track</span><span class="p">)</span>
        <span class="n">itrack</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">_clean_up_warnings</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">new_opus</span>
</pre></div>

  </div>
</div>

  </div>
  

    <h2 class="section-title" id="header-classes">Classes</h2>
      
      <div class="item">
      <p id="TMIDI.Note" class="name">class <span class="ident">Note</span></p>
      
  
    <div class="desc"><p>A note event.
Parameters</p>
<hr>
<p>velocity : int
    Note velocity.
pitch : int
    Note pitch, as a MIDI note number.
start : float
    Note on time, absolute, in seconds.
end : float
    Note off time, absolute, in seconds.</p></div>
  <div class="source_cont">
</div>


      <div class="class">
          <h3>Instance variables</h3>
            <div class="item">
            <p id="TMIDI.Note.duration" class="name">var <span class="ident">duration</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
          <h3>Methods</h3>
            
  <div class="item">
    <div class="name def" id="TMIDI.Note.get_duration">
    <p>def <span class="ident">get_duration</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Get the duration of the note in seconds.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.Note.get_duration', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.Note.get_duration" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_duration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the duration of the note in seconds.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>
</pre></div>

  </div>
</div>

  </div>
  
      </div>
      </div>
      
      <div class="item">
      <p id="TMIDI.Tegridy_RPR_MidiEventProcessor" class="name">class <span class="ident">Tegridy_RPR_MidiEventProcessor</span></p>
      
  
    <div class="desc"><p>Midi Event Representation Processor.</p>
<h2 id="representation-format">Representation Format:</h2>
<p>Size: L * D:
    - L for the sequence (event) length
    - D = 1 {
        0-127: note-on event,
        128-255: note-off event,
        256-355(default):
            tick-shift event
            256 for one tick, 355 for 100 ticks
            the maximum number of tick-shift can be specified
        356-388 (default):
            velocity event
            the maximum number of quantized velocity can be specified
        }</p>
<h2 id="parameters">Parameters:</h2>
<p>min_step(optional):
    minimum quantification step
    decide how many ticks to be the basic unit (default = 1)
tick_dim(optional):
    tick-shift event dimensions
    the maximum number of tick-shift (default = 100)
velocity_dim(optional):
    velocity event dimensions
    the maximum number of quantized velocity (default = 32, max = 128)</p>
<p>e.g.</p>
<p>[C5 - - - E5 - - / G5 - - / /]
-&gt;
[380, 60, 259, 188, 64, 258, 192, 256, 67, 258, 195, 257]</p></div>
  <div class="source_cont">
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#TMIDI.Tegridy_ReprProcessor">Tegridy_ReprProcessor</a></li>
          <li><a href="/abc.ABC.ext">abc.ABC</a></li>
          </ul>
          <h3>Methods</h3>
            
  <div class="item">
    <div class="name def" id="TMIDI.Tegridy_RPR_MidiEventProcessor.decode">
    <p>def <span class="ident">decode</span>(</p><p>self, repr_seq=None)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#TMIDI.Tegridy_ReprProcessor">Tegridy_ReprProcessor</a></code>.<code><a href="#TMIDI.Tegridy_ReprProcessor.decode">decode</a></code>
    </p>

    
  
    <div class="desc"><p>Return the note seq</p>
<h2 id="parameters">Parameters</h2>
<p>repr_seq: Representation Sequence List</p>
<h2 id="returns">Returns</h2>
<p>note_seq : Note List.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.Tegridy_RPR_MidiEventProcessor.decode', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.Tegridy_RPR_MidiEventProcessor.decode" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repr_seq</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the note seq</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    repr_seq: Representation Sequence List</span>
<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    note_seq : Note List.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># print(repr_seq)</span>
    <span class="k">if</span> <span class="n">repr_seq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">time_shift</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">cur_vel</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">meta_events</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">note_on_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">repr_seq</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_index</span><span class="p">[</span><span class="s2">&quot;note_on&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">e</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_index</span><span class="p">[</span><span class="s2">&quot;note_off&quot;</span><span class="p">]:</span>
            <span class="n">token_on</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;note_on&quot;</span><span class="p">,</span>
                <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">time_shift</span><span class="p">,</span>
                <span class="s2">&quot;pitch&quot;</span><span class="p">:</span> <span class="n">e</span><span class="p">,</span>
                <span class="s2">&quot;vel&quot;</span><span class="p">:</span> <span class="n">cur_vel</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">meta_events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token_on</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_index</span><span class="p">[</span><span class="s2">&quot;note_off&quot;</span><span class="p">]</span>
            <span class="o">&lt;=</span> <span class="n">e</span>
            <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_index</span><span class="p">[</span><span class="s2">&quot;time_shift&quot;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">token_off</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;note_off&quot;</span><span class="p">,</span>
                <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">time_shift</span><span class="p">,</span>
                <span class="s2">&quot;pitch&quot;</span><span class="p">:</span> <span class="n">e</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_index</span><span class="p">[</span><span class="s2">&quot;note_off&quot;</span><span class="p">],</span>
                <span class="s2">&quot;vel&quot;</span><span class="p">:</span> <span class="n">cur_vel</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">meta_events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token_off</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_index</span><span class="p">[</span><span class="s2">&quot;time_shift&quot;</span><span class="p">]</span>
            <span class="o">&lt;=</span> <span class="n">e</span>
            <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_index</span><span class="p">[</span><span class="s2">&quot;velocity&quot;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">time_shift</span> <span class="o">+=</span> <span class="p">(</span><span class="n">e</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_index</span><span class="p">[</span><span class="s2">&quot;time_shift&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.01</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_index</span><span class="p">[</span><span class="s2">&quot;velocity&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">e</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_vocab</span><span class="p">:</span>
            <span class="n">cur_vel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span>
                <span class="p">(</span><span class="n">e</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_index</span><span class="p">[</span><span class="s2">&quot;velocity&quot;</span><span class="p">])</span>
                <span class="o">*</span> <span class="mi">128</span>
                <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">velocity_dim</span><span class="p">)</span>
            <span class="p">)</span>
    <span class="n">skip_notes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">me</span> <span class="ow">in</span> <span class="n">meta_events</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">me</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;note_on&quot;</span><span class="p">:</span>
            <span class="n">note_on_dict</span><span class="p">[</span><span class="n">me</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">me</span>
        <span class="k">elif</span> <span class="n">me</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;note_off&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">token_on</span> <span class="o">=</span> <span class="n">note_on_dict</span><span class="p">[</span><span class="n">me</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">]]</span>
                <span class="n">token_off</span> <span class="o">=</span> <span class="n">me</span>
                <span class="k">if</span> <span class="n">token_on</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">token_off</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]:</span>
                    <span class="k">continue</span>
                <span class="n">notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">Note</span><span class="p">(</span>
                        <span class="n">velocity</span><span class="o">=</span><span class="n">token_on</span><span class="p">[</span><span class="s2">&quot;vel&quot;</span><span class="p">],</span>
                        <span class="n">pitch</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">token_on</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">]),</span>
                        <span class="n">start</span><span class="o">=</span><span class="n">token_on</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span>
                        <span class="n">end</span><span class="o">=</span><span class="n">token_off</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">skip_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>
    <span class="n">notes</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_step</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">notes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand</span><span class="p">(</span><span class="n">notes</span><span class="p">)</span>
    <span class="c1"># print(notes)</span>
    <span class="k">return</span> <span class="n">notes</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="TMIDI.Tegridy_RPR_MidiEventProcessor.encode">
    <p>def <span class="ident">encode</span>(</p><p>self, note_seq=None)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#TMIDI.Tegridy_ReprProcessor">Tegridy_ReprProcessor</a></code>.<code><a href="#TMIDI.Tegridy_ReprProcessor.encode">encode</a></code>
    </p>

    
  
    <div class="desc"><p>Return the note token</p>
<h2 id="parameters">Parameters</h2>
<p>note_seq : Note List.</p>
<h2 id="returns">Returns</h2>
<p>repr_seq: Representation List</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.Tegridy_RPR_MidiEventProcessor.encode', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.Tegridy_RPR_MidiEventProcessor.encode" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">note_seq</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the note token</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    note_seq : Note List.</span>
<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    repr_seq: Representation List</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">note_seq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_step</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">note_seq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compress</span><span class="p">(</span><span class="n">note_seq</span><span class="p">)</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="n">note_seq</span>
    <span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">meta_events</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">note</span> <span class="ow">in</span> <span class="n">notes</span><span class="p">:</span>
        <span class="n">token_on</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;note_on&quot;</span><span class="p">,</span>
            <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">note</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
            <span class="s2">&quot;pitch&quot;</span><span class="p">:</span> <span class="n">note</span><span class="o">.</span><span class="n">pitch</span><span class="p">,</span>
            <span class="s2">&quot;vel&quot;</span><span class="p">:</span> <span class="n">note</span><span class="o">.</span><span class="n">velocity</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">token_off</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;note_off&quot;</span><span class="p">,</span>
            <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">note</span><span class="o">.</span><span class="n">end</span><span class="p">,</span>
            <span class="s2">&quot;pitch&quot;</span><span class="p">:</span> <span class="n">note</span><span class="o">.</span><span class="n">pitch</span><span class="p">,</span>
            <span class="s2">&quot;vel&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">meta_events</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">token_on</span><span class="p">,</span> <span class="n">token_off</span><span class="p">])</span>
    <span class="n">meta_events</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">])</span>    
    <span class="n">meta_events</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">])</span>
    <span class="n">time_shift</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">cur_vel</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">me</span> <span class="ow">in</span> <span class="n">meta_events</span><span class="p">:</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">me</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">time_shift</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">duration</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tick_dim</span><span class="p">:</span>
            <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">start_index</span><span class="p">[</span><span class="s2">&quot;time_shift&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tick_dim</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="p">)</span>
            <span class="n">duration</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tick_dim</span>
        <span class="k">if</span> <span class="n">duration</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_index</span><span class="p">[</span><span class="s2">&quot;time_shift&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">duration</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">me</span><span class="p">[</span><span class="s2">&quot;vel&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cur_vel</span> <span class="o">!=</span> <span class="n">me</span><span class="p">[</span><span class="s2">&quot;vel&quot;</span><span class="p">]:</span>
                <span class="n">cur_vel</span> <span class="o">=</span> <span class="n">me</span><span class="p">[</span><span class="s2">&quot;vel&quot;</span><span class="p">]</span>
                <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">start_index</span><span class="p">[</span><span class="s2">&quot;velocity&quot;</span><span class="p">]</span>
                    <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">me</span><span class="p">[</span><span class="s2">&quot;vel&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">velocity_dim</span> <span class="o">/</span> <span class="mi">128</span><span class="p">))</span>
                <span class="p">)</span>
        <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_index</span><span class="p">[</span><span class="n">me</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">+</span> <span class="n">me</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">])</span>
        <span class="n">time_shift</span> <span class="o">=</span> <span class="n">me</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">events</span>
</pre></div>

  </div>
</div>

  </div>
  
      </div>
      </div>
      
      <div class="item">
      <p id="TMIDI.Tegridy_ReprProcessor" class="name">class <span class="ident">Tegridy_ReprProcessor</span></p>
      
  
    <div class="desc"><p>Abstract base class severing as the representation processor.</p>
<p>It provides the following abstract methods.
- encode(self, note_seq): encode the note sequence into the representation sequence.
- decode(self, repr_seq): decode the representation sequence into the note sequence.</p>
<h2 id="notes">Notes</h2>
<p>The base representation processor class includes the convertion between the note sequence and the representation sequence.
In general, we assume the input note sequence has already been quantized.
In that, the smallest unit of the quantization is actually 1 tick no matter what resolution is.
If you init "min_step" to be larger than 1, we assume you wish to compress all the base tick.
e.g. min_step = 2, then the whole ticks will be convertd half.
If you do this, the representation convertion may not be 100% correct.</p>
<hr></div>
  <div class="source_cont">
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="/abc.ABC.ext">abc.ABC</a></li>
          </ul>
          <h3>Methods</h3>
            
  <div class="item">
    <div class="name def" id="TMIDI.Tegridy_ReprProcessor.decode">
    <p>def <span class="ident">decode</span>(</p><p>self, repr_seq=None)</p>
    </div>
    

    
  
    <div class="desc"><p>decode the representation sequence into the note sequence.</p>
<h2 id="parameters">Parameters</h2>
<p>repr_seq: the representation numpy sequence</p>
<h2 id="returns">Returns</h2>
<p>note_seq= the input {Note} sequence</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.Tegridy_ReprProcessor.decode', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.Tegridy_ReprProcessor.decode" class="source">
    <div class="codehilite"><pre><span></span><span class="nd">@abstractmethod</span>
<span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repr_seq</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;decode the representation sequence into the note sequence.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    repr_seq: the representation numpy sequence</span>
<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    note_seq= the input {Note} sequence</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="TMIDI.Tegridy_ReprProcessor.encode">
    <p>def <span class="ident">encode</span>(</p><p>self, note_seq=None)</p>
    </div>
    

    
  
    <div class="desc"><p>encode the note sequence into the representation sequence.</p>
<h2 id="parameters">Parameters</h2>
<p>note_seq= the input {Note} sequence</p>
<h2 id="returns">Returns</h2>
<p>repr_seq: the representation numpy sequence</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-TMIDI.Tegridy_ReprProcessor.encode', this);">Show source &equiv;</a></p>
  <div id="source-TMIDI.Tegridy_ReprProcessor.encode" class="source">
    <div class="codehilite"><pre><span></span><span class="nd">@abstractmethod</span>
<span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">note_seq</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;encode the note sequence into the representation sequence.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    note_seq= the input {Note} sequence</span>
<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    repr_seq: the representation numpy sequence</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>

  </div>
</div>

  </div>
  
      </div>
      </div>

  </section>
</article>
  <div class="clear"> </div>
  <footer id="footer">
    <p>
      Generated by <a href="https://github.com/timothycrosley/pdocs">pdocs 1.1.1</a>
    </p>
  </footer>
</div>
</body>
</html>